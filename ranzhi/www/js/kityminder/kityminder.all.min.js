!function(t,e){function i(t){var e={};e.data=t.getData();var n=t.getChildren();if(n.length){e.children=[];for(var o=0;o<n.length;o++)e.children.push(i(n[o]))}return e}function n(t,e,i){var o=e.data;for(var r in o)t.setData(r,o[r]);t.setData("text",o.text||i.getLang(u[t.getType()]));var a=e.children;if(a){for(var s=0;s<a.length;s++){var l=new c;t.appendChild(l),n(l,a[s],i)}return t}}function o(t){return t.getRenderContainer().getRenderBox("top")}var r=e.KM=e.KityMinder=function(){var t={},e=0;return{version:"1.1.3",createMinder:function(t,e){e=e||{},e.renderTo=Utils.isString(t)?document.getElementById(t):t;var i=new d(e);return this.addMinder(e.renderTo,i),i},addMinder:function(i,n){var o;o="string"==typeof i?i:i.id||"KM_INSTANCE_"+e++,t[o]=n},getMinder:function(i,n){var o;return o="string"==typeof i?i:i.id||"KM_INSTANCE_"+e++,t[o]||this.createMinder(i,n)},LANG:{}}}(),a=Utils=r.Utils={extend:t.Utils.extend.bind(t.Utils),listen:function(t,i,n){var o=a.isArray(i)?i:a.trim(i).split(/\s+/),r=o.length;if(r)for(;r--;)if(i=o[r],t.addEventListener)t.addEventListener(i,n,!1);else{n._d||(n._d={els:[]});var s=i+n.toString(),c=a.indexOf(n._d.els,t);n._d[s]&&-1!=c||(-1==c&&n._d.els.push(t),n._d[s]||(n._d[s]=function(t){return n.call(t.srcElement,t||e.event)}),t.attachEvent("on"+i,n._d[s]))}t=null},trim:function(t){return t.replace(/(^[ \t\n\r]+)|([ \t\n\r]+$)/g,"")},each:function(t,e,i){if(null!=t)if(t.length===+t.length){for(var n=0,o=t.length;o>n;n++)if(e.call(i,n,t[n],t)===!1)return!1}else for(var r in t)if(t.hasOwnProperty(r)&&e.call(i,r,t[r],t)===!1)return!1},addCssRule:function(t,e,i){var n;return void 0===e||e&&e.nodeType&&9==e.nodeType?(i=e&&e.nodeType&&9==e.nodeType?e:i||document,n=i.getElementById(t),n?n.innerHTML:void 0):(i=i||document,n=i.getElementById(t),""===e?n?(n.parentNode.removeChild(n),!0):!1:(n?n.innerHTML=e:(n=i.createElement("style"),n.id=t,n.innerHTML=e,i.getElementsByTagName("head")[0].appendChild(n)),void 0))},keys:function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push(i);return e},proxy:function(t,e){return function(){return t.apply(e,arguments)}},indexOf:function(t,e,i){var n=-1;return i=this.isNumber(i)?i:0,this.each(t,function(t,o){return o>=i&&t===e?(n=o,!1):void 0}),n},argsToArray:function(t,e){return Array.prototype.slice.call(t,e||0)},clonePlainObject:function(t,e){var i;e=e||{};for(var n in t)t.hasOwnProperty(n)&&(i=t[n],a.isObject(i)||a.isArray(i)?(e[n]=a.isArray(i)?[]:{},a.clonePlainObject(t[n],e[n])):e[n]=i);return e},compareObject:function(t,e){var i;if(this.isEmptyObject(t)!==this.isEmptyObject(e))return!1;if(this.getObjectLength(t)!=this.getObjectLength(e))return!1;for(var n in t)if(t.hasOwnProperty(n)){if(i=t[n],void 0===e[n])return!1;if(this.isObject(i)||this.isArray(i)){if(this.isObject(e[n])!==this.isObject(i))return!1;if(this.isArray(i)!==this.isArray(e[n]))return!1;if(this.compareObject(i,e[n])===!1)return!1}else if(i!=e[n])return!1}return!0},getObjectLength:function(t){if(this.isArray(t)||this.isString(t))return t.length;var e=0;for(var i in t)t.hasOwnProperty(i)&&e++;return e},isEmptyObject:function(t){if(null==t)return!0;if(this.isArray(t)||this.isString(t))return 0===t.length;for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},getNodeCommonAncestor:function(t,e){if(t===e)return t.parent;if(t.contains(e))return this;if(e.contains(t))return e;for(var i=t.parent;!i.contains(e);)i=i.parent;return i},loadFile:function(){function t(t,i){try{for(var n,o=0;n=e[o++];)if(n.doc===t&&n.url==(i.src||i.href))return n}catch(r){return null}}var e=[];return function(i,n,o){var r=t(i,n);if(r)return r.ready?o&&o():r.funs.push(o),void 0;if(e.push({doc:i,url:n.src||n.href,funs:[o]}),!i.body){var a=[];for(var s in n)"tag"!=s&&a.push(s+'="'+n[s]+'"');return i.write("<"+n.tag+" "+a.join(" ")+" ></"+n.tag+">"),void 0}if(!n.id||!i.getElementById(n.id)){var c=i.createElement(n.tag);delete n.tag;for(var s in n)c.setAttribute(s,n[s]);c.onload=c.onreadystatechange=function(){if(!this.readyState||/loaded|complete/.test(this.readyState)){if(r=t(i,n),r.funs.length>0){r.ready=1;for(var e;e=r.funs.pop();)e()}c.onload=c.onreadystatechange=null}},i.getElementsByTagName("head")[0].appendChild(c)}}}(),clone:function(t,e){var i;e=e||{};for(var n in t)t.hasOwnProperty(n)&&(i=t[n],"object"==typeof i?(e[n]=a.isArray(i)?[]:{},a.clone(t[n],e[n])):e[n]=i);return e},unhtml:function(t,e){return t?t.replace(e||/[&<">'](?:(amp|lt|quot|gt|#39|nbsp);)?/g,function(t,e){return e?t:{"<":"&lt;","&":"&amp;",'"':"&quot;",">":"&gt;","'":"&#39;"}[t]}):""}};Utils.each(["String","Function","Array","Number","RegExp","Object"],function(t,e){r.Utils["is"+e]=function(t){return Object.prototype.toString.apply(t)=="[object "+e+"]"}});var s=t.createClass("Command",{constructor:function(){this._isContentChange=!0,this._isSelectionChange=!1},execute:function(){},setContentChanged:function(t){this._isContentChange=!!t},isContentChanged:function(){return this._isContentChange},setSelectionChanged:function(t){this._isSelectionChange=!!t},isSelectionChanged:function(){return this._isContentChange},queryState:function(){return 0},queryValue:function(){return 0},isNeedUndo:function(){return!0}}),c=r.MinderNode=t.createClass("MinderNode",{constructor:function(t){this.parent=null,this.children=[],this.data={},this.tmpData={},Utils.isString(t)?this.setData("text",t):this.setData(t),this._createShapeDom(),this.setData("layout",{})},_createShapeDom:function(){this.rc=new t.Group,this.rc.addClass("km-minderNode"),this.rc.minderNode=this,this._createBgGroup(),this._createContGroup()},_createGroup:function(e){var i=new t.Group;i.setData("rctype",e),this.rc.appendShape(i)},_createBgGroup:function(){this._createGroup("bgrc")},_createContGroup:function(){this._createGroup("contrc")},getContRc:function(){var t,e=this.rc.getShapesByType("group");return Utils.each(e,function(e,i){return"contrc"==i.getData("rctype")?(t=i,!1):void 0}),t},getBgRc:function(){var t,e=this.rc.getShapesByType("group");return Utils.each(e,function(e,i){return"bgrc"==i.getData("rctype")?(t=i,!1):void 0}),t},setPoint:function(t,e){arguments.length<2?this.setData("point",t):this.setData("point",{x:t,y:e})},getPoint:function(){return this.getData("point")},setType:function(t){this.setData("type",t)},getLevel:function(){for(var t=0,e=this.parent;e;)t++,e=e.parent;return t},getType:function(){var t=this.getData("type");if(t)return t;var e=Math.min(this.getLevel(),2);return t=["root","main","sub"][e],this.setData("type",t),t},setText:function(t){this.setData("text",t),this.getTextShape().setContent(t)},getText:function(){return this.getData("text")},isRoot:function(){return null===this.getParent()?!0:!1},getParent:function(){return this.parent},getDepth:function(){for(var t=0,e=this.parent;e;)e=e.parent,t++;return t},getRoot:function(){for(var t=this;t.parent;)t=t.parent;return t},isAncestorOf:function(t){for(var e=t.parent;e;){if(e==this)return!0;e=e.parent}return!1},preTraverse:function(t){var e=this.getChildren();t(this);for(var i=0;i<e.length;i++)e[i].preTraverse(t)},postTraverse:function(t){for(var e=this.getChildren(),i=0;i<e.length;i++)e[i].postTraverse(t);t(this)},traverse:function(t){return this.postTraverse(t)},getChildren:function(){return this.children},getIndex:function(){return this.parent?this.parent.children.indexOf(this):-1},insertChild:function(t,e){void 0===e&&(e=this.children.length),t.parent&&t.parent.removeChild(t),t.parent=this,t.root=t.parent.root,this.children.splice(e,0,t)},appendChild:function(t){return this.insertChild(t)},prependChild:function(t){return this.insertChild(t,0)},removeChild:function(t){var e,i=t;t instanceof c&&(i=this.children.indexOf(t)),i>=0&&(e=this.children.splice(i,1)[0],e.parent=null)},getChild:function(t){return this.children[t]},getFirstChild:function(){return this.children[0]},getLastChild:function(){return this.children[this.children.length-1]},getData:function(t){return void 0===t?this.data:this.data[t]},setData:function(t,e){void 0===t?this.data={}:a.isObject(t)?Utils.extend(this.data,t):void 0===e?(this.data[t]=null,delete this.data[t]):this.data[t]=e},getRenderContainer:function(){return this.rc},getCommonAncestor:function(t){return Utils.getNodeCommonAncestor(this,t)},contains:function(t){if(this===t)return!0;if(this===t.parent)return!0;var e=!1;return Utils.each(this.getChildren(),function(i,n){return e=n.contains(t),e===!0?!1:void 0}),e},clone:function(){function t(e,i){var n=new KM.MinderNode(i.getText());n.data=Utils.clonePlainObject(i.getData()),n.tmpData=Utils.clonePlainObject(i.getTmpData()),n.parent=e,e&&e.children.push(n);for(var o,r=0;o=i.children[r++];)t(n,o);return n}return function(){return t(null,this)}}(),equals:function(t){if(t.children.length!=this.children.length)return!1;if(a.compareObject(t.getData(),this.getData())===!1)return!1;if(a.compareObject(t.getTmpData(),this.getTmpData())===!1)return!1;for(var e,i=0;e=this.children[i];i++)if(e.equals(t.children[i])===!1)return!1;return!0},getTextShape:function(){var t;return a.each(this.getContRc().getShapesByType("text"),function(e,i){return i.getAttr("_nodeTextShape")?(t=i,!1):void 0}),t},isSelected:function(){return this.getTmpData("highlight")===!0},clearChildren:function(){this.children=[]},isHighlight:function(){return this.getTmpData("highlight")},select:function(){this.setTmpData("highlight",!0)},setTmpData:function(t,e){var i=this;a.isObject(t)&&a.each(t,function(t,e){i.setTmpData(e,t)}),void 0===e||null===e||""===e?delete this.tmpData[t]:this.tmpData[t]=e},getTmpData:function(t){return void 0===t?this.tmpData:this.tmpData[t]}});!function(){var t;r.registerModule=function(e,i){t||(t={}),t[e]=i},r.getModules=function(){return t}}();var l=t.createClass("MindEvent",{constructor:function(e,i,n){i=i||{},i.getType&&"ShapeEvent"==i.getType()?(this.kityEvent=i,this.originEvent=i.originEvent,this.getPosition=i.getPosition.bind(i)):i.target&&i.preventDefault?this.originEvent=i:t.Utils.extend(this,i),this.type=e,this._canstop=n||!1},getTargetNode:function(){var t=this.kityEvent&&this.kityEvent.targetShape;if(!t)return null;for(;!t.minderNode&&t.container;)t=t.container;return t.minderNode||null},stopPropagation:function(){this._stoped=!0},stopPropagationImmediately:function(){this._immediatelyStoped=!0,this._stoped=!0},shouldStopPropagation:function(){return this._canstop&&this._stoped},shouldStopPropagationImmediately:function(){return this._canstop&&this._immediatelyStoped},preventDefault:function(){this.originEvent.preventDefault()},isRightMB:function(){var t=!1;return this.originEvent?("which"in this.originEvent?t=3==this.originEvent.which:"button"in this.originEvent&&(t=2==this.originEvent.button),t):!1}}),d=r.Minder=t.createClass("KityMinder",{constructor:function(t){this._options=Utils.extend(e.KITYMINDER_CONFIG||{},t),this.setDefaultOptions(KM.defaultOptions),this._initEvents(),this._initMinder(),this._initSelection(),this._initStatus(),this._initShortcutKey(),this._initContextmenu(),this._initModules(),this.getOptions("readOnly")===!0&&this.setDisabled(),this.fire("ready")},getOptions:function(t){var e;return t?(e=this.getPreferences(t),null===e||void 0===e?this._options[t]:e):(e=this.getPreferences(),e?a.extend(e,this._options,!0):this._options)},setDefaultOptions:function(t,e,i){var n={};Utils.isString(t)?n[t]=e:n=t,a.extend(this._options,n,!i)},setOptions:function(t,e){this.setPreferences(t,e)},_initMinder:function(){this._paper=new t.Paper,this._paper.getNode().setAttribute("contenteditable",!0),this._paper.getNode().ondragstart=function(t){t.preventDefault()},this._addRenderContainer(),this._root=new c(this.getLang().maintopic),this._root.setType("root"),this._options.renderTo&&this.renderTo(this._options.renderTo)},_addRenderContainer:function(){this._rc=new t.Group,this._paper.addShape(this._rc)},renderTo:function(t){this._paper.renderTo(this._renderTarget=t),this._bindEvents()},getRenderContainer:function(){return this._rc},getPaper:function(){return this._paper},getRenderTarget:function(){return this._renderTarget},_initShortcutKey:function(){this._shortcutkeys={},this._bindshortcutKeys()},isTextEditStatus:function(){return!1},addShortcutKeys:function(t,e){var i={},n=this;e?i[t]=e:i=t,a.each(i,function(t,e){n._shortcutkeys[t.toLowerCase()]=e})},getShortcutKey:function(t){return this._shortcutkeys[t]},_bindshortcutKeys:function(){function t(t,e,i){switch(t){case"ctrl":case"cmd":if(i.ctrlKey||i.metaKey)return!0;break;case"alt":if(i.altKey)return!0;break;case"shift":if(i.shiftKey)return!0}return e==h[t]?!0:!1}var e=this,i=this._shortcutkeys;e.on("keydown",function(n){var o=n.originEvent,r=o.keyCode||o.which;for(var s in i){var c=i[s].toLowerCase().split("+"),l=0;if(a.each(c,function(e,i){t(i,r,o)&&l++}),l==c.length){-1!=e.queryCommandState(s)&&e.execCommand(s),o.preventDefault();break}}})},_initContextmenu:function(){this.contextmenus=[]},addContextmenu:function(t){return a.isArray(t)?this.contextmenus=this.contextmenus.concat(t):this.contextmenus.push(t),this},getContextmenu:function(){return this.contextmenus},_initStatus:function(){this._status="normal",this._rollbackStatus="normal"},setStatus:function(t){return t?(this._rollbackStatus=this._status,this._status=t):this._status="",this},rollbackStatus:function(){this._status=this._rollbackStatus},getStatus:function(){return this._status},setDisabled:function(){var t=this;t.bkqueryCommandState=t.queryCommandState,t.bkqueryCommandValue=t.queryCommandValue,t.queryCommandState=function(e){var i=this._getCommand(e);return i&&i.enableReadOnly===!1?t.bkqueryCommandState.apply(t,arguments):-1},t.queryCommandValue=function(e){var i=this._getCommand(e);return i&&i.enableReadOnly===!1?t.bkqueryCommandValue.apply(t,arguments):null},this.setStatus("readonly"),t.fire("interactchange")},setEnabled:function(){var t=this;t.bkqueryCommandState&&(t.queryCommandState=t.bkqueryCommandState,delete t.bkqueryCommandState),t.bkqueryCommandValue&&(t.queryCommandValue=t.bkqueryCommandValue,delete t.bkqueryCommandValue),this.rollbackStatus(),t.fire("interactchange")}});Utils.extend(r,{_protocals:{},registerProtocal:function(t,e){r._protocals[t]=e()},findProtocal:function(t){return r._protocals[t]||null},getSupportedProtocals:function(){return Utils.keys(r._protocals).sort(function(t,e){return r._protocals[e].recognizePriority-r._protocals[t].recognizePriority})},getAllRegisteredProtocals:function(){return r._protocals}});var u={root:"maintopic",main:"topic",sub:"topic"};t.extendClass(d,{exportData:function(t){var e,n;return e=i(this.getRoot()),n=r.findProtocal(t),this._fire(new l("beforeexport",{json:e,protocalName:t,protocal:n},!0))!==!0?n?n.encode(e,this):e:void 0},importData:function(t,e){var i,n;if(e?n=r.findProtocal(e):r.getSupportedProtocals().every(function(e){var i=r.findProtocal(e);return i.recognize&&i.recognize(t)&&(n=i),!n}),!n)throw new Error("Unsupported protocal: "+e);var o={local:t,protocalName:e,protocal:n},a=this._fire(new l("beforeimport",o,!0));if(a)return this;if(i=o.json||(o.json=n.decode(t)),"object"==typeof i&&"then"in i){var s=this;i.then(t,function(t){s._afterImportData(t,o)})}else this._afterImportData(i,o);return this},_afterImportData:function(t,e){for(this._fire(new l("preimport",e,!1));this._root.getChildren().length;)this._root.removeChild(0);var i=this._root.getData("currentstyle");this._root.setData(),this._root.setData("currentstyle",i),n(this._root,t,this),this.fire("beforeimport"),this._fire(new l("import",e,!1)),this._firePharse({type:"contentchange"}),this._firePharse({type:"interactchange"})}}),t.extendClass(d,{_initEvents:function(){this._eventCallbacks={}},_bindEvents:function(){this._bindPaperEvents(),this._bindKeyboardEvents()},_resetEvents:function(){this._initEvents(),this._bindEvents()},_bindPaperEvents:function(){this._paper.on("click dblclick mousedown contextmenu mouseup mousemove mousewheel DOMMouseScroll touchstart touchmove touchend",this._firePharse.bind(this)),e&&(e.addEventListener("resize",this._firePharse.bind(this)),e.addEventListener("blur",this._firePharse.bind(this)))},_bindKeyboardEvents:function(){-1==navigator.userAgent.indexOf("iPhone")&&-1==navigator.userAgent.indexOf("iPod")&&-1==navigator.userAgent.indexOf("iPad")&&Utils.listen(document.body,"keydown keyup keypress paste",this._firePharse.bind(this))},_firePharse:function(t){var e,i,n;"DOMMouseScroll"==t.type&&(t.type="mousewheel",t.wheelDelta=t.originEvent.wheelDelta=120*t.originEvent.detail),e=new l("before"+t.type,t,!0),this._fire(e)||(i=new l("pre"+t.type,t,!1),n=new l(t.type,t,!1),this._fire(i),this._fire(n),this._fire(new l("after"+t.type,t,!1)),~"mousedown mouseup keydown keyup".indexOf(t.type)&&this._interactChange(t))},_interactChange:function(){var t=this;clearTimeout(this._interactTimeout),this._interactTimeout=setTimeout(function(){var e=t._fire(new l("beforeinteractchange"));e||(t._fire(new l("preinteractchange")),t._fire(new l("interactchange")))},300)},_listen:function(t,e){var i=this._eventCallbacks[t]||(this._eventCallbacks[t]=[]);i.push(e)},_fire:function(t){var e=this.getStatus(),i=this._eventCallbacks[t.type.toLowerCase()]||[];if(e&&(i=i.concat(this._eventCallbacks[e+"."+t.type.toLowerCase()]||[])),0!==i.length){for(var n=this.getStatus(),o=0;o<i.length&&(i[o].call(this,t),this.getStatus()==n&&!t.shouldStopPropagationImmediately());o++);return t.shouldStopPropagation()}},on:function(t,e){var i=this;return a.each(t.split(/\s+/),function(t,n){i._listen(n.toLowerCase(),e)}),this},off:function(t,e){var i,n,o,r,a=t.split(/\s+/);for(i=0;i<a.length;i++)if(o=this._eventCallbacks[a[i].toLowerCase()]){for(r=null,n=0;n<o.length;n++)o[n]==e&&(r=n);null!==r&&o.splice(r,1)}},fire:function(t,e){var i=new l(t,e);return this._fire(i),this}}),t.extendClass(d,{_initModules:function(){var t=r.getModules(),e=this._options.modules||Utils.keys(t);this._commands={},this._query={},this._modules={};var i,n,o,a,s,c=this;for(i=0;i<e.length;i++)if(n=e[i],t[n]){o=t[n].call(c),this._modules[n]=o,o.init&&o.init.call(c,this._options),a=o.commands;for(var n in a)this._commands[n.toLowerCase()]=new a[n];if(s=o.events)for(var l in s)c.on(l,s[l]);o.defaultOptions&&this.setDefaultOptions(o.defaultOptions),o.addShortcutKeys&&this.addShortcutKeys(o.addShortcutKeys),o.contextmenu&&this.addContextmenu(o.contextmenu)}},_garbage:function(){for(this.clearSelect();this._root.getChildren().length;)this._root.removeChild(0)},destroy:function(){var t=this._modules;this._resetEvents(),this._garbage();for(var e in t)t[e].destroy&&t[e].destroy.call(this)},reset:function(){var t=this._modules;this._garbage();for(var e in t)t[e].reset&&t[e].reset.call(this)}}),t.extendClass(d,{_getCommand:function(t){return this._commands[t.toLowerCase()]},_queryCommand:function(t,e,i){var n=this._getCommand(t);if(n){var o=n["query"+e];if(o)return o.apply(n,[this].concat(i))}return 0},queryCommandState:function(t){return this._queryCommand(t,"State",Utils.argsToArray(1))},queryCommandValue:function(t){return this._queryCommand(t,"Value",Utils.argsToArray(1))},execCommand:function(t){t=t.toLowerCase();var e,i,n,o,r=Utils.argsToArray(arguments,1),a=this;return e=this._getCommand(t),o={command:e,commandName:t.toLowerCase(),commandArgs:r},e?(!this._hasEnterExecCommand&&e.isNeedUndo()?(this._hasEnterExecCommand=!0,i=this._fire(new l("beforeExecCommand",o,!0)),i||(this._fire(new l("saveScene")),this._fire(new l("preExecCommand",o,!1)),n=e.execute.apply(e,[a].concat(r)),this._fire(new l("execCommand",o,!1)),this._fire(new l("saveScene")),e.isContentChanged()&&this._firePharse(new l("contentchange")),e.isSelectionChanged()&&this._firePharse(new l("selectionchange")),this._firePharse(new l("interactchange"))),this._hasEnterExecCommand=!1):(n=e.execute.apply(e,[a].concat(r)),this._hasEnterExecCommand||(e.isSelectionChanged()&&this._firePharse(new l("selectionchange")),this._firePharse(new l("interactchange")))),void 0===n?null:n):!1}}),t.extendClass(d,{getRoot:function(){return this._root},setRoot:function(t){this._root=t},handelNodeInsert:function(t){var e=this._rc;e.addShape(t.getRenderContainer())},handelNodeRemove:function(t){var e=this._rc;t.traverse(function(t){e.removeShape(t.getRenderContainer())})},renderNodes:function(t){var e=this;if(t instanceof Array){if(0===t.length)return!1;for(var i=0;i<t.length;i++)e.renderNode(t[i])}else e.renderNode(t)},getMinderTitle:function(){return this.getRoot().getText()}});var h=r.keymap={Backspace:8,Tab:9,Enter:13,Shift:16,Control:17,Alt:18,CapsLock:20,Esc:27,Spacebar:32,PageUp:33,PageDown:34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Del:46,NumLock:144,Cmd:91,F2:113,F3:114,F4:115,"=":187,"-":189,b:66,i:73,z:90,y:89,v:86,x:88,s:83,n:78,"/":191,".":190,notContentInput:{8:1,46:1,13:1,9:1,33:1,34:1,35:1,36:1,16:1,17:1,18:1,37:1,38:1,39:1,40:1,113:1},isSelectedNodeKey:{37:1,38:1,39:1,40:1,13:1,9:1}};t.extendClass(d,{getLang:function(t){var e=KM.LANG[this.getOptions("lang")];if(!e)throw Error("not import language file");t=(t||"").split(".");for(var i,n=0;(i=t[n++])&&(e=e[i],e););return e}}),KM.defaultOptions={zIndex:1e3,lang:"zh-cn",readyOnly:!1},t.extendClass(d,function(){var t="kityminder_preference",i=function(){var t=e.localStorage;return{saveLocalData:function(e,i){return t&&i?(t.setItem(e,i),!0):!1},getLocalData:function(e){return t?t.getItem(e):null},removeItem:function(e){t&&t.removeItem(e)}}}();return{setPreferences:function(e,n){var o={};Utils.isString(e)?o[e]=n:o=e;var r=i.getLocalData(t);r?(r=JSON.parse(r),a.extend(r,o)):r=o,i.saveLocalData(t,JSON.stringify(r))},getPreferences:function(e){var n=i.getLocalData(t);return n?(n=JSON.parse(n),e?n[e]:n):null},resetPreferences:function(t){var e=t?JSON.stringify(t):"";i.saveLocalData(e)}}}());var f=r.browser=function(){var t=navigator.userAgent.toLowerCase(),i=e.opera,n={ie:/(msie\s|trident.*rv:)([\w.]+)/.test(t),opera:!!i&&i.version,webkit:t.indexOf(" applewebkit/")>-1,mac:t.indexOf("macintosh")>-1,quirks:"BackCompat"==document.compatMode};n.gecko="Gecko"==navigator.product&&!n.webkit&&!n.opera&&!n.ie;var o=0;if(n.ie){var r=t.match(/(?:msie\s([\w.]+))/),a=t.match(/(?:trident.*rv:([\w.]+))/);o=r&&a&&r[1]&&a[1]?Math.max(1*r[1],1*a[1]):r&&r[1]?1*r[1]:a&&a[1]?1*a[1]:0,n.ie11Compat=11==document.documentMode,n.ie9Compat=9==document.documentMode,n.ie8=!!document.documentMode,n.ie8Compat=8==document.documentMode,n.ie7Compat=7==o&&!document.documentMode||7==document.documentMode,n.ie6Compat=7>o||n.quirks,n.ie9above=o>8,n.ie9below=9>o}if(n.gecko){var s=t.match(/rv:([\d\.]+)/);s&&(s=s[1].split("."),o=1e4*s[0]+100*(s[1]||0)+1*(s[2]||0))}return/chrome\/(\d+\.\d)/i.test(t)&&(n.chrome=+RegExp.$1),/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/i.test(t)&&!/chrome/i.test(t)&&(n.safari=+(RegExp.$1||RegExp.$2)),n.opera&&(o=parseFloat(i.version())),n.webkit&&(o=parseFloat(t.match(/ applewebkit\/(\d+)/)[1])),n.version=o,n.isCompatible=!n.mobile&&(n.ie&&o>=6||n.gecko&&o>=10801||n.opera&&o>=9.5||n.air&&o>=1||n.webkit&&o>=522||!1),n}();f.ie,f.webkit,f.gecko,f.opera,r.Geometry=function(){function e(t){return t.width=t.right-t.left,t.height=t.bottom-t.top,t.x=t.left,t.y=t.top,t}var i={},n=Math.min,o=Math.max;Math.abs;var r=Object.prototype.hasOwnProperty;return i.isNumberInRange=function(t,e){return t>e[0]&&t<e[1]},i.getDistance=function(e,i){return t.Vector.fromPoints(e,i).length()},i.getBox=function(t,i){return e({left:n(t.x,i.x),right:o(t.x,i.x),top:n(t.y,i.y),bottom:o(t.y,i.y)})},i.mergeBox=function(t,i){return e({left:n(t.left,i.left),right:o(t.right,i.right),top:n(t.top,i.top),bottom:o(t.bottom,i.bottom)})},i.getBoxRange=function(t){return{x:[t.left,t.right],y:[t.top,t.bottom]}},i.getBoxVertex=function(t){return{leftTop:{x:t.left,y:t.top},rightTop:{x:t.right,y:t.top},leftBottom:{x:t.left,y:t.bottom},rightBottom:{x:t.right,y:t.bottom}}},i.isPointInsideBox=function(t,e){var n=i.getBoxRange(e);return i.isNumberInRange(t.x,n.x)&&i.isNumberInRange(t.y,n.y)},i.isBoxIntersect=function(t,e){var i=o(t.left,e.left),r=o(t.top,e.top),a=n(t.right,e.right),s=n(t.bottom,e.bottom);return a>i&&s>r},i.snapToSharp=function(t){return a.isNumber(t)?(0|t)+.5:a.isArray(t)?t.map(i.snapToSharp):(["x","y","left","top","right","bottom"].forEach(function(e){r.call(t,e)&&(t[e]=i.snapToSharp(t[e]))}),t)},i.expandBox=function(t,i,n){return void 0===n&&(n=i),e({left:t.left-i,top:t.top-n,right:t.right+i,bottom:t.bottom+n})},i}(),r.registerModule("HistoryModule",function(){var e=this,i=t.createClass("Scene",{constructor:function(t){this.data=t.clone()},getData:function(){return this.data},cloneData:function(){return this.getData().clone()},equals:function(t){return this.getData().equals(t.getData())}}),n=t.createClass("HistoryManager",{constructor:function(t){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1,this.km=t},undo:function(){if(this.hasUndo){if(!this.list[this.index-1]&&1==this.list.length)return this.reset(),void 0;for(;this.list[this.index].equals(this.list[this.index-1]);)if(this.index--,0==this.index)return this.restore(0);this.restore(--this.index)}},redo:function(){if(this.hasRedo){for(;this.list[this.index].equals(this.list[this.index+1]);)if(this.index++,this.index==this.list.length-1)return this.restore(this.index);this.restore(++this.index)}},restore:function(){var t=this.list[this.index];this.km.setRoot(t.cloneData()),this.km.removeAllSelectedNodes(),this.km.initStyle(),this.update(),this.km.fire("restoreScene"),this.km.fire("contentChange")},getScene:function(){return new i(this.km.getRoot())},saveScene:function(){var t=this.getScene(),e=this.list[this.index];e&&e.equals(t)||(this.list=this.list.slice(0,this.index+1),this.list.push(t),this.list.length>this.km.getOptions("maxUndoCount")&&this.list.shift(),this.index=this.list.length-1,this.update())},update:function(){this.hasRedo=!!this.list[this.index+1],this.hasUndo=!!this.list[this.index-1]},reset:function(){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1}});this.historyManager=new n(this);var o,r,a={16:1,17:1,18:1,91:1,37:1,38:1,39:1,40:1},c=0;return{defaultOptions:{maxUndoCount:20,maxInputCount:20},commands:{undo:t.createClass("UndoCommand",{base:s,execute:function(t){t.historyManager.undo()},queryState:function(t){return t.historyManager.hasUndo?0:-1},isNeedUndo:function(){return!1}}),redo:t.createClass("RedoCommand",{base:s,execute:function(t){t.historyManager.redo()},queryState:function(t){return t.historyManager.hasRedo?0:-1},isNeedUndo:function(){return!1}})},addShortcutKeys:{Undo:"ctrl+z",Redo:"ctrl+y"},events:{saveScene:function(){this.historyManager.saveScene()},renderNode:function(t){var e=t.node;e.isSelected()&&this.select(e)},keydown:function(t){var i=t.originEvent,n=i.keyCode||i.which;a[n]||i.ctrlKey||i.metaKey||i.shiftKey||i.altKey||(0==e.historyManager.list.length&&e.historyManager.saveScene(),clearTimeout(r),r=setTimeout(function(){e.historyManager.saveScene()},200),o=n,c++,c>=e.getOptions("maxInputCount")&&e.historyManager.saveScene())},"import":function(){this.historyManager.reset()}}}}),r.registerModule("IconModule",function(){var e=this,i=function(e,i){var n=["","#A92E24","#29A6BD","#1E8D54","#eb6100","#876DDA"],o=(new t.Rect).fill(n[i]).setRadius(3).setWidth(20).setHeight(20),r=(new t.Text).setContent(i).fill("white").setSize(12),a=new t.Group;a.addShapes([o,r]),e.getContRc().addShape(a),r.setTranslate(6,15);var s=a.getHeight();a.setTranslate(0,-s/2)},n=function(i,n){var o,r,a=new t.Group,s=i.getContRc(),c=(new t.Circle).setRadius(8).fill("white").stroke(new t.Pen("#29A6BD",2));switch(5>n?(o=new t.Path,r=o.getDrawer(),r.moveTo(0,0).lineTo(6,0)):o=new t.Group,a.addShapes([c,o]),s.addShape(a),n){case 1:break;case 2:r.carcTo(6,0,0,0,-6);break;case 3:r.carcTo(6,0,0,-6,0);break;case 4:r.carcTo(6,1,0,0,6);break;case 5:var l=new t.Path;o.addShapes([(new t.Circle).setRadius(6).fill("#29A6BD"),l]),l.getDrawer().moveTo(-3,0).lineTo(-1,3).lineTo(3,-2),l.stroke(new t.Pen("white",2).setLineCap("round"))}5>n&&r.close(),o.fill("#29A6BD");var d=i.getData("PriorityIcon"),u=e.getCurrentLayoutStyle()[i.getType()];d?a.setTranslate(s.getWidth()+u.spaceLeft,0):a.setTranslate(a.getWidth()/2,0)},o=t.createClass("SetPriorityCommand",function(){return{base:s,execute:function(t,e){for(var i=t.getSelectedNodes(),n=0;n<i.length;n++)i[n].setData("PriorityIcon",e),t.updateLayout(i[n])},queryValue:function(t){for(var e,i=t.getSelectedNodes(),n=0;n<i.length&&!(e=i[n].getData("PriorityIcon"));n++);return e}}}()),r=t.createClass("SetProgressCommand",function(){return{base:s,execute:function(t,e){for(var i=t.getSelectedNodes(),n=0;n<i.length;n++)i[n].setData("ProgressIcon",e),t.updateLayout(i[n])},queryValue:function(t){for(var e,i=t.getSelectedNodes(),n=0;n<i.length&&!(e=i[n].getData("ProgressIcon"));n++);return e}}}());return{commands:{priority:o,progress:r},events:{RenderNodeLeft:function(t){var e=t.node,o=e.getData("PriorityIcon"),r=e.getData("ProgressIcon");e.getContRc(),o&&i(e,o),r&&n(e,r)}}}}),r.registerModule("LayoutModule",function(){t.extendClass(d,{addLayoutStyle:function(t,e){this._layoutStyles||(this._layoutStyles={}),this._layoutStyles[t]=e},getLayoutStyle:function(t){return this._layoutStyles[t]},getLayoutStyleItems:function(){var t=[];for(var e in this._layoutStyles)t.push(e);return t},getCurrentStyle:function(){return this.getRoot(),"default"},setCurrentStyle:function(t){var e=this.getRoot();return e.setData("currentstyle",t),t},getCurrentLayoutStyle:function(){var t=this.getCurrentStyle();return this.getLayoutStyle(t).getCurrentLayoutStyle.call(this)},highlightNode:function(t){var e=this.getCurrentStyle();this.getLayoutStyle(e).highlightNode.call(this,t)},initStyle:function(){var e=this.getCurrentStyle();this._rc.remove();var i=this._rc.transform;this._rc=new t.Group,this._paper.addShape(this._rc),this._rc.transform=i,this._rc._applyTransform();var n=this.getRoot();n.preTraverse(function(t){t.clearLayout()}),this.getLayoutStyle(e).initStyle.call(this),this.fire("afterinitstyle")},appendChildNode:function(t,e,i,n){var o=this.getCurrentStyle();this.getLayoutStyle(o).appendChildNode.call(this,t,e,i,n)},appendSiblingNode:function(t,e,i){var n=this.getCurrentStyle();this.getLayoutStyle(n).appendSiblingNode.call(this,t,e,i)},removeNode:function(t){var e=this.getCurrentStyle();this.getLayoutStyle(e).removeNode.call(this,t)},updateLayout:function(t){var e=this.getCurrentStyle();this.getLayoutStyle(e).updateLayout.call(this,t)},expandNode:function(t){var e=this.getCurrentStyle();this.getLayoutStyle(e).expandNode.call(this,t)}}),t.extendClass(c,{setLayout:function(t,e){void 0===this._layout&&(this._layout={});var i=this.getLayout();Utils.extend(i,{k:e}),this._layout=i},getLayout:function(t){return void 0===t?this._layout:this._layout[t]},clearLayout:function(){this._layout={}}});var e=function(t,e){var i=t.getRoot();return i.preTraverse(function(t){t.setPoint(),t.getBgRc().clear()}),t.setCurrentStyle(e),t.initStyle(),e},i=t.createClass("SwitchLayoutCommand",function(){return{base:s,execute:e,queryValue:function(t){return t.getCurrentStyle()}}}()),n=t.createClass("AppendChildNodeCommand",function(){return{base:s,execute:function(t,e,i,n){var o=t.getSelectedNode();return o?("root"===o.getType()||0===o.getChildren().length||o.isExpanded()||t.expandNode(o),o.expand(),t.appendChildNode(o,e,i,n),t.select(e,!0),e):null},queryState:function(t){var e=t.getSelectedNode();return e?0:-1}}}()),o=t.createClass("AppendSiblingNodeCommand",function(){return{base:s,execute:function(t,e,i){var n=t.getSelectedNode();return n?(n.isRoot()?(e.setType("main"),t.appendChildNode(n,e,i)):t.appendSiblingNode(n,e,i),t.select(e,!0),e):null},queryState:function(t){var e=t.getSelectedNodes();return 0===e.length||1===e.length&&e[0]===t.getRoot()?-1:0}}}()),r=t.createClass("RemoveNodeCommand",function(){return{base:s,execute:function(t){if(0!=t.getRoot().children.length){var e=t.getSelectedNodes();t.getRoot();for(var i=[],n=0;n<e.length;n++)i.push(e[n]);do{var o=i[0].getParent();o&&-1===i.indexOf(o)&&i.push(o),i.shift()}while(i.length>1);t.removeNode(e),t.select(i[0])}},queryState:function(t){var e=t.getSelectedNodes();return 0===e.length||1===e.length&&e[0]===t.getRoot()?-1:0
}}}()),a=t.createClass("EditNodeCommand",function(){return{base:s,execute:function(t){var e=t.getSelectedNode();return e?(t.select(e,!0),t.textEditNode(e),void 0):null},queryState:function(t){var e=t.getSelectedNode();return e?0:-1},isNeedUndo:function(){return!1}}}());return{commands:{appendchildnode:n,appendsiblingnode:o,removenode:r,editnode:a,switchlayout:i},events:{ready:function(){this.setDefaultOptions("layoutstyle",this.getLayoutStyleItems()),e(this,this.getOptions("defaultlayoutstyle"))},click:function(t){var e=t.kityEvent.targetShape&&t.kityEvent.targetShape.container;e&&"shicon"===e.class&&(this.expandNode(e),this.fire("contentchange"))},resize:function(){clearTimeout(this._lastStyleResetTimeout),this._lastStyleResetTimeout=setTimeout(function(){this.updateLayout(this.getRoot())}.bind(this),100)},"import":function(){this.initStyle()}},contextmenu:[{label:this.getLang("node.appendsiblingnode"),exec:function(){this.execCommand("appendsiblingnode",new c(this.getLang("topic")))},cmdName:"appendsiblingnode"},{label:this.getLang("node.appendchildnode"),exec:function(){this.execCommand("appendchildnode",new c(this.getLang("topic")))},cmdName:"appendchildnode"},{label:this.getLang("node.editnode"),exec:function(){this.execCommand("editnode",null)},cmdName:"editnode"},{label:this.getLang("node.removenode"),cmdName:"removenode"},{divider:1}],defaultOptions:{defaultlayoutstyle:"default",node:{appendsiblingnode:"appendsiblingnode",appendchildnode:"appendchildnode",editnode:"editnode",removenode:"removenode"},defaultExpand:{defaultLayer:0,defaultSubShow:0}}}}),r.registerModule("LayoutDefault",function(){function e(){return{width:i.clientWidth,height:i.clientHeight}}var i=this.getRenderTarget(),n=this,o=t.createClass("DefaultshIcon",function(){return{constructor:function(e){this._show=!1,this._node=e;var i=this.shape=new t.Group;i.class="shicon",i.icon=this;var o=this._circle=(new t.Circle).fill("white").stroke("gray").setRadius(5),r=this._plus=new t.Path;r.getDrawer().moveTo(-3,0).lineTo(3,0).moveTo(0,-3).lineTo(0,3),r.stroke("gray");var a=this._dec=new t.Path;a.getDrawer().moveTo(-3,0).lineTo(3,0),a.stroke("gray"),n.getRenderContainer().addShape(i),i.addShapes([o,r,a]),this.update()},switchState:function(t){return(t===!0||t===!1)&&(this._show=!t),this._show?(this._plus.setOpacity(1),this._dec.setOpacity(0),this._show=!1):(this._plus.setOpacity(0),this._dec.setOpacity(1),this._show=!0),this._show},update:function(){var t,e=this._node,i=e.getLayout(),n=e.getRenderContainer(),o="main"===e.getType()?i.y:i.y+n.getHeight()/2-5;"left"===i.appendside?t=n.getRenderBox().closurePoints[1].x-5:(t=n.getRenderBox().closurePoints[0].x+6,"main"===e.getType()&&(t-=3)),this.shape.setTranslate(t,o)},remove:function(){this.shape.remove()}}}()),r=function(t,e){for(var i=0;i<t.length;i++){var n=e.indexOf(t[i]);-1!==n&&e.splice(n,1)}return t.concat(e)},a={root:{color:"#430",fill:"#e9df98",fontSize:24,padding:[15.5,25.5,15.5,25.5],margin:[0,0,0,0],radius:30,highlight:"rgb(254, 219, 0)",spaceLeft:3,spaceRight:0,spaceTop:3,spaceBottom:3},main:{stroke:new t.Pen("white",2).setLineCap("round").setLineJoin("round"),fill:"#A4c5c0",color:"#333",padding:[6.5,20,6.5,20],fontSize:16,margin:[0,10,30,50],radius:10,highlight:"rgb(254, 219, 0)",spaceLeft:5,spaceRight:0,spaceTop:2,spaceBottom:2},sub:{stroke:new t.Pen("white",2).setLineCap("round").setLineJoin("round"),color:"white",fontSize:12,margin:[0,10,20,6],padding:[5,10,5.5,10],highlight:"rgb(254, 219, 0)",spaceLeft:4,spaceRight:0,spaceTop:2,spaceBottom:2}},s=function(e){var i=e.getType(),n=a[i],o=e.getLayout();switch(e.getType()){case"root":case"main":var r=e.getBgRc().clear();r.addShape(o.bgShadow=new t.Rect),r.addShape(o.bgRect=new t.Rect),o.bgRect.fill(n.fill).setRadius(n.radius),o.bgShadow.fill("black").setOpacity(.2).setRadius(n.radius).translate(3,5);break;case"sub":var s=o.underline=new t.Path,c=o.highlightshape=(new t.Rect).setRadius(4);e.getBgRc().clear().addShapes([o.bgRect=(new t.Rect).setRadius(4),c,s])}},d=function(t){var e=t.getLayout(),i=t.getType();a[i],"root"===i&&(e.leftList=[],e.rightList=[],e.leftHeight=0,e.rightHeight=0)},u=function(t){var e=t.getContRc(),i=t.getType(),n=a[i],o=e.getWidth(),r=e.getHeight(),s=t.getLayout();switch(i){case"root":case"main":var c=o+n.padding[1]+n.padding[3],l=r+n.padding[0]+n.padding[2];s.bgRect.setWidth(c).setHeight(l),s.bgShadow.setWidth(c).setHeight(l);break;case"sub":var d=e.getWidth(),u=e.getHeight();c=d+n.padding[1]+n.padding[3],l=u+n.padding[0]+n.padding[2],s.underline.getDrawer().clear().moveTo(0,u+n.padding[2]+n.padding[0]).lineTo(d+n.padding[1]+n.padding[3],u+n.padding[2]+n.padding[0]),s.underline.stroke(n.stroke),s.highlightshape.setWidth(d+n.padding[1]+n.padding[3]).setHeight(u+n.padding[0]+n.padding[2]),s.bgRect.setWidth(c).setHeight(l)}e.setTranslate(n.padding[3],n.padding[0]+r/2)},h=function(t,i,o){var r=n.getRoot(),s=[t];"remove"===o&&(s=[]);var c=t.getLayout();t.getRenderContainer();var l=t.getType(),d=a[l],u=c.appendside,h=function(t,e){var i=a[t.getType()],n=t.getRenderContainer().getHeight()+i.margin[0]+i.margin[2],o=function(){var i,n=0;i=e?t.getLayout()[e+"List"]:t.getChildren();for(var o=0;o<i.length;o++){var r=i[o].getLayout();i[o].getRenderContainer().getPaper()&&0!==i[o].getRenderContainer().getHeight()&&(n+=r.branchheight)}return n}();return e?o:n>o?n:o};if("root"===l)c.y=e().height/2,s.push(t);else{if("append"===o||"contract"===o){var f=t.getRenderContainer().getHeight()||t.getContRc().getHeight()+d.padding[0]+d.padding[2];c.branchheight=f+d.margin[0]+d.margin[2]}else"change"===o&&(c.branchheight=h(t));i.getLayout(),i.getRenderContainer();for(var p=t.getParent()||i;p;){var g=p.getLayout();"root"===p.getType()?g[u+"Height"]=h(p,u):g.branchheight=h(p),p=p.getParent()}}var m=function(t){for(var e=[r];e.length>0;){var i=e[0].getLayout(),n=i[t+"List"]||e[0].getChildren(),n=function(){for(var t=[],e=0;e<n.length;e++){var i=n[e].getLayout();i.added&&t.push(n[e])}return t}();e=e.concat(n);for(var o=i.y-(i[t+"Height"]||i.branchheight)/2,a=0;a<n.length;a++){var c=n[a].getLayout();c.y=o+c.branchheight/2,o+=c.branchheight}e[0]!==r&&e[0].getLayout().added&&s.push(e[0]),e.shift()}};return u?m(u):(m("left"),m("right")),s},f=function(t){t.getType(),t.getParent();for(var i=[t],n=t.getLayout(),o=[t];0!==o.length;){var r=o[0].getParent(),s=o[0].getChildren();if(s=function(){for(var t=[],e=0;e<s.length;e++){var i=s[e].getLayout();i.added&&t.push(s[e])}return t}(),o=o.concat(s),r){var c=r.getLayout(),l=r.getRenderContainer().getWidth(),d=a[r.getType()],u=o[0].getLayout(),h=a[o[0].getType()];"center"===c.align&&(l/=2),u.x="left"===u.appendside?c.x-l-d.margin[1]-h.margin[3]:c.x+l+d.margin[1]+h.margin[3],i.push(o[0]),o.shift()}else n.x=e().width/2,o.shift()}return i},p=function(t){var e=t.getLayout(),i=t.getRenderContainer(),n=e.align,o=i.getHeight(),r=i.getWidth();switch(n){case"right":i.setTranslate(e.x-r,e.y-o/2);break;case"center":i.setTranslate(e.x-r/2,e.y-o/2);break;default:i.setTranslate(e.x,e.y-o/2)}t.setPoint(e.x,e.y)},g=function(e){var i,r=e.getType(),s=e.getLayout(),c=a[e.getType()];if("main"===r){if(!s.connect){i=s.connect=new t.Group;var l=s.connect.bezier=new t.Bezier,d=s.connect.circle=new t.Circle;i.addShapes([l,d]),n.getRenderContainer().addShape(i),n.getRoot().getRenderContainer().bringTop()}var u=n.getRoot(),h=u.getLayout().x,f=u.getLayout().y;i=s.connect;var p,g,m=e.getRenderContainer(),v=m.getRenderBox().closurePoints;"left"===s.appendside?(p=new t.BezierPoint(h-30,v[2].y+m.getHeight()/2),g=new t.BezierPoint(v[2].x+3,v[2].y+m.getHeight()/2)):(p=new t.BezierPoint(h+30,v[3].y+m.getHeight()/2),g=new t.BezierPoint(v[3].x-3,v[3].y+m.getHeight()/2)),p.getVertex();var y=g.getVertex();p.setVertex(h,f),i.bezier.setPoints([p,g]).stroke(c.stroke),i.circle.setCenter(y.x+("left"===s.appendside?-.5:-1.5),y.y).fill("white").setRadius(4)}else if("sub"===r){s.connect||(i=s.connect=new t.Path,n.getRenderContainer().addShape(i)),i=s.connect;var b,x,k=e.getParent().getRenderContainer(),w=k.getRenderBox(),S=e.getParent().getLayout(),_=a[e.getParent().getType()],C=e.getRenderContainer(),T=S.y,P=C.getRenderBox().closurePoints[1].y;"left"===s.appendside?(b=w.closurePoints[1].x-_.margin[1],x=C.getRenderBox().closurePoints[0].x,i.getDrawer().clear().moveTo(b,T).lineTo(b,P>T?P-c.margin[3]:P+c.margin[3]),P>T?i.getDrawer().carcTo(c.margin[3],0,1,x,P):i.getDrawer().carcTo(c.margin[3],0,0,x,P),i.stroke(c.stroke)):(b=w.closurePoints[0].x+_.margin[1],x=C.getRenderBox().closurePoints[1].x+1,i.getDrawer().clear().moveTo(b,T).lineTo(b,P>T?P-c.margin[3]:P+c.margin[3]),P>T?i.getDrawer().carcTo(c.margin[3],0,0,x,P):i.getDrawer().carcTo(c.margin[3],0,1,x,P),i.stroke(c.stroke))}"root"!==r&&0!==e.getChildren().length&&(s.shicon||(s.shicon=new o(e)),s.shicon.update())},m={getCurrentLayoutStyle:function(){return a},highlightNode:function(t){var e=t.isHighlight(),i=t.getType(),n=a[i],o=t.getLayout();switch(i){case"root":case"main":e?o.bgRect.fill(n.highlight):o.bgRect.fill(n.fill);break;case"sub":e?(o.highlightshape.fill(n.highlight).setOpacity(1),t.getTextShape().fill(t.getData("fontcolor")||"black")):(o.highlightshape.setOpacity(0),t.getTextShape().fill(t.getData("fontcolor")||"white"))}},updateLayout:function(t){t.getContRc().clear(),this._firePharse(new l("RenderNodeLeft",{node:t},!1)),this._firePharse(new l("RenderNodeCenter",{node:t},!1)),this._firePharse(new l("RenderNodeRight",{node:t},!1)),this._firePharse(new l("RenderNodeBottom",{node:t},!1)),this._firePharse(new l("RenderNodeTop",{node:t},!1)),this._firePharse(new l("RenderNode",{node:t},!1)),u(t);for(var e=f(t),i=h(t,t.getParent(),"change"),n=r(e,i),o=0;o<n.length;o++)p(n[o]),g(n[o]);this.isNodeSelected(t)&&this.highlightNode(t)},initStyle:function(){var t=n.getRoot(),e=t.getPoint();e&&(e=JSON.parse(JSON.stringify(e))),n.handelNodeInsert(t),t.getLayout().align="center",s(t),d(t),t.getContRc().clear(),this._firePharse(new l("RenderNodeLeft",{node:t},!1)),this._firePharse(new l("RenderNodeCenter",{node:t},!1)),this._firePharse(new l("RenderNodeRight",{node:t},!1)),this._firePharse(new l("RenderNodeBottom",{node:t},!1)),this._firePharse(new l("RenderNodeTop",{node:t},!1)),this._firePharse(new l("RenderNode",{node:t},!1)),u(t),f(t),h(t),p(t),e&&t.setPoint(e.x,e.y);for(var i=t.getChildren(),o=0;o<i.length;o++)this.appendChildNode(t,i[o]),i[o].isExpanded()&&i[o].getChildren().length>0&&n.expandNode(i[o]);t.setPoint(t.getLayout().x,t.getLayout().y)},expandNode:function(t){var e,i;t instanceof c?(i=t,e=i.getLayout().shicon.switchState()):(e=t.icon.switchState(),i=t.icon._node);var o;if(e)for(i.expand(),o=[i];0!==o.length;){var r=o[0].getChildren();if(o[0].isExpanded()&&0!==r.length){for(var a=0;a<r.length;a++)n.appendChildNode(o[0],r[a]);o=o.concat(r)}o.shift()}else{for(i.collapse(),o=i.getChildren();0!==o.length;){var s=o[0].getLayout();s.added&&(s.added=!1,o[0].getRenderContainer().remove(),s.connect.remove(),s.shicon&&s.shicon.remove()),o=o.concat(o[0].getChildren()),o.shift()}for(var l=h(i,i.getParent(),"contract"),d=0;d<l.length;d++)p(l[d]),g(l[d])}},appendChildNode:function(t,e,i,o){n.handelNodeInsert(e);var a=e.getLayout();e.clearLayout(),e.getContRc().clear(),a=e.getLayout(),a.added=!0;var c=t.getLayout(),m=t.getChildren(),v=-1!==m.indexOf(e);if(o){v||t.insertChild(e,o.getIndex()+1);var y=o.getLayout();if(a.appendside=y.appendside,a.align=y.align,"root"===t.getType()){n.handelNodeInsert(e);var b=m.length;7>b&&(b%2?(a.appendside="right",a.align="left"):(a.appendside="left",a.align="right"));var x=c[a.appendside+"List"],k=x.indexOf(o);x.splice(k+1,0,e)}}else if("root"!==t.getType()){var w=t.getLayout();a.appendside=w.appendside,a.align=w.align,v||t.appendChild(e)}else{var S=e.getPoint();S&&S.x&&S.y?S.x>t.getPoint().x?(a.appendside="right",a.align="left"):(a.appendside="left",a.align="right"):c.rightList.length>1&&c.rightList.length>c.leftList.length?(a.appendside="left",a.align="right"):(a.appendside="right",a.align="left");var _=c[a.appendside+"List"];_.push(e);var C;C="right"===a.appendside?_.length:t.getChildren().length,v||t.insertChild(e,C)}"root"===t.getType()?e.setType("main"):e.setType("sub"),s(e),d(e),this._firePharse(new l("RenderNodeLeft",{node:e},!1)),this._firePharse(new l("RenderNodeCenter",{node:e},!1)),this._firePharse(new l("RenderNodeRight",{node:e},!1)),this._firePharse(new l("RenderNodeBottom",{node:e},!1)),this._firePharse(new l("RenderNodeTop",{node:e},!1)),this._firePharse(new l("RenderNode",{node:e},!1)),u(e);for(var T=h(e,t,"append"),P=f(e),N=r(T,P),D=0;D<N.length;D++)p(N[D]),g(N[D]);t.expand();var R=t.getLayout().shicon;R&&R.switchState(!0)},appendSiblingNode:function(t,e,i){var n=t.getParent();this.appendChildNode(n,e,i,t)},removeNode:function(t){for(;0!==t.length;){var e=t[0].getParent();if(!e)return t.splice(0,1),!1;var i=t[0].getLayout();if("root"===e.getType()){var n=e.getLayout()[i.appendside+"List"],o=n.indexOf(t[0]);n.splice(o,1)}if(e.removeChild(t[0]),"root"!==e.getType()&&0===e.getChildren().length){var r=e.getLayout();r.shicon.remove(),r.shicon=null}for(var a=h(t[0],e,"remove"),s=0;s<a.length;s++)p(a[s]),g(a[s]);for(var c=[t[0]];0!==c.length;){c=c.concat(c[0].getChildren());try{c[0].getRenderContainer().remove();var l=c[0].getLayout();l.connect.remove(),l.shicon.remove()}catch(d){console.log("isRemoved")}var u=t.indexOf(c[0]);-1!==u&&t.splice(u,1),c.shift()}}}};return this.addLayoutStyle("default",m),{}}),r.registerModule("LayoutBottom",function(){function e(){return{width:i.clientWidth,height:i.clientHeight}}var i=this.getRenderTarget(),n=this,o=t.createClass("DefaultshIcon",function(){return{constructor:function(e){this._show=!1,this._node=e;var i=this.shape=new t.Group;i.class="shicon",i.icon=this;var o=this._rect=(new t.Rect).fill("white").stroke("gray").setRadius(2).setWidth(10).setHeight(10),r=this._plus=new t.Path;r.getDrawer().moveTo(2,5).lineTo(8,5).moveTo(5,2).lineTo(5,8),r.stroke("gray");var a=this._dec=new t.Path;a.getDrawer().moveTo(2,5).lineTo(8,5),a.stroke("gray"),"main"===e.getType()?n.getRenderContainer().addShape(i):e.getLayout().subgroup.addShape(i),i.addShapes([o,r,a]),this.update(),this.switchState()},switchState:function(){return this._show?(this._plus.setOpacity(1),this._dec.setOpacity(0),this._show=!1):(this._plus.setOpacity(0),this._dec.setOpacity(1),this._show=!0),this._show},update:function(){var t=this._node;t.getLayout();var e=t.getRenderContainer();t.getType();var i=e.getRenderBox().closurePoints[1].x+5,n=e.getRenderBox().closurePoints[0].y;this.shape.setTranslate(i,n)},remove:function(){this.shape.remove()}}}()),r={root:{color:"#430",fill:"#e9df98",fontSize:24,padding:[15.5,25.5,15.5,25.5],margin:[0,0,20,0],radius:0,highlight:"rgb(254, 219, 0)"},main:{stroke:new t.Pen("white",2).setLineCap("round").setLineJoin("round"),fill:"#A4c5c0",color:"#333",padding:[6.5,20,6.5,20],fontSize:16,margin:[20,20,10,10],radius:0,highlight:"rgb(254, 219, 0)"},sub:{stroke:new t.Pen("white",2).setLineCap("round").setLineJoin("round"),color:"#333",fontSize:12,margin:[10,10,10,30],padding:[5,10,5.5,10],highlight:"rgb(254, 219, 0)",fill:"rgb(231, 243, 255)"}},a=function(e){var i=e.getType(),n=r[i],o=e.getLayout();switch(e.getType()){case"root":case"main":var a=e.getBgRc().clear();a.addShape(o.bgShadow=new t.Rect),a.addShape(o.bgRect=new t.Rect),o.bgRect.fill(n.fill).setRadius(n.radius),o.bgShadow.fill("black").setOpacity(.2).setRadius(n.radius).translate(3,5);break;case"sub":var s=e.getBgRc().clear();s.addShape(o.bgRect=new t.Rect),o.bgRect.fill(n.fill)}},s=function(e){var i=e.getLayout(),o=e.getType();if(r[o],"main"===o){var a=i.subgroup=new t.Group;n.getRenderContainer().addShape(a)}},d=function(t){var e=t.getContRc(),i=t.getType(),n=r[i],o=e.getWidth(),a=e.getHeight(),s=t.getLayout();switch(i){case"root":case"main":var c=o+n.padding[1]+n.padding[3],l=a+n.padding[0]+n.padding[2];s.bgRect.setWidth(c).setHeight(l),s.bgShadow.setWidth(c).setHeight(l);break;case"sub":c=o+n.padding[1]+n.padding[3],l=a+n.padding[0]+n.padding[2],s.bgRect.setWidth(c).setHeight(l)}e.setTranslate(n.padding[3],n.padding[0]+a/2)},u=function(){for(var t=n.getRoot(),e=t.getChildren(),i=function(t){var e=t.getLayout(),i=t.getRenderContainer().getWidth()+r.main.margin[1]+r.main.margin[3],n=e.subgroup.getWidth()+r.main.margin[1]+r.sub.margin[3],o=e.branchwidth=i>n?i:n;return o},o=t.getLayout(),a=0,s=0;s<e.length;s++)a+=i(e[s]);for(var c=o.x-a/2,l=0;l<e.length;l++){var d=e[l].getLayout();d.x=c+r.main.margin[3]+5,c+=d.branchwidth}return e},h=function(t,i,o){var a=[],s=t.getType(),c=t.getLayout(),l=n.getRoot(),d=l.getLayout();if("root"===s){c.x=e().width/2,c.y=100,c.align="center",a.push(t);for(var h=t.getChildren(),f=0;f<h.length;f++){var p=h[f].getLayout();p.y=c.y+t.getRenderContainer().getHeight()+r.root.margin[2]+r.main.margin[0]}a=a.concat(h)}else if("main"===s)c.align="left",("append"===o||"contract"===o)&&(c.y=d.y+l.getRenderContainer().getHeight()+r.root.margin[2]+r.main.margin[0]),a=u();else{c.align="left";var g=i.getLayout();"append"===o&&(c.x="main"===i.getType()?r.sub.margin[3]:g.x+r.sub.margin[3]),("append"===o||"contract"===o)&&(c.branchheight=t.getRenderContainer().getHeight()+r.sub.margin[0]+r.sub.margin[2]);var m=i;for("change"===o&&(m=t);"main"!==m.getType();){for(var v=m.getChildren(),y=m.getLayout(),b=m.getRenderContainer().getHeight()+r.sub.margin[0]+r.sub.margin[2],x=0;x<v.length;x++)b+=v[x].getLayout().branchheight;y.branchheight=b,m=m.getParent()}for(var k=[m];0!==k.length;){var w=k[0].getChildren();k=k.concat(w);var S,_=k[0].getLayout(),C=r[k[0].getType()];S="main"===k[0].getType()?0:_.y+k[0].getRenderContainer().getHeight()+C.margin[2];for(var T=0;T<w.length;T++){var P=w[T].getLayout(),N=r[w[T].getType()];P.y=S+N.margin[0],S+=P.branchheight}a.push(k[0]),k.shift()}}return a},f=function(t){var e=t.getLayout(),i=t.getRenderContainer(),n=e.align;i.getHeight();var o=i.getWidth();switch(n){case"right":i.setTranslate(e.x-o,e.y);break;case"center":i.setTranslate(e.x-o/2,e.y);break;default:i.setTranslate(e.x,e.y)}"main"===t.getType()&&e.subgroup.setTranslate(e.x,e.y+t.getRenderContainer().getHeight()),t.setPoint(e.x,e.y)},p=function(e){var i=e.getType(),a=e.getLayout();r[e.getType()];var s,c=n.getRoot(),l=c.getLayout();if("main"===i){a.connect||(s=a.connect=new t.Path,n.getRenderContainer().addShape(s)),s=a.connect;var d=l.x,u=l.y+c.getRenderContainer().getHeight(),h=a.x+e.getRenderContainer().getWidth()/2,f=u+r.root.margin[2];s.getDrawer().clear().moveTo(d,u).lineTo(d,f).lineTo(h,f).lineTo(h,a.y),s.stroke(r.main.stroke)}else if("sub"===i){var p=e.getParent(),g=p.getLayout();a.connect||(s=a.connect=new t.Path,a.subgroup.addShape(s)),s=a.connect;var m,v;"main"===p.getType()?(m=10,v=0):(m=g.x+10,v=g.y+p.getRenderContainer().getHeight()+10);var y=a.y+e.getRenderContainer().getHeight()/2;s.getDrawer().clear().moveTo(m,v).lineTo(m,y).lineTo(a.x,y),s.stroke(r.sub.stroke)}"root"!==i&&0!==e.getChildren().length&&(a.shicon||(a.shicon=new o(e)),a.shicon.update())},g={getCurrentLayoutStyle:function(){return r},highlightNode:function(t){var e=t.isHighlight(),i=t.getType(),n=r[i],o=t.getLayout();switch(i){case"root":case"main":case"sub":e?o.bgRect.fill(n.highlight):o.bgRect.fill(n.fill)}},updateLayout:function(t){t.getContRc().clear(),this._firePharse(new l("RenderNodeLeft",{node:t},!1)),this._firePharse(new l("RenderNodeCenter",{node:t},!1)),this._firePharse(new l("RenderNodeRight",{node:t},!1)),this._firePharse(new l("RenderNodeBottom",{node:t},!1)),this._firePharse(new l("RenderNodeTop",{node:t},!1)),d(t);for(var e=h(t,t.getParent(),"change"),i=0;i<e.length;i++)f(e[i]),p(e[i]);if("sub"===t.getType())for(var n=u(),o=0;o<n.length;o++)f(n[o]),p(n[o])},initStyle:function(){var t=n.getRoot();n.handelNodeInsert(t),t.getLayout().align="center",a(t),s(t),t.getContRc().clear(),this._firePharse(new l("RenderNodeLeft",{node:t},!1)),this._firePharse(new l("RenderNodeCenter",{node:t},!1)),this._firePharse(new l("RenderNodeRight",{node:t},!1)),this._firePharse(new l("RenderNodeBottom",{node:t},!1)),this._firePharse(new l("RenderNodeTop",{node:t},!1)),d(t),h(t),f(t);for(var e=[t],i=[];0!==e.length;){var o=e[0].getChildren();e=e.concat(o);for(var r=0;r<o.length;r++)o[r].getLayout().parent=e[0];e[0].clearChildren(),e[0]!==t&&i.push(e[0]),e.shift()}for(var c=0;c<i.length;c++)this.appendChildNode(i[c].getLayout().parent,i[c])},appendChildNode:function(t,e,i,o){e.clearLayout();var r=t.getLayout();t.getData("expand"),"root"===t.getType()?(e.setType("main"),e.setData("expand",!0),n.handelNodeInsert(e)):(e.setType("sub"),r.subgroup.addShape(e.getRenderContainer()),e.getLayout().subgroup=r.subgroup),o?t.insertChild(e,o.getIndex()+1):t.appendChild(e),a(e),s(e),e.getRenderContainer().clear(),this._firePharse(new l("RenderNodeLeft",{node:e},!1)),this._firePharse(new l("RenderNodeCenter",{node:e},!1)),this._firePharse(new l("RenderNodeRight",{node:e},!1)),this._firePharse(new l("RenderNodeBottom",{node:e},!1)),this._firePharse(new l("RenderNodeTop",{node:e},!1)),d(e);for(var c=h(e,t,"append"),g=0;g<c.length;g++)f(c[g]),p(c[g]);if("sub"===e.getType())for(var m=u(),v=0;v<m.length;v++)f(m[v]),p(m[v])},appendSiblingNode:function(t,e){var i=t.getParent();this.appendChildNode(i,e,t)},removeNode:function(t){for(;0!==t.length;){var e=t[0].getParent();if(!e)return t.splice(0,1),!1;if(t[0].getLayout(),e.removeChild(t[0]),"root"!==e.getType()&&0===e.getChildren().length){var i=e.getLayout();i.shicon.remove(),i.shicon=null}for(var n=h(t[0],e,"remove"),o=0;o<n.length;o++)f(n[o]),p(n[o]);for(var r=u(),a=0;a<r.length;a++)f(r[a]),p(r[a]);for(var s=[t[0]];0!==s.length;){s=s.concat(s[0].getChildren());try{s[0].getRenderContainer().remove();var c=s[0].getLayout();c.connect.remove(),c.shicon.remove()}catch(l){console.log("isRemoved")}var d=t.indexOf(s[0]);-1!==d&&t.splice(d,1),s.shift()}}},expandNode:function(t){var e,i;t instanceof c?(i=t,e=i.getLayout().shicon.switchState()):(e=t.icon.switchState(),i=t.icon._node),i.setData("expand",e);for(var o=i.getChildren(),r=[];0!==o.length;){var a=o[0].getLayout();if(e){var s=o[0].getParent();a.parent=s,r.push(o[0]),a.connect=null,a.shicon=null}else try{o[0].getRenderContainer().remove(),a.connect.remove(),a.shicon&&a.shicon.remove()}catch(l){}o=o.concat(o[0].getChildren()),o.shift()}if(e){i.clearChildren();for(var d=0;d<r.length;d++)r[d].clearChildren(),n.appendChildNode(r[d].getLayout().parent,r[d])}var u=[];e||(u=h(i,i.getParent(),"contract"));for(var g=0;g<u.length;g++)f(u[g]),p(u[g])}};return this.addLayoutStyle("bottom",g),{}}),t.extendClass(d,function(){function t(t,e){e&&(e.setTmpData("highlight",!0),t.highlightNode(e))}function e(t,e){e&&(e.setTmpData("highlight",!1),t.highlightNode(e))}return{_initSelection:function(){this._selectedNodes=[]},getSelectedNodes:function(){return this._selectedNodes},getSelectedNode:function(){return this.getSelectedNodes()[0]||null},removeAllSelectedNodes:function(){var t=this;return Utils.each(this.getSelectedNodes(),function(i,n){e(t,n)}),this._selectedNodes=[],this.fire("selectionclear")},removeSelectedNodes:function(t){var i=this;return Utils.each(Utils.isArray(t)?t:[t],function(t,n){var o;-1!==(o=i._selectedNodes.indexOf(n))&&(i._selectedNodes.splice(o,1),e(i,n))}),this},select:function(e,i){i&&this.removeAllSelectedNodes();var n=this;return Utils.each(Utils.isArray(e)?e:[e],function(e,i){-1===n._selectedNodes.indexOf(i)&&(n._selectedNodes.push(i),t(n,i))}),this},isNodeSelected:function(t){return t.getTmpData("highlight")===!0},toggleSelect:function(t){return Utils.isArray(t)?t.forEach(this.toggleSelect.bind(this)):t.isSelected()?this.removeSelectedNodes(t):this.select(t),this},isSingleSelect:function(){return 1==this._selectedNodes.length},getSelectedAncestors:function(){function t(t,e){for(var i=t.length-1;i>=0;--i)if(t[i].isAncestorOf(e))return!0;return!1}var e,i=this.getSelectedNodes().slice(0),n=[],o=i.indexOf(this.getRoot());for(~o&&i.splice(o,1),i.sort(function(t,e){return t.getLevel()-e.getLevel()});e=i.pop();)t(i,e)||n.push(e);return n}}}());var p=t.createClass("ViewDragger",{constructor:function(t){this._minder=t,this._enabled=!1,this._offset={x:0,y:0},this._bind()},isEnabled:function(){return this._enabled},setEnabled:function(t){var e=this._minder.getPaper();e.setStyle("cursor",t?"pointer":"default"),e.setStyle("cursor",t?"-webkit-grab":"default"),this._enabled=t},move:function(t){this._minder.getRenderContainer().translate(t.x,t.y)},_bind:function(){var e=this,i=!1,n=null,o=null;this._minder.on("normal.mousedown readonly.mousedown readonly.touchstart",function(t){t.getTargetNode()!=this.getRoot()||this.getRoot().isSelected()&&this.isSingleSelect()||(n=t.getPosition(),i=!0)}).on("normal.mousemove normal.touchmove",function(e){if(i){var o=t.Vector.fromPoints(n,e.getPosition());o.length()>3&&this.setStatus("hand")}}).on("hand.beforemousedown hand.beforetouchend",function(t){e.isEnabled()&&(n=t.getPosition(),t.stopPropagation())}).on("hand.beforemousemove hand.beforetouchmove",function(i){if(n){o=i.getPosition();var r=t.Vector.fromPoints(n,o);e.move(r),i.stopPropagation(),i.preventDefault(),i.originEvent.preventDefault(),n=o}}).on("mouseup",function(){n=null,i&&(e.setEnabled(!1),i=!1,this.rollbackStatus())})}});r.registerModule("View",function(){var e=t.createClass("ToggleHandCommand",{base:s,execute:function(t){t._viewDragger.setEnabled(!t._viewDragger.isEnabled()),t._viewDragger.isEnabled()?t.setStatus("hand"):t.rollbackStatus(),this.setContentChanged(!1)},queryState:function(t){return t._viewDragger.isEnabled()?1:0},enableReadOnly:!1}),i=t.createClass("CameraCommand",{base:s,execute:function(t,e){var i=t.getPaper().getViewPort(),n=e.getRenderContainer().getRenderBox("view"),o=i.center.x-n.x-n.width/2,r=i.center.y-n.y;t.getRenderContainer().fxTranslate(o,r,1e3,"easeOutQuint"),this.setContentChanged(!1)},enableReadOnly:!1});return{init:function(){this._viewDragger=new p(this)},commands:{hand:e,camera:i},events:{keyup:function(t){t.originEvent.keyCode==h.Spacebar&&0===this.getSelectedNodes().length&&(this.execCommand("hand"),t.preventDefault())},mousewheel:function(t){var e,i;t=t.originEvent,t.ctrlKey||t.shiftKey||("wheelDeltaX"in t?(e=t.wheelDeltaX||0,i=t.wheelDeltaY||0):(e=0,i=t.wheelDelta),this._viewDragger.move({x:e/2.5,y:i/2.5}),t.preventDefault())},"normal.dblclick readonly.dblclick":function(e){e.kityEvent.targetShape instanceof t.Paper&&this.execCommand("camera",this.getRoot())}}}});var g=r.Geometry,m=t.createClass("AreaAnimator",{base:t.Animator,constructor:function(t,e){t.opacity=0,e.opacity=.8,this.callBase(t,e,function(t,e){t.setPosition(e.x,e.y),t.setSize(e.width,e.height),t.setOpacity(e.opacity)})}}),v=t.createClass("MoveToParentCommand",{base:s,execute:function(t,e,i){var n;!i.isExpanded()&&i.getChildren().length>0&&"root"!==i.getType()&&t.expandNode(i);for(var o=e.length-1;o>=0;o--)n=e[o],n.getParent()&&(t.removeNode([n]),t.appendChildNode(i,n),n.isExpanded()&&0!==n.getChildren().length&&t.expandNode(n));t.select(e,!0)}}),y=t.createClass("DragBox",{base:t.Group,constructor:function(t){this.callBase(),this._minder=t,this._draw()},_draw:function(){this._rect=(new t.Rect).setRadius(5).fill("white").stroke("#3399ff",1),this._text=(new t.Text).setSize(14).setTextAnchor("middle").fill("black").setStyle("cursor","default"),this.addShapes([this._rect,this._text])},_calcDragSources:function(){this._dragSources=this._minder.getSelectedAncestors()},_calcDropTargets:function(){function t(e,i){var n,o=[];return o.push(i),i.getChildren().forEach(function(i){for(n=0;n<e.length;n++)if(e[n]==i)return;o=o.concat(t(e,i))}),o}this._dropTargets=t(this._dragSources,this._minder.getRoot()),this._dropTargetBoxes=this._dropTargets.map(o)},_enterDragMode:function(){return this._calcDragSources(),this._dragSources.length?(this._calcDropTargets(),this._drawForDragMode(),this._shrink(),this._dragMode=!0,!0):(this._startPosition=null,!1)},_leaveDragMode:function(){this.remove(),this._dragMode=!1,this._dropSucceedTarget=null,this._removeDropHint()},_drawForDragMode:function(){this._text.setContent(this._dragSources.length+" items"),this._text.setPosition(this._startPosition.x,this._startPosition.y+5),this._minder.getPaper().addShape(this)},_shrink:function(){function t(t){for(var e=t.pop();t.length;)e=g.mergeBox(e,t.pop());return{x:e.left,y:e.top,width:e.width,height:e.height}}function e(t){var e=80,i=30;return{x:t.x-e/2,y:t.y-i/2,width:e,height:i}}var i=t(this._dragSources.map(o)),n=e(this._startPosition),r=new m(i,n);r.start(this._rect,400,"easeOutQuint")},_dropTest:function(){var t,e=this.getRenderBox();this._dropSucceedTarget=null;for(var i=0;i<this._dropTargetBoxes.length;i++)if(t=this._dropTargetBoxes[i],g.isBoxIntersect(e,t))return this._dropSucceedTarget=this._dropTargets[i],void 0},_updateDropHint:function(){var t=this._dropSucceedTarget,e=this._lastSucceedTarget;t&&t==e||(e&&this._removeDropStyle(e),t&&this._addDropStyle(t),this._lastSucceedTarget=t)},_removeDropHint:function(){var t=this._lastSucceedTarget;t&&this._removeDropStyle(t)},_removeDropStyle:function(t){t._layout.bgRect.stroke("none"),this._rect.stroke("#3399ff",1)},_addDropStyle:function(t){t._layout.bgRect.stroke("rgb(254, 219, 0)",3),t.getRenderContainer().fxScale(1.25,1.25,150,"ease").fxScale(.8,.8,150,"ease")},dragStart:function(t){this._startPosition=t},dragMove:function(e){var i=10;if(this._startPosition){if(this._dragPosition=e,!this._dragMode){if(g.getDistance(this._dragPosition,this._startPosition)<i)return;if(!this._enterDragMode())return}var n=t.Vector.fromPoints(this._startPosition,this._dragPosition);this.setTranslate(n),this._dropTest(),this._updateDropHint()}},dragEnd:function(){this._startPosition=null,this._dragMode&&(this._dropSucceedTarget&&this._minder.execCommand("movetoparent",this._dragSources,this._dropSucceedTarget),this._leaveDragMode())}});r.registerModule("DragTree",function(){return{init:function(){this._dragBox=new y(this)},events:{mousedown:function(t){t.getTargetNode()&&t.getTargetNode()!=this.getRoot()&&this._dragBox.dragStart(t.getPosition())},mousemove:function(t){this._dragBox.dragMove(t.getPosition())},mouseup:function(){this._dragBox.dragEnd()}},commands:{movetoparent:v}}}),r.registerModule("DropFile",function(){function i(){var t=this.getPaper().getContainer();t.addEventListener("dragover",n),t.addEventListener("drop",o.bind(this))}function n(t){t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy"}function o(e){e.preventDefault(),e.stopPropagation();var i=this;if(t.Browser.ie&&Number(t.Browser.version)<10)return alert("文件导入对IE浏览器仅支持10以上版本"),void 0;var n=e.dataTransfer.files;if(n){var o=n[0],r=o.type||/(.)\w+$/.exec(o.name)[0];/xmind/g.test(r)?a(i,o,"xmind"):/mmap/g.test(r)?a(i,o,"mindmanager"):/mm/g.test(r)?s(i,o,"freemind"):s(i,o)}}function r(){u&&(c(this),l.setRemotePath(null,!1),this.execCommand("camera",this.getRoot()),setTimeout(function(){l.watchChanges(!0)},10),u=!1)}function a(t,i,n){l=l||e.social,l.watchChanges(!1),u=!0,t.importData(i,n)}function s(t,e,i){var n=new FileReader;n.onload=function(e){a(t,e.target.result,i)},n.readAsText(e)}function c(t){d=e.draftManager||(e.draftManager=new e.DraftManager(t)),d.create()}var l,d,u=!1;return{events:{ready:i,"import":r}}}),r.registerModule("KeyboardModule",function(){function t(t){var e,n=[];t.traverse(function(t){e=t.getRenderContainer().getRenderBox("top"),e.width&&e.height&&n.push({left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height,width:e.width,height:e.height,node:t,text:t.getText()})});for(var o=0;o<n.length;o++)i(n,o)}function e(t,e){var i,n,r,c,l,d,u;return i=o(t.left,e.left),n=a(t.right,e.right),r=o(t.top,e.top),c=a(t.bottom,e.bottom),l=n-i-t.width-e.width,d=c-r-t.height-e.height,u=0>l?d:0>d?l:s(l*l+d*d),{cx:u,cy:u}}function i(t,i){for(var n,o,r=t[i],a={},s=0;s<t.length;s++)s!=i&&(n=t[s],o=e(n,r),n.right<r.left&&(!a.left||o.cx<a.left.dist)&&(a.left={dist:o.cx,node:n.node}),n.left>r.right&&(!a.right||o.cx<a.right.dist)&&(a.right={dist:o.cx,node:n.node}),n.bottom<r.top&&(!a.top||o.cy<a.top.dist)&&(a.top={dist:o.cy,node:n.node}),n.top>r.bottom&&(!a.down||o.cy<a.down.dist)&&(a.down={dist:o.cy,node:n.node}));
r.node._nearestNodes={right:a.right&&a.right.node||null,top:a.top&&a.top.node||null,left:a.left&&a.left.node||null,down:a.down&&a.down.node||null}}function n(e,i){var n=e.getSelectedNode();if(!n)return e.select(e.getRoot()),t(e.getRoot()),void 0;var o=n._nearestNodes[i];o&&e.select(o,!0)}var o=Math.min,a=Math.max,s=(Math.abs,Math.sqrt);return Math.exp,{events:{contentchange:function(){t(this.getRoot())},"normal.keydown":function(t){var e=r.keymap,i=t.getTargetNode();switch(this.receiver.keydownNode=i,t.originEvent.keyCode){case e.Enter:this.execCommand("appendSiblingNode",new c(this.getLang().topic),!0),t.preventDefault();break;case e.Tab:this.execCommand("appendChildNode",new c(this.getLang().topic),!0),t.preventDefault();break;case e.Backspace:case e.Del:t.preventDefault(),this.execCommand("removenode");break;case e.F2:t.preventDefault(),this.execCommand("editnode");break;case e.Left:n(this,"left"),t.preventDefault();break;case e.Up:n(this,"top"),t.preventDefault();break;case e.Right:n(this,"right"),t.preventDefault();break;case e.Down:n(this,"down"),t.preventDefault()}}}}}),r.registerModule("Select",function(){var e=this,i=r.Geometry,n=function(){var n=null,o=(new t.Path).fill("rgba(255,255,255,.3)").stroke("white"),r=!1,a=10;return{selectStart:function(t){return t.originEvent.button?void 0:n?this.selectEnd():(n=i.snapToSharp(t.getPosition()),void 0)},selectMove:function(t){if(!e.isTextEditStatus()&&n){var s=n,c=t.getPosition();if(!r){if(i.getDistance(s,c)<a)return;r=!0,e.getPaper().addShape(o),o.setOpacity(.8).getDrawer().clear()}var l=i.getBox(s,c),d=[];i.snapToSharp(l),o.getDrawer().pipe(function(){this.clear(),this.moveTo(l.left,l.top),this.lineTo(l.right,l.top),this.lineTo(l.right,l.bottom),this.lineTo(l.left,l.bottom),this.close()}),e.getRoot().traverse(function(t){var e=t.getRenderContainer().getRenderBox("top");i.isBoxIntersect(e,l)&&d.push(t)}),e.select(d,!0)}},selectEnd:function(){n&&(n=null),r&&(o.fadeOut(200,"ease",0,function(){o.remove&&o.remove()}),r=!1)}}}(),o=null;return{events:{"normal.mousedown textedit.mousedown":function(t){var e=t.getTargetNode();e?t.originEvent.shiftKey?this.toggleSelect(e):e.isSelected()?this.isSingleSelect()||(o=e):this.select(e,!0):(this.removeAllSelectedNodes(),n.selectStart(t),this.setStatus("normal"))},"normal.mousemove textedit.mousemove":n.selectMove,"normal.mouseup textedit.mouseup":function(t){var e=t.getTargetNode();e&&e==o&&(this.select(o,!0),o=null),n.selectEnd(t)}}}}),r.registerModule("TextEditModule",function(){var t=this,e=new d.Selection,i=new d.Receiver(this),n=new d.Range;this.receiver=i;var o,r=!1,a=0,s=1;t.isTextEditStatus=function(){return t.receiver.isTextEditStatus()},t.textEditNode=function(t){var o=t.getTextShape();this.setStatus("textedit"),e.setHide(),e.setStartOffset(0),e.setEndOffset(o.getContent().length),i.setTextEditStatus(!0).setSelection(e).setKityMinder(this).setMinderNode(t).setTextShape(o).setRange(n).setBaseOffset().setContainerStyle().setSelectionHeight().setContainerTxt(o.getContent()).updateTextData().updateSelectionShow().updateRange(n).setTextEditStatus(!0),e.setData("relatedNode",t)};var c=!1;return{events:{afterinitstyle:function(){this.getRenderContainer().addShape(e)},"normal.beforemousedown textedit.beforemousedown":function(a){if(a.isRightMB())return a.stopPropagationImmediately(),void 0;e.setHide();var s=a.getTargetNode();if(!s){var l=a.kityEvent.targetShape;l&&"Selection"==l.getType()&&(c=!0,s=l.getData("relatedNode"),a.stopPropagationImmediately()),"textedit"==this.getStatus()&&this.fire("contentchange"),t.setStatus("normal")}if(s){var d=s.getTextShape();d.setStyle("cursor","default"),this.isSingleSelect()&&s.isSelected()&&(e.collapse(),s.getTextShape().setStyle("cursor","text"),t.setStatus("textedit"),i.setTextEditStatus(!0).setSelection(e).setKityMinder(this).setMinderNode(s).setTextShape(d).setBaseOffset().setContainerStyle().setSelectionHeight().setCurrentIndex(a.getPosition(this.getRenderContainer())).updateSelection().setRange(n),e.setData("relatedNode",s),r=!0,o=a.getPosition(),c&&(e.setShow(),c=!1),t.setStatus("textedit"))}},"normal.beforekeydown":function(e){var o=this.getSelectedNode();if(o&&this.isSingleSelect()&&o.isSelected()){var r=e.originEvent.keyCode;if(!h.notContentInput[r]&&0!=n.nativeSel.rangeCount){var a=n.nativeSel.getRangeAt(0);a&&(a.startContainer===i.container||i.container.contains(a.startContainer))&&t.setStatus("textedit")}}},"normal.keyup":function(o){var r=this.getSelectedNode();if(r&&this.isSingleSelect()&&r.isSelected()){var a=o.originEvent.keyCode;if(h.isSelectedNodeKey[a]&&"textedit"!=t.getStatus()){var s=r.getTextShape();e.setHide(),e.setStartOffset(0),e.setEndOffset(s.getContent().length),i.setTextEditStatus(!0).setSelection(e).setKityMinder(this).setMinderNode(r).setTextShape(s).setRange(n).setBaseOffset().setContainerStyle().setSelectionHeight().setContainerTxt(s.getContent()).updateRange(n).setTextEditStatus(!0),e.setData("relatedNode",r)}}},"normal.mouseup textedit.mouseup":function(t){if(r)if(e.collapsed)e.setShow();else try{i.updateRange(n)}catch(t){console.log(t)}else{var o=t.getTargetNode();if(o&&this.isSingleSelect()&&o.isSelected()){var s=o.getTextShape();e.setHide(),e.setStartOffset(0),e.setEndOffset(s.getContent().length),i.setTextEditStatus(!0).setSelection(e).setKityMinder(this).setMinderNode(o).setTextShape(s).setRange(n).setBaseOffset().setContainerStyle().setSelectionHeight().setContainerTxt(s.getContent()).updateRange(n).setTextEditStatus(!0),e.setData("relatedNode",o)}}r=!1,a=0},"textedit.beforemousemove":function(t){if(r){t.stopPropagationImmediately();var n=t.getPosition(this.getRenderContainer());if(Math.abs(n.y-o.y)>=2&&Math.abs(o.x-n.x)<=2)return e.setHide(),r=!1,void 0;s=n.x>o.x?1:n.x<o.x?-1:s,i.updateSelectionByMousePosition(n,s).updateSelectionShow(s),o=t.getPosition()}},"normal.dblclick textedit.dblclick":function(o){var r=o.kityEvent.targetShape;"text"==r.getType().toLowerCase()&&(e.setStartOffset(0),e.setEndOffset(r.getContent().length),e.setShow(),i.setContainerTxt(r.getContent()).updateSelectionShow(1).updateRange(n).setTextEditStatus(!0),t.setStatus("textedit"))},restoreScene:function(){e.setHide()},stopTextEdit:function(){e.setHide(),i.clear().setTextEditStatus(!1),t.setStatus("normal")},resize:function(){e.setHide()},execCommand:function(o){var r={appendchildnode:1,appendsiblingnode:1,editnode:1};if(r[o.commandName]){var a=t.getSelectedNode();if(!a)return;var s=a.getTextShape();return s.setStyle("cursor","default"),a.getTextShape().setStyle("cursor","text"),t.setStatus("textedit"),i.setTextEditStatus(!0).setSelection(e).setKityMinder(this).setMinderNode(a).setTextShape(s).setBaseOffset().setContainerStyle().setSelectionHeight().getTextOffsetData().setIndex(0).updateSelection().setRange(n),e.setStartOffset(0),e.setEndOffset(s.getContent().length),e.setShow(),i.updateSelectionShow(1).updateRange(n),void 0}return"priority"!=o.commandName&&"progress"!=o.commandName||"textedit"!=this.getStatus()?(i.clear().setTextEditStatus(!1),"textedit"==this.getStatus()&&this.setStatus("normal"),void 0):(i.setBaseOffset().getTextOffsetData(),e.collapsed?i.updateSelection():i.updateSelectionShow(1),void 0)},selectionclear:function(){t.setStatus("normal"),i.setTextEditStatus(!1).clear()},blur:function(){i.clear()},"textedit.mousewheel":function(){i.setContainerStyle()}}}}),d.Range=t.createClass("Range",{constructor:function(){this.nativeRange=document.createRange(),this.nativeSel=e.getSelection()},hasNativeRange:function(){return 0!=this.nativeSel.rangeCount},select:function(){var t=this.nativeRange.startContainer;if(1==t.nodeType&&0==t.childNodes.length){var e=document.createTextNode("​");t.appendChild(e),this.nativeRange.setStart(e,1),this.nativeRange.collapse(!0)}try{this.nativeSel.removeAllRanges()}catch(i){}return this.nativeSel.addRange(this.nativeRange),this},setStart:function(t,e){try{this.nativeRange.setStart(t,e)}catch(i){console.log("e")}return this},setEnd:function(t,e){return this.nativeRange.setEnd(t,e),this},getStart:function(){var t=this.nativeSel.getRangeAt(0);return{startContainer:t.startContainer,startOffset:t.startOffset}},collapse:function(t){return this.nativeRange.collapse(t===!0),this},insertNode:function(t){return this.nativeRange.insertNode(t),this},updateNativeRange:function(){return this.nativeRange=this.nativeSel.getRangeAt(0),this}}),d.Receiver=t.createClass("Receiver",{clear:function(){return this.container.innerHTML="",this.selection&&this.selection.setHide(),this.range&&this.range.nativeSel.removeAllRanges(),this.index=0,this.inputLength=0,this},setTextEditStatus:function(t){return this.textEditStatus=t||!1,this},isTextEditStatus:function(){return this.textEditStatus},constructor:function(t){var e=this;this.setKityMinder(t),this.textEditStatus=!1;var i=document.createElement("div");i.setAttribute("contenteditable",!0),i.className="km_receiver",this.container=document.body.insertBefore(i,document.body.firstChild),f.ie&&11==f.version&&a.listen(this.container,"keydown keypress keyup",function(t){e.keyboardEvents.call(e,new l("keyup"==t.type?"beforekeyup":t.type,t))}),a.addCssRule("km_receiver_css"," .km_receiver{white-space:nowrap;position:absolute;padding:0;margin:0;word-wrap:break-word;clip:rect(1em 1em 1em 1em);}"),this.km.on("textedit.beforekeyup textedit.keydown textedit.keypress textedit.paste",a.proxy(this.keyboardEvents,this)),this.timer=null,this.index=0},setRange:function(t,e){this.index=e||this.index;var i=this.container.firstChild;this.range=t,t.setStart(i||this.container,this.index).collapse(!0);var n=this;return setTimeout(function(){n.container.focus(),t.select()}),this},setTextShape:function(e){return e||(e=new t.Text),this.textShape=e,this.container.innerHTML=a.unhtml(e.getContent()),this},setTextShapeSize:function(t){return this.textShape.setSize(t),this},getTextShapeHeight:function(){return this.textShape.getRenderBox().height},appendTextShapeToPaper:function(t){return t.addShape(this.textShape),this},setKityMinder:function(t){return this.km=t,this},setMinderNode:function(t){return this.minderNode=t,this},keyboardEvents:function(t){function e(){if(i.range.hasNativeRange()){var t=i.container.textContent.replace(/[\u200b\t\r\n]/g,"");0==i.textShape.getOpacity()&&i.textShape.setOpacity(1),f.gecko&&/\s$/.test(t)&&(t+="​"),i.textShape.setContent(t),i.setContainerStyle(),i.minderNode.setText(t),0==t.length&&i.minderNode.setText("a"),i.km.updateLayout(i.minderNode),i.textShape=i.minderNode.getTextShape(),0==t.length&&i.textShape.setOpacity(0),i.setBaseOffset(),i.updateTextData(),i.updateIndex(),i.updateSelection(),i.timer=setTimeout(function(){i.selection.setShow()},500)}}clearTimeout(this.timer);var i=this,n=t.originEvent,o=n.keyCode,s=r.keymap,c=!1,l=!1;switch(t.type){case"keydown":switch(c=!1,l=!1,t.originEvent.keyCode){case s.Enter:case s.Tab:return this.selection.setHide(),this.clear().setTextEditStatus(!1),this.km.fire("contentchange"),this.km.setStatus("normal"),t.preventDefault(),void 0;case h.Shift:case h.Control:case h.Alt:case h.Cmd:return}if(t.originEvent.ctrlKey||t.originEvent.metaKey)return o==h.v&&setTimeout(function(){i.range.updateNativeRange().insertNode($("<span>$$_kityminder_bookmark_$$</span>")[0]),i.container.innerHTML=a.unhtml(i.container.textContent.replace(/[\u200b\t\r\n]/g,""));var t=i.container.textContent.indexOf("$$_kityminder_bookmark_$$");i.container.textContent=i.container.textContent.replace("$$_kityminder_bookmark_$$",""),i.range.setStart(i.container.firstChild,t).collapse(!0).select(),e()},100),o==h.x&&setTimeout(function(){e()},100),void 0;c=!0,e();break;case"keypress":c&&(l=!0);break;case"beforekeyup":switch(o){case h.Enter:case h.Tab:case h.F2:return this.keydownNode===this.minderNode&&(this.rollbackStatus(),this.setTextEditStatus(!1),this.clear()),t.preventDefault(),void 0}return l||e(),!0}},updateIndex:function(){return this.index=this.range.getStart().startOffset,this},updateTextData:function(){return this.textShape.textData=this.getTextOffsetData(),this},setSelection:function(t){return this.selection=t,this},updateSelection:function(){return this.selection.setShowHold(),this.selection.bringTop(),this.selection.setStartOffset(this.index).collapse(!0),this.index==this.textData.length?0==this.index?this.selection.setPosition(this.getBaseOffset()):this.selection.setPosition({x:this.textData[this.index-1].x+this.textData[this.index-1].width,y:this.textData[this.index-1].y}):this.selection.setPosition(this.textData[this.index]),this},getBaseOffset:function(t){var e=this.textShape.getRenderBox(t||this.km.getRenderContainer());return e},setBaseOffset:function(){return this.offset=this.textShape.getRenderBox(this.km.getRenderContainer()),this},setContainerStyle:function(){var t=this.getBaseOffset("screen");if(this.container.style.cssText=";left:"+t.x+"px;top:"+(t.y-5)+"px;width:"+t.width+"px;height:"+t.height+"px;",!this.selection.isShow()){var e=this.km.getPaper(),i=e.node.parentNode.clientWidth,n=e.node.parentNode.clientHeight;i<this.container.offsetWidth+this.container.offsetLeft?(this.km.getRenderContainer().translate(i/-3,0),this.setContainerStyle()):n<this.container.offsetTop+this.container.offsetHeight&&(this.km.getRenderContainer().translate(0,n/-3),this.setContainerStyle())}return this},getTextOffsetData:function(){var t=this.textShape.getContent();this.textData=[];for(var e=0,i=t.length;i>e;e++){try{var n=this.textShape.getExtentOfChar(e)}catch(o){console.log(o)}this.textData.push({x:n.x+this.offset.x,y:this.offset.y,width:n.width,height:n.height})}return this},setCurrentIndex:function(t){var e=this;this.getTextOffsetData();var i=!1;return a.each(this.textData,function(n,o){return 0==n&&t.x<=o.x?(e.index=0,!1):t.x>=o.x&&t.x<=o.x+o.width?(e.index=t.x-o.x>o.width/2?n+1:n,i=!0,!1):n==e.textData.length-1&&t.x>=o.x?(e.index=e.textData.length,!1):void 0}),this},setSelectionHeight:function(){return this.selection.setHeight(this.getTextShapeHeight()),this},updateSelectionByMousePosition:function(t,e){var i=this;return a.each(this.textData,function(n,o){return 0==n&&t.x<=o.x?(i.selection.setStartOffset(0),!1):n==i.textData.length-1&&t.x>=o.x?(i.selection.setEndOffset(i.textData.length),!1):t.x>=o.x&&t.x<=o.x+o.width?(i.index==n?(0==n&&i.selection.setStartOffset(n),t.x<=o.x+o.width/2?i.selection.collapse():i.selection.setEndOffset(n+((i.selection.endOffset>n||1==e)&&n!=i.textData.length-1?1:0))):n>i.index?(i.selection.setStartOffset(i.index),i.selection.setEndOffset(n+1)):(1==e?i.selection.setStartOffset(n+(t.x>=o.x+o.width/2&&n!=i.textData.length-1?1:0)):i.selection.setStartOffset(n),i.selection.setEndOffset(i.index)),!1):void 0}),this},updateSelectionShow:function(){var t=this.textData[this.selection.startOffset],e=this.textData[this.selection.endOffset],i=0;if(this.selection.collapsed)return this.selection.updateShow(t||this.textData[this.textData.length-1],1),this;if(e)i=e.x-t.x;else try{var n=this.textData[this.textData.length-1];i=n.x-t.x+n.width}catch(o){console.log("e")}return this.selection.updateShow(t,i),this},updateRange:function(t){var e=this.container.firstChild;return t.setStart(e,this.selection.startOffset),t.setEnd(e,this.selection.endOffset),t.select(),this},setIndex:function(t){return this.index=t,this},setContainerTxt:function(t){return this.container.textContent=t,this}}),d.Selection=t.createClass("Selection",{base:t.Rect,constructor:function(t,e,i){this.callBase(),this.height=t||20,this.setAttr("id","_kity_selection"),this.stroke(e||"rgb(27,171,255)",i||1),this.width=0,this.fill("rgb(27,171,255)"),this.setHide(),this.timer=null,this.collapsed=!0,this.startOffset=this.endOffset=0,this.setOpacity(.5),this.setStyle("cursor","text"),this._show=!1},collapse:function(t){return this.stroke("rgb(27,171,255)",1),this.setOpacity(1),this.width=1,this.collapsed=!0,t?this.startOffset=this.endOffset:this.endOffset=this.startOffset,this},setStartOffset:function(t){this.startOffset=t;var e=this.startOffset;if(this.startOffset>this.endOffset)this.startOffset=this.endOffset,this.endOffset=e;else if(this.startOffset==this.endOffset)return this.collapse(),this;return this.collapsed=!1,this.stroke("none",0),this.setOpacity(.5),this},setEndOffset:function(t){this.endOffset=t;var e=this.endOffset;if(this.endOffset<this.startOffset)this.endOffset=this.startOffset,this.startOffset=e;else if(this.startOffset==this.endOffset)return this.collapse(),this;return this.collapsed=!1,this.stroke("none",0),this.setOpacity(.5),this},updateShow:function(t,e){return e&&this.setShowHold(),this.setPosition(t).setWidth(e),0==e?this.setOpacity(0):this.setOpacity(.5),this.bringTop(),this},setPosition:function(t){try{this.x=t.x,this.y=t.y}catch(e){console.log(e)}return this.update()},setHeight:function(t){this.height=t},setHide:function(){return clearInterval(this.timer),this.setStyle("display","none"),this._show=!1,this},setShowHold:function(){return clearInterval(this.timer),this.setStyle("display",""),this._show=!0,this},setShow:function(){clearInterval(this.timer);var t=this,e="";return t.setStyle("display",""),t._show=!0,this.collapsed&&(t.setOpacity(1),this.timer=setInterval(function(){t.setStyle("display",e),e=e?"":"none"},400)),this},isShow:function(){return this._show},setTextShape:function(e){return this.text=e?e:new t.Text,this},getTextShape:function(){return this.text},setTxtContent:function(t){this.text.setContent(t)},updatePosition:function(){}}),r.registerModule("basestylemodule",function(){var e=this;return{commands:{bold:t.createClass("boldCommand",{base:s,execute:function(){var t=e.getSelectedNodes();1==this.queryState("bold")?a.each(t,function(t,i){i.setData("bold"),i.getTextShape().setAttr("font-weight"),e.updateLayout(i)}):a.each(t,function(t,i){i.setData("bold",!0),i.getTextShape().setAttr("font-weight","bold"),e.updateLayout(i)})},queryState:function(){var t=e.getSelectedNodes(),i=0;return 0==t.length?-1:(a.each(t,function(t,e){return e&&e.getData("bold")?(i=1,!1):void 0}),i)}}),italic:t.createClass("italicCommand",{base:s,execute:function(){var t=e.getSelectedNodes();1==this.queryState("italic")?a.each(t,function(t,i){i.setData("italic"),i.getTextShape().setAttr("font-style"),e.updateLayout(i)}):a.each(t,function(t,i){i.setData("italic",!0),i.getTextShape().setAttr("font-style","italic"),e.updateLayout(i)})},queryState:function(){var t=e.getSelectedNodes(),i=0;return 0==t.length?-1:(a.each(t,function(t,e){return e&&e.getData("italic")?(i=1,!1):void 0}),i)}})},addShortcutKeys:{bold:"ctrl+b",italic:"ctrl+i"},events:{afterrendernodecenter:function(t){t.node.getData("bold")&&t.node.getTextShape().setAttr("font-weight","bold"),t.node.getData("italic")&&t.node.getTextShape().setAttr("font-style","italic")}}}}),r.registerModule("fontmodule",function(){return{defaultOptions:{fontfamily:[{name:"songti",val:"宋体,SimSun"},{name:"yahei",val:"微软雅黑,Microsoft YaHei"},{name:"kaiti",val:"楷体,楷体_GB2312, SimKai"},{name:"heiti",val:"黑体, SimHei"},{name:"lishu",val:"隶书, SimLi"},{name:"andaleMono",val:"andale mono"},{name:"arial",val:"arial, helvetica,sans-serif"},{name:"arialBlack",val:"arial black,avant garde"},{name:"comicSansMs",val:"comic sans ms"},{name:"impact",val:"impact,chicago"},{name:"timesNewRoman",val:"times new roman"},{name:"sans-serif",val:"sans-serif"}],fontsize:[10,12,16,18,24,32,48]},commands:{forecolor:t.createClass("fontcolorCommand",{base:s,execute:function(t,e){var i=t.getSelectedNodes();a.each(i,function(t,i){i.setData("fontcolor",e),i.getTextShape().fill(e)})},queryState:function(t){return 0==t.getSelectedNodes().length?-1:0}}),fontfamily:t.createClass("fontfamilyCommand",{base:s,execute:function(t,e){var i=t.getSelectedNodes();a.each(i,function(i,n){n.setData("fontfamily",e),n.getTextShape().setAttr("font-family",e),t.updateLayout(n)})},queryState:function(t){return 0==t.getSelectedNodes().length?-1:0}}),fontsize:t.createClass("fontsizeCommand",{base:s,execute:function(t,e){var i=t.getSelectedNodes();a.each(i,function(i,n){n.setData("fontsize",e),n.getTextShape().setSize(e),t.updateLayout(n)})},queryState:function(t){return 0==t.getSelectedNodes().length?-1:0}})},events:{afterrendernodecenter:function(t){var e;(e=t.node.getData("fontfamily"))&&t.node.getTextShape().setAttr("font-family",e),(e=t.node.getData("fontcolor"))&&t.node.getTextShape().fill(e),(e=t.node.getData("fontsize"))&&t.node.getTextShape().setSize(e)}}}}),r.registerModule("Zoom",function(){function e(e,n){var o=e.getPaper(),r=o.getViewPort();if(n){var a=new t.Animator({beginValue:r.zoom,finishValue:n/100,setter:function(t,e){r.zoom=e,t.setViewPort(r)}});e.zoom=n,i&&i.pause(),i=a.start(o,500,"ease")}}var i,n=this;n.setOptions("zoom",[50,80,100,120,150,200]);var o=t.createClass("Zoom",{base:s,execute:e,queryValue:function(t){return t.zoom}}),r=t.createClass("ZoomInCommand",{base:s,execute:function(t){e(t,this.nextValue(t))},queryState:function(t){return~this.nextValue(t)},nextValue:function(t){var e,i=t.getOptions("zoom");for(e=0;e<i.length;e++)if(i[e]>t.zoom)return i[e];return 0},enableReadOnly:!1}),a=t.createClass("ZoomOutCommand",{base:s,execute:function(t){e(t,this.nextValue(t))},queryState:function(t){return~this.nextValue(t)},nextValue:function(t){var e,i=t.getOptions("zoom");for(e=i.length-1;e>=0;e--)if(i[e]<t.zoom)return i[e];return 0},enableReadOnly:!1});return{init:function(){this.zoom=100},commands:{"zoom-in":r,"zoom-out":a,zoom:o},events:{"normal.keydown":function(t){var e=this,i=t.originEvent,n=i.keyCode||i.which;h["="]==n&&e.execCommand("zoom-in"),h["-"]==n&&e.execCommand("zoom-out")},ready:function(){this._zoomValue=1},"normal.mousewheel readonly.mousewheel":function(e){if(e.originEvent.ctrlKey){var i=e.originEvent.wheelDelta,n=this;t.Browser.mac||(i=-i),Math.abs(i)>100&&(clearTimeout(this._wheelZoomTimeout),this._wheelZoomTimeout=setTimeout(function(){n.getPaper()._zoom||1,0>i?n.execCommand("zoom-in"):i>0&&n.execCommand("zoom-out")},100),e.originEvent.preventDefault())}}}}}),r.registerModule("NodeText",function(){return{events:{renderNodeCenter:function(e){var i=e.node,n=i.getContRc().getWidth(),o=new t.Text(i.getData("text")||"");o.setAttr("_nodeTextShape",!0),i.getContRc().appendShape(o);var r=this.getCurrentLayoutStyle()[i.getType()];o.fill(r.color).setSize(r.fontSize),o.setTranslate(n+r.spaceLeft,0),o.setVerticalAlign("middle")}}}}),r.registerModule("hyperlink",function(){var e="M16.614,10.224h-1.278c-1.668,0-3.07-1.07-3.599-2.556h4.877c0.707,0,1.278-0.571,1.278-1.278V3.834 c0-0.707-0.571-1.278-1.278-1.278h-4.877C12.266,1.071,13.668,0,15.336,0h1.278c2.116,0,3.834,1.716,3.834,3.834V6.39 C20.448,8.508,18.73,10.224,16.614,10.224z M5.112,5.112c0-0.707,0.573-1.278,1.278-1.278h7.668c0.707,0,1.278,0.571,1.278,1.278 S14.765,6.39,14.058,6.39H6.39C5.685,6.39,5.112,5.819,5.112,5.112z M2.556,3.834V6.39c0,0.707,0.573,1.278,1.278,1.278h4.877 c-0.528,1.486-1.932,2.556-3.599,2.556H3.834C1.716,10.224,0,8.508,0,6.39V3.834C0,1.716,1.716,0,3.834,0h1.278 c1.667,0,3.071,1.071,3.599,2.556H3.834C3.129,2.556,2.556,3.127,2.556,3.834z";return{commands:{hyperlink:t.createClass("hyperlink",{base:s,execute:function(t,e){var i=t.getSelectedNodes();a.each(i,function(i,n){n.setData("hyperlink",e),t.updateLayout(n)})},queryState:function(t){var e=t.getSelectedNodes(),i=0;return 0==e.length?-1:(a.each(e,function(t,e){return e&&e.getData("hyperlink")?(i=0,!1):void 0}),i)},queryValue:function(t){var e=t.getSelectedNode();return e.getData("hyperlink")}}),unhyperlink:t.createClass("hyperlink",{base:s,execute:function(t){var e=t.getSelectedNodes();a.each(e,function(e,i){i.setData("hyperlink"),t.updateLayout(i)})},queryState:function(t){var e=t.getSelectedNodes();if(0==e.length)return-1;var i=!1;return a.each(e,function(t,e){return e.getData("hyperlink")?(i=!0,!1):void 0}),i?0:-1}})},events:{RenderNodeRight:function(i){var n,o=i.node;if(n=o.getData("hyperlink")){var r=new t.HyperLink(n),a=new t.Path,s=o.getContRc().getBoundaryBox(),c=this.getCurrentLayoutStyle()[o.getType()];a.setPathData(e).fill("#666").setTranslate(s.x+s.width+c.spaceLeft,-5),r.addShape(a),r.setTarget("_blank"),r.setStyle("cursor","pointer"),o.getContRc().addShape(r)}}}}}),r.registerModule("Expand",function(){function e(t,e){return function(n,o,r,a){var s,c,l;for(n.setData(i,o),a=a||1,s=n.getChildren(),l=0;l<s.length;l++)c=s[l],t>=a?r(c,o,r,a+1):e&&e(c,o,r,a+1)}}var i="expandState",n="expand",o="collapse",r=function(t,e){for(var i=[t];0!==i.length;)e(i[0]),i=i.concat(i[0].getChildren()),i.shift()},a=function(t){for(var e=[].concat(t),i=[],n=0;n<e.length;n++){var o=e[n].getParent();if(!o){i=[e[n]];break}for(;o;){if(-1!==e.indexOf(o)){e[n]=null;break}o=o.getParent()}e[n]&&i.push(e[n])}return i},l=function(t,e){var i=t.getSelectedNodes(),n=a(i);if(0===i.length||"root"===i[0].getType()||"root"===n[0].getType())r(t.getRoot(),function(t){"expand"===e?t.expand():t.collapse()}),t.initStyle();else for(var o=0;o<n.length;o++){var s=n[o],c=s.getChildren();if(0!==c.length){r(s,function(t){t!==s&&("expand"===e?t.expand():t.collapse())});var l;l="expand"===e?!s.isExpanded():s.isExpanded(),l?t.expandNode(s):(t.expandNode(s),t.expandNode(s))}}for(var d=0;d<i.length;d++)t.highlightNode(i[d])},d=c.EXPAND_POLICY={KEEP_STATE:function(t,e){t.setData(i,e)},generateDeepPolicy:e,DEEP_TO_CHILD:e(1),DEEP_TO_LEAF:e(Number.MAX_VALUE)};t.extendClass(c,{expand:function(t){return t=t||d.KEEP_STATE,t(this,n,t),this},collapse:function(t){return t=t||d.KEEP_STATE,t(this,o,t),this},isExpanded:function(){return this.getData(i)===n}});var u=t.createClass("ExpandNodeCommand",function(){return{base:s,execute:function(t){l(t,"expand")},queryState:function(){return 0}}}()),h=t.createClass("CollapseNodeCommand",function(){return{base:s,execute:function(t){l(t,"collapse")},queryState:function(){return 0}}}());return{events:{beforeimport:function(){}},addShortcutKeys:{ExpandNode:"ctrl+/",CollapseNode:"ctrl+."},commands:{ExpandNode:u,CollapseNode:h}}}),function(t,e){function i(e,i){var o,r,a,s=e.nodeName.toLowerCase();return"area"===s?(o=e.parentNode,r=o.name,e.href&&r&&"map"===o.nodeName.toLowerCase()?(a=t("img[usemap=#"+r+"]")[0],!!a&&n(a)):!1):(/input|select|textarea|button|object/.test(s)?!e.disabled:"a"===s?e.href||i:i)&&n(e)}function n(e){return t.expr.filters.visible(e)&&!t(e).parents().addBack().filter(function(){return"hidden"===t.css(this,"visibility")}).length}var o=0,r=/^ui-id-\d+$/;t.ui=t.ui||{},t.extend(t.ui,{version:"1.10.4",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),t.fn.extend({focus:function(e){return function(i,n){return"number"==typeof i?this.each(function(){var e=this;setTimeout(function(){t(e).focus(),n&&n.call(e)},i)}):e.apply(this,arguments)}}(t.fn.focus),scrollParent:function(){var e;return e=t.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?this.parents().filter(function(){return/(relative|absolute|fixed)/.test(t.css(this,"position"))&&/(auto|scroll)/.test(t.css(this,"overflow")+t.css(this,"overflow-y")+t.css(this,"overflow-x"))}).eq(0):this.parents().filter(function(){return/(auto|scroll)/.test(t.css(this,"overflow")+t.css(this,"overflow-y")+t.css(this,"overflow-x"))}).eq(0),/fixed/.test(this.css("position"))||!e.length?t(document):e},zIndex:function(i){if(i!==e)return this.css("zIndex",i);if(this.length)for(var n,o,r=t(this[0]);r.length&&r[0]!==document;){if(n=r.css("position"),("absolute"===n||"relative"===n||"fixed"===n)&&(o=parseInt(r.css("zIndex"),10),!isNaN(o)&&0!==o))return o;r=r.parent()}return 0},uniqueId:function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++o)})},removeUniqueId:function(){return this.each(function(){r.test(this.id)&&t(this).removeAttr("id")})}}),t.extend(t.expr[":"],{data:t.expr.createPseudo?t.expr.createPseudo(function(e){return function(i){return!!t.data(i,e)}}):function(e,i,n){return!!t.data(e,n[3])},focusable:function(e){return i(e,!isNaN(t.attr(e,"tabindex")))},tabbable:function(e){var n=t.attr(e,"tabindex"),o=isNaN(n);return(o||n>=0)&&i(e,!o)}}),t("<a>").outerWidth(1).jquery||t.each(["Width","Height"],function(i,n){function o(e,i,n,o){return t.each(r,function(){i-=parseFloat(t.css(e,"padding"+this))||0,n&&(i-=parseFloat(t.css(e,"border"+this+"Width"))||0),o&&(i-=parseFloat(t.css(e,"margin"+this))||0)}),i}var r="Width"===n?["Left","Right"]:["Top","Bottom"],a=n.toLowerCase(),s={innerWidth:t.fn.innerWidth,innerHeight:t.fn.innerHeight,outerWidth:t.fn.outerWidth,outerHeight:t.fn.outerHeight};t.fn["inner"+n]=function(i){return i===e?s["inner"+n].call(this):this.each(function(){t(this).css(a,o(this,i)+"px")})},t.fn["outer"+n]=function(e,i){return"number"!=typeof e?s["outer"+n].call(this,e):this.each(function(){t(this).css(a,o(this,e,!0,i)+"px")})}}),t.fn.addBack||(t.fn.addBack=function(t){return this.add(null==t?this.prevObject:this.prevObject.filter(t))}),t("<a>").data("a-b","a").removeData("a-b").data("a-b")&&(t.fn.removeData=function(e){return function(i){return arguments.length?e.call(this,t.camelCase(i)):e.call(this)}}(t.fn.removeData)),t.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),t.support.selectstart="onselectstart"in document.createElement("div"),t.fn.extend({disableSelection:function(){return this.bind((t.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(t){t.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),t.extend(t.ui,{plugin:{add:function(e,i,n){var o,r=t.ui[e].prototype;for(o in n)r.plugins[o]=r.plugins[o]||[],r.plugins[o].push([i,n[o]])},call:function(t,e,i){var n,o=t.plugins[e];if(o&&t.element[0].parentNode&&11!==t.element[0].parentNode.nodeType)for(n=0;o.length>n;n++)t.options[o[n][0]]&&o[n][1].apply(t.element,i)}},hasScroll:function(e,i){if("hidden"===t(e).css("overflow"))return!1;var n=i&&"left"===i?"scrollLeft":"scrollTop",o=!1;return e[n]>0?!0:(e[n]=1,o=e[n]>0,e[n]=0,o)}})}(jQuery),function(t,e){var i=0,n=Array.prototype.slice,o=t.cleanData;t.cleanData=function(e){for(var i,n=0;null!=(i=e[n]);n++)try{t(i).triggerHandler("remove")}catch(r){}o(e)},t.widget=function(i,n,o){var r,a,s,c,l={},d=i.split(".")[0];i=i.split(".")[1],r=d+"-"+i,o||(o=n,n=t.Widget),t.expr[":"][r.toLowerCase()]=function(e){return!!t.data(e,r)},t[d]=t[d]||{},a=t[d][i],s=t[d][i]=function(t,i){return this._createWidget?(arguments.length&&this._createWidget(t,i),e):new s(t,i)},t.extend(s,a,{version:o.version,_proto:t.extend({},o),_childConstructors:[]}),c=new n,c.options=t.widget.extend({},c.options),t.each(o,function(i,o){return t.isFunction(o)?(l[i]=function(){var t=function(){return n.prototype[i].apply(this,arguments)},e=function(t){return n.prototype[i].apply(this,t)};return function(){var i,n=this._super,r=this._superApply;return this._super=t,this._superApply=e,i=o.apply(this,arguments),this._super=n,this._superApply=r,i}}(),e):(l[i]=o,e)}),s.prototype=t.widget.extend(c,{widgetEventPrefix:a?c.widgetEventPrefix||i:i},l,{constructor:s,namespace:d,widgetName:i,widgetFullName:r}),a?(t.each(a._childConstructors,function(e,i){var n=i.prototype;t.widget(n.namespace+"."+n.widgetName,s,i._proto)}),delete a._childConstructors):n._childConstructors.push(s),t.widget.bridge(i,s)},t.widget.extend=function(i){for(var o,r,a=n.call(arguments,1),s=0,c=a.length;c>s;s++)for(o in a[s])r=a[s][o],a[s].hasOwnProperty(o)&&r!==e&&(i[o]=t.isPlainObject(r)?t.isPlainObject(i[o])?t.widget.extend({},i[o],r):t.widget.extend({},r):r);return i},t.widget.bridge=function(i,o){var r=o.prototype.widgetFullName||i;t.fn[i]=function(a){var s="string"==typeof a,c=n.call(arguments,1),l=this;return a=!s&&c.length?t.widget.extend.apply(null,[a].concat(c)):a,s?this.each(function(){var n,o=t.data(this,r);return o?t.isFunction(o[a])&&"_"!==a.charAt(0)?(n=o[a].apply(o,c),n!==o&&n!==e?(l=n&&n.jquery?l.pushStack(n.get()):n,!1):e):t.error("no such method '"+a+"' for "+i+" widget instance"):t.error("cannot call methods on "+i+" prior to initialization; "+"attempted to call method '"+a+"'")
}):this.each(function(){var e=t.data(this,r);e?e.option(a||{})._init():t.data(this,r,new o(a,this))}),l}},t.Widget=function(){},t.Widget._childConstructors=[],t.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(e,n){n=t(n||this.defaultElement||this)[0],this.element=t(n),this.uuid=i++,this.eventNamespace="."+this.widgetName+this.uuid,this.options=t.widget.extend({},this.options,this._getCreateOptions(),e),this.bindings=t(),this.hoverable=t(),this.focusable=t(),n!==this&&(t.data(n,this.widgetFullName,this),this._on(!0,this.element,{remove:function(t){t.target===n&&this.destroy()}}),this.document=t(n.style?n.ownerDocument:n.document||n),this.window=t(this.document[0].defaultView||this.document[0].parentWindow)),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:t.noop,_getCreateEventData:t.noop,_create:t.noop,_init:t.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData(t.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled "+"ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:t.noop,widget:function(){return this.element},option:function(i,n){var o,r,a,s=i;if(0===arguments.length)return t.widget.extend({},this.options);if("string"==typeof i)if(s={},o=i.split("."),i=o.shift(),o.length){for(r=s[i]=t.widget.extend({},this.options[i]),a=0;o.length-1>a;a++)r[o[a]]=r[o[a]]||{},r=r[o[a]];if(i=o.pop(),1===arguments.length)return r[i]===e?null:r[i];r[i]=n}else{if(1===arguments.length)return this.options[i]===e?null:this.options[i];s[i]=n}return this._setOptions(s),this},_setOptions:function(t){var e;for(e in t)this._setOption(e,t[e]);return this},_setOption:function(t,e){return this.options[t]=e,"disabled"===t&&(this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!e).attr("aria-disabled",e),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")),this},enable:function(){return this._setOption("disabled",!1)},disable:function(){return this._setOption("disabled",!0)},_on:function(i,n,o){var r,a=this;"boolean"!=typeof i&&(o=n,n=i,i=!1),o?(n=r=t(n),this.bindings=this.bindings.add(n)):(o=n,n=this.element,r=this.widget()),t.each(o,function(o,s){function c(){return i||a.options.disabled!==!0&&!t(this).hasClass("ui-state-disabled")?("string"==typeof s?a[s]:s).apply(a,arguments):e}"string"!=typeof s&&(c.guid=s.guid=s.guid||c.guid||t.guid++);var l=o.match(/^(\w+)\s*(.*)$/),d=l[1]+a.eventNamespace,u=l[2];u?r.delegate(u,d,c):n.bind(d,c)})},_off:function(t,e){e=(e||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,t.unbind(e).undelegate(e)},_delay:function(t,e){function i(){return("string"==typeof t?n[t]:t).apply(n,arguments)}var n=this;return setTimeout(i,e||0)},_hoverable:function(e){this.hoverable=this.hoverable.add(e),this._on(e,{mouseenter:function(e){t(e.currentTarget).addClass("ui-state-hover")},mouseleave:function(e){t(e.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(e){this.focusable=this.focusable.add(e),this._on(e,{focusin:function(e){t(e.currentTarget).addClass("ui-state-focus")},focusout:function(e){t(e.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(e,i,n){var o,r,a=this.options[e];if(n=n||{},i=t.Event(i),i.type=(e===this.widgetEventPrefix?e:this.widgetEventPrefix+e).toLowerCase(),i.target=this.element[0],r=i.originalEvent)for(o in r)o in i||(i[o]=r[o]);return this.element.trigger(i,n),!(t.isFunction(a)&&a.apply(this.element[0],[i].concat(n))===!1||i.isDefaultPrevented())}},t.each({show:"fadeIn",hide:"fadeOut"},function(e,i){t.Widget.prototype["_"+e]=function(n,o,r){"string"==typeof o&&(o={effect:o});var a,s=o?o===!0||"number"==typeof o?i:o.effect||i:e;o=o||{},"number"==typeof o&&(o={duration:o}),a=!t.isEmptyObject(o),o.complete=r,o.delay&&n.delay(o.delay),a&&t.effects&&t.effects.effect[s]?n[e](o):s!==e&&n[s]?n[s](o.duration,o.easing,r):n.queue(function(i){t(this)[e](),r&&r.call(n[0]),i()})}})}(jQuery),function(t){var e=!1;t(document).mouseup(function(){e=!1}),t.widget("ui.mouse",{version:"1.10.4",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var e=this;this.element.bind("mousedown."+this.widgetName,function(t){return e._mouseDown(t)}).bind("click."+this.widgetName,function(i){return!0===t.data(i.target,e.widgetName+".preventClickEvent")?(t.removeData(i.target,e.widgetName+".preventClickEvent"),i.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&t(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(i){if(!e){this._mouseStarted&&this._mouseUp(i),this._mouseDownEvent=i;var n=this,o=1===i.which,r="string"==typeof this.options.cancel&&i.target.nodeName?t(i.target).closest(this.options.cancel).length:!1;return o&&!r&&this._mouseCapture(i)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){n.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(i)&&this._mouseDelayMet(i)&&(this._mouseStarted=this._mouseStart(i)!==!1,!this._mouseStarted)?(i.preventDefault(),!0):(!0===t.data(i.target,this.widgetName+".preventClickEvent")&&t.removeData(i.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(t){return n._mouseMove(t)},this._mouseUpDelegate=function(t){return n._mouseUp(t)},t(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),i.preventDefault(),e=!0,!0)):!0}},_mouseMove:function(e){return t.ui.ie&&(!document.documentMode||9>document.documentMode)&&!e.button?this._mouseUp(e):this._mouseStarted?(this._mouseDrag(e),e.preventDefault()):(this._mouseDistanceMet(e)&&this._mouseDelayMet(e)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,e)!==!1,this._mouseStarted?this._mouseDrag(e):this._mouseUp(e)),!this._mouseStarted)},_mouseUp:function(e){return t(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,e.target===this._mouseDownEvent.target&&t.data(e.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(e)),!1},_mouseDistanceMet:function(t){return Math.max(Math.abs(this._mouseDownEvent.pageX-t.pageX),Math.abs(this._mouseDownEvent.pageY-t.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}})}(jQuery),function(t){t.widget("ui.draggable",t.ui.mouse,{version:"1.10.4",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"!==this.options.helper||/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative"),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._mouseInit()},_destroy:function(){this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._mouseDestroy()},_mouseCapture:function(e){var i=this.options;return this.helper||i.disabled||t(e.target).closest(".ui-resizable-handle").length>0?!1:(this.handle=this._getHandle(e),this.handle?(t(i.iframeFix===!0?"iframe":i.iframeFix).each(function(){t("<div class='ui-draggable-iframeFix' style='background: #fff;'></div>").css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e3}).css(t(this).offset()).appendTo("body")}),!0):!1)},_mouseStart:function(e){var i=this.options;return this.helper=this._createHelper(e),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),t.ui.ddmanager&&(t.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(),this.offsetParent=this.helper.offsetParent(),this.offsetParentCssPosition=this.offsetParent.css("position"),this.offset=this.positionAbs=this.element.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},this.offset.scroll=!1,t.extend(this.offset,{click:{left:e.pageX-this.offset.left,top:e.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this.position=this._generatePosition(e),this.originalPageX=e.pageX,this.originalPageY=e.pageY,i.cursorAt&&this._adjustOffsetFromHelper(i.cursorAt),this._setContainment(),this._trigger("start",e)===!1?(this._clear(),!1):(this._cacheHelperProportions(),t.ui.ddmanager&&!i.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e),this._mouseDrag(e,!0),t.ui.ddmanager&&t.ui.ddmanager.dragStart(this,e),!0)},_mouseDrag:function(e,i){if("fixed"===this.offsetParentCssPosition&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(e),this.positionAbs=this._convertPositionTo("absolute"),!i){var n=this._uiHash();if(this._trigger("drag",e,n)===!1)return this._mouseUp({}),!1;this.position=n.position}return this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),t.ui.ddmanager&&t.ui.ddmanager.drag(this,e),!1},_mouseStop:function(e){var i=this,n=!1;return t.ui.ddmanager&&!this.options.dropBehaviour&&(n=t.ui.ddmanager.drop(this,e)),this.dropped&&(n=this.dropped,this.dropped=!1),"original"!==this.options.helper||t.contains(this.element[0].ownerDocument,this.element[0])?("invalid"===this.options.revert&&!n||"valid"===this.options.revert&&n||this.options.revert===!0||t.isFunction(this.options.revert)&&this.options.revert.call(this.element,n)?t(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){i._trigger("stop",e)!==!1&&i._clear()}):this._trigger("stop",e)!==!1&&this._clear(),!1):!1},_mouseUp:function(e){return t("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),t.ui.ddmanager&&t.ui.ddmanager.dragStop(this,e),t.ui.mouse.prototype._mouseUp.call(this,e)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(e){return this.options.handle?!!t(e.target).closest(this.element.find(this.options.handle)).length:!0},_createHelper:function(e){var i=this.options,n=t.isFunction(i.helper)?t(i.helper.apply(this.element[0],[e])):"clone"===i.helper?this.element.clone().removeAttr("id"):this.element;return n.parents("body").length||n.appendTo("parent"===i.appendTo?this.element[0].parentNode:i.appendTo),n[0]===this.element[0]||/(fixed|absolute)/.test(n.css("position"))||n.css("position","absolute"),n},_adjustOffsetFromHelper:function(e){"string"==typeof e&&(e=e.split(" ")),t.isArray(e)&&(e={left:+e[0],top:+e[1]||0}),"left"in e&&(this.offset.click.left=e.left+this.margins.left),"right"in e&&(this.offset.click.left=this.helperProportions.width-e.right+this.margins.left),"top"in e&&(this.offset.click.top=e.top+this.margins.top),"bottom"in e&&(this.offset.click.top=this.helperProportions.height-e.bottom+this.margins.top)},_getParentOffset:function(){var e=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==document&&t.contains(this.scrollParent[0],this.offsetParent[0])&&(e.left+=this.scrollParent.scrollLeft(),e.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===document.body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&t.ui.ie)&&(e={top:0,left:0}),{top:e.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:e.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"===this.cssPosition){var t=this.element.position();return{top:t.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:t.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var i,n,o,r=this.options;return r.containment?"window"===r.containment?(this.containment=[t(e).scrollLeft()-this.offset.relative.left-this.offset.parent.left,t(e).scrollTop()-this.offset.relative.top-this.offset.parent.top,t(e).scrollLeft()+t(e).width()-this.helperProportions.width-this.margins.left,t(e).scrollTop()+(t(e).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top],void 0):"document"===r.containment?(this.containment=[0,0,t(document).width()-this.helperProportions.width-this.margins.left,(t(document).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top],void 0):r.containment.constructor===Array?(this.containment=r.containment,void 0):("parent"===r.containment&&(r.containment=this.helper[0].parentNode),n=t(r.containment),o=n[0],o&&(i="hidden"!==n.css("overflow"),this.containment=[(parseInt(n.css("borderLeftWidth"),10)||0)+(parseInt(n.css("paddingLeft"),10)||0),(parseInt(n.css("borderTopWidth"),10)||0)+(parseInt(n.css("paddingTop"),10)||0),(i?Math.max(o.scrollWidth,o.offsetWidth):o.offsetWidth)-(parseInt(n.css("borderRightWidth"),10)||0)-(parseInt(n.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(i?Math.max(o.scrollHeight,o.offsetHeight):o.offsetHeight)-(parseInt(n.css("borderBottomWidth"),10)||0)-(parseInt(n.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relative_container=n),void 0):(this.containment=null,void 0)},_convertPositionTo:function(e,i){i||(i=this.position);var n="absolute"===e?1:-1,o="absolute"!==this.cssPosition||this.scrollParent[0]!==document&&t.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent;return this.offset.scroll||(this.offset.scroll={top:o.scrollTop(),left:o.scrollLeft()}),{top:i.top+this.offset.relative.top*n+this.offset.parent.top*n-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():this.offset.scroll.top)*n,left:i.left+this.offset.relative.left*n+this.offset.parent.left*n-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():this.offset.scroll.left)*n}},_generatePosition:function(e){var i,n,o,r,a=this.options,s="absolute"!==this.cssPosition||this.scrollParent[0]!==document&&t.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,c=e.pageX,l=e.pageY;return this.offset.scroll||(this.offset.scroll={top:s.scrollTop(),left:s.scrollLeft()}),this.originalPosition&&(this.containment&&(this.relative_container?(n=this.relative_container.offset(),i=[this.containment[0]+n.left,this.containment[1]+n.top,this.containment[2]+n.left,this.containment[3]+n.top]):i=this.containment,e.pageX-this.offset.click.left<i[0]&&(c=i[0]+this.offset.click.left),e.pageY-this.offset.click.top<i[1]&&(l=i[1]+this.offset.click.top),e.pageX-this.offset.click.left>i[2]&&(c=i[2]+this.offset.click.left),e.pageY-this.offset.click.top>i[3]&&(l=i[3]+this.offset.click.top)),a.grid&&(o=a.grid[1]?this.originalPageY+Math.round((l-this.originalPageY)/a.grid[1])*a.grid[1]:this.originalPageY,l=i?o-this.offset.click.top>=i[1]||o-this.offset.click.top>i[3]?o:o-this.offset.click.top>=i[1]?o-a.grid[1]:o+a.grid[1]:o,r=a.grid[0]?this.originalPageX+Math.round((c-this.originalPageX)/a.grid[0])*a.grid[0]:this.originalPageX,c=i?r-this.offset.click.left>=i[0]||r-this.offset.click.left>i[2]?r:r-this.offset.click.left>=i[0]?r-a.grid[0]:r+a.grid[0]:r)),{top:l-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():this.offset.scroll.top),left:c-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():this.offset.scroll.left)}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1},_trigger:function(e,i,n){return n=n||this._uiHash(),t.ui.plugin.call(this,e,[i,n]),"drag"===e&&(this.positionAbs=this._convertPositionTo("absolute")),t.Widget.prototype._trigger.call(this,e,i,n)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),t.ui.plugin.add("draggable","connectToSortable",{start:function(e,i){var n=t(this).data("ui-draggable"),o=n.options,r=t.extend({},i,{item:n.element});n.sortables=[],t(o.connectToSortable).each(function(){var i=t.data(this,"ui-sortable");i&&!i.options.disabled&&(n.sortables.push({instance:i,shouldRevert:i.options.revert}),i.refreshPositions(),i._trigger("activate",e,r))})},stop:function(e,i){var n=t(this).data("ui-draggable"),o=t.extend({},i,{item:n.element});t.each(n.sortables,function(){this.instance.isOver?(this.instance.isOver=0,n.cancelHelperRemoval=!0,this.instance.cancelHelperRemoval=!1,this.shouldRevert&&(this.instance.options.revert=this.shouldRevert),this.instance._mouseStop(e),this.instance.options.helper=this.instance.options._helper,"original"===n.options.helper&&this.instance.currentItem.css({top:"auto",left:"auto"})):(this.instance.cancelHelperRemoval=!1,this.instance._trigger("deactivate",e,o))})},drag:function(e,i){var n=t(this).data("ui-draggable"),o=this;t.each(n.sortables,function(){var r=!1,a=this;this.instance.positionAbs=n.positionAbs,this.instance.helperProportions=n.helperProportions,this.instance.offset.click=n.offset.click,this.instance._intersectsWith(this.instance.containerCache)&&(r=!0,t.each(n.sortables,function(){return this.instance.positionAbs=n.positionAbs,this.instance.helperProportions=n.helperProportions,this.instance.offset.click=n.offset.click,this!==a&&this.instance._intersectsWith(this.instance.containerCache)&&t.contains(a.instance.element[0],this.instance.element[0])&&(r=!1),r})),r?(this.instance.isOver||(this.instance.isOver=1,this.instance.currentItem=t(o).clone().removeAttr("id").appendTo(this.instance.element).data("ui-sortable-item",!0),this.instance.options._helper=this.instance.options.helper,this.instance.options.helper=function(){return i.helper[0]},e.target=this.instance.currentItem[0],this.instance._mouseCapture(e,!0),this.instance._mouseStart(e,!0,!0),this.instance.offset.click.top=n.offset.click.top,this.instance.offset.click.left=n.offset.click.left,this.instance.offset.parent.left-=n.offset.parent.left-this.instance.offset.parent.left,this.instance.offset.parent.top-=n.offset.parent.top-this.instance.offset.parent.top,n._trigger("toSortable",e),n.dropped=this.instance.element,n.currentItem=n.element,this.instance.fromOutside=n),this.instance.currentItem&&this.instance._mouseDrag(e)):this.instance.isOver&&(this.instance.isOver=0,this.instance.cancelHelperRemoval=!0,this.instance.options.revert=!1,this.instance._trigger("out",e,this.instance._uiHash(this.instance)),this.instance._mouseStop(e,!0),this.instance.options.helper=this.instance.options._helper,this.instance.currentItem.remove(),this.instance.placeholder&&this.instance.placeholder.remove(),n._trigger("fromSortable",e),n.dropped=!1)})}}),t.ui.plugin.add("draggable","cursor",{start:function(){var e=t("body"),i=t(this).data("ui-draggable").options;e.css("cursor")&&(i._cursor=e.css("cursor")),e.css("cursor",i.cursor)},stop:function(){var e=t(this).data("ui-draggable").options;e._cursor&&t("body").css("cursor",e._cursor)}}),t.ui.plugin.add("draggable","opacity",{start:function(e,i){var n=t(i.helper),o=t(this).data("ui-draggable").options;n.css("opacity")&&(o._opacity=n.css("opacity")),n.css("opacity",o.opacity)},stop:function(e,i){var n=t(this).data("ui-draggable").options;n._opacity&&t(i.helper).css("opacity",n._opacity)}}),t.ui.plugin.add("draggable","scroll",{start:function(){var e=t(this).data("ui-draggable");e.scrollParent[0]!==document&&"HTML"!==e.scrollParent[0].tagName&&(e.overflowOffset=e.scrollParent.offset())},drag:function(i){var n=t(this).data("ui-draggable"),o=n.options,r=!1;n.scrollParent[0]!==document&&"HTML"!==n.scrollParent[0].tagName?(o.axis&&"x"===o.axis||(n.overflowOffset.top+n.scrollParent[0].offsetHeight-i.pageY<o.scrollSensitivity?n.scrollParent[0].scrollTop=r=n.scrollParent[0].scrollTop+o.scrollSpeed:i.pageY-n.overflowOffset.top<o.scrollSensitivity&&(n.scrollParent[0].scrollTop=r=n.scrollParent[0].scrollTop-o.scrollSpeed)),o.axis&&"y"===o.axis||(n.overflowOffset.left+n.scrollParent[0].offsetWidth-i.pageX<o.scrollSensitivity?n.scrollParent[0].scrollLeft=r=n.scrollParent[0].scrollLeft+o.scrollSpeed:i.pageX-n.overflowOffset.left<o.scrollSensitivity&&(n.scrollParent[0].scrollLeft=r=n.scrollParent[0].scrollLeft-o.scrollSpeed))):(o.axis&&"x"===o.axis||(i.pageY-t(document).scrollTop()<o.scrollSensitivity?r=t(document).scrollTop(t(document).scrollTop()-o.scrollSpeed):t(e).height()-(i.pageY-t(document).scrollTop())<o.scrollSensitivity&&(r=t(document).scrollTop(t(document).scrollTop()+o.scrollSpeed))),o.axis&&"y"===o.axis||(i.pageX-t(document).scrollLeft()<o.scrollSensitivity?r=t(document).scrollLeft(t(document).scrollLeft()-o.scrollSpeed):t(e).width()-(i.pageX-t(document).scrollLeft())<o.scrollSensitivity&&(r=t(document).scrollLeft(t(document).scrollLeft()+o.scrollSpeed)))),r!==!1&&t.ui.ddmanager&&!o.dropBehaviour&&t.ui.ddmanager.prepareOffsets(n,i)}}),t.ui.plugin.add("draggable","snap",{start:function(){var e=t(this).data("ui-draggable"),i=e.options;e.snapElements=[],t(i.snap.constructor!==String?i.snap.items||":data(ui-draggable)":i.snap).each(function(){var i=t(this),n=i.offset();this!==e.element[0]&&e.snapElements.push({item:this,width:i.outerWidth(),height:i.outerHeight(),top:n.top,left:n.left})})},drag:function(e,i){var n,o,r,a,s,c,l,d,u,h,f=t(this).data("ui-draggable"),p=f.options,g=p.snapTolerance,m=i.offset.left,v=m+f.helperProportions.width,y=i.offset.top,b=y+f.helperProportions.height;for(u=f.snapElements.length-1;u>=0;u--)s=f.snapElements[u].left,c=s+f.snapElements[u].width,l=f.snapElements[u].top,d=l+f.snapElements[u].height,s-g>v||m>c+g||l-g>b||y>d+g||!t.contains(f.snapElements[u].item.ownerDocument,f.snapElements[u].item)?(f.snapElements[u].snapping&&f.options.snap.release&&f.options.snap.release.call(f.element,e,t.extend(f._uiHash(),{snapItem:f.snapElements[u].item})),f.snapElements[u].snapping=!1):("inner"!==p.snapMode&&(n=g>=Math.abs(l-b),o=g>=Math.abs(d-y),r=g>=Math.abs(s-v),a=g>=Math.abs(c-m),n&&(i.position.top=f._convertPositionTo("relative",{top:l-f.helperProportions.height,left:0}).top-f.margins.top),o&&(i.position.top=f._convertPositionTo("relative",{top:d,left:0}).top-f.margins.top),r&&(i.position.left=f._convertPositionTo("relative",{top:0,left:s-f.helperProportions.width}).left-f.margins.left),a&&(i.position.left=f._convertPositionTo("relative",{top:0,left:c}).left-f.margins.left)),h=n||o||r||a,"outer"!==p.snapMode&&(n=g>=Math.abs(l-y),o=g>=Math.abs(d-b),r=g>=Math.abs(s-m),a=g>=Math.abs(c-v),n&&(i.position.top=f._convertPositionTo("relative",{top:l,left:0}).top-f.margins.top),o&&(i.position.top=f._convertPositionTo("relative",{top:d-f.helperProportions.height,left:0}).top-f.margins.top),r&&(i.position.left=f._convertPositionTo("relative",{top:0,left:s}).left-f.margins.left),a&&(i.position.left=f._convertPositionTo("relative",{top:0,left:c-f.helperProportions.width}).left-f.margins.left)),!f.snapElements[u].snapping&&(n||o||r||a||h)&&f.options.snap.snap&&f.options.snap.snap.call(f.element,e,t.extend(f._uiHash(),{snapItem:f.snapElements[u].item})),f.snapElements[u].snapping=n||o||r||a||h)}}),t.ui.plugin.add("draggable","stack",{start:function(){var e,i=this.data("ui-draggable").options,n=t.makeArray(t(i.stack)).sort(function(e,i){return(parseInt(t(e).css("zIndex"),10)||0)-(parseInt(t(i).css("zIndex"),10)||0)});n.length&&(e=parseInt(t(n[0]).css("zIndex"),10)||0,t(n).each(function(i){t(this).css("zIndex",e+i)}),this.css("zIndex",e+n.length))}}),t.ui.plugin.add("draggable","zIndex",{start:function(e,i){var n=t(i.helper),o=t(this).data("ui-draggable").options;n.css("zIndex")&&(o._zIndex=n.css("zIndex")),n.css("zIndex",o.zIndex)},stop:function(e,i){var n=t(this).data("ui-draggable").options;n._zIndex&&t(i.helper).css("zIndex",n._zIndex)}})}(jQuery),function(t){function i(e,i,n){if(e.prototype=t.extend2(t.extend({},i),(KM.ui[n]||r).prototype,!0),e.prototype.supper=(KM.ui[n]||r).prototype,KM.ui[n]&&KM.ui[n].prototype.defaultOpt){var o=KM.ui[n].prototype.defaultOpt,a=e.prototype.defaultOpt;e.prototype.defaultOpt=t.extend({},o,a||{})}return e}function n(e,i){t[s+i]=e,t.fn[s+i]=function(i){var n,o=Array.prototype.slice.call(arguments,1);return this.each(function(r,a){var s=t(a),c=s.kmui();if(c||(e(i&&t.isPlainObject(i)?i:{},s),s.kmui(c)),"string"==t.type(i))if("this"==i)n=c;else{if(n=c[i].apply(c,o),n!==c&&void 0!==n)return!1;n=null}}),null!==n?n:this}}t.parseTmpl=function(t,e){var i="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(t,e){return"',"+e.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(t,e){return"');"+e.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",n=new Function("obj",i);return e?n(e):n},t.extend2=function(e){for(var i=arguments,n="boolean"==t.type(i[i.length-1])?i[i.length-1]:!1,o="boolean"==t.type(i[i.length-1])?i.length-1:i.length,r=1;o>r;r++){var a=i[r];for(var s in a)n&&e.hasOwnProperty(s)||(e[s]=a[s])}return e},t.IE6=!!e.ActiveXObject&&6==parseFloat(navigator.userAgent.match(/msie (\d+)/i)[1]);var o=[],r=function(){},s="kmui";r.prototype={on:function(e,i){return this.root().on(e,t.proxy(i,this)),this},off:function(e,i){return this.root().off(e,t.proxy(i,this)),this},trigger:function(t,e){return this.root().trigger(t,e)===!1?!1:this},root:function(t){return this._$el||(this._$el=t)},destroy:function(){},data:function(t,e){return void 0!==e?(this.root().data(s+t,e),this):this.root().data(s+t)},register:function(e,i,n){o.push({evtname:e,$els:t.isArray(i)?i:[i],handler:t.proxy(n,i)})}},t.fn.kmui=function(t){return t?this.data("kmuiwidget",t):this.data("kmuiwidget")};var c=1;KM.ui={define:function(e,o,r){var l=KM.ui[e]=i(function(i,n){var o=function(){};t.extend(o.prototype,l.prototype,{guid:e+c++,widgetName:e});var r=new o;if("string"==t.type(i))return r.init&&r.init({}),r.root().kmui(r),r.root().find("a").click(function(t){t.preventDefault()}),r.root()[s+e].apply(r.root(),arguments);n&&r.root(n),r.init&&r.init(a.clonePlainObject(!i||t.isPlainObject(i)?t.extend2(i||{},r.defaultOpt||{},!0):i));try{r.root().find("a").click(function(t){t.preventDefault()})}catch(d){}return r.root().kmui(r)},o,r);n(l,e)}},t(function(){t(document).on("click mouseup mousedown dblclick mouseover",function(e){t.each(o,function(i,n){n.evtname==e.type&&t.each(n.$els,function(i,o){o[0]===e.target||t.contains(o[0],e.target)||n.handler(e)})})})})}(jQuery),KM.ui.define("button",{tpl:'<<%if(!texttype){%>div class="kmui-btn kmui-btn-<%=icon%> <%if(name){%>kmui-btn-name-<%=name%><%}%>" unselectable="on" onmousedown="return false" <%}else{%>a class="kmui-text-btn"<%}%><% if(title) {%> data-original-title="<%=title%>" <%};%>> <% if(icon) {%><div unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><% }; %><%if(text) {%><span unselectable="on" onmousedown="return false" class="kmui-button-label"><%=text%></span><%}%><%if(caret && text){%><span class="kmui-button-spacing"></span><%}%><% if(caret) {%><span unselectable="on" onmousedown="return false" class="kmui-caret"></span><% };%></<%if(!texttype){%>div<%}else{%>a<%}%>>',defaultOpt:{text:"",title:"",icon:"",width:"",caret:!1,texttype:!1,click:function(){}},init:function(t){var e=this;return e.root($($.parseTmpl(e.tpl,t))).click(function(i){e.wrapclick(t.click,i)}),e.root().hover(function(){e.root().hasClass("kmui-disabled")||e.root().toggleClass("kmui-hover")}),e},wrapclick:function(t,e){return this.disabled()||(this.root().trigger("wrapclick"),$.proxy(t,this,e)()),this},label:function(t){return void 0===t?this.root().find(".kmui-button-label").text():(this.root().find(".kmui-button-label").text(t),this)},disabled:function(t){return void 0===t?this.root().hasClass("kmui-disabled"):(this.root().toggleClass("kmui-disabled",t),this.root().hasClass("kmui-disabled")&&this.root().removeClass("kmui-hover"),this)},active:function(t){return void 0===t?this.root().hasClass("kmui-active"):(this.root().toggleClass("kmui-active",t),this)},mergeWith:function(t){var e=this;e.data("$mergeObj",t),t.kmui().data("$mergeObj",e.root()),$.contains(document.body,t[0])||t.appendTo(e.root()),e.on("click",function(){e.wrapclick(function(){t.kmui().show()})}).register("click",e.root(),function(){t.hide()})}}),function(){KM.ui.define("toolbar",{tpl:'<div class="kmui-toolbar"  ><div class="kmui-btn-toolbar" unselectable="on" onmousedown="return false"  ></div></div>',init:function(){var t=this.root($(this.tpl));this.data("$btnToolbar",t.find(".kmui-btn-toolbar"))},appendToBtnmenu:function(t){var e=this.data("$btnToolbar");t=$.isArray(t)?t:[t],$.each(t,function(t,i){e.append(i)})}})}(),KM.ui.define("menu",{show:function(t,e,i,n,o){i=i||"position",this.trigger("beforeshow")!==!1&&(this.root().css($.extend({display:"block"},t?{top:t[i]().top+("right"==e?0:t.outerHeight())-(n||0),left:t[i]().left+("right"==e?t.outerWidth():0)-(o||0)}:{})),this.trigger("aftershow"))},hide:function(t){var e;this.trigger("beforehide")!==!1&&((e=this.root().data("parentmenu"))&&(e.data("parentmenu")||t)&&e.kmui().hide(),this.root().css("display","none"),this.trigger("afterhide"))},attachTo:function(t){var e=this;t.data("$mergeObj")||(t.data("$mergeObj",e.root()),t.kmui()?t.on("wrapclick",function(){e.supper.show.call(e,t,"","offset",15)}):t.on("click",function(){e.supper.show.call(e,t,"","offset",15)}),e.register("click",t,function(){e.hide()}),e.data("$mergeObj",t))}}),KM.ui.define("dropmenu",{tmpl:'<ul class="kmui-dropdown-menu" aria-labelledby="dropdownMenu" ><%if(data && data.length){for(var i=0,ci;ci=data[i++];){%><%if(ci.divider){%><li class="kmui-divider"></li><%}else{%><li <%if(ci.active||ci.disabled){%>class="<%= ci.active|| \'\' %> <%=ci.disabled||\'\' %>" <%}%> data-value="<%= ci.value%>" data-label="<%= ci.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= ci.label%></a></li><%}}%><%}%></ul>',subTmpl:'<%if(data && data.length){for(var i=0,ci;ci=data[i++];){%><%if(ci.divider){%><li class="kmui-divider"></li><%}else{%><li <%if(ci.active||ci.disabled){%>class="<%= ci.active|| \'\' %> <%=ci.disabled||\'\' %>" <%}%> data-value="<%= ci.value%>" data-label="<%= ci.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= ci.label%></a></li><%}}%><%}%>',defaultOpt:{data:[],anchor:"top",click:function(){}},setData:function(t){return this.root().html($.parseTmpl(this.subTmpl,t)),this
},position:function(t){return this.root().css({left:t.x,top:t.y}),this},show:function(){return this.trigger("beforeshow")!==!1?(this.root().css({display:"block"}),this.trigger("aftershow"),this):void 0},init:function(t){var e=this,i={click:1,mouseover:1,mouseout:1};this.root($($.parseTmpl(this.tmpl,t))).on("click",'li[class!="kmui-disabled kmui-divider kmui-dropdown-submenu"]',function(i){$.proxy(t.click,e,i,$(this).data("value"),$(this).data("label"),$(this))()}).find("li").each(function(n,o){var r=$(this);if(!r.hasClass("kmui-disabled kmui-divider kmui-dropdown-submenu")){var a=t.data[n];$.each(i,function(t){a[t]&&r[t](function(i){$.proxy(a[t],o)(i,a,e.root)})})}})},_initEvent:function(){this.root().on("mouseover",'li[class="kmui-dropdown-submenu',function(){var t=$(this).data("widget");t.kmui().show($(this),"right","position",5,2)})},disabled:function(t){$("li[class!=kmui-divider]",this.root()).each(function(){var e=$(this);t===!0?e.addClass("kmui-disabled"):$.isFunction(t)?e.toggleClass("kmui-disabled",t(e)):e.removeClass("kmui-disabled")})},val:function(t){var e;return $('li[class!="kmui-divider kmui-disabled kmui-dropdown-submenu"]',this.root()).each(function(){var i=$(this);if(void 0===t){if(i.find("em.kmui-dropmenu-checked").length)return e=i.data("value"),!1}else i.find("em").toggleClass("kmui-dropmenu-checked",i.data("value")==t)}),void 0===t?e:void 0},appendItem:function(t){var e='<%if(item.divider){%><li class="kmui-divider"></li><%}else{%><li <%if(item.active||item.disabled){%>class="<%= item.active|| \'\' %> <%=item.disabled||\'\' %>" <%}%> data-value="<%= item.value%>" data-label="<%= item.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= item.label%></a></li><%}%>',i=$.parseTmpl(e,t),n=$(i).click(t.click);this.root().append(n)},addSubmenu:function(t,e,i){i=i||0;var n=$("li[class!=kmui-divider]",this.root()),o=$('<li class="kmui-dropdown-submenu"><a tabindex="-1" href="#">'+t+"</a></li>").append(e);o.data("widget",e),i>=0&&i<n.length?o.insertBefore(n[i]):0>i?o.insertBefore(n[0]):i>=n.length&&o.appendTo(n)}},"menu"),KM.ui.define("splitbutton",{tpl:'<div class="kmui-splitbutton <%if (name){%>kmui-splitbutton-<%= name %><%}%>"  unselectable="on" <%if(title){%>data-original-title="<%=title%>"<%}%>><div class="kmui-btn"  unselectable="on" ><%if(icon){%><div  unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><%}%><%if(text){%><%=text%><%}%></div><div  unselectable="on" class="kmui-btn kmui-dropdown-toggle" ><div  unselectable="on" class="kmui-caret"></div></div></div>',defaultOpt:{text:"",title:"",click:function(){}},init:function(t){var e=this;return e.root($($.parseTmpl(e.tpl,t))),e.root().find(".kmui-btn:first").click(function(){e.disabled()||$.proxy(t.click,e)()}),e.root().find(".kmui-dropdown-toggle").click(function(){e.disabled()||e.trigger("arrowclick")}),e.root().hover(function(){e.root().hasClass("kmui-disabled")||e.root().toggleClass("kmui-hover")}),e},wrapclick:function(t,e){return this.disabled()||$.proxy(t,this,e)(),this},disabled:function(t){return void 0===t?this.root().hasClass("kmui-disabled"):(this.root().toggleClass("kmui-disabled",t).find(".kmui-btn").toggleClass("kmui-disabled",t),this)},active:function(t){return void 0===t?this.root().hasClass("kmui-active"):(this.root().toggleClass("kmui-active",t).find(".kmui-btn:first").toggleClass("kmui-active",t),this)},mergeWith:function(t){var e=this;e.data("$mergeObj",t),t.kmui().data("$mergeObj",e.root()),$.contains(document.body,t[0])||t.appendTo(e.root()),e.root().delegate(".kmui-dropdown-toggle","click",function(){e.wrapclick(function(){t.kmui().show()})}),e.register("click",e.root().find(".kmui-dropdown-toggle"),function(){t.hide()})}}),KM.ui.define("colorsplitbutton",{tpl:'<div class="kmui-splitbutton <%if (name){%>kmui-splitbutton-<%= name %><%}%>"  unselectable="on" <%if(title){%>data-original-title="<%=title%>"<%}%>><div class="kmui-btn"  unselectable="on" ><%if(icon){%><div  unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><%}%><div class="kmui-splitbutton-color-label" <%if (color) {%>style="background: <%=color%>"<%}%>></div><%if(text){%><%=text%><%}%></div><div  unselectable="on" class="kmui-btn kmui-dropdown-toggle" ><div  unselectable="on" class="kmui-caret"></div></div></div>',defaultOpt:{color:""},init:function(t){var e=this;e.supper.init.call(e,t)},colorLabel:function(){return this.root().find(".kmui-splitbutton-color-label")}},"splitbutton"),KM.ui.define("popup",{tpl:'<div class="kmui-dropdown-menu kmui-popup"<%if(!<%=stopprop%>){%>onmousedown="return false"<%}%>><div class="kmui-popup-body" unselectable="on" onmousedown="return false"><%=subtpl%></div><div class="kmui-popup-caret"></div></div>',defaultOpt:{stopprop:!1,subtpl:"",width:"",height:""},init:function(t){return this.root($($.parseTmpl(this.tpl,t))),this},mergeTpl:function(t){return $.parseTmpl(this.tpl,{subtpl:t})},show:function(t,e){e||(e={});var i=e.fnname||"position";this.trigger("beforeshow")!==!1&&(this.root().css($.extend({display:"block"},t?{top:t[i]().top+("right"==e.dir?0:t.outerHeight())-(e.offsetTop||0),left:t[i]().left+("right"==e.dir?t.outerWidth():0)-(e.offsetLeft||0),position:"absolute"}:{})),this.root().find(".kmui-popup-caret").css({top:e.caretTop||0,left:e.caretLeft||0,position:"absolute"}).addClass(e.caretDir||"up"),this.trigger("aftershow"))},hide:function(){this.root().css("display","none"),this.trigger("afterhide")},attachTo:function(t,e){var i=this;t.data("$mergeObj")||(t.data("$mergeObj",i.root()),t.on("wrapclick",function(){i.show(t,e)}),i.register("click",t,function(){i.hide()}),i.data("$mergeObj",t))},getBodyContainer:function(){return this.root().find(".kmui-popup-body")}}),KM.ui.define("scale",{tpl:'<div class="kmui-scale" unselectable="on"><span class="kmui-scale-hand0"></span><span class="kmui-scale-hand1"></span><span class="kmui-scale-hand2"></span><span class="kmui-scale-hand3"></span><span class="kmui-scale-hand4"></span><span class="kmui-scale-hand5"></span><span class="kmui-scale-hand6"></span><span class="kmui-scale-hand7"></span></div>',defaultOpt:{$doc:$(document),$wrap:$(document)},init:function(t){return t.$doc&&(this.defaultOpt.$doc=t.$doc),t.$wrap&&(this.defaultOpt.$wrap=t.$wrap),this.root($($.parseTmpl(this.tpl,t))),this.initStyle(),this.startPos=this.prePos={x:0,y:0},this.dragId=-1,this},initStyle:function(){a.cssRule("kmui-style-scale",".kmui-scale{display:none;position:absolute;border:1px solid #38B2CE;cursor:hand;}.kmui-scale span{position:absolute;left:0;top:0;width:7px;height:7px;overflow:hidden;font-size:0px;display:block;background-color:#3C9DD0;}.kmui-scale .kmui-scale-hand0{cursor:nw-resize;top:0;margin-top:-4px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand1{cursor:n-resize;top:0;margin-top:-4px;left:50%;margin-left:-4px;}.kmui-scale .kmui-scale-hand2{cursor:ne-resize;top:0;margin-top:-4px;left:100%;margin-left:-3px;}.kmui-scale .kmui-scale-hand3{cursor:w-resize;top:50%;margin-top:-4px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand4{cursor:e-resize;top:50%;margin-top:-4px;left:100%;margin-left:-3px;}.kmui-scale .kmui-scale-hand5{cursor:sw-resize;top:100%;margin-top:-3px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand6{cursor:s-resize;top:100%;margin-top:-3px;left:50%;margin-left:-4px;}.kmui-scale .kmui-scale-hand7{cursor:se-resize;top:100%;margin-top:-3px;left:100%;margin-left:-3px;}")},_eventHandler:function(t){var e=this,i=e.defaultOpt.$doc;switch(t.type){case"mousedown":var n,n=t.target||t.srcElement;-1!=n.className.indexOf("kmui-scale-hand")&&(e.dragId=n.className.slice(-1),e.startPos.x=e.prePos.x=t.clientX,e.startPos.y=e.prePos.y=t.clientY,i.bind("mousemove",$.proxy(e._eventHandler,e)));break;case"mousemove":-1!=e.dragId&&(e.updateContainerStyle(e.dragId,{x:t.clientX-e.prePos.x,y:t.clientY-e.prePos.y}),e.prePos.x=t.clientX,e.prePos.y=t.clientY,e.updateTargetElement());break;case"mouseup":if(-1!=e.dragId){e.dragId=-1,e.updateTargetElement();var o=e.data("$scaleTarget");o.parent()&&e.attachTo(e.data("$scaleTarget"))}i.unbind("mousemove",$.proxy(e._eventHandler,e))}},updateTargetElement:function(){var t=this,e=t.root(),i=t.data("$scaleTarget");i.css({width:e.width(),height:e.height()}),t.attachTo(i)},updateContainerStyle:function(t,e){var i,n=this,o=n.root(),r=[[0,0,-1,-1],[0,0,0,-1],[0,0,1,-1],[0,0,-1,0],[0,0,1,0],[0,0,-1,1],[0,0,0,1],[0,0,1,1]];0!=r[t][0]&&(i=parseInt(o.offset().left)+e.x,o.css("left",n._validScaledProp("left",i))),0!=r[t][1]&&(i=parseInt(o.offset().top)+e.y,o.css("top",n._validScaledProp("top",i))),0!=r[t][2]&&(i=o.width()+r[t][2]*e.x,o.css("width",n._validScaledProp("width",i))),0!=r[t][3]&&(i=o.height()+r[t][3]*e.y,o.css("height",n._validScaledProp("height",i)))},_validScaledProp:function(t,e){var i=this.root(),n=this.defaultOpt.$doc,o=function(t,i,n){return t+i>n?n-i:e};switch(e=isNaN(e)?0:e,t){case"left":return 0>e?0:o(e,i.width(),n.width());case"top":return 0>e?0:o(e,i.height(),n.height());case"width":return 0>=e?1:o(e,i.offset().left,n.width());case"height":return 0>=e?1:o(e,i.offset().top,n.height())}},show:function(t){var e=this;t&&e.attachTo(t),e.root().bind("mousedown",$.proxy(e._eventHandler,e)),e.defaultOpt.$doc.bind("mouseup",$.proxy(e._eventHandler,e)),e.root().show(),e.trigger("aftershow")},hide:function(){var t=this;t.root().unbind("mousedown",$.proxy(t._eventHandler,t)),t.defaultOpt.$doc.unbind("mouseup",$.proxy(t._eventHandler,t)),t.root().hide(),t.trigger("afterhide")},attachTo:function(t){var e=this,i=t.offset(),n=e.root(),o=e.defaultOpt.$wrap,r=o.offset();e.data("$scaleTarget",t),e.root().css({position:"absolute",width:t.width(),height:t.height(),left:i.left-r.left-parseInt(o.css("border-left-width"))-parseInt(n.css("border-left-width")),top:i.top-r.top-parseInt(o.css("border-top-width"))-parseInt(n.css("border-top-width"))})},getScaleTarget:function(){return this.data("$scaleTarget")[0]}}),KM.ui.define("colorpicker",{tpl:function(t){for(var e="ffffff,000000,eeece1,1f497d,4f81bd,c0504d,9bbb59,8064a2,4bacc6,f79646,f2f2f2,7f7f7f,ddd9c3,c6d9f0,dbe5f1,f2dcdb,ebf1dd,e5e0ec,dbeef3,fdeada,d8d8d8,595959,c4bd97,8db3e2,b8cce4,e5b9b7,d7e3bc,ccc1d9,b7dde8,fbd5b5,bfbfbf,3f3f3f,938953,548dd4,95b3d7,d99694,c3d69b,b2a2c7,92cddc,fac08f,a5a5a5,262626,494429,17365d,366092,953734,76923c,5f497a,31859b,e36c09,7f7f7f,0c0c0c,1d1b10,0f243e,244061,632423,4f6128,3f3151,205867,974806,c00000,ff0000,ffc000,ffff00,92d050,00b050,00b0f0,0070c0,002060,7030a0,".split(","),i='<div unselectable="on" onmousedown="return false" class="kmui-colorpicker<%if (name){%> kmui-colorpicker-<%=name%><%}%>" ><table unselectable="on" onmousedown="return false"><tr><td colspan="10">'+t.lang_themeColor+"</td> </tr>"+'<tr class="kmui-colorpicker-firstrow" >',n=0;n<e.length;n++)n&&0===n%10&&(i+="</tr>"+(60==n?'<tr><td colspan="10">'+t.lang_standardColor+"</td></tr>":"")+"<tr"+(60==n?' class="kmui-colorpicker-firstrow"':"")+">"),i+=70>n?'<td><a unselectable="on" onmousedown="return false" title="'+e[n]+'" class="kmui-colorpicker-colorcell"'+' data-color="#'+e[n]+'"'+' style="background-color:#'+e[n]+";border:solid #ccc;"+(10>n||n>=60?"border-width:1px;":n>=10&&20>n?"border-width:1px 1px 0 1px;":"border-width:0 1px 0 1px;")+'"'+"></a></td>":"";return i+="</tr></table></div>"},init:function(t){var e=this;e.root($($.parseTmpl(e.supper.mergeTpl(e.tpl(t)),t))),e.root().on("click",function(t){e.trigger("pickcolor",$(t.target).data("color"))})}},"popup"),function(){var t="combobox",e="kmui-combobox-item",i="kmui-combobox-item-hover",n="kmui-combobox-checked-icon",o="kmui-combobox-item-label";KM.ui.define(t,function(){return{tpl:'<ul class="dropdown-menu kmui-combobox-menu<%if (comboboxName!==\'\') {%> kmui-combobox-<%=comboboxName%><%}%>" unselectable="on" onmousedown="return false" role="menu" aria-labelledby="dropdownMenu"><%if(autoRecord) {%><%for( var i=0, len = recordStack.length; i<len; i++ ) {%><%var index = recordStack[i];%><li class="<%=itemClassName%><%if( selected == index ) {%> kmui-combobox-checked<%}%><%if( disabled[ index ] === true ) {%> kmui-combobox-item-disabled<%}%>" data-item-index="<%=index%>" unselectable="on" onmousedown="return false"><span class="kmui-combobox-icon" unselectable="on" onmousedown="return false"></span><label class="<%=labelClassName%>" style="<%=itemStyles[ index ]%>" unselectable="on" onmousedown="return false"><%=items[index]%></label></li><%}%><%if( i ) {%><li class="kmui-combobox-item-separator"></li><%}%><%}%><%for( var i=0, label; label = items[i]; i++ ) {%><li class="<%=itemClassName%><%if( selected == i && enabledSelected ) {%> kmui-combobox-checked<%}%> kmui-combobox-item-<%=i%><%if( disabled[ i ] === true ) {%> kmui-combobox-item-disabled<%}%>" data-item-index="<%=i%>" unselectable="on" onmousedown="return false"><span class="kmui-combobox-icon" unselectable="on" onmousedown="return false"></span><label class="<%=labelClassName%>" style="<%=itemStyles[ i ]%>" unselectable="on" onmousedown="return false"><%=label%></label></li><%}%></ul>',defaultOpt:{recordStack:[],items:[],value:[],comboboxName:"",selected:"",disabled:{},autoRecord:!0,recordCount:5,enabledRecord:!0,enabledSelected:!0},init:function(t){var i=this;$.extend(i._optionAdaptation(t),i._createItemMapping(t.recordStack,t.items),{itemClassName:e,iconClass:n,labelClassName:o}),this._transStack(t),i.root($($.parseTmpl(i.tpl,t))),this.data("options",t).initEvent()},initEvent:function(){var t=this;t.initSelectItem(),this.initItemActive()},setLabelWithDefaultValue:function(){var t=this.data("button");t.kmui().label(t.data("original-title"))},initSelectItem:function(){var t=this,i=t.data("options"),n="."+o;t.root().delegate("."+e,"click",function(){var e=$(this),o=e.attr("data-item-index");return i.disabled[o]?!1:(t.trigger("comboboxselect",{index:o,label:e.find(n).text(),value:t.data("options").value[o]}).select(o),t.hide(),t.trigger("aftercomboboxselect"),!1)})},initItemActive:function(){var t={mouseenter:"addClass",mouseleave:"removeClass"};$.IE6&&this.root().delegate("."+e,"mouseenter mouseleave",function(e){$(this)[t[e.type]](i)}).one("afterhide",function(){})},select:function(t){var e=this.data("options"),i=e.itemCount,n=e.autowidthitem;return n&&!n.length&&(n=e.items),e.disabled[t]?null:0==i?null:(0>t?t=i+t%i:t>=i&&(t=i-1),this.trigger("changebefore",n[t]),this._update(t),this.trigger("changeafter",n[t]),null)},selectItemByLabel:function(t){var e=this.data("options").itemMapping,i=this,n=null;!$.isArray(t)&&(t=[t]),$.each(t,function(t,o){return n=e[o],void 0!==n?(i.select(n),!1):void 0})},getItems:function(){return this.data("options").items},traverseItems:function(t){var e=this.data("options").value,i=this.data("options").items;return $.each(i,function(i,n){t(n,e[i])}),this},getItemMapping:function(){return this.data("options").itemMapping},disableItemByIndex:function(t){var e=this.data("options");e.disabled[t]=!0,this._repaint()},disableItemByLabel:function(t){var e=this.data("options").itemMapping,i=e[t];return"number"==typeof i?this.disableItemByIndex(i):!1},enableItemByIndex:function(t){var e=this.data("options");delete e.disabled[t],this._repaint()},enableItemByLabel:function(t){var e=this.data("options").itemMapping,i=e[t];return"number"==typeof i?this.enableItemByIndex(i):!1},_transStack:function(t){var e=[],i=-1,n=-1;$.each(t.recordStack,function(o,r){i=t.itemMapping[r],$.isNumeric(i)&&(e.push(i),r==t.selected&&(n=i))}),t.recordStack=e,t.selected=n,e=null},_optionAdaptation:function(t){if(!("itemStyles"in t)){t.itemStyles=[];for(var e=0,i=t.items.length;i>e;e++)t.itemStyles.push("")}return t.autowidthitem=t.autowidthitem||t.items,t.itemCount=t.items.length,t},_createItemMapping:function(t,e){var i={},n={recordStack:[],mapping:{}};return $.each(e,function(t,e){i[e]=t}),n.itemMapping=i,$.each(t,function(t,e){void 0!==i[e]&&(n.recordStack.push(i[e]),n.mapping[e]=i[e])}),n},_update:function(t){var e=this.data("options"),i=[];this.data("options").enabledRecord&&($.each(e.recordStack,function(e,n){n!=t&&i.push(n)}),i.unshift(t),i.length>e.recordCount&&(i.length=e.recordCount),e.recordStack=i),e.selected=t,this._repaint(),i=null},_repaint:function(){var t=$($.parseTmpl(this.tpl,this.data("options")));this.root().html(t.html()),t=null}}}(),"menu")}(),function(){var t="buttoncombobox";KM.ui.define(t,function(){return{defaultOpt:{label:"",title:""},init:function(t){var e=this,i=$.kmuibutton({caret:!0,name:t.comboboxName,title:t.title,text:t.label,click:function(){e.show(this.root())}});e.supper.init.call(e,t),e.on("changebefore",function(t,e){i.kmuibutton("label",e)}),e.data("button",i),e.attachTo(i)},button:function(){return this.data("button")}}}(),"combobox")}(),KM.ui.define("modal",{tpl:'<div class="kmui-modal" tabindex="-1" ><div class="kmui-modal-header"><div class="kmui-close" data-hide="modal"></div><h3 class="kmui-title"><%=title%></h3></div><div class="kmui-modal-body"  style="<%if(width){%>width:<%=width%>px;<%}%><%if(height){%>height:<%=height%>px;<%}%>"> </div><% if(cancellabel || oklabel) {%><div class="kmui-modal-footer"><div class="kmui-modal-tip"></div><%if(oklabel){%><div class="kmui-btn kmui-btn-primary" data-ok="modal"><%=oklabel%></div><%}%><%if(cancellabel){%><div class="kmui-btn" data-hide="modal"><%=cancellabel%></div><%}%></div><%}%></div>',defaultOpt:{title:"",cancellabel:"",oklabel:"",width:"",height:"",backdrop:!0,keyboard:!0},init:function(t){var e=this;e.root($($.parseTmpl(e.tpl,t||{}))),e.data("options",t),t.okFn&&e.on("ok",$.proxy(t.okFn,e)),t.cancelFn&&e.on("beforehide",$.proxy(t.cancelFn,e)),e.root().delegate('[data-hide="modal"]',"click",$.proxy(e.hide,e)).delegate('[data-ok="modal"]',"click",$.proxy(e.ok,e)),$('[data-hide="modal"],[data-ok="modal"]',e.root()).hover(function(){$(this).toggleClass("kmui-hover")}),setTimeout(function(){$(".kmui-modal").draggable({handle:".kmui-modal-header"})},100)},toggle:function(){var t=this;return t[t.data("isShown")?"hide":"show"]()},show:function(){var t=this;t.trigger("beforeshow"),t.data("isShown")||(t.data("isShown",!0),t.escape(),t.backdrop(function(){t.autoCenter(),t.root().show().focus().trigger("aftershow")}),$(".kmui-modal").draggable({handle:".kmui-modal-header"}))},showTip:function(t){$(".kmui-modal-tip",this.root()).html(t).fadeIn()},hideTip:function(){$(".kmui-modal-tip",this.root()).fadeOut(function(){$(this).html("")})},autoCenter:function(){!$.IE6&&this.root().css("margin-left",-(this.root().width()/2))},hide:function(){var t=this;t.trigger("beforehide"),t.data("isShown")&&(t.data("isShown",!1),t.escape(),t.hideModal())},escape:function(){var t=this;t.data("isShown")&&t.data("options").keyboard?t.root().on("keyup",function(e){27==e.which&&t.hide()}):t.data("isShown")||t.root().off("keyup")},hideModal:function(){var t=this;t.root().hide(),t.backdrop(function(){t.removeBackdrop(),t.trigger("afterhide")})},removeBackdrop:function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},backdrop:function(t){var e=this;e.data("isShown")&&e.data("options").backdrop&&(e.$backdrop=$('<div class="kmui-modal-backdrop" />').click("static"==e.data("options").backdrop?$.proxy(e.root()[0].focus,e.root()[0]):$.proxy(e.hide,e))),e.trigger("afterbackdrop"),t&&t()},attachTo:function(t){var e=this;t.data("$mergeObj")||(t.data("$mergeObj",e.root()),t.on("wrapclick",function(){e.toggle(t)}),e.data("$mergeObj",t))},ok:function(){var t=this;t.trigger("beforeok"),t.trigger("ok",t)!==!1&&t.hide()},getBodyContainer:function(){return this.root().find(".kmui-modal-body")}}),KM.ui.define("tooltip",{tpl:'<div class="kmui-tooltip" unselectable="on" onmousedown="return false"><div class="kmui-tooltip-arrow" unselectable="on" onmousedown="return false"></div><div class="kmui-tooltip-inner" unselectable="on" onmousedown="return false"></div></div>',init:function(t){var e=this;e.root($($.parseTmpl(e.tpl,t||{})))},content:function(t){var e=this,i=$(t.currentTarget).attr("data-original-title");e.root().find(".kmui-tooltip-inner").text(i)},position:function(t){var e=this,i=$(t.currentTarget);e.root().css($.extend({display:"block"},i?{top:i.outerHeight(),left:(i.outerWidth()-e.root().outerWidth())/2}:{}))},show:function(t){if(!$(t.currentTarget).hasClass("kmui-disabled")){var e=this;e.content(t),e.root().appendTo($(t.currentTarget)),e.position(t),e.root().css("display","block")}},hide:function(){var t=this;t.root().css("display","none")},attachTo:function(t){function e(t){var e=this;$.contains(document.body,e.root()[0])||e.root().appendTo(t),e.data("tooltip",e.root()),t.each(function(){$(this).attr("data-original-title")&&$(this).on("mouseenter",$.proxy(e.show,e)).on("mouseleave click",$.proxy(e.hide,e))})}var i=this;"undefined"===$.type(t)?$("[data-original-title]").each(function(t,n){e.call(i,$(n))}):t.data("tooltip")||e.call(i,t)}}),KM.ui.define("tab",{init:function(t){var e=this,i=t.selector;$.type(i)&&(e.root($(i,t.context)),e.data("context",t.context),$(i,e.data("context")).on("click",function(t){e.show(t)}))},show:function(t){var e,i,n,t,o=this,r=$(t.target),a=r.closest("ul");e=r.attr("data-context"),e=e&&e.replace(/.*(?=#[^\s]*$)/,"");var s=r.parent("li");s.length&&!s.hasClass("kmui-active")&&(i=a.find(".kmui-active:last a")[0],t=$.Event("beforeshow",{target:r[0],relatedTarget:i}),o.trigger(t),t.isDefaultPrevented()||(n=$(e,o.data("context")),o.activate(r.parent("li"),a),o.activate(n,n.parent(),function(){o.trigger({type:"aftershow",relatedTarget:i})})))},activate:function(t,e,i){if(void 0===t)return $(".kmui-tab-item.kmui-active",this.root()).index();var n=e.find("> .kmui-active");n.removeClass("kmui-active"),t.addClass("kmui-active"),i&&i()}}),KM.ui.define("separator",{tpl:'<div class="kmui-separator" unselectable="on" onmousedown="return false" ></div>',init:function(t){var e=this;return e.root($($.parseTmpl(e.tpl,t))),e}}),$.wordCountAdaptive=function(t,e){var i=$("<span>").html(t).css({display:"inline",position:"absolute",top:-1e7,left:-1e5}).appendTo(document.body),n=i.width();return i.remove(),i=null,50>n?t:(t=t.slice(0,e?-4:-1),t.length?$.wordCountAdaptive(t+"...",!0):"...")},a.extend(r,function(){var t={},e={},i=null,n={},o={};return{registerUI:function(e,i){a.each(e.split(/\s+/),function(e,n){t[n]=i})},registerToolbarUI:function(t,i){a.each(t.split(/\s+/),function(t,n){e[n]=i})},loadUI:function(e){a.each(t,function(t,i){i.call(e)})},_createUI:function(t){var e=$('<div class="kmui-container"></div>'),i=$.kmuitoolbar(),n=$('<div class="kmui-editor-body"></div>'),o=$('<div class="kmui-statusbar"></div>');return e.append(i).append(n).append(o),$(a.isString(t)?"#"+t:t).append(e),{$container:e,$toolbar:i,$body:n,$statusbar:o}},_createToolbar:function(t,i){var n=i.getOptions("toolbars");if(n&&n.length){var o=[];$.each(n,function(n,r){$.each(r.split(/\s+/),function(t,n){if("|"==n)$.kmuiseparator&&o.push($.kmuiseparator());else if(e[n]){var r=e[n].call(i,n);r&&o.push(r)}}),o.length&&t.kmui().appendToBtnmenu(o)}),t.append($('<div class="kmui-dialog-container"></div>'))}else t.hide()},_createStatusbar:function(){},getKityMinder:function(t,e){var i=this._createUI(t),n=this.getMinder(i.$body.get(0),e);return this._createToolbar(i.$toolbar,n),this._createStatusbar(i.$statusbar,n),n.$container=i.$container,this.loadUI(n),n.fire("interactchange")},registerWidget:function(t,e,i){n[t]=$.extend2(e,{$root:"",_preventDefault:!1,root:function(t){return this.$root||(this.$root=t)},preventDefault:function(){this._preventDefault=!0},clear:!1}),i&&(o[t]=i)},getWidgetData:function(t){return n[t]},setWidgetBody:function(t,e,i){i._widgetData||a.extend(i,{_widgetData:{},getWidgetData:function(t){return this._widgetData[t]},getWidgetCallback:function(t){var i=this;return function(){return o[t].apply(i,[i,e].concat(a.argsToArray(arguments,0)))}}});var r=n[t];return r?(r=i._widgetData[t],r||(r=n[t],r=i._widgetData[t]="function"==$.type(r)?r:a.clone(r)),r.root(e.kmui().getBodyContainer()),i.fire("selectionclear"),r.initContent(i,e),e.on("keydown keyup keypress",function(t){t.stopPropagation()}),r._preventDefault||r.initEvent(i,e),r.width&&e.width(r.width),void 0):null},setActiveWidget:function(t){i=t}}}()),KM.registerToolbarUI("bold italic redo undo unhyperlink expandnode collapsenode hand zoom-in zoom-out",function(t){var e=this,i=$.kmuibutton({icon:t,click:function(){e.execCommand(t)},title:this.getLang("tooltips")[t]||""});return this.on("interactchange",function(){var e=this.queryCommandState(t);i.kmui().disabled(-1==e).active(1==e)}),i}),KM.registerToolbarUI("fontfamily fontsize",function(t){function e(t){for(var e=null,i=[],n=0,o=t.items.length;o>n;n++)e=t.items[n].val,i.push(e.split(/\s*,\s*/)[0]),t.itemStyles.push("font-family: "+e),t.value.push(e),t.autowidthitem.push($.wordCountAdaptive(i[n]));return t.items=i,t}function i(t){var e=null,i=[];t.itemStyles=[],t.value=[];for(var n=0,o=t.items.length;o>n;n++)e=t.items[n],i.push(e),t.itemStyles.push("font-size: "+e+"px; height:"+(e+2)+"px; line-height: "+(e+2)+"px");return t.value=t.items,t.items=i,t.autoRecord=!1,t}var n=this,o=n.getLang("tooltips."+t),r={label:o,title:o,comboboxName:t,items:n.getOptions(t)||[],itemStyles:[],value:[],autowidthitem:[]},a=null,s=null;if(0==r.items.length)return null;switch(t){case"fontfamily":r=e(r);break;case"fontsize":r=i(r)}return a=$.kmuibuttoncombobox(r).css("zIndex",n.getOptions("zIndex")+1),s=a.kmui(),s.on("comboboxselect",function(e,i){n.execCommand(t,i.value)}).on("beforeshow",function(){0===a.parent().length&&a.appendTo(n.$container.find(".kmui-dialog-container"))}),this.on("interactchange",function(){var e=this.queryCommandState(t),i=this.queryCommandValue(t);s.button().kmui().disabled(-1==e).active(1==e),i&&(i=i.replace(/['"]/g,"").toLowerCase().split(/['|"]?\s*,\s*[\1]?/),s.selectItemByLabel(i))}),s.button().addClass("kmui-combobox")}),KM.registerToolbarUI("forecolor",function(i){function n(){return a.css("background-color")}var o=this,r=null,a=null,s=null;return this.on("interactchange",function(){var t=this.queryCommandState(i);s.kmui().disabled(-1==t).active(1==t)}),s=$.kmuicolorsplitbutton({icon:i,caret:!0,name:i,title:this.getLang("tooltips")[i]||"",click:function(){var e=t.Color.parse(n()).toHEX();"#000000"!=e&&o.execCommand(i,e)}}),a=s.kmui().colorLabel(),r=$.kmuicolorpicker({name:i,lang_clearColor:o.getLang("popupcolor").clearColor||"",lang_themeColor:o.getLang("popupcolor").themeColor||"",lang_standardColor:o.getLang("popupcolor").standardColor||""}).on("pickcolor",function(t,n){e.setTimeout(function(){a.css("backgroundColor",n),o.execCommand(i,n)},0)}).on("show",function(){KM.setActiveWidget(r.kmui().root())}).css("zIndex",o.getOptions("zIndex")+1),s.kmui().on("arrowclick",function(){r.parent().length||o.$container.find(".kmui-dialog-container").append(r),r.kmui().show(s,{caretDir:"down",offsetTop:-5,offsetLeft:8,caretLeft:11,caretTop:-8})}).register("click",s,function(){r.kmui().hide()}),s}),KM.registerToolbarUI("saveto",function(t){function e(t,e){var i=document.createElement("a");i.setAttribute("download",e),i.setAttribute("href",t);var n;try{n=new MouseEvent("click")}catch(o){n=document.createEvent("MouseEvents"),n.initEvent("click",!0,!0)}i.dispatchEvent(n)}var i=this,n=i.getLang("tooltips."+t),o={label:n,title:n,comboboxName:t,items:[],itemStyles:[],value:[],autowidthitem:[],enabledRecord:!1,enabledSelected:!1},s=null,c=null;a.each(r.getAllRegisteredProtocals(),function(t){var e=r.findProtocal(t);if(e.encode){var i=e.fileDescription+"（"+e.fileExtension+"）";o.value.push(t),o.items.push(i),o.autowidthitem.push($.wordCountAdaptive(i),!0)}}),s=$.kmuibuttoncombobox(o).css("zIndex",i.getOptions("zIndex")+1),c=s.kmui();var l=function(){var t=0,e=/MSIE (\d+\.\d+);/.test(navigator.userAgent),i=!!navigator.userAgent.match(/Trident\/7.0/),n=navigator.userAgent.indexOf("rv:11.0");return e&&(t=new Number(RegExp.$1)),-1!=navigator.appVersion.indexOf("MSIE 10")&&(t=10),i&&-1!=n&&(t=11),t},d=function(t,e,i){var n=document.createElement("iframe");n.style.display="none",document.body.appendChild(n),n.contentDocument.open(t,"replace"),n.contentDocument.writeln(e),n.contentDocument.execCommand("saveas","",i)};return c.on("comboboxselect",function(t,n){var o=i.exportData(n.value),a=r.findProtocal(n.value),s=i.getMinderTitle()+a.fileExtension;if("string"==typeof o){var c="data:text/plain; utf-8,"+encodeURIComponent(o);l()>0?".km"===a.fileExtension?d("application/x-javascript",o,i.getMinderTitle()):".svg"===a.fileExtension||d("text/html",o,s):e(c,s)}else o&&o.then&&o.then(function(t){l()>0||e(t,s)})}).on("beforeshow",function(){0===s.parent().length&&s.appendTo(i.$container.find(".kmui-dialog-container"))}).on("aftercomboboxselect",function(){this.setLabelWithDefaultValue()}),c.button().addClass("kmui-combobox")}),KM.registerUI("tooltips",function(){var t=this;$.kmuitooltip&&($("[data-original-title]",t.$container).each(function(e,i){var n=t.getLang("tooltips"),o=$(i).data("original-title");a.each(n,function(e,n){n==o&&t.getShortcutKey(e)&&$(i).attr("data-original-title",o+" ("+t.getShortcutKey(e).toUpperCase()+")")})}),$.kmuitooltip("attachTo",$("[data-original-title]",t.$container)).css("z-index",t.getOptions("zIndex")+1)),t.$container.find("a").click(function(t){t.preventDefault()})}),KM.registerToolbarUI("switchlayout",function(t){var e=this,i=e.getLang("tooltips."+t),n={label:i,title:i,comboboxName:t,items:e.getLayoutStyleItems()||[],itemStyles:[],value:e.getLayoutStyleItems(),autowidthitem:[],enabledRecord:!1},o=null;if(0==n.items.length)return null;a.each(n.items,function(t,i){n.items[t]=e.getLang("layout")[i]}),o=$.kmuibuttoncombobox(n).css("zIndex",e.getOptions("zIndex")+1);var r=o.kmui();r.on("comboboxselect",function(i,n){e.execCommand(t,n.value)}).on("beforeshow",function(){0===o.parent().length&&o.appendTo(e.$container.find(".kmui-dialog-container"))}),e.on("interactchange",function(){var e=this.queryCommandState(t),i=this.queryCommandValue(t);r.button().kmui().disabled(-1==e).active(1==e),i&&(i=i.replace(/['"]/g,"").toLowerCase().split(/['|"]?\s*,\s*[\1]?/),r.selectItemByLabel(i))});var s=[];return a.each(e.getLayoutStyleItems(),function(i,n){s.push({label:e.getLang("tooltips."+t)+" "+n,cmdName:"switchlayout",exec:function(){e.execCommand("switchlayout",n)}})}),s.push({divider:1}),e.addContextmenu(s),r.button().addClass("kmui-combobox")}),KM.registerToolbarUI("node",function(t){function e(t){var e=[];return a.each(t.items,function(n,r){t.value.push(r),e.push((o[n]||n)+"("+i[r].toUpperCase()+")"),t.autowidthitem.push($.wordCountAdaptive(e[e.length-1]))}),t.items=e,t}var i={appendsiblingnode:"enter",appendchildnode:"tab",removenode:"del|backspace",editnode:"F2"},n=this,o=n.getLang("node"),r=n.getLang("tooltips."+t),s={label:r,title:r,comboboxName:t,items:n.getOptions(t)||[],itemStyles:[],value:[],autowidthitem:[],enabledRecord:!1,enabledSelected:!1},l=null;if(0==s.items.length)return null;l=$.kmuibuttoncombobox(e(s)).css("zIndex",n.getOptions("zIndex")+1);var d=l.kmui();return d.on("comboboxselect",function(t,e){n.execCommand(e.value,new c(n.getLang().topic),!0)}).on("beforeshow",function(){0===l.parent().length&&l.appendTo(n.$container.find(".kmui-dialog-container"));var t=l.kmui();t.traverseItems(function(e,i){-1==n.queryCommandState(i)?t.disableItemByLabel(e):t.enableItemByLabel(e)})}),n.on("interactchange",function(){var t=0;a.each(i,function(e){return t=n.queryCommandState(e),-1!=t?!1:void 0}),d.button().kmui().disabled(-1==t).active(1==t)}),d.button().addClass("kmui-combobox")}),KM.registerUI("contextmenu",function(){function t(t){var i;return a.each(e.getContextmenu(),function(e,n){return n.label==t?(i=n,!1):void 0}),i}var e=this,i=$.kmuidropmenu({click:function(i,n,o){var r=t(o);r.exec?r.exec.apply(km):e.execCommand(r.cmdName),this.hide()}});e.$container.append(i),e.on("contextmenu",function(t){var n=t.getTargetNode();n&&(this.removeAllSelectedNodes(),this.select(n));var o=e.getContextmenu(),r=[];if(a.each(o,function(t,i){return i.divider?(r.length&&r.push(i),void 0):(-1!=e.queryCommandState(i.cmdName)&&r.push({label:i.label,value:i.cmdName}),void 0)
}),r.length){var s=r[r.length-1];s.divider&&r.pop(),i.kmui().setData({data:r}).position(t.getPosition()).show()}t.preventDefault()}),e.on("click",function(){i.kmui().hide()}),e.on("beforemousedown",function(t){t.isRightMB()&&t.stopPropagationImmediately()})}),KM.registerToolbarUI("markers help preference",function(t){var e,i=this,n={title:this.getLang("tooltips")[t]||"",url:i.getOptions("KITYMINDER_HOME_URL")+"dialogs/"+t+"/"+t+".js"},o=$.kmuibutton({icon:t,title:this.getLang("tooltips")[t]||""});return a.loadFile(document,{src:n.url,tag:"script",type:"text/javascript",defer:"defer"},function(){e=$.kmuimodal(n),e.attr("id","kmui-dialog-"+t).addClass("kmui-dialog-"+t).find(".kmui-modal-body").addClass("kmui-dialog-"+t+"-body"),e.kmui().on("beforeshow",function(){var n=this.root();n.parent()[0]||i.$container.find(".kmui-dialog-container").append(n),KM.setWidgetBody(t,e,i)}).attachTo(o)}),i.on("interactchange",function(){var e=this.queryCommandState(t);o.kmui().disabled(-1==e).active(1==e)}),o}),KM.registerToolbarUI("hyperlink",function(t){var e,i=this,n={title:this.getLang("tooltips")[t]||"",url:i.getOptions("KITYMINDER_HOME_URL")+"dialogs/"+t+"/"+t+".js"},o=$.kmuibutton({icon:t,title:this.getLang("tooltips")[t]||""});return a.loadFile(document,{src:n.url,tag:"script",type:"text/javascript",defer:"defer"},function(){e=$.kmuimodal(n),e.attr("id","kmui-dialog-"+t).addClass("kmui-dialog-"+t).find(".kmui-modal-body").addClass("kmui-dialog-"+t+"-body"),e.kmui().on("beforeshow",function(){var n=this.root();n.parent()[0]||i.$container.find(".kmui-dialog-container").append(n),KM.setWidgetBody(t,e,i)}).attachTo(o)}),i.addContextmenu([{label:i.getLang("hyperlink.hyperlink"),exec:function(){e.kmui().show()},cmdName:"hyperlink"},{label:i.getLang("hyperlink.unhyperlink"),exec:function(){this.execCommand("unhyperlink")},cmdName:"unhyperlink"}]),i.on("interactchange",function(){var e=this.queryCommandState(t);o.kmui().disabled(-1==e).active(1==e)}),o}),KM.registerToolbarUI("zoom",function(t){function e(t){var e=[];return a.each(t.items,function(i,n){t.value.push(n),e.push(n+"%"),t.autowidthitem.push($.wordCountAdaptive(e[e.length-1]))}),t.items=e,t}var i=this,n=i.getLang("tooltips."+t),o={label:n,title:n,comboboxName:t,items:i.getOptions(t)||[],itemStyles:[],value:i.getOptions(t),autowidthitem:[],enabledRecord:!1},r=null;if(0==o.items.length)return null;r=$.kmuibuttoncombobox(e(o)).css("zIndex",i.getOptions("zIndex")+1);var s=r.kmui();return s.on("comboboxselect",function(t,e){i.execCommand("zoom",e.value)}).on("beforeshow",function(){0===r.parent().length&&r.appendTo(i.$container.find(".kmui-dialog-container"))}),i.on("interactchange",function(){var e=this.queryCommandState(t),i=this.queryCommandValue(t);s.button().kmui().disabled(-1==e).active(1==e),i&&s.selectItemByLabel(i+"%")}),s.button().addClass("kmui-combobox")}),r.registerProtocal("xmind",function(){function t(e,i){if(i.data={text:e.title},e.marker_refs&&e.marker_refs.marker_ref){var o=e.marker_refs.marker_ref;if(o.length&&o.length>0)for(var r in o){var a=n[o[r].marker_id];a&&(i.data[a[0]]=a[1])}else{var a=n[o.marker_id];a&&(i.data[a[0]]=a[1])}}if(e["xlink:href"]&&(i.data.hyperlink=e["xlink:href"]),e.children&&e.children.topics&&e.children.topics.topic){var s=e.children.topics.topic;if(s.length&&s.length>0){i.children=[];for(var r in s)i.children.push({}),t(s[r],i.children[r])}else i.children=[{}],t(s,i.children[0])}}function e(e){var i=$.xml2json(e),n={},o=i.sheet,r=a.isArray(o)?o[0].topic:o.topic;return t(r,n),n}function i(t,e){zip.createReader(new zip.BlobReader(t),function(t){t.getEntries(e)},onerror)}var n={"priority-1":["PriorityIcon",1],"priority-2":["PriorityIcon",2],"priority-3":["PriorityIcon",3],"priority-4":["PriorityIcon",4],"priority-5":["PriorityIcon",5],"task-start":["ProgressIcon",1],"task-quarter":["ProgressIcon",2],"task-half":["ProgressIcon",3],"task-3quar":["ProgressIcon",4],"task-done":["ProgressIcon",5],"task-oct":null,"task-3oct":null,"task-5oct":null,"task-7oct":null};return{fileDescription:"xmind格式文件",fileExtension:".xmind",decode:function(){return{then:function(t,n){i(t,function(t){t.forEach(function(t){"content.xml"==t.filename&&t.getData(new zip.TextWriter,function(t){var i=e($.parseXML(t));n&&n(i)})})})}}},recognizePriority:-1}}),r.registerProtocal("freemind",function(){function t(e,n){if(n.data={text:e.TEXT},e.icon){var o=e.icon;if(o.length&&o.length>0)for(var r in o){var a=i[o[r].BUILTIN];a&&(n.data[a[0]]=a[1])}else{var a=i[o.BUILTIN];a&&(n.data[a[0]]=a[1])}}if(e.LINK&&(n.data.hyperlink=e.LINK),e.node){var s=e.node;if(s.length&&s.length>0){n.children=[];for(var r in s)n.children.push({}),t(s[r],n.children[r])}else n.children=[{}],t(s,n.children[0])}}function e(e){var i=$.xml2json(e),n={};return t(i.node,n),n}var i={"full-1":["PriorityIcon",1],"full-2":["PriorityIcon",2],"full-3":["PriorityIcon",3],"full-4":["PriorityIcon",4],"full-5":["PriorityIcon",5],"full-6":null,"full-7":null,"full-8":null,"full-9":null,"full-0":null};return{fileDescription:"xmind格式文件",fileExtension:".xmind",decode:function(t){var i=e(t);return i},recognizePriority:-1}}),r.registerProtocal("mindmanager",function(){function t(e,i){if(i.data={text:e.Text&&e.Text.PlainText||""},e.Task){var o;e.Task.TaskPriority&&(o=n[e.Task.TaskPriority],o&&(i.data[o[0]]=o[1])),e.Task.TaskPercentage&&(o=n[e.Task.TaskPercentage],o&&(i.data[o[0]]=o[1]))}if(e.Hyperlink&&(i.data.hyperlink=e.Hyperlink.Url),e.SubTopics&&e.SubTopics.Topic){var r=e.SubTopics.Topic;if(r.length&&r.length>0){i.children=[];for(var a in r)i.children.push({}),t(r[a],i.children[a])}else i.children=[{}],t(r,i.children[0])}}function e(e){var i=$.xml2json(e),n={};return t(i.OneTopic.Topic,n),n}function i(t,e){zip.createReader(new zip.BlobReader(t),function(t){t.getEntries(e)},onerror)}var n={"urn:mindjet:Prio1":["PriorityIcon",1],"urn:mindjet:Prio2":["PriorityIcon",2],"urn:mindjet:Prio3":["PriorityIcon",3],"urn:mindjet:Prio4":["PriorityIcon",4],"urn:mindjet:Prio5":["PriorityIcon",5],0:["ProgressIcon",1],25:["ProgressIcon",2],50:["ProgressIcon",3],75:["ProgressIcon",4],100:["ProgressIcon",5]};return{fileDescription:"mindmanager格式文件",fileExtension:".mmap",decode:function(){return{then:function(t,n){i(t,function(t){t.forEach(function(t){"Document.xml"==t.filename&&t.getData(new zip.TextWriter,function(t){var i=e($.parseXML(t));n&&n(i)})})})}}},recognizePriority:-1}}),r.registerProtocal("plain",function(){function t(t,e){for(var i="";e--;)i+=t;return i}function e(i,n){var o="";return n=n||0,o+=t(d,n),o+=i.data.text+l,i.children&&i.children.forEach(function(t){o+=e(t,n+1)}),o}function i(t){return!/\S/.test(t)}function n(t){for(var e=0;t.charAt(e)===d;)e++;return e}function o(t){return{data:{text:t.replace(new RegExp("^"+d+"*"),"")}}}function r(t){function e(t,e){var i=t.children||(t.children=[]);i.push(e)}for(var r,a,s,c,d={},u=t.split(l),h=0;h<u.length;h++)if(a=u[h],!i(a)){if(s=n(a),c=o(a),0===s){if(r)throw new Error("Invalid local format");r=c}else{if(!d[s-1])throw new Error("Invalid local format");e(d[s-1],c)}d[s]=c}return r}function a(t){if(!Utils.isString(t))return!1;s=t;try{c=r(t)}catch(e){c=null}return!!c}var s,c,l="\n",d="	";return{fileDescription:"大纲文本",fileExtension:".txt",encode:function(t){return e(t,0)},decode:function(t){return s==t&&c?c:r(t)},recognize:a,recognizePriority:-1}}),r.registerProtocal("json",function(){function t(t,e){return"layout"==t||"shicon"==t?void 0:e}return{fileDescription:"KityMinder",fileExtension:".km",encode:function(e){return JSON.stringify(e,t)},decode:function(t){return JSON.parse(t)},recognize:function(t){return Utils.isString(t)&&"{"==t.charAt(0)&&"}"==t.charAt(t.length-1)},recognizePriority:0}}),r.registerProtocal("png",function(){function t(t,e){var i=new Image;i.onload=e,console.log(t),i.src=t}return{fileDescription:"PNG 图片（暂不支持IE）",fileExtension:".png",encode:function(i,n){function o(t,e,i,n){t.save(),t.fillStyle=t.createPattern(e,"repeat"),t.fillRect(0,0,i,n),t.restore()}function r(t,e,i,n){t.drawImage(e,i,n)}function a(t){var e=t.toDataURL("png");return e.replace("image/png","image/octet-stream")}var s,c,l,d,u,h,f=n.getPaper().container,p=getComputedStyle(f).backgroundImage,g=/url\((.+)\)$/.exec(p)[1],m=n.getRenderContainer(),v=m.getRenderBox(),y=(m.getTransform(),v.width),b=v.height,x=20,k=document.createElement("canvas"),w=k.getContext("2d");return g=g.replace(/"/g,""),m.translate(-v.x,-v.y),s=n.getPaper().container.innerHTML,m.translate(v.x,v.y),c=$(s),c.attr({width:v.width,height:v.height,style:'font-family: Arial, "Microsoft Yahei","Heiti SC";'}),s=$("<div></div>").append(c).html(),s=s.replace(/&nbsp;/g,"&#xa0;"),l=new Blob([s],{type:"image/svg+xml;charset=utf-8"}),d=e.URL||e.webkitURL||e,u=d.createObjectURL(l),k.width=y+2*x,k.height=b+2*x,t(u,function(){var e=this;t(g,function(){var t;o(w,this,k.width,k.height),r(w,e,x,x),d.revokeObjectURL(u),t=a(k),h&&h(t)})}),{then:function(t){h=t}}},recognizePriority:-1}}),r.registerProtocal("svg",function(){return{fileDescription:"SVG 矢量图（暂不支持IE）",fileExtension:".svg",encode:function(t,e){return e.getPaper().container.innerHTML.replace(/&nbsp;/g,"&#xa0;")},recognizePriority:-1}})}(kity,window),function(){function t(t,n){return i(t||self.document.URL||self.location.href,n||e())}function e(){var t=document.getElementsByTagName("script");return t[t.length-1].src}function i(t,e){var i=e;return/^(\/|\\\\)/.test(e)?i=/^.+?\w(\/|\\\\)/.exec(t)[0]+e.replace(/^(\/|\\\\)/,""):/^[a-z]+:/i.test(e)||(t=t.split("#")[0].split("?")[0].replace(/[^\\\/]+$/,""),i=t+""+e),n(i)}function n(t){var e=/^[a-z]+:\/\//.exec(t)[0],i=null,n=[];for(t=t.replace(e,"").split("?")[0].split("#")[0],t=t.replace(/\\/g,"/").split(/\//),t[t.length-1]="";t.length;)".."===(i=t.shift())?n.pop():"."!==i&&n.push(i);return e+n.join("/")}window.KITYMINDER_CONFIG={KITYMINDER_HOME_URL:t(),toolbars:["hand | zoom-in zoom zoom-out | collapsenode expandnode | undo redo | bold italic | fontfamily fontsize forecolor | saveto | hyperlink unhyperlink | markers | node | help"]}}(),KityMinder.LANG["zh-cn"]={maintopic:"中心主题",topic:"分支主题",tooltips:{undo:"撤销",redo:"重做",bold:"加粗",italic:"斜体",forecolor:"字体颜色",fontfamily:"字体",fontsize:"字号",layoutstyle:"主题",node:"节点操作",saveto:"另存为",hand:"允许拖拽",zoom:"放大缩小",markers:"添加标签",switchlayout:"切换主题",help:"帮助",preference:"偏好设置",hyperlink:"插入链接",unhyperlink:"删除链接",expandnode:"展开节点",collapsenode:"收起节点"},popupcolor:{clearColor:"清空颜色",standardColor:"标准颜色",themeColor:"主题颜色"},dialogs:{markers:{"static":{lang_input_text:"文本内容：",lang_input_url:"链接地址：",lang_input_title:"标题：",lang_input_target:"是否在新窗口打开："},priority:"优先级",progress:{notdone:"未完成",quarterdone:"完成1/4",halfdone:"完成1/2",threequartersdone:"完成3/4",done:"已完成"}},help:{},hyperlink:{}},node:{appendsiblingnode:"插入同级节点",appendchildnode:"插入子节点",removenode:"删除节点",editnode:"编辑节点"},layout:{"default":"左右展开",bottom:"向下展开"},hyperlink:{hyperlink:"插入超链接",unhyperlink:"取消超链接"}};