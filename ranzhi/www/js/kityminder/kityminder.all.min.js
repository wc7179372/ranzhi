!function(t,e){function n(t){var e={};e.data=t.getData();var i=t.getChildren();if(i.length){e.children=[];for(var o=0;o<i.length;o++)e.children.push(n(i[o]))}return e}function i(t,e,n){var o=e.data;for(var r in o)t.setData(r,o[r]);t.setData("text",o.text||n.getLang(u[t.getType()]));var a=e.children;if(a){for(var s=0;s<a.length;s++){var l=new c;t.appendChild(l),i(l,a[s],n)}return t}}function o(t){return t.getRenderContainer().getRenderBox("top")}var r=e.KM=e.KityMinder=function(){var t={},e=0;return{version:"1.1.3.1",createMinder:function(t,e){e=e||{},e.renderTo=Utils.isString(t)?document.getElementById(t):t;var n=new h(e);return this.addMinder(e.renderTo,n),n},addMinder:function(n,i){var o;o="string"==typeof n?n:n.id||"KM_INSTANCE_"+e++,t[o]=i},getMinder:function(n,i){var o;return o="string"==typeof n?n:n.id||"KM_INSTANCE_"+e++,t[o]||this.createMinder(n,i)},LANG:{}}}(),a=Utils=r.Utils={extend:t.Utils.extend.bind(t.Utils),listen:function(t,n,i){var o=a.isArray(n)?n:a.trim(n).split(/\s+/),r=o.length;if(r)for(;r--;)if(n=o[r],t.addEventListener)t.addEventListener(n,i,!1);else{i._d||(i._d={els:[]});var s=n+i.toString(),c=a.indexOf(i._d.els,t);i._d[s]&&-1!=c||(-1==c&&i._d.els.push(t),i._d[s]||(i._d[s]=function(t){return i.call(t.srcElement,t||e.event)}),t.attachEvent("on"+n,i._d[s]))}t=null},trim:function(t){return t.replace(/(^[ \t\n\r]+)|([ \t\n\r]+$)/g,"")},each:function(t,e,n){if(null!=t)if(t.length===+t.length){for(var i=0,o=t.length;o>i;i++)if(e.call(n,i,t[i],t)===!1)return!1}else for(var r in t)if(t.hasOwnProperty(r)&&e.call(n,r,t[r],t)===!1)return!1},addCssRule:function(t,e,n){var i;return void 0===e||e&&e.nodeType&&9==e.nodeType?(n=e&&e.nodeType&&9==e.nodeType?e:n||document,i=n.getElementById(t),i?i.innerHTML:void 0):(n=n||document,i=n.getElementById(t),""===e?i?(i.parentNode.removeChild(i),!0):!1:void(i?i.innerHTML=e:(i=n.createElement("style"),i.id=t,i.innerHTML=e,n.getElementsByTagName("head")[0].appendChild(i))))},keys:function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return e},proxy:function(t,e){return function(){return t.apply(e,arguments)}},indexOf:function(t,e,n){var i=-1;return n=this.isNumber(n)?n:0,this.each(t,function(t,o){return o>=n&&t===e?(i=o,!1):void 0}),i},argsToArray:function(t,e){return Array.prototype.slice.call(t,e||0)},clonePlainObject:function(t,e){var n;e=e||{};for(var i in t)t.hasOwnProperty(i)&&(n=t[i],a.isObject(n)||a.isArray(n)?(e[i]=a.isArray(n)?[]:{},a.clonePlainObject(t[i],e[i])):e[i]=n);return e},compareObject:function(t,e){var n;if(this.isEmptyObject(t)!==this.isEmptyObject(e))return!1;if(this.getObjectLength(t)!=this.getObjectLength(e))return!1;for(var i in t)if(t.hasOwnProperty(i)){if(n=t[i],void 0===e[i])return!1;if(this.isObject(n)||this.isArray(n)){if(this.isObject(e[i])!==this.isObject(n))return!1;if(this.isArray(n)!==this.isArray(e[i]))return!1;if(this.compareObject(n,e[i])===!1)return!1}else if(n!=e[i])return!1}return!0},getObjectLength:function(t){if(this.isArray(t)||this.isString(t))return t.length;var e=0;for(var n in t)t.hasOwnProperty(n)&&e++;return e},isEmptyObject:function(t){if(null==t)return!0;if(this.isArray(t)||this.isString(t))return 0===t.length;for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},getNodeCommonAncestor:function(t,e){if(t===e)return t.parent;if(t.contains(e))return this;if(e.contains(t))return e;for(var n=t.parent;!n.contains(e);)n=n.parent;return n},loadFile:function(){function t(t,n){try{for(var i,o=0;i=e[o++];)if(i.doc===t&&i.url==(n.src||n.href))return i}catch(r){return null}}var e=[];return function(n,i,o){var r=t(n,i);if(r)return void(r.ready?o&&o():r.funs.push(o));if(e.push({doc:n,url:i.src||i.href,funs:[o]}),!n.body){var a=[];for(var s in i)"tag"!=s&&a.push(s+'="'+i[s]+'"');return void n.write("<"+i.tag+" "+a.join(" ")+" ></"+i.tag+">")}if(!i.id||!n.getElementById(i.id)){var c=n.createElement(i.tag);delete i.tag;for(var s in i)c.setAttribute(s,i[s]);c.onload=c.onreadystatechange=function(){if(!this.readyState||/loaded|complete/.test(this.readyState)){if(r=t(n,i),r.funs.length>0){r.ready=1;for(var e;e=r.funs.pop();)e()}c.onload=c.onreadystatechange=null}},n.getElementsByTagName("head")[0].appendChild(c)}}}(),clone:function(t,e){var n;e=e||{};for(var i in t)t.hasOwnProperty(i)&&(n=t[i],"object"==typeof n?(e[i]=a.isArray(n)?[]:{},a.clone(t[i],e[i])):e[i]=n);return e},unhtml:function(t,e){return t?t.replace(e||/[&<">'](?:(amp|lt|quot|gt|#39|nbsp);)?/g,function(t,e){return e?t:{"<":"&lt;","&":"&amp;",'"':"&quot;",">":"&gt;","'":"&#39;"}[t]}):""}};Utils.each(["String","Function","Array","Number","RegExp","Object"],function(t,e){r.Utils["is"+e]=function(t){return Object.prototype.toString.apply(t)=="[object "+e+"]"}});var s=t.createClass("Command",{constructor:function(){this._isContentChange=!0,this._isSelectionChange=!1},execute:function(){},setContentChanged:function(t){this._isContentChange=!!t},isContentChanged:function(){return this._isContentChange},setSelectionChanged:function(t){this._isSelectionChange=!!t},isSelectionChanged:function(){return this._isContentChange},queryState:function(){return 0},queryValue:function(){return 0},isNeedUndo:function(){return!0}}),c=r.MinderNode=t.createClass("MinderNode",{constructor:function(t){this.parent=null,this.children=[],this.data={},this.tmpData={},Utils.isString(t)?this.setData("text",t):this.setData(t),this._createShapeDom(),this.setData("layout",{})},_createShapeDom:function(){this.rc=new t.Group,this.rc.addClass("km-minderNode"),this.rc.minderNode=this,this._createBgGroup(),this._createContGroup()},_createGroup:function(e){var n=new t.Group;n.setData("rctype",e),this.rc.appendShape(n)},_createBgGroup:function(){this._createGroup("bgrc")},_createContGroup:function(){this._createGroup("contrc")},getContRc:function(){var t,e=this.rc.getShapesByType("group");return Utils.each(e,function(e,n){return"contrc"==n.getData("rctype")?(t=n,!1):void 0}),t},getBgRc:function(){var t,e=this.rc.getShapesByType("group");return Utils.each(e,function(e,n){return"bgrc"==n.getData("rctype")?(t=n,!1):void 0}),t},setPoint:function(t,e){arguments.length<2?this.setData("point",t):this.setData("point",{x:t,y:e})},getPoint:function(){return this.getData("point")},setType:function(t){this.setData("type",t)},getLevel:function(){for(var t=0,e=this.parent;e;)t++,e=e.parent;return t},getType:function(){var t=this.getData("type");if(t)return t;var e=Math.min(this.getLevel(),2);return t=["root","main","sub"][e],this.setData("type",t),t},setText:function(t){this.setData("text",t),this.getTextShape().setContent(t)},getText:function(){return this.getData("text")},isRoot:function(){return null===this.getParent()?!0:!1},getParent:function(){return this.parent},getDepth:function(){for(var t=0,e=this.parent;e;)e=e.parent,t++;return t},getRoot:function(){for(var t=this;t.parent;)t=t.parent;return t},isAncestorOf:function(t){for(var e=t.parent;e;){if(e==this)return!0;e=e.parent}return!1},preTraverse:function(t){var e=this.getChildren();t(this);for(var n=0;n<e.length;n++)e[n].preTraverse(t)},postTraverse:function(t){for(var e=this.getChildren(),n=0;n<e.length;n++)e[n].postTraverse(t);t(this)},traverse:function(t){return this.postTraverse(t)},getChildren:function(){return this.children},getIndex:function(){return this.parent?this.parent.children.indexOf(this):-1},insertChild:function(t,e){void 0===e&&(e=this.children.length),t.parent&&t.parent.removeChild(t),t.parent=this,t.root=t.parent.root,this.children.splice(e,0,t)},appendChild:function(t){return this.insertChild(t)},prependChild:function(t){return this.insertChild(t,0)},removeChild:function(t){var e,n=t;t instanceof c&&(n=this.children.indexOf(t)),n>=0&&(e=this.children.splice(n,1)[0],e.parent=null)},getChild:function(t){return this.children[t]},getFirstChild:function(){return this.children[0]},getLastChild:function(){return this.children[this.children.length-1]},getData:function(t){return void 0===t?this.data:this.data[t]},setData:function(t,e){void 0===t?this.data={}:a.isObject(t)?Utils.extend(this.data,t):void 0===e?(this.data[t]=null,delete this.data[t]):this.data[t]=e},getRenderContainer:function(){return this.rc},getCommonAncestor:function(t){return Utils.getNodeCommonAncestor(this,t)},contains:function(t){if(this===t)return!0;if(this===t.parent)return!0;var e=!1;return Utils.each(this.getChildren(),function(n,i){return e=i.contains(t),e===!0?!1:void 0}),e},clone:function(){function t(e,n){var i=new KM.MinderNode(n.getText());i.data=Utils.clonePlainObject(n.getData()),i.tmpData=Utils.clonePlainObject(n.getTmpData()),i.parent=e,e&&e.children.push(i);for(var o,r=0;o=n.children[r++];)t(i,o);return i}return function(){return t(null,this)}}(),equals:function(t){if(t.children.length!=this.children.length)return!1;if(a.compareObject(t.getData(),this.getData())===!1)return!1;if(a.compareObject(t.getTmpData(),this.getTmpData())===!1)return!1;for(var e,n=0;e=this.children[n];n++)if(e.equals(t.children[n])===!1)return!1;return!0},getTextShape:function(){var t;return a.each(this.getContRc().getShapesByType("text"),function(e,n){return n.getAttr("_nodeTextShape")?(t=n,!1):void 0}),t},isSelected:function(){return this.getTmpData("highlight")===!0},clearChildren:function(){this.children=[]},isHighlight:function(){return this.getTmpData("highlight")},select:function(){this.setTmpData("highlight",!0)},setTmpData:function(t,e){var n=this;a.isObject(t)&&a.each(t,function(t,e){n.setTmpData(e,t)}),void 0===e||null===e||""===e?delete this.tmpData[t]:this.tmpData[t]=e},getTmpData:function(t){return void 0===t?this.tmpData:this.tmpData[t]}});!function(){var t;r.registerModule=function(e,n){t||(t={}),t[e]=n},r.getModules=function(){return t}}();var l=t.createClass("MindEvent",{constructor:function(e,n,i){n=n||{},n.getType&&"ShapeEvent"==n.getType()?(this.kityEvent=n,this.originEvent=n.originEvent,this.getPosition=n.getPosition.bind(n)):n.target&&n.preventDefault?this.originEvent=n:t.Utils.extend(this,n),this.type=e,this._canstop=i||!1},getTargetNode:function(){var t=this.kityEvent&&this.kityEvent.targetShape;if(!t)return null;for(;!t.minderNode&&t.container;)t=t.container;return t.minderNode||null},stopPropagation:function(){this._stoped=!0},stopPropagationImmediately:function(){this._immediatelyStoped=!0,this._stoped=!0},shouldStopPropagation:function(){return this._canstop&&this._stoped},shouldStopPropagationImmediately:function(){return this._canstop&&this._immediatelyStoped},preventDefault:function(){this.originEvent.preventDefault()},isRightMB:function(){var t=!1;return this.originEvent?("which"in this.originEvent?t=3==this.originEvent.which:"button"in this.originEvent&&(t=2==this.originEvent.button),t):!1}}),h=r.Minder=t.createClass("KityMinder",{constructor:function(t){this._options=Utils.extend(e.KITYMINDER_CONFIG||{},t),this.setDefaultOptions(KM.defaultOptions),this._initEvents(),this._initMinder(),this._initSelection(),this._initStatus(),this._initShortcutKey(),this._initContextmenu(),this._initModules(),this.getOptions("readOnly")===!0&&this.setDisabled(),this.fire("ready")},getOptions:function(t){var e;return t?(e=this.getPreferences(t),null===e||void 0===e?this._options[t]:e):(e=this.getPreferences(),e?a.extend(e,this._options,!0):this._options)},setDefaultOptions:function(t,e,n){var i={};Utils.isString(t)?i[t]=e:i=t,a.extend(this._options,i,!n)},setOptions:function(t,e){this.setPreferences(t,e)},_initMinder:function(){this._paper=new t.Paper,this._paper.getNode().setAttribute("contenteditable",!0),this._paper.getNode().ondragstart=function(t){t.preventDefault()},this._addRenderContainer(),this._root=new c(this.getLang().maintopic),this._root.setType("root"),this._options.renderTo&&this.renderTo(this._options.renderTo)},_addRenderContainer:function(){this._rc=new t.Group,this._paper.addShape(this._rc)},renderTo:function(t){this._paper.renderTo(this._renderTarget=t),this._bindEvents()},getRenderContainer:function(){return this._rc},getPaper:function(){return this._paper},getRenderTarget:function(){return this._renderTarget},_initShortcutKey:function(){this._shortcutkeys={},this._bindshortcutKeys()},isTextEditStatus:function(){return!1},addShortcutKeys:function(t,e){var n={},i=this;e?n[t]=e:n=t,a.each(n,function(t,e){i._shortcutkeys[t.toLowerCase()]=e})},getShortcutKey:function(t){return this._shortcutkeys[t]},_bindshortcutKeys:function(){function t(t,e,n){switch(t){case"ctrl":case"cmd":if(n.ctrlKey||n.metaKey)return!0;break;case"alt":if(n.altKey)return!0;break;case"shift":if(n.shiftKey)return!0}return e==d[t]?!0:!1}var e=this,n=this._shortcutkeys;e.on("keydown",function(i){var o=i.originEvent,r=o.keyCode||o.which;for(var s in n){var c=n[s].toLowerCase().split("+"),l=0;if(a.each(c,function(e,n){t(n,r,o)&&l++}),l==c.length){-1!=e.queryCommandState(s)&&e.execCommand(s),o.preventDefault();break}}})},_initContextmenu:function(){this.contextmenus=[]},addContextmenu:function(t){return a.isArray(t)?this.contextmenus=this.contextmenus.concat(t):this.contextmenus.push(t),this},getContextmenu:function(){return this.contextmenus},_initStatus:function(){this._status="normal",this._rollbackStatus="normal"},setStatus:function(t){return t?(this._rollbackStatus=this._status,this._status=t):this._status="",this},rollbackStatus:function(){this._status=this._rollbackStatus},getStatus:function(){return this._status},setDisabled:function(){var t=this;t.bkqueryCommandState=t.queryCommandState,t.bkqueryCommandValue=t.queryCommandValue,t.queryCommandState=function(e){var n=this._getCommand(e);return n&&n.enableReadOnly===!1?t.bkqueryCommandState.apply(t,arguments):-1},t.queryCommandValue=function(e){var n=this._getCommand(e);return n&&n.enableReadOnly===!1?t.bkqueryCommandValue.apply(t,arguments):null},this.setStatus("readonly"),t.fire("interactchange")},setEnabled:function(){var t=this;t.bkqueryCommandState&&(t.queryCommandState=t.bkqueryCommandState,delete t.bkqueryCommandState),t.bkqueryCommandValue&&(t.queryCommandValue=t.bkqueryCommandValue,delete t.bkqueryCommandValue),this.rollbackStatus(),t.fire("interactchange")}});Utils.extend(r,{_protocals:{},registerProtocal:function(t,e){r._protocals[t]=e()},findProtocal:function(t){return r._protocals[t]||null},getSupportedProtocals:function(){return Utils.keys(r._protocals).sort(function(t,e){return r._protocals[e].recognizePriority-r._protocals[t].recognizePriority})},getAllRegisteredProtocals:function(){return r._protocals}});var u={root:"maintopic",main:"topic",sub:"topic"};t.extendClass(h,{exportData:function(t){var e,i;return e=n(this.getRoot()),i=r.findProtocal(t),this._fire(new l("beforeexport",{json:e,protocalName:t,protocal:i},!0))!==!0?i?i.encode(e,this):e:void 0},importData:function(t,e){var n,i;if(e?i=r.findProtocal(e):r.getSupportedProtocals().every(function(e){var n=r.findProtocal(e);return n.recognize&&n.recognize(t)&&(i=n),!i}),!i)throw new Error("Unsupported protocal: "+e);var o={local:t,protocalName:e,protocal:i},a=this._fire(new l("beforeimport",o,!0));if(a)return this;if(n=o.json||(o.json=i.decode(t)),"object"==typeof n&&"then"in n){var s=this;n.then(t,function(t){s._afterImportData(t,o)})}else this._afterImportData(n,o);return this},_afterImportData:function(t,e){for(this._fire(new l("preimport",e,!1));this._root.getChildren().length;)this._root.removeChild(0);var n=this._root.getData("currentstyle");this._root.setData(),this._root.setData("currentstyle",n),i(this._root,t,this),this.fire("beforeimport"),this._fire(new l("import",e,!1)),this._firePharse({type:"contentchange"}),this._firePharse({type:"interactchange"})}}),t.extendClass(h,{_initEvents:function(){this._eventCallbacks={}},_bindEvents:function(){this._bindPaperEvents(),this._bindKeyboardEvents()},_resetEvents:function(){this._initEvents(),this._bindEvents()},_bindPaperEvents:function(){this._paper.on("click dblclick mousedown contextmenu mouseup mousemove mousewheel DOMMouseScroll touchstart touchmove touchend",this._firePharse.bind(this)),e&&(e.addEventListener("resize",this._firePharse.bind(this)),e.addEventListener("blur",this._firePharse.bind(this)))},_bindKeyboardEvents:function(){-1==navigator.userAgent.indexOf("iPhone")&&-1==navigator.userAgent.indexOf("iPod")&&-1==navigator.userAgent.indexOf("iPad")&&Utils.listen(document.body,"keydown keyup keypress paste",this._firePharse.bind(this))},_firePharse:function(t){var e,n,i;"DOMMouseScroll"==t.type&&(t.type="mousewheel",t.wheelDelta=t.originEvent.wheelDelta=120*t.originEvent.detail),e=new l("before"+t.type,t,!0),this._fire(e)||(n=new l("pre"+t.type,t,!1),i=new l(t.type,t,!1),this._fire(n),this._fire(i),this._fire(new l("after"+t.type,t,!1)),~"mousedown mouseup keydown keyup".indexOf(t.type)&&this._interactChange(t))},_interactChange:function(){var t=this;clearTimeout(this._interactTimeout),this._interactTimeout=setTimeout(function(){var e=t._fire(new l("beforeinteractchange"));e||(t._fire(new l("preinteractchange")),t._fire(new l("interactchange")))},300)},_listen:function(t,e){var n=this._eventCallbacks[t]||(this._eventCallbacks[t]=[]);n.push(e)},_fire:function(t){var e=this.getStatus(),n=this._eventCallbacks[t.type.toLowerCase()]||[];if(e&&(n=n.concat(this._eventCallbacks[e+"."+t.type.toLowerCase()]||[])),0!==n.length){for(var i=this.getStatus(),o=0;o<n.length&&(n[o].call(this,t),this.getStatus()==i&&!t.shouldStopPropagationImmediately());o++);return t.shouldStopPropagation()}},on:function(t,e){var n=this;return a.each(t.split(/\s+/),function(t,i){n._listen(i.toLowerCase(),e)}),this},off:function(t,e){var n,i,o,r,a=t.split(/\s+/);for(n=0;n<a.length;n++)if(o=this._eventCallbacks[a[n].toLowerCase()]){for(r=null,i=0;i<o.length;i++)o[i]==e&&(r=i);null!==r&&o.splice(r,1)}},fire:function(t,e){var n=new l(t,e);return this._fire(n),this}}),t.extendClass(h,{_initModules:function(){var t=r.getModules(),e=this._options.modules||Utils.keys(t);this._commands={},this._query={},this._modules={};var n,i,o,a,s,c=this;for(n=0;n<e.length;n++)if(i=e[n],t[i]){o=t[i].call(c),this._modules[i]=o,o.init&&o.init.call(c,this._options),a=o.commands;for(var i in a)this._commands[i.toLowerCase()]=new a[i];if(s=o.events)for(var l in s)c.on(l,s[l]);o.defaultOptions&&this.setDefaultOptions(o.defaultOptions),o.addShortcutKeys&&this.addShortcutKeys(o.addShortcutKeys),o.contextmenu&&this.addContextmenu(o.contextmenu)}},_garbage:function(){for(this.clearSelect();this._root.getChildren().length;)this._root.removeChild(0)},destroy:function(){var t=this._modules;this._resetEvents(),this._garbage();for(var e in t)t[e].destroy&&t[e].destroy.call(this)},reset:function(){var t=this._modules;this._garbage();for(var e in t)t[e].reset&&t[e].reset.call(this)}}),t.extendClass(h,{_getCommand:function(t){return this._commands[t.toLowerCase()]},_queryCommand:function(t,e,n){var i=this._getCommand(t);if(i){var o=i["query"+e];if(o)return o.apply(i,[this].concat(n))}return 0},queryCommandState:function(t){return this._queryCommand(t,"State",Utils.argsToArray(1))},queryCommandValue:function(t){return this._queryCommand(t,"Value",Utils.argsToArray(1))},execCommand:function(t){t=t.toLowerCase();var e,n,i,o,r=Utils.argsToArray(arguments,1),a=this;return e=this._getCommand(t),o={command:e,commandName:t.toLowerCase(),commandArgs:r},e?(!this._hasEnterExecCommand&&e.isNeedUndo()?(this._hasEnterExecCommand=!0,n=this._fire(new l("beforeExecCommand",o,!0)),n||(this._fire(new l("saveScene")),this._fire(new l("preExecCommand",o,!1)),i=e.execute.apply(e,[a].concat(r)),this._fire(new l("execCommand",o,!1)),this._fire(new l("saveScene")),e.isContentChanged()&&this._firePharse(new l("contentchange")),e.isSelectionChanged()&&this._firePharse(new l("selectionchange")),this._firePharse(new l("interactchange"))),this._hasEnterExecCommand=!1):(i=e.execute.apply(e,[a].concat(r)),this._hasEnterExecCommand||(e.isSelectionChanged()&&this._firePharse(new l("selectionchange")),this._firePharse(new l("interactchange")))),void 0===i?null:i):!1}}),t.extendClass(h,{getRoot:function(){return this._root},setRoot:function(t){this._root=t},handelNodeInsert:function(t){var e=this._rc;e.addShape(t.getRenderContainer())},handelNodeRemove:function(t){var e=this._rc;t.traverse(function(t){e.removeShape(t.getRenderContainer())})},renderNodes:function(t){var e=this;if(t instanceof Array){if(0===t.length)return!1;for(var n=0;n<t.length;n++)e.renderNode(t[n])}else e.renderNode(t)},getMinderTitle:function(){return this.getRoot().getText()}});var d=r.keymap={Backspace:8,Tab:9,Enter:13,Shift:16,Control:17,Alt:18,CapsLock:20,Esc:27,Spacebar:32,PageUp:33,PageDown:34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Del:46,NumLock:144,Cmd:91,F2:113,F3:114,F4:115,"=":187,"-":189,b:66,i:73,z:90,y:89,v:86,x:88,s:83,n:78,"/":191,".":190,notContentInput:{8:1,46:1,13:1,9:1,33:1,34:1,35:1,36:1,16:1,17:1,18:1,37:1,38:1,39:1,40:1,113:1},isSelectedNodeKey:{37:1,38:1,39:1,40:1,13:1,9:1}};t.extendClass(h,{getLang:function(t){var e=KM.LANG[this.getOptions("lang")];if(!e)throw Error("not import language file");t=(t||"").split(".");for(var n,i=0;(n=t[i++])&&(e=e[n]););return e}}),KM.defaultOptions={zIndex:1e3,lang:"zh-cn",readyOnly:!1},t.extendClass(h,function(){var t="kityminder_preference",n=function(){var t=e.localStorage;return{saveLocalData:function(e,n){return t&&n?(t.setItem(e,n),!0):!1},getLocalData:function(e){return t?t.getItem(e):null},removeItem:function(e){t&&t.removeItem(e)}}}();return{setPreferences:function(e,i){var o={};Utils.isString(e)?o[e]=i:o=e;var r=n.getLocalData(t);r?(r=JSON.parse(r),a.extend(r,o)):r=o,n.saveLocalData(t,JSON.stringify(r))},getPreferences:function(e){var i=n.getLocalData(t);return i?(i=JSON.parse(i),e?i[e]:i):null},resetPreferences:function(t){var e=t?JSON.stringify(t):"";n.saveLocalData(e)}}}());var f=r.browser=function(){var t=navigator.userAgent.toLowerCase(),n=e.opera,i={ie:/(msie\s|trident.*rv:)([\w.]+)/.test(t),opera:!!n&&n.version,webkit:t.indexOf(" applewebkit/")>-1,mac:t.indexOf("macintosh")>-1,quirks:"BackCompat"==document.compatMode};i.gecko="Gecko"==navigator.product&&!i.webkit&&!i.opera&&!i.ie;var o=0;if(i.ie){var r=t.match(/(?:msie\s([\w.]+))/),a=t.match(/(?:trident.*rv:([\w.]+))/);o=r&&a&&r[1]&&a[1]?Math.max(1*r[1],1*a[1]):r&&r[1]?1*r[1]:a&&a[1]?1*a[1]:0,i.ie11Compat=11==document.documentMode,i.ie9Compat=9==document.documentMode,i.ie8=!!document.documentMode,i.ie8Compat=8==document.documentMode,i.ie7Compat=7==o&&!document.documentMode||7==document.documentMode,i.ie6Compat=7>o||i.quirks,i.ie9above=o>8,i.ie9below=9>o}if(i.gecko){var s=t.match(/rv:([\d\.]+)/);s&&(s=s[1].split("."),o=1e4*s[0]+100*(s[1]||0)+1*(s[2]||0))}return/chrome\/(\d+\.\d)/i.test(t)&&(i.chrome=+RegExp.$1),/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/i.test(t)&&!/chrome/i.test(t)&&(i.safari=+(RegExp.$1||RegExp.$2)),i.opera&&(o=parseFloat(n.version())),i.webkit&&(o=parseFloat(t.match(/ applewebkit\/(\d+)/)[1])),i.version=o,i.isCompatible=!i.mobile&&(i.ie&&o>=6||i.gecko&&o>=10801||i.opera&&o>=9.5||i.air&&o>=1||i.webkit&&o>=522||!1),i}();f.ie,f.webkit,f.gecko,f.opera,r.Geometry=function(){function e(t){return t.width=t.right-t.left,t.height=t.bottom-t.top,t.x=t.left,t.y=t.top,t}var n={},i=Math.min,o=Math.max,r=(Math.abs,Object.prototype.hasOwnProperty);return n.isNumberInRange=function(t,e){return t>e[0]&&t<e[1]},n.getDistance=function(e,n){return t.Vector.fromPoints(e,n).length()},n.getBox=function(t,n){return e({left:i(t.x,n.x),right:o(t.x,n.x),top:i(t.y,n.y),bottom:o(t.y,n.y)})},n.mergeBox=function(t,n){return e({left:i(t.left,n.left),right:o(t.right,n.right),top:i(t.top,n.top),bottom:o(t.bottom,n.bottom)})},n.getBoxRange=function(t){return{x:[t.left,t.right],y:[t.top,t.bottom]}},n.getBoxVertex=function(t){return{leftTop:{x:t.left,y:t.top},rightTop:{x:t.right,y:t.top},leftBottom:{x:t.left,y:t.bottom},rightBottom:{x:t.right,y:t.bottom}}},n.isPointInsideBox=function(t,e){var i=n.getBoxRange(e);return n.isNumberInRange(t.x,i.x)&&n.isNumberInRange(t.y,i.y)},n.isBoxIntersect=function(t,e){var n=o(t.left,e.left),r=o(t.top,e.top),a=i(t.right,e.right),s=i(t.bottom,e.bottom);return a>n&&s>r},n.snapToSharp=function(t){return a.isNumber(t)?(0|t)+.5:a.isArray(t)?t.map(n.snapToSharp):(["x","y","left","top","right","bottom"].forEach(function(e){r.call(t,e)&&(t[e]=n.snapToSharp(t[e]))}),t)},n.expandBox=function(t,n,i){return void 0===i&&(i=n),e({left:t.left-n,top:t.top-i,right:t.right+n,bottom:t.bottom+i})},n}(),r.registerModule("HistoryModule",function(){var e=this,n=t.createClass("Scene",{constructor:function(t){this.data=t.clone()},getData:function(){return this.data},cloneData:function(){return this.getData().clone()},equals:function(t){return this.getData().equals(t.getData())}}),i=t.createClass("HistoryManager",{constructor:function(t){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1,this.km=t},undo:function(){if(this.hasUndo){if(!this.list[this.index-1]&&1==this.list.length)return void this.reset();for(;this.list[this.index].equals(this.list[this.index-1]);)if(this.index--,0==this.index)return this.restore(0);this.restore(--this.index)}},redo:function(){if(this.hasRedo){for(;this.list[this.index].equals(this.list[this.index+1]);)if(this.index++,this.index==this.list.length-1)return this.restore(this.index);this.restore(++this.index)}},restore:function(){var t=this.list[this.index];this.km.setRoot(t.cloneData()),this.km.removeAllSelectedNodes(),this.km.initStyle(),this.update(),this.km.fire("restoreScene"),this.km.fire("contentChange")},getScene:function(){return new n(this.km.getRoot())},saveScene:function(){var t=this.getScene(),e=this.list[this.index];e&&e.equals(t)||(this.list=this.list.slice(0,this.index+1),this.list.push(t),this.list.length>this.km.getOptions("maxUndoCount")&&this.list.shift(),this.index=this.list.length-1,this.update())},update:function(){this.hasRedo=!!this.list[this.index+1],this.hasUndo=!!this.list[this.index-1]},reset:function(){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1}});this.historyManager=new i(this);var o,r,a={16:1,17:1,18:1,91:1,37:1,38:1,39:1,40:1},c=0;return{defaultOptions:{maxUndoCount:20,maxInputCount:20},commands:{undo:t.createClass("UndoCommand",{base:s,execute:function(t){t.historyManager.undo()},queryState:function(t){return t.historyManager.hasUndo?0:-1},isNeedUndo:function(){return!1}}),redo:t.createClass("RedoCommand",{base:s,execute:function(t){t.historyManager.redo()},queryState:function(t){return t.historyManager.hasRedo?0:-1},isNeedUndo:function(){return!1}})},addShortcutKeys:{Undo:"ctrl+z",Redo:"ctrl+y"},events:{saveScene:function(){this.historyManager.saveScene()},renderNode:function(t){var e=t.node;e.isSelected()&&this.select(e)},keydown:function(t){var n=t.originEvent,i=n.keyCode||n.which;a[i]||n.ctrlKey||n.metaKey||n.shiftKey||n.altKey||(0==e.historyManager.list.length&&e.historyManager.saveScene(),clearTimeout(r),r=setTimeout(function(){e.historyManager.saveScene()},200),o=i,c++,c>=e.getOptions("maxInputCount")&&e.historyManager.saveScene())},"import":function(){this.historyManager.reset()}}}}),r.registerModule("IconModule",function(){var e=this,n=function(e,n){var i=["","#A92E24","#29A6BD","#1E8D54","#eb6100","#876DDA"],o=(new t.Rect).fill(i[n]).setRadius(3).setWidth(20).setHeight(20),r=(new t.Text).setContent(n).fill("white").setSize(12),a=new t.Group;a.addShapes([o,r]),e.getContRc().addShape(a),r.setTranslate(6,15);var s=a.getHeight();a.setTranslate(0,-s/2)},i=function(n,i){var o,r,a=new t.Group,s=n.getContRc(),c=(new t.Circle).setRadius(8).fill("white").stroke(new t.Pen("#29A6BD",2));switch(5>i?(o=new t.Path,r=o.getDrawer(),r.moveTo(0,0).lineTo(6,0)):o=new t.Group,a.addShapes([c,o]),s.addShape(a),i){case 1:break;case 2:r.carcTo(6,0,0,0,-6);break;case 3:r.carcTo(6,0,0,-6,0);break;case 4:r.carcTo(6,1,0,0,6);break;case 5:var l=new t.Path;o.addShapes([(new t.Circle).setRadius(6).fill("#29A6BD"),l]),l.getDrawer().moveTo(-3,0).lineTo(-1,3).lineTo(3,-2),l.stroke(new t.Pen("white",2).setLineCap("round"))}5>i&&r.close(),o.fill("#29A6BD");var h=n.getData("PriorityIcon"),u=e.getCurrentLayoutStyle()[n.getType()];h?a.setTranslate(s.getWidth()+u.spaceLeft,0):a.setTranslate(a.getWidth()/2,0)},o=t.createClass("SetPriorityCommand",function(){return{base:s,execute:function(t,e){for(var n=t.getSelectedNodes(),i=0;i<n.length;i++)n[i].setData("PriorityIcon",e),t.updateLayout(n[i])},queryValue:function(t){for(var e,n=t.getSelectedNodes(),i=0;i<n.length&&!(e=n[i].getData("PriorityIcon"));i++);return e}}}()),r=t.createClass("SetProgressCommand",function(){return{base:s,execute:function(t,e){for(var n=t.getSelectedNodes(),i=0;i<n.length;i++)n[i].setData("ProgressIcon",e),t.updateLayout(n[i])},queryValue:function(t){for(var e,n=t.getSelectedNodes(),i=0;i<n.length&&!(e=n[i].getData("ProgressIcon"));i++);return e}}}());return{commands:{priority:o,progress:r},events:{RenderNodeLeft:function(t){var e=t.node,o=e.getData("PriorityIcon"),r=e.getData("ProgressIcon");e.getContRc(),o&&n(e,o),r&&i(e,r)}}}}),r.registerModule("LayoutModule",function(){t.extendClass(h,{addLayoutStyle:function(t,e){this._layoutStyles||(this._layoutStyles={}),this._layoutStyles[t]=e},getLayoutStyle:function(t){return this._layoutStyles[t]},getLayoutStyleItems:function(){var t=[];for(var e in this._layoutStyles)t.push(e);return t},getCurrentStyle:function(){return this.getRoot(),"default"},setCurrentStyle:function(t){var e=this.getRoot();return e.setData("currentstyle",t),t},getCurrentLayoutStyle:function(){var t=this.getCurrentStyle();return this.getLayoutStyle(t).getCurrentLayoutStyle.call(this)},highlightNode:function(t){var e=this.getCurrentStyle();this.getLayoutStyle(e).highlightNode.call(this,t)},initStyle:function(){var e=this.getCurrentStyle();this._rc.remove();var n=this._rc.transform;this._rc=new t.Group,this._paper.addShape(this._rc),this._rc.transform=n,this._rc._applyTransform();var i=this.getRoot();i.preTraverse(function(t){t.clearLayout()}),this.getLayoutStyle(e).initStyle.call(this),this.fire("afterinitstyle")},appendChildNode:function(t,e,n,i){var o=this.getCurrentStyle();this.getLayoutStyle(o).appendChildNode.call(this,t,e,n,i)},appendSiblingNode:function(t,e,n){var i=this.getCurrentStyle();this.getLayoutStyle(i).appendSiblingNode.call(this,t,e,n)},removeNode:function(t){var e=this.getCurrentStyle();this.getLayoutStyle(e).removeNode.call(this,t)},updateLayout:function(t){var e=this.getCurrentStyle();this.getLayoutStyle(e).updateLayout.call(this,t)},expandNode:function(t){var e=this.getCurrentStyle();this.getLayoutStyle(e).expandNode.call(this,t)}}),t.extendClass(c,{setLayout:function(t,e){void 0===this._layout&&(this._layout={});var n=this.getLayout();Utils.extend(n,{k:e}),this._layout=n},getLayout:function(t){return void 0===t?this._layout:this._layout[t]},clearLayout:function(){this._layout={}}});var e=function(t,e){var n=t.getRoot();return n.preTraverse(function(t){t.setPoint(),t.getBgRc().clear()}),t.setCurrentStyle(e),t.initStyle(),e},n=t.createClass("SwitchLayoutCommand",function(){return{base:s,execute:e,queryValue:function(t){return t.getCurrentStyle()}}}()),i=t.createClass("AppendChildNodeCommand",function(){return{base:s,execute:function(t,e,n,i){var o=t.getSelectedNode();return o?("root"===o.getType()||0===o.getChildren().length||o.isExpanded()||t.expandNode(o),o.expand(),t.appendChildNode(o,e,n,i),t.select(e,!0),e):null},queryState:function(t){var e=t.getSelectedNode();return e?0:-1}}}()),o=t.createClass("AppendSiblingNodeCommand",function(){return{base:s,execute:function(t,e,n){var i=t.getSelectedNode();return i?(i.isRoot()?(e.setType("main"),t.appendChildNode(i,e,n)):t.appendSiblingNode(i,e,n),t.select(e,!0),e):null},queryState:function(t){var e=t.getSelectedNodes();return 0===e.length||1===e.length&&e[0]===t.getRoot()?-1:0}}}()),r=t.createClass("RemoveNodeCommand",function(){return{base:s,execute:function(t){if(0!=t.getRoot().children.length){for(var e=t.getSelectedNodes(),n=(t.getRoot(),[]),i=0;i<e.length;i++)n.push(e[i]);do{var o=n[0].getParent();o&&-1===n.indexOf(o)&&n.push(o),n.shift()}while(n.length>1);t.removeNode(e),t.select(n[0])}},queryState:function(t){var e=t.getSelectedNodes();return 0===e.length||1===e.length&&e[0]===t.getRoot()?-1:0
}}}()),a=t.createClass("EditNodeCommand",function(){return{base:s,execute:function(t){var e=t.getSelectedNode();return e?(t.select(e,!0),void t.textEditNode(e)):null},queryState:function(t){var e=t.getSelectedNode();return e?0:-1},isNeedUndo:function(){return!1}}}());return{commands:{appendchildnode:i,appendsiblingnode:o,removenode:r,editnode:a,switchlayout:n},events:{ready:function(){this.setDefaultOptions("layoutstyle",this.getLayoutStyleItems()),e(this,this.getOptions("defaultlayoutstyle"))},click:function(t){var e=t.kityEvent.targetShape&&t.kityEvent.targetShape.container;e&&"shicon"===e.class&&(this.expandNode(e),this.fire("contentchange"))},resize:function(){clearTimeout(this._lastStyleResetTimeout),this._lastStyleResetTimeout=setTimeout(function(){this.updateLayout(this.getRoot())}.bind(this),100)},"import":function(){this.initStyle()}},contextmenu:[{label:this.getLang("node.appendsiblingnode"),exec:function(){this.execCommand("appendsiblingnode",new c(this.getLang("topic")))},cmdName:"appendsiblingnode"},{label:this.getLang("node.appendchildnode"),exec:function(){this.execCommand("appendchildnode",new c(this.getLang("topic")))},cmdName:"appendchildnode"},{label:this.getLang("node.editnode"),exec:function(){this.execCommand("editnode",null)},cmdName:"editnode"},{label:this.getLang("node.removenode"),cmdName:"removenode"},{divider:1}],defaultOptions:{defaultlayoutstyle:"default",node:{appendsiblingnode:"appendsiblingnode",appendchildnode:"appendchildnode",editnode:"editnode",removenode:"removenode"},defaultExpand:{defaultLayer:0,defaultSubShow:0}}}}),r.registerModule("LayoutDefault",function(){function e(){return{width:n.clientWidth,height:n.clientHeight}}var n=this.getRenderTarget(),i=this,o=t.createClass("DefaultshIcon",function(){return{constructor:function(e){this._show=!1,this._node=e;var n=this.shape=new t.Group;n.class="shicon",n.icon=this;var o=this._circle=(new t.Circle).fill("white").stroke("gray").setRadius(5),r=this._plus=new t.Path;r.getDrawer().moveTo(-3,0).lineTo(3,0).moveTo(0,-3).lineTo(0,3),r.stroke("gray");var a=this._dec=new t.Path;a.getDrawer().moveTo(-3,0).lineTo(3,0),a.stroke("gray"),i.getRenderContainer().addShape(n),n.addShapes([o,r,a]),this.update()},switchState:function(t){return(t===!0||t===!1)&&(this._show=!t),this._show?(this._plus.setOpacity(1),this._dec.setOpacity(0),this._show=!1):(this._plus.setOpacity(0),this._dec.setOpacity(1),this._show=!0),this._show},update:function(){var t,e=this._node,n=e.getLayout(),i=e.getRenderContainer(),o="main"===e.getType()?n.y:n.y+i.getHeight()/2-5;"left"===n.appendside?t=i.getRenderBox().closurePoints[1].x-5:(t=i.getRenderBox().closurePoints[0].x+6,"main"===e.getType()&&(t-=3)),this.shape.setTranslate(t,o)},remove:function(){this.shape.remove()}}}()),r=function(t,e){for(var n=0;n<t.length;n++){var i=e.indexOf(t[n]);-1!==i&&e.splice(i,1)}return t.concat(e)},a={root:{color:"#430",fill:"#e9df98",fontSize:24,padding:[15.5,25.5,15.5,25.5],margin:[0,0,0,0],radius:30,highlight:"rgb(254, 219, 0)",spaceLeft:3,spaceRight:0,spaceTop:3,spaceBottom:3},main:{stroke:new t.Pen("white",2).setLineCap("round").setLineJoin("round"),fill:"#A4c5c0",color:"#333",padding:[6.5,20,6.5,20],fontSize:16,margin:[0,10,30,50],radius:10,highlight:"rgb(254, 219, 0)",spaceLeft:5,spaceRight:0,spaceTop:2,spaceBottom:2},sub:{stroke:new t.Pen("white",2).setLineCap("round").setLineJoin("round"),color:"white",fontSize:12,margin:[0,10,20,6],padding:[5,10,5.5,10],highlight:"rgb(254, 219, 0)",spaceLeft:4,spaceRight:0,spaceTop:2,spaceBottom:2}},s=function(e){var n=e.getType(),i=a[n],o=e.getLayout();switch(e.getType()){case"root":case"main":var r=e.getBgRc().clear();r.addShape(o.bgShadow=new t.Rect),r.addShape(o.bgRect=new t.Rect),o.bgRect.fill(i.fill).setRadius(i.radius),o.bgShadow.fill("black").setOpacity(.2).setRadius(i.radius).translate(3,5);break;case"sub":var s=o.underline=new t.Path,c=o.highlightshape=(new t.Rect).setRadius(4);e.getBgRc().clear().addShapes([o.bgRect=(new t.Rect).setRadius(4),c,s])}},h=function(t){var e=t.getLayout(),n=t.getType();a[n],"root"===n&&(e.leftList=[],e.rightList=[],e.leftHeight=0,e.rightHeight=0)},u=function(t){var e=t.getContRc(),n=t.getType(),i=a[n],o=e.getWidth(),r=e.getHeight(),s=t.getLayout();switch(n){case"root":case"main":var c=o+i.padding[1]+i.padding[3],l=r+i.padding[0]+i.padding[2];s.bgRect.setWidth(c).setHeight(l),s.bgShadow.setWidth(c).setHeight(l);break;case"sub":var h=e.getWidth(),u=e.getHeight();c=h+i.padding[1]+i.padding[3],l=u+i.padding[0]+i.padding[2],s.underline.getDrawer().clear().moveTo(0,u+i.padding[2]+i.padding[0]).lineTo(h+i.padding[1]+i.padding[3],u+i.padding[2]+i.padding[0]),s.underline.stroke(i.stroke),s.highlightshape.setWidth(h+i.padding[1]+i.padding[3]).setHeight(u+i.padding[0]+i.padding[2]),s.bgRect.setWidth(c).setHeight(l)}e.setTranslate(i.padding[3],i.padding[0]+r/2)},d=function(t,n,o){var r=i.getRoot(),s=[t];"remove"===o&&(s=[]);var c=t.getLayout(),l=(t.getRenderContainer(),t.getType()),h=a[l],u=c.appendside,d=function(t,e){var n=a[t.getType()],i=t.getRenderContainer().getHeight()+n.margin[0]+n.margin[2],o=function(){var n,i=0;n=e?t.getLayout()[e+"List"]:t.getChildren();for(var o=0;o<n.length;o++){var r=n[o].getLayout();n[o].getRenderContainer().getPaper()&&0!==n[o].getRenderContainer().getHeight()&&(i+=r.branchheight)}return i}();return e?o:i>o?i:o};if("root"===l)c.y=e().height/2,s.push(t);else{if("append"===o||"contract"===o){var f=t.getRenderContainer().getHeight()||t.getContRc().getHeight()+h.padding[0]+h.padding[2];c.branchheight=f+h.margin[0]+h.margin[2]}else"change"===o&&(c.branchheight=d(t));for(var p=(n.getLayout(),n.getRenderContainer(),t.getParent()||n);p;){var g=p.getLayout();"root"===p.getType()?g[u+"Height"]=d(p,u):g.branchheight=d(p),p=p.getParent()}}var m=function(t){for(var e=[r];e.length>0;){var n=e[0].getLayout(),i=n[t+"List"]||e[0].getChildren(),i=function(){for(var t=[],e=0;e<i.length;e++){var n=i[e].getLayout();n.added&&t.push(i[e])}return t}();e=e.concat(i);for(var o=n.y-(n[t+"Height"]||n.branchheight)/2,a=0;a<i.length;a++){var c=i[a].getLayout();c.y=o+c.branchheight/2,o+=c.branchheight}e[0]!==r&&e[0].getLayout().added&&s.push(e[0]),e.shift()}};return u?m(u):(m("left"),m("right")),s},f=function(t){for(var n=(t.getType(),t.getParent(),[t]),i=t.getLayout(),o=[t];0!==o.length;){var r=o[0].getParent(),s=o[0].getChildren();if(s=function(){for(var t=[],e=0;e<s.length;e++){var n=s[e].getLayout();n.added&&t.push(s[e])}return t}(),o=o.concat(s),r){var c=r.getLayout(),l=r.getRenderContainer().getWidth(),h=a[r.getType()],u=o[0].getLayout(),d=a[o[0].getType()];"center"===c.align&&(l/=2),u.x="left"===u.appendside?c.x-l-h.margin[1]-d.margin[3]:c.x+l+h.margin[1]+d.margin[3],n.push(o[0]),o.shift()}else i.x=e().width/2,o.shift()}return n},p=function(t){var e=t.getLayout(),n=t.getRenderContainer(),i=e.align,o=n.getHeight(),r=n.getWidth();switch(i){case"right":n.setTranslate(e.x-r,e.y-o/2);break;case"center":n.setTranslate(e.x-r/2,e.y-o/2);break;default:n.setTranslate(e.x,e.y-o/2)}t.setPoint(e.x,e.y)},g=function(e){var n,r=e.getType(),s=e.getLayout(),c=a[e.getType()];if("main"===r){if(!s.connect){n=s.connect=new t.Group;var l=s.connect.bezier=new t.Bezier,h=s.connect.circle=new t.Circle;n.addShapes([l,h]),i.getRenderContainer().addShape(n),i.getRoot().getRenderContainer().bringTop()}var u=i.getRoot(),d=u.getLayout().x,f=u.getLayout().y;n=s.connect;var p,g,m=e.getRenderContainer(),v=m.getRenderBox().closurePoints;"left"===s.appendside?(p=new t.BezierPoint(d-30,v[2].y+m.getHeight()/2),g=new t.BezierPoint(v[2].x+3,v[2].y+m.getHeight()/2)):(p=new t.BezierPoint(d+30,v[3].y+m.getHeight()/2),g=new t.BezierPoint(v[3].x-3,v[3].y+m.getHeight()/2));var b=(p.getVertex(),g.getVertex());p.setVertex(d,f),n.bezier.setPoints([p,g]).stroke(c.stroke),n.circle.setCenter(b.x+("left"===s.appendside?-.5:-1.5),b.y).fill("white").setRadius(4)}else if("sub"===r){s.connect||(n=s.connect=new t.Path,i.getRenderContainer().addShape(n)),n=s.connect;var y,x,w=e.getParent().getRenderContainer(),C=w.getRenderBox(),k=e.getParent().getLayout(),S=a[e.getParent().getType()],_=e.getRenderContainer(),T=k.y,P=_.getRenderBox().closurePoints[1].y;"left"===s.appendside?(y=C.closurePoints[1].x-S.margin[1],x=_.getRenderBox().closurePoints[0].x,n.getDrawer().clear().moveTo(y,T).lineTo(y,P>T?P-c.margin[3]:P+c.margin[3]),P>T?n.getDrawer().carcTo(c.margin[3],0,1,x,P):n.getDrawer().carcTo(c.margin[3],0,0,x,P),n.stroke(c.stroke)):(y=C.closurePoints[0].x+S.margin[1],x=_.getRenderBox().closurePoints[1].x+1,n.getDrawer().clear().moveTo(y,T).lineTo(y,P>T?P-c.margin[3]:P+c.margin[3]),P>T?n.getDrawer().carcTo(c.margin[3],0,0,x,P):n.getDrawer().carcTo(c.margin[3],0,1,x,P),n.stroke(c.stroke))}"root"!==r&&0!==e.getChildren().length&&(s.shicon||(s.shicon=new o(e)),s.shicon.update())},m={getCurrentLayoutStyle:function(){return a},highlightNode:function(t){var e=t.isHighlight(),n=t.getType(),i=a[n],o=t.getLayout();switch(n){case"root":case"main":o.bgRect.fill(e?i.highlight:i.fill);break;case"sub":e?(o.highlightshape.fill(i.highlight).setOpacity(1),t.getTextShape().fill(t.getData("fontcolor")||"black")):(o.highlightshape.setOpacity(0),t.getTextShape().fill(t.getData("fontcolor")||"white"))}},updateLayout:function(t){t.getContRc().clear(),this._firePharse(new l("RenderNodeLeft",{node:t},!1)),this._firePharse(new l("RenderNodeCenter",{node:t},!1)),this._firePharse(new l("RenderNodeRight",{node:t},!1)),this._firePharse(new l("RenderNodeBottom",{node:t},!1)),this._firePharse(new l("RenderNodeTop",{node:t},!1)),this._firePharse(new l("RenderNode",{node:t},!1)),u(t);for(var e=f(t),n=d(t,t.getParent(),"change"),i=r(e,n),o=0;o<i.length;o++)p(i[o]),g(i[o]);this.isNodeSelected(t)&&this.highlightNode(t)},initStyle:function(){var t=i.getRoot(),e=t.getPoint();e&&(e=JSON.parse(JSON.stringify(e))),i.handelNodeInsert(t),t.getLayout().align="center",s(t),h(t),t.getContRc().clear(),this._firePharse(new l("RenderNodeLeft",{node:t},!1)),this._firePharse(new l("RenderNodeCenter",{node:t},!1)),this._firePharse(new l("RenderNodeRight",{node:t},!1)),this._firePharse(new l("RenderNodeBottom",{node:t},!1)),this._firePharse(new l("RenderNodeTop",{node:t},!1)),this._firePharse(new l("RenderNode",{node:t},!1)),u(t),f(t),d(t),p(t),e&&t.setPoint(e.x,e.y);for(var n=t.getChildren(),o=0;o<n.length;o++)this.appendChildNode(t,n[o]),n[o].isExpanded()&&n[o].getChildren().length>0&&i.expandNode(n[o]);t.setPoint(t.getLayout().x,t.getLayout().y)},expandNode:function(t){var e,n;t instanceof c?(n=t,e=n.getLayout().shicon.switchState()):(e=t.icon.switchState(),n=t.icon._node);var o;if(e)for(n.expand(),o=[n];0!==o.length;){var r=o[0].getChildren();if(o[0].isExpanded()&&0!==r.length){for(var a=0;a<r.length;a++)i.appendChildNode(o[0],r[a]);o=o.concat(r)}o.shift()}else{for(n.collapse(),o=n.getChildren();0!==o.length;){var s=o[0].getLayout();s.added&&(s.added=!1,o[0].getRenderContainer().remove(),s.connect.remove(),s.shicon&&s.shicon.remove()),o=o.concat(o[0].getChildren()),o.shift()}for(var l=d(n,n.getParent(),"contract"),h=0;h<l.length;h++)p(l[h]),g(l[h])}},appendChildNode:function(t,e,n,o){i.handelNodeInsert(e);var a=e.getLayout();e.clearLayout(),e.getContRc().clear(),a=e.getLayout(),a.added=!0;var c=t.getLayout(),m=t.getChildren(),v=-1!==m.indexOf(e);if(o){v||t.insertChild(e,o.getIndex()+1);var b=o.getLayout();if(a.appendside=b.appendside,a.align=b.align,"root"===t.getType()){i.handelNodeInsert(e);var y=m.length;7>y&&(y%2?(a.appendside="right",a.align="left"):(a.appendside="left",a.align="right"));var x=c[a.appendside+"List"],w=x.indexOf(o);x.splice(w+1,0,e)}}else if("root"!==t.getType()){var C=t.getLayout();a.appendside=C.appendside,a.align=C.align,v||t.appendChild(e)}else{var k=e.getPoint();k&&k.x&&k.y?k.x>t.getPoint().x?(a.appendside="right",a.align="left"):(a.appendside="left",a.align="right"):c.rightList.length>1&&c.rightList.length>c.leftList.length?(a.appendside="left",a.align="right"):(a.appendside="right",a.align="left");var S=c[a.appendside+"List"];S.push(e);var _;_="right"===a.appendside?S.length:t.getChildren().length,v||t.insertChild(e,_)}e.setType("root"===t.getType()?"main":"sub"),s(e),h(e),this._firePharse(new l("RenderNodeLeft",{node:e},!1)),this._firePharse(new l("RenderNodeCenter",{node:e},!1)),this._firePharse(new l("RenderNodeRight",{node:e},!1)),this._firePharse(new l("RenderNodeBottom",{node:e},!1)),this._firePharse(new l("RenderNodeTop",{node:e},!1)),this._firePharse(new l("RenderNode",{node:e},!1)),u(e);for(var T=d(e,t,"append"),P=f(e),E=r(T,P),D=0;D<E.length;D++)p(E[D]),g(E[D]);t.expand();var N=t.getLayout().shicon;N&&N.switchState(!0)},appendSiblingNode:function(t,e,n){var i=t.getParent();this.appendChildNode(i,e,n,t)},removeNode:function(t){for(;0!==t.length;){var e=t[0].getParent();if(!e)return t.splice(0,1),!1;var n=t[0].getLayout();if("root"===e.getType()){var i=e.getLayout()[n.appendside+"List"],o=i.indexOf(t[0]);i.splice(o,1)}if(e.removeChild(t[0]),"root"!==e.getType()&&0===e.getChildren().length){var r=e.getLayout();r.shicon.remove(),r.shicon=null}for(var a=d(t[0],e,"remove"),s=0;s<a.length;s++)p(a[s]),g(a[s]);for(var c=[t[0]];0!==c.length;){c=c.concat(c[0].getChildren());try{c[0].getRenderContainer().remove();var l=c[0].getLayout();l.connect.remove(),l.shicon.remove()}catch(h){console.log("isRemoved")}var u=t.indexOf(c[0]);-1!==u&&t.splice(u,1),c.shift()}}}};return this.addLayoutStyle("default",m),{}}),r.registerModule("LayoutBottom",function(){function e(){return{width:n.clientWidth,height:n.clientHeight}}var n=this.getRenderTarget(),i=this,o=t.createClass("DefaultshIcon",function(){return{constructor:function(e){this._show=!1,this._node=e;var n=this.shape=new t.Group;n.class="shicon",n.icon=this;var o=this._rect=(new t.Rect).fill("white").stroke("gray").setRadius(2).setWidth(10).setHeight(10),r=this._plus=new t.Path;r.getDrawer().moveTo(2,5).lineTo(8,5).moveTo(5,2).lineTo(5,8),r.stroke("gray");var a=this._dec=new t.Path;a.getDrawer().moveTo(2,5).lineTo(8,5),a.stroke("gray"),"main"===e.getType()?i.getRenderContainer().addShape(n):e.getLayout().subgroup.addShape(n),n.addShapes([o,r,a]),this.update(),this.switchState()},switchState:function(){return this._show?(this._plus.setOpacity(1),this._dec.setOpacity(0),this._show=!1):(this._plus.setOpacity(0),this._dec.setOpacity(1),this._show=!0),this._show},update:function(){var t=this._node,e=(t.getLayout(),t.getRenderContainer()),n=(t.getType(),e.getRenderBox().closurePoints[1].x+5),i=e.getRenderBox().closurePoints[0].y;this.shape.setTranslate(n,i)},remove:function(){this.shape.remove()}}}()),r={root:{color:"#430",fill:"#e9df98",fontSize:24,padding:[15.5,25.5,15.5,25.5],margin:[0,0,20,0],radius:0,highlight:"rgb(254, 219, 0)"},main:{stroke:new t.Pen("white",2).setLineCap("round").setLineJoin("round"),fill:"#A4c5c0",color:"#333",padding:[6.5,20,6.5,20],fontSize:16,margin:[20,20,10,10],radius:0,highlight:"rgb(254, 219, 0)"},sub:{stroke:new t.Pen("white",2).setLineCap("round").setLineJoin("round"),color:"#333",fontSize:12,margin:[10,10,10,30],padding:[5,10,5.5,10],highlight:"rgb(254, 219, 0)",fill:"rgb(231, 243, 255)"}},a=function(e){var n=e.getType(),i=r[n],o=e.getLayout();switch(e.getType()){case"root":case"main":var a=e.getBgRc().clear();a.addShape(o.bgShadow=new t.Rect),a.addShape(o.bgRect=new t.Rect),o.bgRect.fill(i.fill).setRadius(i.radius),o.bgShadow.fill("black").setOpacity(.2).setRadius(i.radius).translate(3,5);break;case"sub":var s=e.getBgRc().clear();s.addShape(o.bgRect=new t.Rect),o.bgRect.fill(i.fill)}},s=function(e){var n=e.getLayout(),o=e.getType();if(r[o],"main"===o){var a=n.subgroup=new t.Group;i.getRenderContainer().addShape(a)}},h=function(t){var e=t.getContRc(),n=t.getType(),i=r[n],o=e.getWidth(),a=e.getHeight(),s=t.getLayout();switch(n){case"root":case"main":var c=o+i.padding[1]+i.padding[3],l=a+i.padding[0]+i.padding[2];s.bgRect.setWidth(c).setHeight(l),s.bgShadow.setWidth(c).setHeight(l);break;case"sub":c=o+i.padding[1]+i.padding[3],l=a+i.padding[0]+i.padding[2],s.bgRect.setWidth(c).setHeight(l)}e.setTranslate(i.padding[3],i.padding[0]+a/2)},u=function(){for(var t=i.getRoot(),e=t.getChildren(),n=function(t){var e=t.getLayout(),n=t.getRenderContainer().getWidth()+r.main.margin[1]+r.main.margin[3],i=e.subgroup.getWidth()+r.main.margin[1]+r.sub.margin[3],o=e.branchwidth=n>i?n:i;return o},o=t.getLayout(),a=0,s=0;s<e.length;s++)a+=n(e[s]);for(var c=o.x-a/2,l=0;l<e.length;l++){var h=e[l].getLayout();h.x=c+r.main.margin[3]+5,c+=h.branchwidth}return e},d=function(t,n,o){var a=[],s=t.getType(),c=t.getLayout(),l=i.getRoot(),h=l.getLayout();if("root"===s){c.x=e().width/2,c.y=100,c.align="center",a.push(t);for(var d=t.getChildren(),f=0;f<d.length;f++){var p=d[f].getLayout();p.y=c.y+t.getRenderContainer().getHeight()+r.root.margin[2]+r.main.margin[0]}a=a.concat(d)}else if("main"===s)c.align="left",("append"===o||"contract"===o)&&(c.y=h.y+l.getRenderContainer().getHeight()+r.root.margin[2]+r.main.margin[0]),a=u();else{c.align="left";var g=n.getLayout();"append"===o&&(c.x="main"===n.getType()?r.sub.margin[3]:g.x+r.sub.margin[3]),("append"===o||"contract"===o)&&(c.branchheight=t.getRenderContainer().getHeight()+r.sub.margin[0]+r.sub.margin[2]);var m=n;for("change"===o&&(m=t);"main"!==m.getType();){for(var v=m.getChildren(),b=m.getLayout(),y=m.getRenderContainer().getHeight()+r.sub.margin[0]+r.sub.margin[2],x=0;x<v.length;x++)y+=v[x].getLayout().branchheight;b.branchheight=y,m=m.getParent()}for(var w=[m];0!==w.length;){var C=w[0].getChildren();w=w.concat(C);var k,S=w[0].getLayout(),_=r[w[0].getType()];k="main"===w[0].getType()?0:S.y+w[0].getRenderContainer().getHeight()+_.margin[2];for(var T=0;T<C.length;T++){var P=C[T].getLayout(),E=r[C[T].getType()];P.y=k+E.margin[0],k+=P.branchheight}a.push(w[0]),w.shift()}}return a},f=function(t){var e=t.getLayout(),n=t.getRenderContainer(),i=e.align,o=(n.getHeight(),n.getWidth());switch(i){case"right":n.setTranslate(e.x-o,e.y);break;case"center":n.setTranslate(e.x-o/2,e.y);break;default:n.setTranslate(e.x,e.y)}"main"===t.getType()&&e.subgroup.setTranslate(e.x,e.y+t.getRenderContainer().getHeight()),t.setPoint(e.x,e.y)},p=function(e){var n,a=e.getType(),s=e.getLayout(),c=(r[e.getType()],i.getRoot()),l=c.getLayout();if("main"===a){s.connect||(n=s.connect=new t.Path,i.getRenderContainer().addShape(n)),n=s.connect;var h=l.x,u=l.y+c.getRenderContainer().getHeight(),d=s.x+e.getRenderContainer().getWidth()/2,f=u+r.root.margin[2];n.getDrawer().clear().moveTo(h,u).lineTo(h,f).lineTo(d,f).lineTo(d,s.y),n.stroke(r.main.stroke)}else if("sub"===a){var p=e.getParent(),g=p.getLayout();s.connect||(n=s.connect=new t.Path,s.subgroup.addShape(n)),n=s.connect;var m,v;"main"===p.getType()?(m=10,v=0):(m=g.x+10,v=g.y+p.getRenderContainer().getHeight()+10);var b=s.y+e.getRenderContainer().getHeight()/2;n.getDrawer().clear().moveTo(m,v).lineTo(m,b).lineTo(s.x,b),n.stroke(r.sub.stroke)}"root"!==a&&0!==e.getChildren().length&&(s.shicon||(s.shicon=new o(e)),s.shicon.update())},g={getCurrentLayoutStyle:function(){return r},highlightNode:function(t){var e=t.isHighlight(),n=t.getType(),i=r[n],o=t.getLayout();switch(n){case"root":case"main":case"sub":o.bgRect.fill(e?i.highlight:i.fill)}},updateLayout:function(t){t.getContRc().clear(),this._firePharse(new l("RenderNodeLeft",{node:t},!1)),this._firePharse(new l("RenderNodeCenter",{node:t},!1)),this._firePharse(new l("RenderNodeRight",{node:t},!1)),this._firePharse(new l("RenderNodeBottom",{node:t},!1)),this._firePharse(new l("RenderNodeTop",{node:t},!1)),h(t);for(var e=d(t,t.getParent(),"change"),n=0;n<e.length;n++)f(e[n]),p(e[n]);if("sub"===t.getType())for(var i=u(),o=0;o<i.length;o++)f(i[o]),p(i[o])},initStyle:function(){var t=i.getRoot();i.handelNodeInsert(t),t.getLayout().align="center",a(t),s(t),t.getContRc().clear(),this._firePharse(new l("RenderNodeLeft",{node:t},!1)),this._firePharse(new l("RenderNodeCenter",{node:t},!1)),this._firePharse(new l("RenderNodeRight",{node:t},!1)),this._firePharse(new l("RenderNodeBottom",{node:t},!1)),this._firePharse(new l("RenderNodeTop",{node:t},!1)),h(t),d(t),f(t);for(var e=[t],n=[];0!==e.length;){var o=e[0].getChildren();e=e.concat(o);for(var r=0;r<o.length;r++)o[r].getLayout().parent=e[0];e[0].clearChildren(),e[0]!==t&&n.push(e[0]),e.shift()}for(var c=0;c<n.length;c++)this.appendChildNode(n[c].getLayout().parent,n[c])},appendChildNode:function(t,e,n,o){e.clearLayout();var r=t.getLayout();t.getData("expand"),"root"===t.getType()?(e.setType("main"),e.setData("expand",!0),i.handelNodeInsert(e)):(e.setType("sub"),r.subgroup.addShape(e.getRenderContainer()),e.getLayout().subgroup=r.subgroup),o?t.insertChild(e,o.getIndex()+1):t.appendChild(e),a(e),s(e),e.getRenderContainer().clear(),this._firePharse(new l("RenderNodeLeft",{node:e},!1)),this._firePharse(new l("RenderNodeCenter",{node:e},!1)),this._firePharse(new l("RenderNodeRight",{node:e},!1)),this._firePharse(new l("RenderNodeBottom",{node:e},!1)),this._firePharse(new l("RenderNodeTop",{node:e},!1)),h(e);for(var c=d(e,t,"append"),g=0;g<c.length;g++)f(c[g]),p(c[g]);if("sub"===e.getType())for(var m=u(),v=0;v<m.length;v++)f(m[v]),p(m[v])},appendSiblingNode:function(t,e){var n=t.getParent();this.appendChildNode(n,e,t)},removeNode:function(t){for(;0!==t.length;){var e=t[0].getParent();if(!e)return t.splice(0,1),!1;if(t[0].getLayout(),e.removeChild(t[0]),"root"!==e.getType()&&0===e.getChildren().length){var n=e.getLayout();n.shicon.remove(),n.shicon=null}for(var i=d(t[0],e,"remove"),o=0;o<i.length;o++)f(i[o]),p(i[o]);for(var r=u(),a=0;a<r.length;a++)f(r[a]),p(r[a]);for(var s=[t[0]];0!==s.length;){s=s.concat(s[0].getChildren());try{s[0].getRenderContainer().remove();var c=s[0].getLayout();c.connect.remove(),c.shicon.remove()}catch(l){console.log("isRemoved")}var h=t.indexOf(s[0]);-1!==h&&t.splice(h,1),s.shift()}}},expandNode:function(t){var e,n;t instanceof c?(n=t,e=n.getLayout().shicon.switchState()):(e=t.icon.switchState(),n=t.icon._node),n.setData("expand",e);for(var o=n.getChildren(),r=[];0!==o.length;){var a=o[0].getLayout();if(e){var s=o[0].getParent();a.parent=s,r.push(o[0]),a.connect=null,a.shicon=null}else try{o[0].getRenderContainer().remove(),a.connect.remove(),a.shicon&&a.shicon.remove()}catch(l){}o=o.concat(o[0].getChildren()),o.shift()}if(e){n.clearChildren();for(var h=0;h<r.length;h++)r[h].clearChildren(),i.appendChildNode(r[h].getLayout().parent,r[h])}var u=[];e||(u=d(n,n.getParent(),"contract"));for(var g=0;g<u.length;g++)f(u[g]),p(u[g])}};return this.addLayoutStyle("bottom",g),{}}),t.extendClass(h,function(){function t(t,e){e&&(e.setTmpData("highlight",!0),t.highlightNode(e))}function e(t,e){e&&(e.setTmpData("highlight",!1),t.highlightNode(e))}return{_initSelection:function(){this._selectedNodes=[]},getSelectedNodes:function(){return this._selectedNodes},getSelectedNode:function(){return this.getSelectedNodes()[0]||null},removeAllSelectedNodes:function(){var t=this;return Utils.each(this.getSelectedNodes(),function(n,i){e(t,i)}),this._selectedNodes=[],this.fire("selectionclear")},removeSelectedNodes:function(t){var n=this;return Utils.each(Utils.isArray(t)?t:[t],function(t,i){var o;-1!==(o=n._selectedNodes.indexOf(i))&&(n._selectedNodes.splice(o,1),e(n,i))}),this},select:function(e,n){n&&this.removeAllSelectedNodes();var i=this;return Utils.each(Utils.isArray(e)?e:[e],function(e,n){-1===i._selectedNodes.indexOf(n)&&(i._selectedNodes.push(n),t(i,n))}),this},isNodeSelected:function(t){return t.getTmpData("highlight")===!0},toggleSelect:function(t){return Utils.isArray(t)?t.forEach(this.toggleSelect.bind(this)):t.isSelected()?this.removeSelectedNodes(t):this.select(t),this},isSingleSelect:function(){return 1==this._selectedNodes.length},getSelectedAncestors:function(){function t(t,e){for(var n=t.length-1;n>=0;--n)if(t[n].isAncestorOf(e))return!0;return!1}var e,n=this.getSelectedNodes().slice(0),i=[],o=n.indexOf(this.getRoot());for(~o&&n.splice(o,1),n.sort(function(t,e){return t.getLevel()-e.getLevel()});e=n.pop();)t(n,e)||i.push(e);return i}}}());var p=t.createClass("ViewDragger",{constructor:function(t){this._minder=t,this._enabled=!1,this._offset={x:0,y:0},this._bind()},isEnabled:function(){return this._enabled},setEnabled:function(t){var e=this._minder.getPaper();e.setStyle("cursor",t?"pointer":"default"),e.setStyle("cursor",t?"-webkit-grab":"default"),this._enabled=t},move:function(t){this._minder.getRenderContainer().translate(t.x,t.y)},_bind:function(){var e=this,n=!1,i=null,o=null;this._minder.on("normal.mousedown readonly.mousedown readonly.touchstart",function(t){t.getTargetNode()!=this.getRoot()||this.getRoot().isSelected()&&this.isSingleSelect()||(i=t.getPosition(),n=!0)}).on("normal.mousemove normal.touchmove",function(e){if(n){var o=t.Vector.fromPoints(i,e.getPosition());o.length()>3&&this.setStatus("hand")}}).on("hand.beforemousedown hand.beforetouchend",function(t){e.isEnabled()&&(i=t.getPosition(),t.stopPropagation())}).on("hand.beforemousemove hand.beforetouchmove",function(n){if(i){o=n.getPosition();var r=t.Vector.fromPoints(i,o);e.move(r),n.stopPropagation(),n.preventDefault(),n.originEvent.preventDefault(),i=o}}).on("mouseup",function(){i=null,n&&(e.setEnabled(!1),n=!1,this.rollbackStatus())})}});r.registerModule("View",function(){var e=t.createClass("ToggleHandCommand",{base:s,execute:function(t){t._viewDragger.setEnabled(!t._viewDragger.isEnabled()),t._viewDragger.isEnabled()?t.setStatus("hand"):t.rollbackStatus(),this.setContentChanged(!1)},queryState:function(t){return t._viewDragger.isEnabled()?1:0},enableReadOnly:!1}),n=t.createClass("CameraCommand",{base:s,execute:function(t,e){var n=t.getPaper().getViewPort(),i=e.getRenderContainer().getRenderBox("view"),o=n.center.x-i.x-i.width/2,r=n.center.y-i.y;t.getRenderContainer().fxTranslate(o,r,1e3,"easeOutQuint"),this.setContentChanged(!1)},enableReadOnly:!1});return{init:function(){this._viewDragger=new p(this)},commands:{hand:e,camera:n},events:{keyup:function(t){t.originEvent.keyCode==d.Spacebar&&0===this.getSelectedNodes().length&&(this.execCommand("hand"),t.preventDefault())},mousewheel:function(t){var e,n;t=t.originEvent,t.ctrlKey||t.shiftKey||("wheelDeltaX"in t?(e=t.wheelDeltaX||0,n=t.wheelDeltaY||0):(e=0,n=t.wheelDelta),this._viewDragger.move({x:e/2.5,y:n/2.5}),t.preventDefault())},"normal.dblclick readonly.dblclick":function(e){e.kityEvent.targetShape instanceof t.Paper&&this.execCommand("camera",this.getRoot())}}}});var g=r.Geometry,m=t.createClass("AreaAnimator",{base:t.Animator,constructor:function(t,e){t.opacity=0,e.opacity=.8,this.callBase(t,e,function(t,e){t.setPosition(e.x,e.y),t.setSize(e.width,e.height),t.setOpacity(e.opacity)})}}),v=t.createClass("MoveToParentCommand",{base:s,execute:function(t,e,n){var i;!n.isExpanded()&&n.getChildren().length>0&&"root"!==n.getType()&&t.expandNode(n);for(var o=e.length-1;o>=0;o--)i=e[o],i.getParent()&&(t.removeNode([i]),t.appendChildNode(n,i),i.isExpanded()&&0!==i.getChildren().length&&t.expandNode(i));t.select(e,!0)}}),b=t.createClass("DragBox",{base:t.Group,constructor:function(t){this.callBase(),this._minder=t,this._draw()},_draw:function(){this._rect=(new t.Rect).setRadius(5).fill("white").stroke("#3399ff",1),this._text=(new t.Text).setSize(14).setTextAnchor("middle").fill("black").setStyle("cursor","default"),this.addShapes([this._rect,this._text])},_calcDragSources:function(){this._dragSources=this._minder.getSelectedAncestors()},_calcDropTargets:function(){function t(e,n){var i,o=[];return o.push(n),n.getChildren().forEach(function(n){for(i=0;i<e.length;i++)if(e[i]==n)return;o=o.concat(t(e,n))}),o}this._dropTargets=t(this._dragSources,this._minder.getRoot()),this._dropTargetBoxes=this._dropTargets.map(o)},_enterDragMode:function(){return this._calcDragSources(),this._dragSources.length?(this._calcDropTargets(),this._drawForDragMode(),this._shrink(),this._dragMode=!0,!0):(this._startPosition=null,!1)},_leaveDragMode:function(){this.remove(),this._dragMode=!1,this._dropSucceedTarget=null,this._removeDropHint()},_drawForDragMode:function(){this._text.setContent(this._dragSources.length+" items"),this._text.setPosition(this._startPosition.x,this._startPosition.y+5),this._minder.getPaper().addShape(this)},_shrink:function(){function t(t){for(var e=t.pop();t.length;)e=g.mergeBox(e,t.pop());return{x:e.left,y:e.top,width:e.width,height:e.height}}function e(t){var e=80,n=30;return{x:t.x-e/2,y:t.y-n/2,width:e,height:n}}var n=t(this._dragSources.map(o)),i=e(this._startPosition),r=new m(n,i);r.start(this._rect,400,"easeOutQuint")},_dropTest:function(){var t,e=this.getRenderBox();this._dropSucceedTarget=null;for(var n=0;n<this._dropTargetBoxes.length;n++)if(t=this._dropTargetBoxes[n],g.isBoxIntersect(e,t))return void(this._dropSucceedTarget=this._dropTargets[n])},_updateDropHint:function(){var t=this._dropSucceedTarget,e=this._lastSucceedTarget;t&&t==e||(e&&this._removeDropStyle(e),t&&this._addDropStyle(t),this._lastSucceedTarget=t)},_removeDropHint:function(){var t=this._lastSucceedTarget;t&&this._removeDropStyle(t)},_removeDropStyle:function(t){t._layout.bgRect.stroke("none"),this._rect.stroke("#3399ff",1)},_addDropStyle:function(t){t._layout.bgRect.stroke("rgb(254, 219, 0)",3),t.getRenderContainer().fxScale(1.25,1.25,150,"ease").fxScale(.8,.8,150,"ease")},dragStart:function(t){this._startPosition=t},dragMove:function(e){var n=10;if(this._startPosition){if(this._dragPosition=e,!this._dragMode){if(g.getDistance(this._dragPosition,this._startPosition)<n)return;if(!this._enterDragMode())return}var i=t.Vector.fromPoints(this._startPosition,this._dragPosition);this.setTranslate(i),this._dropTest(),this._updateDropHint()}},dragEnd:function(){this._startPosition=null,this._dragMode&&(this._dropSucceedTarget&&this._minder.execCommand("movetoparent",this._dragSources,this._dropSucceedTarget),this._leaveDragMode())}});r.registerModule("DragTree",function(){return{init:function(){this._dragBox=new b(this)},events:{mousedown:function(t){t.getTargetNode()&&t.getTargetNode()!=this.getRoot()&&this._dragBox.dragStart(t.getPosition())},mousemove:function(t){this._dragBox.dragMove(t.getPosition())},mouseup:function(){this._dragBox.dragEnd()}},commands:{movetoparent:v}}}),r.registerModule("DropFile",function(){function n(){var t=this.getPaper().getContainer();t.addEventListener("dragover",i),t.addEventListener("drop",o.bind(this))}function i(t){t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy"}function o(e){e.preventDefault(),e.stopPropagation();var n=this;if(t.Browser.ie&&Number(t.Browser.version)<10)return void alert("文件导入对IE浏览器仅支持10以上版本");var i=e.dataTransfer.files;if(i){var o=i[0],r=o.type||/(.)\w+$/.exec(o.name)[0];/xmind/g.test(r)?a(n,o,"xmind"):/mmap/g.test(r)?a(n,o,"mindmanager"):/mm/g.test(r)?s(n,o,"freemind"):s(n,o)}}function r(){u&&(c(this),l.setRemotePath(null,!1),this.execCommand("camera",this.getRoot()),setTimeout(function(){l.watchChanges(!0)},10),u=!1)}function a(t,n,i){l=l||e.social,l.watchChanges(!1),u=!0,t.importData(n,i)}function s(t,e,n){var i=new FileReader;i.onload=function(e){a(t,e.target.result,n)},i.readAsText(e)}function c(t){h=e.draftManager||(e.draftManager=new e.DraftManager(t)),h.create()}var l,h,u=!1;return{events:{ready:n,"import":r}}}),r.registerModule("KeyboardModule",function(){function t(t){var e,i=[];t.traverse(function(t){e=t.getRenderContainer().getRenderBox("top"),e.width&&e.height&&i.push({left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height,width:e.width,height:e.height,node:t,text:t.getText()})});for(var o=0;o<i.length;o++)n(i,o)}function e(t,e){var n,i,r,c,l,h,u;return n=o(t.left,e.left),i=a(t.right,e.right),r=o(t.top,e.top),c=a(t.bottom,e.bottom),l=i-n-t.width-e.width,h=c-r-t.height-e.height,u=0>l?h:0>h?l:s(l*l+h*h),{cx:u,cy:u}}function n(t,n){for(var i,o,r=t[n],a={},s=0;s<t.length;s++)s!=n&&(i=t[s],o=e(i,r),i.right<r.left&&(!a.left||o.cx<a.left.dist)&&(a.left={dist:o.cx,node:i.node}),i.left>r.right&&(!a.right||o.cx<a.right.dist)&&(a.right={dist:o.cx,node:i.node}),i.bottom<r.top&&(!a.top||o.cy<a.top.dist)&&(a.top={dist:o.cy,node:i.node}),i.top>r.bottom&&(!a.down||o.cy<a.down.dist)&&(a.down={dist:o.cy,node:i.node}));
r.node._nearestNodes={right:a.right&&a.right.node||null,top:a.top&&a.top.node||null,left:a.left&&a.left.node||null,down:a.down&&a.down.node||null}}function i(e,n){var i=e.getSelectedNode();if(!i)return e.select(e.getRoot()),void t(e.getRoot());var o=i._nearestNodes[n];o&&e.select(o,!0)}var o=Math.min,a=Math.max,s=(Math.abs,Math.sqrt);return Math.exp,{events:{contentchange:function(){t(this.getRoot())},"normal.keydown":function(t){var e=r.keymap,n=t.getTargetNode();switch(this.receiver.keydownNode=n,t.originEvent.keyCode){case e.Enter:this.execCommand("appendSiblingNode",new c(this.getLang().topic),!0),t.preventDefault();break;case e.Tab:this.execCommand("appendChildNode",new c(this.getLang().topic),!0),t.preventDefault();break;case e.Backspace:case e.Del:t.preventDefault(),this.execCommand("removenode");break;case e.F2:t.preventDefault(),this.execCommand("editnode");break;case e.Left:i(this,"left"),t.preventDefault();break;case e.Up:i(this,"top"),t.preventDefault();break;case e.Right:i(this,"right"),t.preventDefault();break;case e.Down:i(this,"down"),t.preventDefault()}}}}}),r.registerModule("Select",function(){var e=this,n=r.Geometry,i=function(){var i=null,o=(new t.Path).fill("rgba(255,255,255,.3)").stroke("white"),r=!1,a=10;return{selectStart:function(t){return t.originEvent.button?void 0:i?this.selectEnd():void(i=n.snapToSharp(t.getPosition()))},selectMove:function(t){if(!e.isTextEditStatus()&&i){var s=i,c=t.getPosition();if(!r){if(n.getDistance(s,c)<a)return;r=!0,e.getPaper().addShape(o),o.setOpacity(.8).getDrawer().clear()}var l=n.getBox(s,c),h=[];n.snapToSharp(l),o.getDrawer().pipe(function(){this.clear(),this.moveTo(l.left,l.top),this.lineTo(l.right,l.top),this.lineTo(l.right,l.bottom),this.lineTo(l.left,l.bottom),this.close()}),e.getRoot().traverse(function(t){var e=t.getRenderContainer().getRenderBox("top");n.isBoxIntersect(e,l)&&h.push(t)}),e.select(h,!0)}},selectEnd:function(){i&&(i=null),r&&(o.fadeOut(200,"ease",0,function(){o.remove&&o.remove()}),r=!1)}}}(),o=null;return{events:{"normal.mousedown textedit.mousedown":function(t){var e=t.getTargetNode();e?t.originEvent.shiftKey?this.toggleSelect(e):e.isSelected()?this.isSingleSelect()||(o=e):this.select(e,!0):(this.removeAllSelectedNodes(),i.selectStart(t),this.setStatus("normal"))},"normal.mousemove textedit.mousemove":i.selectMove,"normal.mouseup textedit.mouseup":function(t){var e=t.getTargetNode();e&&e==o&&(this.select(o,!0),o=null),i.selectEnd(t)}}}}),r.registerModule("TextEditModule",function(){var t=this,e=new h.Selection,n=new h.Receiver(this),i=new h.Range;this.receiver=n;var o,r=!1,a=0,s=1;t.isTextEditStatus=function(){return t.receiver.isTextEditStatus()},t.textEditNode=function(t){var o=t.getTextShape();this.setStatus("textedit"),e.setHide(),e.setStartOffset(0),e.setEndOffset(o.getContent().length),n.setTextEditStatus(!0).setSelection(e).setKityMinder(this).setMinderNode(t).setTextShape(o).setRange(i).setBaseOffset().setContainerStyle().setSelectionHeight().setContainerTxt(o.getContent()).updateTextData().updateSelectionShow().updateRange(i).setTextEditStatus(!0),e.setData("relatedNode",t)};var c=!1;return{events:{afterinitstyle:function(){this.getRenderContainer().addShape(e)},"normal.beforemousedown textedit.beforemousedown":function(a){if(a.isRightMB())return void a.stopPropagationImmediately();e.setHide();var s=a.getTargetNode();if(!s){var l=a.kityEvent.targetShape;l&&"Selection"==l.getType()&&(c=!0,s=l.getData("relatedNode"),a.stopPropagationImmediately()),"textedit"==this.getStatus()&&this.fire("contentchange"),t.setStatus("normal")}if(s){var h=s.getTextShape();h.setStyle("cursor","default"),this.isSingleSelect()&&s.isSelected()&&(e.collapse(),s.getTextShape().setStyle("cursor","text"),t.setStatus("textedit"),n.setTextEditStatus(!0).setSelection(e).setKityMinder(this).setMinderNode(s).setTextShape(h).setBaseOffset().setContainerStyle().setSelectionHeight().setCurrentIndex(a.getPosition(this.getRenderContainer())).updateSelection().setRange(i),e.setData("relatedNode",s),r=!0,o=a.getPosition(),c&&(e.setShow(),c=!1),t.setStatus("textedit"))}},"normal.beforekeydown":function(e){var o=this.getSelectedNode();if(o&&this.isSingleSelect()&&o.isSelected()){var r=e.originEvent.keyCode;if(!d.notContentInput[r]&&0!=i.nativeSel.rangeCount){var a=i.nativeSel.getRangeAt(0);a&&(a.startContainer===n.container||n.container.contains(a.startContainer))&&t.setStatus("textedit")}}},"normal.keyup":function(o){var r=this.getSelectedNode();if(r&&this.isSingleSelect()&&r.isSelected()){var a=o.originEvent.keyCode;if(d.isSelectedNodeKey[a]&&"textedit"!=t.getStatus()){var s=r.getTextShape();e.setHide(),e.setStartOffset(0),e.setEndOffset(s.getContent().length),n.setTextEditStatus(!0).setSelection(e).setKityMinder(this).setMinderNode(r).setTextShape(s).setRange(i).setBaseOffset().setContainerStyle().setSelectionHeight().setContainerTxt(s.getContent()).updateRange(i).setTextEditStatus(!0),e.setData("relatedNode",r)}}},"normal.mouseup textedit.mouseup":function(t){if(r)if(e.collapsed)e.setShow();else try{n.updateRange(i)}catch(t){console.log(t)}else{var o=t.getTargetNode();if(o&&this.isSingleSelect()&&o.isSelected()){var s=o.getTextShape();e.setHide(),e.setStartOffset(0),e.setEndOffset(s.getContent().length),n.setTextEditStatus(!0).setSelection(e).setKityMinder(this).setMinderNode(o).setTextShape(s).setRange(i).setBaseOffset().setContainerStyle().setSelectionHeight().setContainerTxt(s.getContent()).updateRange(i).setTextEditStatus(!0),e.setData("relatedNode",o)}}r=!1,a=0},"textedit.beforemousemove":function(t){if(r){t.stopPropagationImmediately();var i=t.getPosition(this.getRenderContainer());if(Math.abs(i.y-o.y)>=2&&Math.abs(o.x-i.x)<=2)return e.setHide(),void(r=!1);s=i.x>o.x?1:i.x<o.x?-1:s,n.updateSelectionByMousePosition(i,s).updateSelectionShow(s),o=t.getPosition()}},"normal.dblclick textedit.dblclick":function(o){var r=o.kityEvent.targetShape;"text"==r.getType().toLowerCase()&&(e.setStartOffset(0),e.setEndOffset(r.getContent().length),e.setShow(),n.setContainerTxt(r.getContent()).updateSelectionShow(1).updateRange(i).setTextEditStatus(!0),t.setStatus("textedit"))},restoreScene:function(){e.setHide()},stopTextEdit:function(){e.setHide(),n.clear().setTextEditStatus(!1),t.setStatus("normal")},resize:function(){e.setHide()},execCommand:function(o){var r={appendchildnode:1,appendsiblingnode:1,editnode:1};if(r[o.commandName]){var a=t.getSelectedNode();if(!a)return;var s=a.getTextShape();return s.setStyle("cursor","default"),a.getTextShape().setStyle("cursor","text"),t.setStatus("textedit"),n.setTextEditStatus(!0).setSelection(e).setKityMinder(this).setMinderNode(a).setTextShape(s).setBaseOffset().setContainerStyle().setSelectionHeight().getTextOffsetData().setIndex(0).updateSelection().setRange(i),e.setStartOffset(0),e.setEndOffset(s.getContent().length),e.setShow(),void n.updateSelectionShow(1).updateRange(i)}return"priority"!=o.commandName&&"progress"!=o.commandName||"textedit"!=this.getStatus()?(n.clear().setTextEditStatus(!1),void("textedit"==this.getStatus()&&this.setStatus("normal"))):(n.setBaseOffset().getTextOffsetData(),void(e.collapsed?n.updateSelection():n.updateSelectionShow(1)))},selectionclear:function(){t.setStatus("normal"),n.setTextEditStatus(!1).clear()},blur:function(){n.clear()},"textedit.mousewheel":function(){n.setContainerStyle()}}}}),h.Range=t.createClass("Range",{constructor:function(){this.nativeRange=document.createRange(),this.nativeSel=e.getSelection()},hasNativeRange:function(){return 0!=this.nativeSel.rangeCount},select:function(){var t=this.nativeRange.startContainer;if(1==t.nodeType&&0==t.childNodes.length){var e=document.createTextNode("​");t.appendChild(e),this.nativeRange.setStart(e,1),this.nativeRange.collapse(!0)}try{this.nativeSel.removeAllRanges()}catch(n){}return this.nativeSel.addRange(this.nativeRange),this},setStart:function(t,e){try{this.nativeRange.setStart(t,e)}catch(n){console.log("e")}return this},setEnd:function(t,e){return this.nativeRange.setEnd(t,e),this},getStart:function(){var t=this.nativeSel.getRangeAt(0);return{startContainer:t.startContainer,startOffset:t.startOffset}},collapse:function(t){return this.nativeRange.collapse(t===!0),this},insertNode:function(t){return this.nativeRange.insertNode(t),this},updateNativeRange:function(){return this.nativeRange=this.nativeSel.getRangeAt(0),this}}),h.Receiver=t.createClass("Receiver",{clear:function(){return this.container.innerHTML="",this.selection&&this.selection.setHide(),this.range&&this.range.nativeSel.removeAllRanges(),this.index=0,this.inputLength=0,this.isTypeText=!1,this},setTextEditStatus:function(t){return this.textEditStatus=t||!1,this},isTextEditStatus:function(){return this.textEditStatus},constructor:function(t){var e=this;this.setKityMinder(t),this.textEditStatus=!1;var n=document.createElement("div");n.setAttribute("contenteditable",!0),n.className="km_receiver",this.container=document.body.insertBefore(n,document.body.firstChild),f.ie&&11==f.version&&a.listen(this.container,"keydown keypress keyup",function(t){e.keyboardEvents.call(e,new l("keyup"==t.type?"beforekeyup":t.type,t))}),a.addCssRule("km_receiver_css"," .km_receiver{white-space:nowrap;position:absolute;padding:0;margin:0;word-wrap:break-word;clip:rect(1em 1em 1em 1em);}"),this.km.on("textedit.beforekeyup textedit.keydown textedit.keypress textedit.paste",a.proxy(this.keyboardEvents,this)),this.timer=null,this.index=0},setRange:function(t,e){this.index=e||this.index;var n=this.container.firstChild;this.range=t,t.setStart(n||this.container,this.index).collapse(!0);var i=this;return setTimeout(function(){i.container.focus(),t.select()}),this},setTextShape:function(e){return e||(e=new t.Text),this.textShape=e,this.container.innerHTML=a.unhtml(e.getContent()),this},setTextShapeSize:function(t){return this.textShape.setSize(t),this},getTextShapeHeight:function(){return this.textShape.getRenderBox().height},appendTextShapeToPaper:function(t){return t.addShape(this.textShape),this},setKityMinder:function(t){return this.km=t,this},setMinderNode:function(t){return this.minderNode=t,this},keyboardEvents:function(t){function e(){if(n.range.hasNativeRange()){var t=n.container.textContent.replace(/[\u200b\t\r\n]/g,"");0==n.textShape.getOpacity()&&n.textShape.setOpacity(1),f.gecko&&/\s$/.test(t)&&(t+="​"),n.minderNode.setText(t),0==t.length&&n.minderNode.setText("|"),n.setContainerStyle(),n.km.updateLayout(n.minderNode),n.textShape=n.minderNode.getTextShape(),0==t.length&&n.textShape.setOpacity(0),n.setBaseOffset(),n.updateTextData(),n.updateIndex(),n.updateSelection(),n.timer=setTimeout(function(){n.selection.setShow()},500)}}clearTimeout(this.timer);var n=this,i=t.originEvent,o=i.keyCode,s=r.keymap;switch(t.type){case"keydown":switch(this.isTypeText=229==o||0===o,o){case s.Enter:case s.Tab:return this.selection.setHide(),this.clear().setTextEditStatus(!1),this.km.fire("contentchange"),this.km.setStatus("normal"),void t.preventDefault();case d.Shift:case d.Control:case d.Alt:case d.Cmd:return}if(t.originEvent.ctrlKey||t.originEvent.metaKey)return o==d.v&&setTimeout(function(){n.range.updateNativeRange().insertNode($("<span>$$_kityminder_bookmark_$$</span>")[0]),n.container.innerHTML=a.unhtml(n.container.textContent.replace(/[\u200b\t\r\n]/g,""));var t=n.container.textContent.indexOf("$$_kityminder_bookmark_$$");n.container.textContent=n.container.textContent.replace("$$_kityminder_bookmark_$$",""),n.range.setStart(n.container.firstChild,t).collapse(!0).select(),e()},100),void(o==d.x&&setTimeout(function(){e()},100));setTimeout(function(){e()});break;case"beforekeyup":switch(o){case d.Enter:case d.Tab:case d.F2:return d.Enter==o&&(this.isTypeText||f.mac&&f.gecko)&&e(),this.keydownNode===this.minderNode&&(this.rollbackStatus(),this.setTextEditStatus(!1),this.clear()),void t.preventDefault();case d.Del:case d.Backspace:case d.Spacebar:return void e()}return this.isTypeText&&e(),f.mac&&f.gecko&&e(),!0}},updateIndex:function(){return this.index=this.range.getStart().startOffset,this},updateTextData:function(){return this.textShape.textData=this.getTextOffsetData(),this},setSelection:function(t){return this.selection=t,this},updateSelection:function(){return this.selection.setShowHold(),this.selection.bringTop(),this.selection.setStartOffset(this.index).collapse(!0),this.selection.setPosition(this.index==this.textData.length?0==this.index?this.getBaseOffset():{x:this.textData[this.index-1].x+this.textData[this.index-1].width,y:this.textData[this.index-1].y}:this.textData[this.index]),this},getBaseOffset:function(t){var e=this.textShape.getRenderBox(t||this.km.getRenderContainer());return e},setBaseOffset:function(){return this.offset=this.textShape.getRenderBox(this.km.getRenderContainer()),this},setContainerStyle:function(){var t=this.getBaseOffset("screen");if(this.container.style.cssText=";left:"+t.x+"px;top:"+(t.y+.1*t.height)+"px;width:"+t.width+"px;height:"+t.height+"px;",!this.selection.isShow()){var e=this.km.getPaper(),n=e.node.parentNode.clientWidth,i=e.node.parentNode.clientHeight;n<this.container.offsetWidth+this.container.offsetLeft?(this.km.getRenderContainer().translate(n/-3,0),this.setContainerStyle()):i<this.container.offsetTop+this.container.offsetHeight&&(this.km.getRenderContainer().translate(0,i/-3),this.setContainerStyle())}return this},getTextOffsetData:function(){var t=this.textShape.getContent();this.textData=[];for(var e=0,n=t.length;n>e;e++){try{var i=this.textShape.getExtentOfChar(e)}catch(o){console.log(o)}this.textData.push({x:i.x+this.offset.x,y:this.offset.y,width:i.width,height:i.height})}return this},setCurrentIndex:function(t){var e=this;this.getTextOffsetData();var n=!1;return a.each(this.textData,function(i,o){return 0==i&&t.x<=o.x?(e.index=0,!1):t.x>=o.x&&t.x<=o.x+o.width?(e.index=t.x-o.x>o.width/2?i+1:i,n=!0,!1):i==e.textData.length-1&&t.x>=o.x?(e.index=e.textData.length,!1):void 0}),this},setSelectionHeight:function(){return this.selection.setHeight(this.getTextShapeHeight()),this},updateSelectionByMousePosition:function(t,e){var n=this;return a.each(this.textData,function(i,o){return 0==i&&t.x<=o.x?(n.selection.setStartOffset(0),!1):i==n.textData.length-1&&t.x>=o.x?(n.selection.setEndOffset(n.textData.length),!1):t.x>=o.x&&t.x<=o.x+o.width?(n.index==i?(0==i&&n.selection.setStartOffset(i),t.x<=o.x+o.width/2?n.selection.collapse():n.selection.setEndOffset(i+((n.selection.endOffset>i||1==e)&&i!=n.textData.length-1?1:0))):i>n.index?(n.selection.setStartOffset(n.index),n.selection.setEndOffset(i+1)):(n.selection.setStartOffset(1==e?i+(t.x>=o.x+o.width/2&&i!=n.textData.length-1?1:0):i),n.selection.setEndOffset(n.index)),!1):void 0}),this},updateSelectionShow:function(){var t=this.textData[this.selection.startOffset],e=this.textData[this.selection.endOffset],n=0;if(this.selection.collapsed)return this.selection.updateShow(t||this.textData[this.textData.length-1],1),this;if(e)n=e.x-t.x;else try{var i=this.textData[this.textData.length-1];n=i.x-t.x+i.width}catch(o){console.log("e")}return this.selection.updateShow(t,n),this},updateRange:function(t){var e=this.container.firstChild;return t.setStart(e,this.selection.startOffset),t.setEnd(e,this.selection.endOffset),t.select(),this},setIndex:function(t){return this.index=t,this},setContainerTxt:function(t){return this.container.textContent=t,this}}),h.Selection=t.createClass("Selection",{base:t.Rect,constructor:function(t,e,n){this.callBase(),this.height=t||20,this.setAttr("id","_kity_selection"),this.stroke(e||"rgb(27,171,255)",n||1),this.width=0,this.fill("rgb(27,171,255)"),this.setHide(),this.timer=null,this.collapsed=!0,this.startOffset=this.endOffset=0,this.setOpacity(.5),this.setStyle("cursor","text"),this._show=!1},collapse:function(t){return this.stroke("rgb(27,171,255)",1),this.setOpacity(1),this.width=1,this.collapsed=!0,t?this.startOffset=this.endOffset:this.endOffset=this.startOffset,this},setStartOffset:function(t){this.startOffset=t;var e=this.startOffset;if(this.startOffset>this.endOffset)this.startOffset=this.endOffset,this.endOffset=e;else if(this.startOffset==this.endOffset)return this.collapse(),this;return this.collapsed=!1,this.stroke("none",0),this.setOpacity(.5),this},setEndOffset:function(t){this.endOffset=t;var e=this.endOffset;if(this.endOffset<this.startOffset)this.endOffset=this.startOffset,this.startOffset=e;else if(this.startOffset==this.endOffset)return this.collapse(),this;return this.collapsed=!1,this.stroke("none",0),this.setOpacity(.5),this},updateShow:function(t,e){return e&&this.setShowHold(),this.setPosition(t).setWidth(e),this.setOpacity(0==e?0:.5),this.bringTop(),this},setPosition:function(t){try{this.x=t.x,this.y=t.y}catch(e){console.log(e)}return this.update()},setHeight:function(t){this.height=t},setHide:function(){return clearInterval(this.timer),this.setStyle("display","none"),this._show=!1,this},setShowHold:function(){return clearInterval(this.timer),this.setStyle("display",""),this._show=!0,this},setShow:function(){clearInterval(this.timer);var t=this,e="";return t.setStyle("display",""),t._show=!0,this.collapsed&&(t.setOpacity(1),this.timer=setInterval(function(){t.setStyle("display",e),e=e?"":"none"},400)),this},isShow:function(){return this._show},setTextShape:function(e){return this.text=e?e:new t.Text,this},getTextShape:function(){return this.text},setTxtContent:function(t){this.text.setContent(t)},updatePosition:function(){}}),r.registerModule("basestylemodule",function(){var e=this;return{commands:{bold:t.createClass("boldCommand",{base:s,execute:function(){var t=e.getSelectedNodes();1==this.queryState("bold")?a.each(t,function(t,n){n.setData("bold"),n.getTextShape().setAttr("font-weight"),e.updateLayout(n)}):a.each(t,function(t,n){n.setData("bold",!0),n.getTextShape().setAttr("font-weight","bold"),e.updateLayout(n)})},queryState:function(){var t=e.getSelectedNodes(),n=0;return 0==t.length?-1:(a.each(t,function(t,e){return e&&e.getData("bold")?(n=1,!1):void 0}),n)}}),italic:t.createClass("italicCommand",{base:s,execute:function(){var t=e.getSelectedNodes();1==this.queryState("italic")?a.each(t,function(t,n){n.setData("italic"),n.getTextShape().setAttr("font-style"),e.updateLayout(n)}):a.each(t,function(t,n){n.setData("italic",!0),n.getTextShape().setAttr("font-style","italic"),e.updateLayout(n)})},queryState:function(){var t=e.getSelectedNodes(),n=0;return 0==t.length?-1:(a.each(t,function(t,e){return e&&e.getData("italic")?(n=1,!1):void 0}),n)}})},addShortcutKeys:{bold:"ctrl+b",italic:"ctrl+i"},events:{afterrendernodecenter:function(t){t.node.getData("bold")&&t.node.getTextShape().setAttr("font-weight","bold"),t.node.getData("italic")&&t.node.getTextShape().setAttr("font-style","italic")}}}}),r.registerModule("fontmodule",function(){return{defaultOptions:{fontfamily:[{name:"songti",val:"宋体,SimSun"},{name:"yahei",val:"微软雅黑,Microsoft YaHei"},{name:"kaiti",val:"楷体,楷体_GB2312, SimKai"},{name:"heiti",val:"黑体, SimHei"},{name:"lishu",val:"隶书, SimLi"},{name:"andaleMono",val:"andale mono"},{name:"arial",val:"arial, helvetica,sans-serif"},{name:"arialBlack",val:"arial black,avant garde"},{name:"comicSansMs",val:"comic sans ms"},{name:"impact",val:"impact,chicago"},{name:"timesNewRoman",val:"times new roman"},{name:"sans-serif",val:"sans-serif"}],fontsize:[10,12,16,18,24,32,48]},commands:{forecolor:t.createClass("fontcolorCommand",{base:s,execute:function(t,e){var n=t.getSelectedNodes();a.each(n,function(t,n){n.setData("fontcolor",e),n.getTextShape().fill(e)})},queryState:function(t){return 0==t.getSelectedNodes().length?-1:0}}),fontfamily:t.createClass("fontfamilyCommand",{base:s,execute:function(t,e){var n=t.getSelectedNodes();a.each(n,function(n,i){i.setData("fontfamily",e),i.getTextShape().setAttr("font-family",e),t.updateLayout(i)})},queryState:function(t){return 0==t.getSelectedNodes().length?-1:0}}),fontsize:t.createClass("fontsizeCommand",{base:s,execute:function(t,e){var n=t.getSelectedNodes();a.each(n,function(n,i){i.setData("fontsize",e),i.getTextShape().setSize(e),t.updateLayout(i)})},queryState:function(t){return 0==t.getSelectedNodes().length?-1:0}})},events:{afterrendernodecenter:function(t){var e;(e=t.node.getData("fontfamily"))&&t.node.getTextShape().setAttr("font-family",e),(e=t.node.getData("fontcolor"))&&t.node.getTextShape().fill(e),(e=t.node.getData("fontsize"))&&t.node.getTextShape().setSize(e)}}}}),r.registerModule("Zoom",function(){function e(e,i){var o=e.getPaper(),r=o.getViewPort();if(i){var a=new t.Animator({beginValue:r.zoom,finishValue:i/100,setter:function(t,e){r.zoom=e,t.setViewPort(r)}});e.zoom=i,n&&n.pause(),n=a.start(o,500,"ease")}}var n,i=this;i.setOptions("zoom",[50,80,100,120,150,200]);var o=t.createClass("Zoom",{base:s,execute:e,queryValue:function(t){return t.zoom}}),r=t.createClass("ZoomInCommand",{base:s,execute:function(t){e(t,this.nextValue(t))},queryState:function(t){return~this.nextValue(t)},nextValue:function(t){var e,n=t.getOptions("zoom");for(e=0;e<n.length;e++)if(n[e]>t.zoom)return n[e];return 0},enableReadOnly:!1}),a=t.createClass("ZoomOutCommand",{base:s,execute:function(t){e(t,this.nextValue(t))},queryState:function(t){return~this.nextValue(t)},nextValue:function(t){var e,n=t.getOptions("zoom");for(e=n.length-1;e>=0;e--)if(n[e]<t.zoom)return n[e];return 0},enableReadOnly:!1});return{init:function(){this.zoom=100},commands:{"zoom-in":r,"zoom-out":a,zoom:o},events:{"normal.keydown":function(t){var e=this,n=t.originEvent,i=n.keyCode||n.which;d["="]==i&&e.execCommand("zoom-in"),d["-"]==i&&e.execCommand("zoom-out")},ready:function(){this._zoomValue=1},"normal.mousewheel readonly.mousewheel":function(e){if(e.originEvent.ctrlKey){var n=e.originEvent.wheelDelta,i=this;t.Browser.mac||(n=-n),Math.abs(n)>100&&(clearTimeout(this._wheelZoomTimeout),this._wheelZoomTimeout=setTimeout(function(){i.getPaper()._zoom||1,0>n?i.execCommand("zoom-in"):n>0&&i.execCommand("zoom-out")},100),e.originEvent.preventDefault())}}}}}),r.registerModule("NodeText",function(){return{events:{renderNodeCenter:function(e){var n=e.node,i=n.getContRc().getWidth(),o=new t.Text(n.getData("text")||"");o.setAttr("_nodeTextShape",!0),n.getContRc().appendShape(o);var r=this.getCurrentLayoutStyle()[n.getType()];o.fill(r.color).setSize(r.fontSize),o.setTranslate(i+r.spaceLeft,0),o.setVerticalAlign("middle")}}}}),r.registerModule("hyperlink",function(){var e="M16.614,10.224h-1.278c-1.668,0-3.07-1.07-3.599-2.556h4.877c0.707,0,1.278-0.571,1.278-1.278V3.834 c0-0.707-0.571-1.278-1.278-1.278h-4.877C12.266,1.071,13.668,0,15.336,0h1.278c2.116,0,3.834,1.716,3.834,3.834V6.39 C20.448,8.508,18.73,10.224,16.614,10.224z M5.112,5.112c0-0.707,0.573-1.278,1.278-1.278h7.668c0.707,0,1.278,0.571,1.278,1.278 S14.765,6.39,14.058,6.39H6.39C5.685,6.39,5.112,5.819,5.112,5.112z M2.556,3.834V6.39c0,0.707,0.573,1.278,1.278,1.278h4.877 c-0.528,1.486-1.932,2.556-3.599,2.556H3.834C1.716,10.224,0,8.508,0,6.39V3.834C0,1.716,1.716,0,3.834,0h1.278 c1.667,0,3.071,1.071,3.599,2.556H3.834C3.129,2.556,2.556,3.127,2.556,3.834z";return{commands:{hyperlink:t.createClass("hyperlink",{base:s,execute:function(t,e){var n=t.getSelectedNodes();a.each(n,function(n,i){i.setData("hyperlink",e),t.updateLayout(i)})},queryState:function(t){var e=t.getSelectedNodes(),n=0;return 0==e.length?-1:(a.each(e,function(t,e){return e&&e.getData("hyperlink")?(n=0,!1):void 0}),n)},queryValue:function(t){var e=t.getSelectedNode();return e.getData("hyperlink")}}),unhyperlink:t.createClass("hyperlink",{base:s,execute:function(t){var e=t.getSelectedNodes();a.each(e,function(e,n){n.setData("hyperlink"),t.updateLayout(n)})},queryState:function(t){var e=t.getSelectedNodes();if(0==e.length)return-1;var n=!1;return a.each(e,function(t,e){return e.getData("hyperlink")?(n=!0,!1):void 0}),n?0:-1}})},events:{RenderNodeRight:function(n){var i,o=n.node;if(i=o.getData("hyperlink")){var r=new t.HyperLink(i),a=new t.Path,s=o.getContRc().getBoundaryBox(),c=this.getCurrentLayoutStyle()[o.getType()];a.setPathData(e).fill("#666").setTranslate(s.x+s.width+c.spaceLeft,-5),r.addShape(a),r.setTarget("_blank"),r.setStyle("cursor","pointer"),o.getContRc().addShape(r)}}}}}),r.registerModule("Expand",function(){function e(t,e){return function(i,o,r,a){var s,c,l;for(i.setData(n,o),a=a||1,s=i.getChildren(),l=0;l<s.length;l++)c=s[l],t>=a?r(c,o,r,a+1):e&&e(c,o,r,a+1)}}var n="expandState",i="expand",o="collapse",r=function(t,e){for(var n=[t];0!==n.length;)e(n[0]),n=n.concat(n[0].getChildren()),n.shift()},a=function(t){for(var e=[].concat(t),n=[],i=0;i<e.length;i++){var o=e[i].getParent();if(!o){n=[e[i]];break}for(;o;){if(-1!==e.indexOf(o)){e[i]=null;break}o=o.getParent()}e[i]&&n.push(e[i])}return n},l=function(t,e){var n=t.getSelectedNodes(),i=a(n);if(0===n.length||"root"===n[0].getType()||"root"===i[0].getType())r(t.getRoot(),function(t){"expand"===e?t.expand():t.collapse()}),t.initStyle();else for(var o=0;o<i.length;o++){var s=i[o],c=s.getChildren();if(0!==c.length){r(s,function(t){t!==s&&("expand"===e?t.expand():t.collapse())});var l;l="expand"===e?!s.isExpanded():s.isExpanded(),l?t.expandNode(s):(t.expandNode(s),t.expandNode(s))}}for(var h=0;h<n.length;h++)t.highlightNode(n[h])},h=c.EXPAND_POLICY={KEEP_STATE:function(t,e){t.setData(n,e)},generateDeepPolicy:e,DEEP_TO_CHILD:e(1),DEEP_TO_LEAF:e(Number.MAX_VALUE)};t.extendClass(c,{expand:function(t){return t=t||h.KEEP_STATE,t(this,i,t),this},collapse:function(t){return t=t||h.KEEP_STATE,t(this,o,t),this},isExpanded:function(){return this.getData(n)===i}});var u=t.createClass("ExpandNodeCommand",function(){return{base:s,execute:function(t){l(t,"expand")},queryState:function(){return 0}}}()),d=t.createClass("CollapseNodeCommand",function(){return{base:s,execute:function(t){l(t,"collapse")},queryState:function(){return 0}}}());return{events:{beforeimport:function(){}},addShortcutKeys:{ExpandNode:"ctrl+/",CollapseNode:"ctrl+."},commands:{ExpandNode:u,CollapseNode:d}}}),function(t,e){function n(e,n){var o,r,a,s=e.nodeName.toLowerCase();return"area"===s?(o=e.parentNode,r=o.name,e.href&&r&&"map"===o.nodeName.toLowerCase()?(a=t("img[usemap=#"+r+"]")[0],!!a&&i(a)):!1):(/input|select|textarea|button|object/.test(s)?!e.disabled:"a"===s?e.href||n:n)&&i(e)}function i(e){return t.expr.filters.visible(e)&&!t(e).parents().addBack().filter(function(){return"hidden"===t.css(this,"visibility")}).length}var o=0,r=/^ui-id-\d+$/;t.ui=t.ui||{},t.extend(t.ui,{version:"1.10.4",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),t.fn.extend({focus:function(e){return function(n,i){return"number"==typeof n?this.each(function(){var e=this;setTimeout(function(){t(e).focus(),i&&i.call(e)},n)}):e.apply(this,arguments)}}(t.fn.focus),scrollParent:function(){var e;return e=t.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?this.parents().filter(function(){return/(relative|absolute|fixed)/.test(t.css(this,"position"))&&/(auto|scroll)/.test(t.css(this,"overflow")+t.css(this,"overflow-y")+t.css(this,"overflow-x"))}).eq(0):this.parents().filter(function(){return/(auto|scroll)/.test(t.css(this,"overflow")+t.css(this,"overflow-y")+t.css(this,"overflow-x"))}).eq(0),/fixed/.test(this.css("position"))||!e.length?t(document):e},zIndex:function(n){if(n!==e)return this.css("zIndex",n);if(this.length)for(var i,o,r=t(this[0]);r.length&&r[0]!==document;){if(i=r.css("position"),("absolute"===i||"relative"===i||"fixed"===i)&&(o=parseInt(r.css("zIndex"),10),!isNaN(o)&&0!==o))return o;r=r.parent()}return 0},uniqueId:function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++o)})},removeUniqueId:function(){return this.each(function(){r.test(this.id)&&t(this).removeAttr("id")})}}),t.extend(t.expr[":"],{data:t.expr.createPseudo?t.expr.createPseudo(function(e){return function(n){return!!t.data(n,e)}}):function(e,n,i){return!!t.data(e,i[3])},focusable:function(e){return n(e,!isNaN(t.attr(e,"tabindex")))},tabbable:function(e){var i=t.attr(e,"tabindex"),o=isNaN(i);return(o||i>=0)&&n(e,!o)}}),t("<a>").outerWidth(1).jquery||t.each(["Width","Height"],function(n,i){function o(e,n,i,o){return t.each(r,function(){n-=parseFloat(t.css(e,"padding"+this))||0,i&&(n-=parseFloat(t.css(e,"border"+this+"Width"))||0),o&&(n-=parseFloat(t.css(e,"margin"+this))||0)}),n}var r="Width"===i?["Left","Right"]:["Top","Bottom"],a=i.toLowerCase(),s={innerWidth:t.fn.innerWidth,innerHeight:t.fn.innerHeight,outerWidth:t.fn.outerWidth,outerHeight:t.fn.outerHeight};t.fn["inner"+i]=function(n){return n===e?s["inner"+i].call(this):this.each(function(){t(this).css(a,o(this,n)+"px")})},t.fn["outer"+i]=function(e,n){return"number"!=typeof e?s["outer"+i].call(this,e):this.each(function(){t(this).css(a,o(this,e,!0,n)+"px")})}}),t.fn.addBack||(t.fn.addBack=function(t){return this.add(null==t?this.prevObject:this.prevObject.filter(t))}),t("<a>").data("a-b","a").removeData("a-b").data("a-b")&&(t.fn.removeData=function(e){return function(n){return arguments.length?e.call(this,t.camelCase(n)):e.call(this)}}(t.fn.removeData)),t.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),t.support.selectstart="onselectstart"in document.createElement("div"),t.fn.extend({disableSelection:function(){return this.bind((t.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(t){t.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),t.extend(t.ui,{plugin:{add:function(e,n,i){var o,r=t.ui[e].prototype;for(o in i)r.plugins[o]=r.plugins[o]||[],r.plugins[o].push([n,i[o]])},call:function(t,e,n){var i,o=t.plugins[e];if(o&&t.element[0].parentNode&&11!==t.element[0].parentNode.nodeType)for(i=0;o.length>i;i++)t.options[o[i][0]]&&o[i][1].apply(t.element,n)}},hasScroll:function(e,n){if("hidden"===t(e).css("overflow"))return!1;var i=n&&"left"===n?"scrollLeft":"scrollTop",o=!1;return e[i]>0?!0:(e[i]=1,o=e[i]>0,e[i]=0,o)}})}(jQuery),function(t,e){var n=0,i=Array.prototype.slice,o=t.cleanData;t.cleanData=function(e){for(var n,i=0;null!=(n=e[i]);i++)try{t(n).triggerHandler("remove")}catch(r){}o(e)},t.widget=function(n,i,o){var r,a,s,c,l={},h=n.split(".")[0];n=n.split(".")[1],r=h+"-"+n,o||(o=i,i=t.Widget),t.expr[":"][r.toLowerCase()]=function(e){return!!t.data(e,r)},t[h]=t[h]||{},a=t[h][n],s=t[h][n]=function(t,n){return this._createWidget?(arguments.length&&this._createWidget(t,n),e):new s(t,n)},t.extend(s,a,{version:o.version,_proto:t.extend({},o),_childConstructors:[]}),c=new i,c.options=t.widget.extend({},c.options),t.each(o,function(n,o){return t.isFunction(o)?(l[n]=function(){var t=function(){return i.prototype[n].apply(this,arguments)},e=function(t){return i.prototype[n].apply(this,t)};return function(){var n,i=this._super,r=this._superApply;return this._super=t,this._superApply=e,n=o.apply(this,arguments),this._super=i,this._superApply=r,n}}(),e):(l[n]=o,e)}),s.prototype=t.widget.extend(c,{widgetEventPrefix:a?c.widgetEventPrefix||n:n},l,{constructor:s,namespace:h,widgetName:n,widgetFullName:r}),a?(t.each(a._childConstructors,function(e,n){var i=n.prototype;t.widget(i.namespace+"."+i.widgetName,s,n._proto)}),delete a._childConstructors):i._childConstructors.push(s),t.widget.bridge(n,s)},t.widget.extend=function(n){for(var o,r,a=i.call(arguments,1),s=0,c=a.length;c>s;s++)for(o in a[s])r=a[s][o],a[s].hasOwnProperty(o)&&r!==e&&(n[o]=t.isPlainObject(r)?t.isPlainObject(n[o])?t.widget.extend({},n[o],r):t.widget.extend({},r):r);return n},t.widget.bridge=function(n,o){var r=o.prototype.widgetFullName||n;t.fn[n]=function(a){var s="string"==typeof a,c=i.call(arguments,1),l=this;return a=!s&&c.length?t.widget.extend.apply(null,[a].concat(c)):a,this.each(s?function(){var i,o=t.data(this,r);return o?t.isFunction(o[a])&&"_"!==a.charAt(0)?(i=o[a].apply(o,c),i!==o&&i!==e?(l=i&&i.jquery?l.pushStack(i.get()):i,!1):e):t.error("no such method '"+a+"' for "+n+" widget instance"):t.error("cannot call methods on "+n+" prior to initialization; attempted to call method '"+a+"'")
}:function(){var e=t.data(this,r);e?e.option(a||{})._init():t.data(this,r,new o(a,this))}),l}},t.Widget=function(){},t.Widget._childConstructors=[],t.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(e,i){i=t(i||this.defaultElement||this)[0],this.element=t(i),this.uuid=n++,this.eventNamespace="."+this.widgetName+this.uuid,this.options=t.widget.extend({},this.options,this._getCreateOptions(),e),this.bindings=t(),this.hoverable=t(),this.focusable=t(),i!==this&&(t.data(i,this.widgetFullName,this),this._on(!0,this.element,{remove:function(t){t.target===i&&this.destroy()}}),this.document=t(i.style?i.ownerDocument:i.document||i),this.window=t(this.document[0].defaultView||this.document[0].parentWindow)),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:t.noop,_getCreateEventData:t.noop,_create:t.noop,_init:t.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData(t.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:t.noop,widget:function(){return this.element},option:function(n,i){var o,r,a,s=n;if(0===arguments.length)return t.widget.extend({},this.options);if("string"==typeof n)if(s={},o=n.split("."),n=o.shift(),o.length){for(r=s[n]=t.widget.extend({},this.options[n]),a=0;o.length-1>a;a++)r[o[a]]=r[o[a]]||{},r=r[o[a]];if(n=o.pop(),1===arguments.length)return r[n]===e?null:r[n];r[n]=i}else{if(1===arguments.length)return this.options[n]===e?null:this.options[n];s[n]=i}return this._setOptions(s),this},_setOptions:function(t){var e;for(e in t)this._setOption(e,t[e]);return this},_setOption:function(t,e){return this.options[t]=e,"disabled"===t&&(this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!e).attr("aria-disabled",e),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")),this},enable:function(){return this._setOption("disabled",!1)},disable:function(){return this._setOption("disabled",!0)},_on:function(n,i,o){var r,a=this;"boolean"!=typeof n&&(o=i,i=n,n=!1),o?(i=r=t(i),this.bindings=this.bindings.add(i)):(o=i,i=this.element,r=this.widget()),t.each(o,function(o,s){function c(){return n||a.options.disabled!==!0&&!t(this).hasClass("ui-state-disabled")?("string"==typeof s?a[s]:s).apply(a,arguments):e}"string"!=typeof s&&(c.guid=s.guid=s.guid||c.guid||t.guid++);var l=o.match(/^(\w+)\s*(.*)$/),h=l[1]+a.eventNamespace,u=l[2];u?r.delegate(u,h,c):i.bind(h,c)})},_off:function(t,e){e=(e||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,t.unbind(e).undelegate(e)},_delay:function(t,e){function n(){return("string"==typeof t?i[t]:t).apply(i,arguments)}var i=this;return setTimeout(n,e||0)},_hoverable:function(e){this.hoverable=this.hoverable.add(e),this._on(e,{mouseenter:function(e){t(e.currentTarget).addClass("ui-state-hover")},mouseleave:function(e){t(e.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(e){this.focusable=this.focusable.add(e),this._on(e,{focusin:function(e){t(e.currentTarget).addClass("ui-state-focus")},focusout:function(e){t(e.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(e,n,i){var o,r,a=this.options[e];if(i=i||{},n=t.Event(n),n.type=(e===this.widgetEventPrefix?e:this.widgetEventPrefix+e).toLowerCase(),n.target=this.element[0],r=n.originalEvent)for(o in r)o in n||(n[o]=r[o]);return this.element.trigger(n,i),!(t.isFunction(a)&&a.apply(this.element[0],[n].concat(i))===!1||n.isDefaultPrevented())}},t.each({show:"fadeIn",hide:"fadeOut"},function(e,n){t.Widget.prototype["_"+e]=function(i,o,r){"string"==typeof o&&(o={effect:o});var a,s=o?o===!0||"number"==typeof o?n:o.effect||n:e;o=o||{},"number"==typeof o&&(o={duration:o}),a=!t.isEmptyObject(o),o.complete=r,o.delay&&i.delay(o.delay),a&&t.effects&&t.effects.effect[s]?i[e](o):s!==e&&i[s]?i[s](o.duration,o.easing,r):i.queue(function(n){t(this)[e](),r&&r.call(i[0]),n()})}})}(jQuery),function(t){var e=!1;t(document).mouseup(function(){e=!1}),t.widget("ui.mouse",{version:"1.10.4",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var e=this;this.element.bind("mousedown."+this.widgetName,function(t){return e._mouseDown(t)}).bind("click."+this.widgetName,function(n){return!0===t.data(n.target,e.widgetName+".preventClickEvent")?(t.removeData(n.target,e.widgetName+".preventClickEvent"),n.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&t(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(n){if(!e){this._mouseStarted&&this._mouseUp(n),this._mouseDownEvent=n;var i=this,o=1===n.which,r="string"==typeof this.options.cancel&&n.target.nodeName?t(n.target).closest(this.options.cancel).length:!1;return o&&!r&&this._mouseCapture(n)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){i.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(n)&&this._mouseDelayMet(n)&&(this._mouseStarted=this._mouseStart(n)!==!1,!this._mouseStarted)?(n.preventDefault(),!0):(!0===t.data(n.target,this.widgetName+".preventClickEvent")&&t.removeData(n.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(t){return i._mouseMove(t)},this._mouseUpDelegate=function(t){return i._mouseUp(t)},t(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),n.preventDefault(),e=!0,!0)):!0}},_mouseMove:function(e){return t.ui.ie&&(!document.documentMode||9>document.documentMode)&&!e.button?this._mouseUp(e):this._mouseStarted?(this._mouseDrag(e),e.preventDefault()):(this._mouseDistanceMet(e)&&this._mouseDelayMet(e)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,e)!==!1,this._mouseStarted?this._mouseDrag(e):this._mouseUp(e)),!this._mouseStarted)},_mouseUp:function(e){return t(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,e.target===this._mouseDownEvent.target&&t.data(e.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(e)),!1},_mouseDistanceMet:function(t){return Math.max(Math.abs(this._mouseDownEvent.pageX-t.pageX),Math.abs(this._mouseDownEvent.pageY-t.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}})}(jQuery),function(t){t.widget("ui.draggable",t.ui.mouse,{version:"1.10.4",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"!==this.options.helper||/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative"),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._mouseInit()},_destroy:function(){this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._mouseDestroy()},_mouseCapture:function(e){var n=this.options;return this.helper||n.disabled||t(e.target).closest(".ui-resizable-handle").length>0?!1:(this.handle=this._getHandle(e),this.handle?(t(n.iframeFix===!0?"iframe":n.iframeFix).each(function(){t("<div class='ui-draggable-iframeFix' style='background: #fff;'></div>").css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e3}).css(t(this).offset()).appendTo("body")}),!0):!1)},_mouseStart:function(e){var n=this.options;return this.helper=this._createHelper(e),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),t.ui.ddmanager&&(t.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(),this.offsetParent=this.helper.offsetParent(),this.offsetParentCssPosition=this.offsetParent.css("position"),this.offset=this.positionAbs=this.element.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},this.offset.scroll=!1,t.extend(this.offset,{click:{left:e.pageX-this.offset.left,top:e.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this.position=this._generatePosition(e),this.originalPageX=e.pageX,this.originalPageY=e.pageY,n.cursorAt&&this._adjustOffsetFromHelper(n.cursorAt),this._setContainment(),this._trigger("start",e)===!1?(this._clear(),!1):(this._cacheHelperProportions(),t.ui.ddmanager&&!n.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e),this._mouseDrag(e,!0),t.ui.ddmanager&&t.ui.ddmanager.dragStart(this,e),!0)},_mouseDrag:function(e,n){if("fixed"===this.offsetParentCssPosition&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(e),this.positionAbs=this._convertPositionTo("absolute"),!n){var i=this._uiHash();if(this._trigger("drag",e,i)===!1)return this._mouseUp({}),!1;this.position=i.position}return this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),t.ui.ddmanager&&t.ui.ddmanager.drag(this,e),!1},_mouseStop:function(e){var n=this,i=!1;return t.ui.ddmanager&&!this.options.dropBehaviour&&(i=t.ui.ddmanager.drop(this,e)),this.dropped&&(i=this.dropped,this.dropped=!1),"original"!==this.options.helper||t.contains(this.element[0].ownerDocument,this.element[0])?("invalid"===this.options.revert&&!i||"valid"===this.options.revert&&i||this.options.revert===!0||t.isFunction(this.options.revert)&&this.options.revert.call(this.element,i)?t(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){n._trigger("stop",e)!==!1&&n._clear()}):this._trigger("stop",e)!==!1&&this._clear(),!1):!1},_mouseUp:function(e){return t("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),t.ui.ddmanager&&t.ui.ddmanager.dragStop(this,e),t.ui.mouse.prototype._mouseUp.call(this,e)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(e){return this.options.handle?!!t(e.target).closest(this.element.find(this.options.handle)).length:!0},_createHelper:function(e){var n=this.options,i=t.isFunction(n.helper)?t(n.helper.apply(this.element[0],[e])):"clone"===n.helper?this.element.clone().removeAttr("id"):this.element;return i.parents("body").length||i.appendTo("parent"===n.appendTo?this.element[0].parentNode:n.appendTo),i[0]===this.element[0]||/(fixed|absolute)/.test(i.css("position"))||i.css("position","absolute"),i},_adjustOffsetFromHelper:function(e){"string"==typeof e&&(e=e.split(" ")),t.isArray(e)&&(e={left:+e[0],top:+e[1]||0}),"left"in e&&(this.offset.click.left=e.left+this.margins.left),"right"in e&&(this.offset.click.left=this.helperProportions.width-e.right+this.margins.left),"top"in e&&(this.offset.click.top=e.top+this.margins.top),"bottom"in e&&(this.offset.click.top=this.helperProportions.height-e.bottom+this.margins.top)},_getParentOffset:function(){var e=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==document&&t.contains(this.scrollParent[0],this.offsetParent[0])&&(e.left+=this.scrollParent.scrollLeft(),e.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===document.body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&t.ui.ie)&&(e={top:0,left:0}),{top:e.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:e.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"===this.cssPosition){var t=this.element.position();return{top:t.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:t.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var n,i,o,r=this.options;return r.containment?"window"===r.containment?void(this.containment=[t(e).scrollLeft()-this.offset.relative.left-this.offset.parent.left,t(e).scrollTop()-this.offset.relative.top-this.offset.parent.top,t(e).scrollLeft()+t(e).width()-this.helperProportions.width-this.margins.left,t(e).scrollTop()+(t(e).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):"document"===r.containment?void(this.containment=[0,0,t(document).width()-this.helperProportions.width-this.margins.left,(t(document).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):r.containment.constructor===Array?void(this.containment=r.containment):("parent"===r.containment&&(r.containment=this.helper[0].parentNode),i=t(r.containment),o=i[0],void(o&&(n="hidden"!==i.css("overflow"),this.containment=[(parseInt(i.css("borderLeftWidth"),10)||0)+(parseInt(i.css("paddingLeft"),10)||0),(parseInt(i.css("borderTopWidth"),10)||0)+(parseInt(i.css("paddingTop"),10)||0),(n?Math.max(o.scrollWidth,o.offsetWidth):o.offsetWidth)-(parseInt(i.css("borderRightWidth"),10)||0)-(parseInt(i.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(n?Math.max(o.scrollHeight,o.offsetHeight):o.offsetHeight)-(parseInt(i.css("borderBottomWidth"),10)||0)-(parseInt(i.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relative_container=i))):void(this.containment=null)},_convertPositionTo:function(e,n){n||(n=this.position);var i="absolute"===e?1:-1,o="absolute"!==this.cssPosition||this.scrollParent[0]!==document&&t.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent;return this.offset.scroll||(this.offset.scroll={top:o.scrollTop(),left:o.scrollLeft()}),{top:n.top+this.offset.relative.top*i+this.offset.parent.top*i-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():this.offset.scroll.top)*i,left:n.left+this.offset.relative.left*i+this.offset.parent.left*i-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():this.offset.scroll.left)*i}},_generatePosition:function(e){var n,i,o,r,a=this.options,s="absolute"!==this.cssPosition||this.scrollParent[0]!==document&&t.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,c=e.pageX,l=e.pageY;return this.offset.scroll||(this.offset.scroll={top:s.scrollTop(),left:s.scrollLeft()}),this.originalPosition&&(this.containment&&(this.relative_container?(i=this.relative_container.offset(),n=[this.containment[0]+i.left,this.containment[1]+i.top,this.containment[2]+i.left,this.containment[3]+i.top]):n=this.containment,e.pageX-this.offset.click.left<n[0]&&(c=n[0]+this.offset.click.left),e.pageY-this.offset.click.top<n[1]&&(l=n[1]+this.offset.click.top),e.pageX-this.offset.click.left>n[2]&&(c=n[2]+this.offset.click.left),e.pageY-this.offset.click.top>n[3]&&(l=n[3]+this.offset.click.top)),a.grid&&(o=a.grid[1]?this.originalPageY+Math.round((l-this.originalPageY)/a.grid[1])*a.grid[1]:this.originalPageY,l=n?o-this.offset.click.top>=n[1]||o-this.offset.click.top>n[3]?o:o-this.offset.click.top>=n[1]?o-a.grid[1]:o+a.grid[1]:o,r=a.grid[0]?this.originalPageX+Math.round((c-this.originalPageX)/a.grid[0])*a.grid[0]:this.originalPageX,c=n?r-this.offset.click.left>=n[0]||r-this.offset.click.left>n[2]?r:r-this.offset.click.left>=n[0]?r-a.grid[0]:r+a.grid[0]:r)),{top:l-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():this.offset.scroll.top),left:c-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():this.offset.scroll.left)}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1},_trigger:function(e,n,i){return i=i||this._uiHash(),t.ui.plugin.call(this,e,[n,i]),"drag"===e&&(this.positionAbs=this._convertPositionTo("absolute")),t.Widget.prototype._trigger.call(this,e,n,i)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),t.ui.plugin.add("draggable","connectToSortable",{start:function(e,n){var i=t(this).data("ui-draggable"),o=i.options,r=t.extend({},n,{item:i.element});i.sortables=[],t(o.connectToSortable).each(function(){var n=t.data(this,"ui-sortable");n&&!n.options.disabled&&(i.sortables.push({instance:n,shouldRevert:n.options.revert}),n.refreshPositions(),n._trigger("activate",e,r))})},stop:function(e,n){var i=t(this).data("ui-draggable"),o=t.extend({},n,{item:i.element});t.each(i.sortables,function(){this.instance.isOver?(this.instance.isOver=0,i.cancelHelperRemoval=!0,this.instance.cancelHelperRemoval=!1,this.shouldRevert&&(this.instance.options.revert=this.shouldRevert),this.instance._mouseStop(e),this.instance.options.helper=this.instance.options._helper,"original"===i.options.helper&&this.instance.currentItem.css({top:"auto",left:"auto"})):(this.instance.cancelHelperRemoval=!1,this.instance._trigger("deactivate",e,o))})},drag:function(e,n){var i=t(this).data("ui-draggable"),o=this;t.each(i.sortables,function(){var r=!1,a=this;this.instance.positionAbs=i.positionAbs,this.instance.helperProportions=i.helperProportions,this.instance.offset.click=i.offset.click,this.instance._intersectsWith(this.instance.containerCache)&&(r=!0,t.each(i.sortables,function(){return this.instance.positionAbs=i.positionAbs,this.instance.helperProportions=i.helperProportions,this.instance.offset.click=i.offset.click,this!==a&&this.instance._intersectsWith(this.instance.containerCache)&&t.contains(a.instance.element[0],this.instance.element[0])&&(r=!1),r})),r?(this.instance.isOver||(this.instance.isOver=1,this.instance.currentItem=t(o).clone().removeAttr("id").appendTo(this.instance.element).data("ui-sortable-item",!0),this.instance.options._helper=this.instance.options.helper,this.instance.options.helper=function(){return n.helper[0]},e.target=this.instance.currentItem[0],this.instance._mouseCapture(e,!0),this.instance._mouseStart(e,!0,!0),this.instance.offset.click.top=i.offset.click.top,this.instance.offset.click.left=i.offset.click.left,this.instance.offset.parent.left-=i.offset.parent.left-this.instance.offset.parent.left,this.instance.offset.parent.top-=i.offset.parent.top-this.instance.offset.parent.top,i._trigger("toSortable",e),i.dropped=this.instance.element,i.currentItem=i.element,this.instance.fromOutside=i),this.instance.currentItem&&this.instance._mouseDrag(e)):this.instance.isOver&&(this.instance.isOver=0,this.instance.cancelHelperRemoval=!0,this.instance.options.revert=!1,this.instance._trigger("out",e,this.instance._uiHash(this.instance)),this.instance._mouseStop(e,!0),this.instance.options.helper=this.instance.options._helper,this.instance.currentItem.remove(),this.instance.placeholder&&this.instance.placeholder.remove(),i._trigger("fromSortable",e),i.dropped=!1)})}}),t.ui.plugin.add("draggable","cursor",{start:function(){var e=t("body"),n=t(this).data("ui-draggable").options;e.css("cursor")&&(n._cursor=e.css("cursor")),e.css("cursor",n.cursor)},stop:function(){var e=t(this).data("ui-draggable").options;e._cursor&&t("body").css("cursor",e._cursor)}}),t.ui.plugin.add("draggable","opacity",{start:function(e,n){var i=t(n.helper),o=t(this).data("ui-draggable").options;i.css("opacity")&&(o._opacity=i.css("opacity")),i.css("opacity",o.opacity)},stop:function(e,n){var i=t(this).data("ui-draggable").options;i._opacity&&t(n.helper).css("opacity",i._opacity)}}),t.ui.plugin.add("draggable","scroll",{start:function(){var e=t(this).data("ui-draggable");e.scrollParent[0]!==document&&"HTML"!==e.scrollParent[0].tagName&&(e.overflowOffset=e.scrollParent.offset())},drag:function(n){var i=t(this).data("ui-draggable"),o=i.options,r=!1;i.scrollParent[0]!==document&&"HTML"!==i.scrollParent[0].tagName?(o.axis&&"x"===o.axis||(i.overflowOffset.top+i.scrollParent[0].offsetHeight-n.pageY<o.scrollSensitivity?i.scrollParent[0].scrollTop=r=i.scrollParent[0].scrollTop+o.scrollSpeed:n.pageY-i.overflowOffset.top<o.scrollSensitivity&&(i.scrollParent[0].scrollTop=r=i.scrollParent[0].scrollTop-o.scrollSpeed)),o.axis&&"y"===o.axis||(i.overflowOffset.left+i.scrollParent[0].offsetWidth-n.pageX<o.scrollSensitivity?i.scrollParent[0].scrollLeft=r=i.scrollParent[0].scrollLeft+o.scrollSpeed:n.pageX-i.overflowOffset.left<o.scrollSensitivity&&(i.scrollParent[0].scrollLeft=r=i.scrollParent[0].scrollLeft-o.scrollSpeed))):(o.axis&&"x"===o.axis||(n.pageY-t(document).scrollTop()<o.scrollSensitivity?r=t(document).scrollTop(t(document).scrollTop()-o.scrollSpeed):t(e).height()-(n.pageY-t(document).scrollTop())<o.scrollSensitivity&&(r=t(document).scrollTop(t(document).scrollTop()+o.scrollSpeed))),o.axis&&"y"===o.axis||(n.pageX-t(document).scrollLeft()<o.scrollSensitivity?r=t(document).scrollLeft(t(document).scrollLeft()-o.scrollSpeed):t(e).width()-(n.pageX-t(document).scrollLeft())<o.scrollSensitivity&&(r=t(document).scrollLeft(t(document).scrollLeft()+o.scrollSpeed)))),r!==!1&&t.ui.ddmanager&&!o.dropBehaviour&&t.ui.ddmanager.prepareOffsets(i,n)}}),t.ui.plugin.add("draggable","snap",{start:function(){var e=t(this).data("ui-draggable"),n=e.options;e.snapElements=[],t(n.snap.constructor!==String?n.snap.items||":data(ui-draggable)":n.snap).each(function(){var n=t(this),i=n.offset();this!==e.element[0]&&e.snapElements.push({item:this,width:n.outerWidth(),height:n.outerHeight(),top:i.top,left:i.left})})},drag:function(e,n){var i,o,r,a,s,c,l,h,u,d,f=t(this).data("ui-draggable"),p=f.options,g=p.snapTolerance,m=n.offset.left,v=m+f.helperProportions.width,b=n.offset.top,y=b+f.helperProportions.height;for(u=f.snapElements.length-1;u>=0;u--)s=f.snapElements[u].left,c=s+f.snapElements[u].width,l=f.snapElements[u].top,h=l+f.snapElements[u].height,s-g>v||m>c+g||l-g>y||b>h+g||!t.contains(f.snapElements[u].item.ownerDocument,f.snapElements[u].item)?(f.snapElements[u].snapping&&f.options.snap.release&&f.options.snap.release.call(f.element,e,t.extend(f._uiHash(),{snapItem:f.snapElements[u].item})),f.snapElements[u].snapping=!1):("inner"!==p.snapMode&&(i=g>=Math.abs(l-y),o=g>=Math.abs(h-b),r=g>=Math.abs(s-v),a=g>=Math.abs(c-m),i&&(n.position.top=f._convertPositionTo("relative",{top:l-f.helperProportions.height,left:0}).top-f.margins.top),o&&(n.position.top=f._convertPositionTo("relative",{top:h,left:0}).top-f.margins.top),r&&(n.position.left=f._convertPositionTo("relative",{top:0,left:s-f.helperProportions.width}).left-f.margins.left),a&&(n.position.left=f._convertPositionTo("relative",{top:0,left:c}).left-f.margins.left)),d=i||o||r||a,"outer"!==p.snapMode&&(i=g>=Math.abs(l-b),o=g>=Math.abs(h-y),r=g>=Math.abs(s-m),a=g>=Math.abs(c-v),i&&(n.position.top=f._convertPositionTo("relative",{top:l,left:0}).top-f.margins.top),o&&(n.position.top=f._convertPositionTo("relative",{top:h-f.helperProportions.height,left:0}).top-f.margins.top),r&&(n.position.left=f._convertPositionTo("relative",{top:0,left:s}).left-f.margins.left),a&&(n.position.left=f._convertPositionTo("relative",{top:0,left:c-f.helperProportions.width}).left-f.margins.left)),!f.snapElements[u].snapping&&(i||o||r||a||d)&&f.options.snap.snap&&f.options.snap.snap.call(f.element,e,t.extend(f._uiHash(),{snapItem:f.snapElements[u].item})),f.snapElements[u].snapping=i||o||r||a||d)}}),t.ui.plugin.add("draggable","stack",{start:function(){var e,n=this.data("ui-draggable").options,i=t.makeArray(t(n.stack)).sort(function(e,n){return(parseInt(t(e).css("zIndex"),10)||0)-(parseInt(t(n).css("zIndex"),10)||0)});i.length&&(e=parseInt(t(i[0]).css("zIndex"),10)||0,t(i).each(function(n){t(this).css("zIndex",e+n)}),this.css("zIndex",e+i.length))}}),t.ui.plugin.add("draggable","zIndex",{start:function(e,n){var i=t(n.helper),o=t(this).data("ui-draggable").options;i.css("zIndex")&&(o._zIndex=i.css("zIndex")),i.css("zIndex",o.zIndex)},stop:function(e,n){var i=t(this).data("ui-draggable").options;i._zIndex&&t(n.helper).css("zIndex",i._zIndex)}})}(jQuery),function(t){function n(e,n,i){if(e.prototype=t.extend2(t.extend({},n),(KM.ui[i]||r).prototype,!0),e.prototype.supper=(KM.ui[i]||r).prototype,KM.ui[i]&&KM.ui[i].prototype.defaultOpt){var o=KM.ui[i].prototype.defaultOpt,a=e.prototype.defaultOpt;e.prototype.defaultOpt=t.extend({},o,a||{})}return e}function i(e,n){t[s+n]=e,t.fn[s+n]=function(n){var i,o=Array.prototype.slice.call(arguments,1);return this.each(function(r,a){var s=t(a),c=s.kmui();if(c||(e(n&&t.isPlainObject(n)?n:{},s),s.kmui(c)),"string"==t.type(n))if("this"==n)i=c;else{if(i=c[n].apply(c,o),i!==c&&void 0!==i)return!1;i=null}}),null!==i?i:this}}t.parseTmpl=function(t,e){var n="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(t,e){return"',"+e.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(t,e){return"');"+e.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",i=new Function("obj",n);return e?i(e):i},t.extend2=function(e){for(var n=arguments,i="boolean"==t.type(n[n.length-1])?n[n.length-1]:!1,o="boolean"==t.type(n[n.length-1])?n.length-1:n.length,r=1;o>r;r++){var a=n[r];for(var s in a)i&&e.hasOwnProperty(s)||(e[s]=a[s])}return e},t.IE6=!!e.ActiveXObject&&6==parseFloat(navigator.userAgent.match(/msie (\d+)/i)[1]);var o=[],r=function(){},s="kmui";r.prototype={on:function(e,n){return this.root().on(e,t.proxy(n,this)),this},off:function(e,n){return this.root().off(e,t.proxy(n,this)),this},trigger:function(t,e){return this.root().trigger(t,e)===!1?!1:this},root:function(t){return this._$el||(this._$el=t)},destroy:function(){},data:function(t,e){return void 0!==e?(this.root().data(s+t,e),this):this.root().data(s+t)},register:function(e,n,i){o.push({evtname:e,$els:t.isArray(n)?n:[n],handler:t.proxy(i,n)})}},t.fn.kmui=function(t){return t?this.data("kmuiwidget",t):this.data("kmuiwidget")};var c=1;KM.ui={define:function(e,o,r){var l=KM.ui[e]=n(function(n,i){var o=function(){};t.extend(o.prototype,l.prototype,{guid:e+c++,widgetName:e});var r=new o;if("string"==t.type(n))return r.init&&r.init({}),r.root().kmui(r),r.root().find("a").click(function(t){t.preventDefault()}),r.root()[s+e].apply(r.root(),arguments);i&&r.root(i),r.init&&r.init(a.clonePlainObject(!n||t.isPlainObject(n)?t.extend2(n||{},r.defaultOpt||{},!0):n));try{r.root().find("a").click(function(t){t.preventDefault()})}catch(h){}return r.root().kmui(r)},o,r);i(l,e)}},t(function(){t(document).on("click mouseup mousedown dblclick mouseover",function(e){t.each(o,function(n,i){i.evtname==e.type&&t.each(i.$els,function(n,o){o[0]===e.target||t.contains(o[0],e.target)||i.handler(e)})})})})}(jQuery),KM.ui.define("button",{tpl:'<<%if(!texttype){%>div class="kmui-btn kmui-btn-<%=icon%> <%if(name){%>kmui-btn-name-<%=name%><%}%>" unselectable="on" onmousedown="return false" <%}else{%>a class="kmui-text-btn"<%}%><% if(title) {%> data-original-title="<%=title%>" <%};%>> <% if(icon) {%><div unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><% }; %><%if(text) {%><span unselectable="on" onmousedown="return false" class="kmui-button-label"><%=text%></span><%}%><%if(caret && text){%><span class="kmui-button-spacing"></span><%}%><% if(caret) {%><span unselectable="on" onmousedown="return false" class="kmui-caret"></span><% };%></<%if(!texttype){%>div<%}else{%>a<%}%>>',defaultOpt:{text:"",title:"",icon:"",width:"",caret:!1,texttype:!1,click:function(){}},init:function(t){var e=this;return e.root($($.parseTmpl(e.tpl,t))).click(function(n){e.wrapclick(t.click,n)}),e.root().hover(function(){e.root().hasClass("kmui-disabled")||e.root().toggleClass("kmui-hover")}),e},wrapclick:function(t,e){return this.disabled()||(this.root().trigger("wrapclick"),$.proxy(t,this,e)()),this},label:function(t){return void 0===t?this.root().find(".kmui-button-label").text():(this.root().find(".kmui-button-label").text(t),this)},disabled:function(t){return void 0===t?this.root().hasClass("kmui-disabled"):(this.root().toggleClass("kmui-disabled",t),this.root().hasClass("kmui-disabled")&&this.root().removeClass("kmui-hover"),this)},active:function(t){return void 0===t?this.root().hasClass("kmui-active"):(this.root().toggleClass("kmui-active",t),this)},mergeWith:function(t){var e=this;e.data("$mergeObj",t),t.kmui().data("$mergeObj",e.root()),$.contains(document.body,t[0])||t.appendTo(e.root()),e.on("click",function(){e.wrapclick(function(){t.kmui().show()})}).register("click",e.root(),function(){t.hide()})}}),function(){KM.ui.define("toolbar",{tpl:'<div class="kmui-toolbar"  ><div class="kmui-btn-toolbar" unselectable="on" onmousedown="return false"  ></div></div>',init:function(){var t=this.root($(this.tpl));this.data("$btnToolbar",t.find(".kmui-btn-toolbar"))},appendToBtnmenu:function(t){var e=this.data("$btnToolbar");t=$.isArray(t)?t:[t],$.each(t,function(t,n){e.append(n)})}})}(),KM.ui.define("menu",{show:function(t,e,n,i,o){n=n||"position",this.trigger("beforeshow")!==!1&&(this.root().css($.extend({display:"block"},t?{top:t[n]().top+("right"==e?0:t.outerHeight())-(i||0),left:t[n]().left+("right"==e?t.outerWidth():0)-(o||0)}:{})),this.trigger("aftershow"))},hide:function(t){var e;this.trigger("beforehide")!==!1&&((e=this.root().data("parentmenu"))&&(e.data("parentmenu")||t)&&e.kmui().hide(),this.root().css("display","none"),this.trigger("afterhide"))},attachTo:function(t){var e=this;t.data("$mergeObj")||(t.data("$mergeObj",e.root()),t.kmui()?t.on("wrapclick",function(){e.supper.show.call(e,t,"","offset",15)}):t.on("click",function(){e.supper.show.call(e,t,"","offset",15)}),e.register("click",t,function(){e.hide()}),e.data("$mergeObj",t))}}),KM.ui.define("dropmenu",{tmpl:'<ul class="kmui-dropdown-menu" aria-labelledby="dropdownMenu" ><%if(data && data.length){for(var i=0,ci;ci=data[i++];){%><%if(ci.divider){%><li class="kmui-divider"></li><%}else{%><li id="<%= ci.id%>" <%if(ci.active||ci.disabled){%>class="<%= ci.active|| \'\' %> <%=ci.disabled||\'\' %>" <%}%> data-value="<%= ci.value%>" data-label="<%= ci.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= ci.label%></a></li><%}}%><%}%></ul>',subTmpl:'<%if(data && data.length){for(var i=0,ci;ci=data[i++];){%><%if(ci.divider){%><li class="kmui-divider"></li><%}else{%><li <%if(ci.active||ci.disabled){%>class="<%= ci.active|| \'\' %> <%=ci.disabled||\'\' %>" <%}%> data-value="<%= ci.value%>" data-label="<%= ci.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= ci.label%></a></li><%}}%><%}%>',defaultOpt:{data:[],anchor:"top",click:function(){}},setData:function(t){return this.root().html($.parseTmpl(this.subTmpl,t)),this
},position:function(t){return this.root().css({left:t.x,top:t.y}),this},show:function(){return this.trigger("beforeshow")!==!1?(this.root().css({display:"block"}),this.trigger("aftershow"),this):void 0},init:function(t){var e=this,n={click:1,mouseover:1,mouseout:1};this.root($($.parseTmpl(this.tmpl,t))).on("click",'li[class!="kmui-disabled kmui-divider kmui-dropdown-submenu"]',function(n){$.proxy(t.click,e,n,$(this).data("value"),$(this).data("label"),$(this))()}).find("li").each(function(i,o){var r=$(this);if(!r.hasClass("kmui-disabled kmui-divider kmui-dropdown-submenu")){var a=t.data[i];$.each(n,function(t){a[t]&&r[t](function(n){$.proxy(a[t],o)(n,a,e.root)})})}})},_initEvent:function(){this.root().on("mouseover",'li[class="kmui-dropdown-submenu',function(){var t=$(this).data("widget");t.kmui().show($(this),"right","position",5,2)})},disabled:function(t){$("li[class!=kmui-divider]",this.root()).each(function(){var e=$(this);t===!0?e.addClass("kmui-disabled"):$.isFunction(t)?e.toggleClass("kmui-disabled",t(e)):e.removeClass("kmui-disabled")})},val:function(t){var e;return $('li[class!="kmui-divider kmui-disabled kmui-dropdown-submenu"]',this.root()).each(function(){var n=$(this);if(void 0===t){if(n.find("em.kmui-dropmenu-checked").length)return e=n.data("value"),!1}else n.find("em").toggleClass("kmui-dropmenu-checked",n.data("value")==t)}),void 0===t?e:void 0},appendItem:function(t){var e='<%if(item.divider){%><li class="kmui-divider"></li><%}else{%><li id="<%= item.id%>" <%if(item.active||item.disabled){%>class="<%= item.active|| \'\' %> <%=item.disabled||\'\' %>" <%}%> data-value="<%= item.value%>" data-label="<%= item.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= item.label%></a></li><%}%>',n=$.parseTmpl(e,t),i=$(n).click(t.click);return this.root().append(i),i},addSubmenu:function(t,e,n){n=n||0;var i=$("li[class!=kmui-divider]",this.root()),o=$('<li class="kmui-dropdown-submenu"><a tabindex="-1" href="#">'+t+"</a></li>").append(e);o.data("widget",e),n>=0&&n<i.length?o.insertBefore(i[n]):0>n?o.insertBefore(i[0]):n>=i.length&&o.appendTo(i)}},"menu"),KM.ui.define("splitbutton",{tpl:'<div class="kmui-splitbutton <%if (name){%>kmui-splitbutton-<%= name %><%}%>"  unselectable="on" <%if(title){%>data-original-title="<%=title%>"<%}%>><div class="kmui-btn"  unselectable="on" ><%if(icon){%><div  unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><%}%><%if(text){%><%=text%><%}%></div><div  unselectable="on" class="kmui-btn kmui-dropdown-toggle" ><div  unselectable="on" class="kmui-caret"></div></div></div>',defaultOpt:{text:"",title:"",click:function(){}},init:function(t){var e=this;return e.root($($.parseTmpl(e.tpl,t))),e.root().find(".kmui-btn:first").click(function(){e.disabled()||$.proxy(t.click,e)()}),e.root().find(".kmui-dropdown-toggle").click(function(){e.disabled()||e.trigger("arrowclick")}),e.root().hover(function(){e.root().hasClass("kmui-disabled")||e.root().toggleClass("kmui-hover")}),e},wrapclick:function(t,e){return this.disabled()||$.proxy(t,this,e)(),this},disabled:function(t){return void 0===t?this.root().hasClass("kmui-disabled"):(this.root().toggleClass("kmui-disabled",t).find(".kmui-btn").toggleClass("kmui-disabled",t),this)},active:function(t){return void 0===t?this.root().hasClass("kmui-active"):(this.root().toggleClass("kmui-active",t).find(".kmui-btn:first").toggleClass("kmui-active",t),this)},mergeWith:function(t){var e=this;e.data("$mergeObj",t),t.kmui().data("$mergeObj",e.root()),$.contains(document.body,t[0])||t.appendTo(e.root()),e.root().delegate(".kmui-dropdown-toggle","click",function(){e.wrapclick(function(){t.kmui().show()})}),e.register("click",e.root().find(".kmui-dropdown-toggle"),function(){t.hide()})}}),KM.ui.define("colorsplitbutton",{tpl:'<div class="kmui-splitbutton <%if (name){%>kmui-splitbutton-<%= name %><%}%>"  unselectable="on" <%if(title){%>data-original-title="<%=title%>"<%}%>><div class="kmui-btn"  unselectable="on" ><%if(icon){%><div  unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><%}%><div class="kmui-splitbutton-color-label" <%if (color) {%>style="background: <%=color%>"<%}%>></div><%if(text){%><%=text%><%}%></div><div  unselectable="on" class="kmui-btn kmui-dropdown-toggle" ><div  unselectable="on" class="kmui-caret"></div></div></div>',defaultOpt:{color:""},init:function(t){var e=this;e.supper.init.call(e,t)},colorLabel:function(){return this.root().find(".kmui-splitbutton-color-label")}},"splitbutton"),KM.ui.define("popup",{tpl:'<div class="kmui-dropdown-menu kmui-popup"<%if(!<%=stopprop%>){%>onmousedown="return false"<%}%>><div class="kmui-popup-body" unselectable="on" onmousedown="return false"><%=subtpl%></div><div class="kmui-popup-caret"></div></div>',defaultOpt:{stopprop:!1,subtpl:"",width:"",height:""},init:function(t){return this.root($($.parseTmpl(this.tpl,t))),this},mergeTpl:function(t){return $.parseTmpl(this.tpl,{subtpl:t})},show:function(t,e){e||(e={});var n=e.fnname||"position";this.trigger("beforeshow")!==!1&&(this.root().css($.extend({display:"block"},t?{top:t[n]().top+("right"==e.dir?0:t.outerHeight())-(e.offsetTop||0),left:t[n]().left+("right"==e.dir?t.outerWidth():0)-(e.offsetLeft||0),position:"absolute"}:{})),this.root().find(".kmui-popup-caret").css({top:e.caretTop||0,left:e.caretLeft||0,position:"absolute"}).addClass(e.caretDir||"up"),this.trigger("aftershow"))},hide:function(){this.root().css("display","none"),this.trigger("afterhide")},attachTo:function(t,e){var n=this;t.data("$mergeObj")||(t.data("$mergeObj",n.root()),t.on("wrapclick",function(){n.show(t,e)}),n.register("click",t,function(){n.hide()}),n.data("$mergeObj",t))},getBodyContainer:function(){return this.root().find(".kmui-popup-body")}}),KM.ui.define("scale",{tpl:'<div class="kmui-scale" unselectable="on"><span class="kmui-scale-hand0"></span><span class="kmui-scale-hand1"></span><span class="kmui-scale-hand2"></span><span class="kmui-scale-hand3"></span><span class="kmui-scale-hand4"></span><span class="kmui-scale-hand5"></span><span class="kmui-scale-hand6"></span><span class="kmui-scale-hand7"></span></div>',defaultOpt:{$doc:$(document),$wrap:$(document)},init:function(t){return t.$doc&&(this.defaultOpt.$doc=t.$doc),t.$wrap&&(this.defaultOpt.$wrap=t.$wrap),this.root($($.parseTmpl(this.tpl,t))),this.initStyle(),this.startPos=this.prePos={x:0,y:0},this.dragId=-1,this},initStyle:function(){a.cssRule("kmui-style-scale",".kmui-scale{display:none;position:absolute;border:1px solid #38B2CE;cursor:hand;}.kmui-scale span{position:absolute;left:0;top:0;width:7px;height:7px;overflow:hidden;font-size:0px;display:block;background-color:#3C9DD0;}.kmui-scale .kmui-scale-hand0{cursor:nw-resize;top:0;margin-top:-4px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand1{cursor:n-resize;top:0;margin-top:-4px;left:50%;margin-left:-4px;}.kmui-scale .kmui-scale-hand2{cursor:ne-resize;top:0;margin-top:-4px;left:100%;margin-left:-3px;}.kmui-scale .kmui-scale-hand3{cursor:w-resize;top:50%;margin-top:-4px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand4{cursor:e-resize;top:50%;margin-top:-4px;left:100%;margin-left:-3px;}.kmui-scale .kmui-scale-hand5{cursor:sw-resize;top:100%;margin-top:-3px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand6{cursor:s-resize;top:100%;margin-top:-3px;left:50%;margin-left:-4px;}.kmui-scale .kmui-scale-hand7{cursor:se-resize;top:100%;margin-top:-3px;left:100%;margin-left:-3px;}")},_eventHandler:function(t){var e=this,n=e.defaultOpt.$doc;switch(t.type){case"mousedown":var i,i=t.target||t.srcElement;-1!=i.className.indexOf("kmui-scale-hand")&&(e.dragId=i.className.slice(-1),e.startPos.x=e.prePos.x=t.clientX,e.startPos.y=e.prePos.y=t.clientY,n.bind("mousemove",$.proxy(e._eventHandler,e)));break;case"mousemove":-1!=e.dragId&&(e.updateContainerStyle(e.dragId,{x:t.clientX-e.prePos.x,y:t.clientY-e.prePos.y}),e.prePos.x=t.clientX,e.prePos.y=t.clientY,e.updateTargetElement());break;case"mouseup":if(-1!=e.dragId){e.dragId=-1,e.updateTargetElement();var o=e.data("$scaleTarget");o.parent()&&e.attachTo(e.data("$scaleTarget"))}n.unbind("mousemove",$.proxy(e._eventHandler,e))}},updateTargetElement:function(){var t=this,e=t.root(),n=t.data("$scaleTarget");n.css({width:e.width(),height:e.height()}),t.attachTo(n)},updateContainerStyle:function(t,e){var n,i=this,o=i.root(),r=[[0,0,-1,-1],[0,0,0,-1],[0,0,1,-1],[0,0,-1,0],[0,0,1,0],[0,0,-1,1],[0,0,0,1],[0,0,1,1]];0!=r[t][0]&&(n=parseInt(o.offset().left)+e.x,o.css("left",i._validScaledProp("left",n))),0!=r[t][1]&&(n=parseInt(o.offset().top)+e.y,o.css("top",i._validScaledProp("top",n))),0!=r[t][2]&&(n=o.width()+r[t][2]*e.x,o.css("width",i._validScaledProp("width",n))),0!=r[t][3]&&(n=o.height()+r[t][3]*e.y,o.css("height",i._validScaledProp("height",n)))},_validScaledProp:function(t,e){var n=this.root(),i=this.defaultOpt.$doc,o=function(t,n,i){return t+n>i?i-n:e};switch(e=isNaN(e)?0:e,t){case"left":return 0>e?0:o(e,n.width(),i.width());case"top":return 0>e?0:o(e,n.height(),i.height());case"width":return 0>=e?1:o(e,n.offset().left,i.width());case"height":return 0>=e?1:o(e,n.offset().top,i.height())}},show:function(t){var e=this;t&&e.attachTo(t),e.root().bind("mousedown",$.proxy(e._eventHandler,e)),e.defaultOpt.$doc.bind("mouseup",$.proxy(e._eventHandler,e)),e.root().show(),e.trigger("aftershow")},hide:function(){var t=this;t.root().unbind("mousedown",$.proxy(t._eventHandler,t)),t.defaultOpt.$doc.unbind("mouseup",$.proxy(t._eventHandler,t)),t.root().hide(),t.trigger("afterhide")},attachTo:function(t){var e=this,n=t.offset(),i=e.root(),o=e.defaultOpt.$wrap,r=o.offset();e.data("$scaleTarget",t),e.root().css({position:"absolute",width:t.width(),height:t.height(),left:n.left-r.left-parseInt(o.css("border-left-width"))-parseInt(i.css("border-left-width")),top:n.top-r.top-parseInt(o.css("border-top-width"))-parseInt(i.css("border-top-width"))})},getScaleTarget:function(){return this.data("$scaleTarget")[0]}}),KM.ui.define("colorpicker",{tpl:function(t){for(var e="ffffff,000000,eeece1,1f497d,4f81bd,c0504d,9bbb59,8064a2,4bacc6,f79646,f2f2f2,7f7f7f,ddd9c3,c6d9f0,dbe5f1,f2dcdb,ebf1dd,e5e0ec,dbeef3,fdeada,d8d8d8,595959,c4bd97,8db3e2,b8cce4,e5b9b7,d7e3bc,ccc1d9,b7dde8,fbd5b5,bfbfbf,3f3f3f,938953,548dd4,95b3d7,d99694,c3d69b,b2a2c7,92cddc,fac08f,a5a5a5,262626,494429,17365d,366092,953734,76923c,5f497a,31859b,e36c09,7f7f7f,0c0c0c,1d1b10,0f243e,244061,632423,4f6128,3f3151,205867,974806,c00000,ff0000,ffc000,ffff00,92d050,00b050,00b0f0,0070c0,002060,7030a0,".split(","),n='<div unselectable="on" onmousedown="return false" class="kmui-colorpicker<%if (name){%> kmui-colorpicker-<%=name%><%}%>" ><table unselectable="on" onmousedown="return false"><tr><td colspan="10">'+t.lang_themeColor+'</td> </tr><tr class="kmui-colorpicker-firstrow" >',i=0;i<e.length;i++)i&&0===i%10&&(n+="</tr>"+(60==i?'<tr><td colspan="10">'+t.lang_standardColor+"</td></tr>":"")+"<tr"+(60==i?' class="kmui-colorpicker-firstrow"':"")+">"),n+=70>i?'<td><a unselectable="on" onmousedown="return false" title="'+e[i]+'" class="kmui-colorpicker-colorcell" data-color="#'+e[i]+'" style="background-color:#'+e[i]+";border:solid #ccc;"+(10>i||i>=60?"border-width:1px;":i>=10&&20>i?"border-width:1px 1px 0 1px;":"border-width:0 1px 0 1px;")+'"></a></td>':"";return n+="</tr></table></div>"},init:function(t){var e=this;e.root($($.parseTmpl(e.supper.mergeTpl(e.tpl(t)),t))),e.root().on("click",function(t){e.trigger("pickcolor",$(t.target).data("color"))})}},"popup"),function(){var t="combobox",e="kmui-combobox-item",n="kmui-combobox-item-hover",i="kmui-combobox-checked-icon",o="kmui-combobox-item-label";KM.ui.define(t,function(){return{tpl:'<ul class="dropdown-menu kmui-combobox-menu<%if (comboboxName!==\'\') {%> kmui-combobox-<%=comboboxName%><%}%>" unselectable="on" onmousedown="return false" role="menu" aria-labelledby="dropdownMenu"><%if(autoRecord) {%><%for( var i=0, len = recordStack.length; i<len; i++ ) {%><%var index = recordStack[i];%><li class="<%=itemClassName%><%if( selected == index ) {%> kmui-combobox-checked<%}%><%if( disabled[ index ] === true ) {%> kmui-combobox-item-disabled<%}%>" data-item-index="<%=index%>" unselectable="on" onmousedown="return false"><span class="kmui-combobox-icon" unselectable="on" onmousedown="return false"></span><label class="<%=labelClassName%>" style="<%=itemStyles[ index ]%>" unselectable="on" onmousedown="return false"><%=items[index]%></label></li><%}%><%if( i ) {%><li class="kmui-combobox-item-separator"></li><%}%><%}%><%for( var i=0, label; label = items[i]; i++ ) {%><li class="<%=itemClassName%><%if( selected == i && enabledSelected ) {%> kmui-combobox-checked<%}%> kmui-combobox-item-<%=i%><%if( disabled[ i ] === true ) {%> kmui-combobox-item-disabled<%}%>" data-item-index="<%=i%>" unselectable="on" onmousedown="return false"><span class="kmui-combobox-icon" unselectable="on" onmousedown="return false"></span><label class="<%=labelClassName%>" style="<%=itemStyles[ i ]%>" unselectable="on" onmousedown="return false"><%=label%></label></li><%}%></ul>',defaultOpt:{recordStack:[],items:[],value:[],comboboxName:"",selected:"",disabled:{},autoRecord:!0,recordCount:5,enabledRecord:!0,enabledSelected:!0},init:function(t){var n=this;$.extend(n._optionAdaptation(t),n._createItemMapping(t.recordStack,t.items),{itemClassName:e,iconClass:i,labelClassName:o}),this._transStack(t),n.root($($.parseTmpl(n.tpl,t))),this.data("options",t).initEvent()},initEvent:function(){var t=this;t.initSelectItem(),this.initItemActive()},setLabelWithDefaultValue:function(){var t=this.data("button");t.kmui().label(t.data("original-title"))},initSelectItem:function(){var t=this,n=t.data("options"),i="."+o;t.root().delegate("."+e,"click",function(){var e=$(this),o=e.attr("data-item-index");return n.disabled[o]?!1:(t.trigger("comboboxselect",{index:o,label:e.find(i).text(),value:t.data("options").value[o]}).select(o),t.hide(),t.trigger("aftercomboboxselect"),!1)})},initItemActive:function(){var t={mouseenter:"addClass",mouseleave:"removeClass"};$.IE6&&this.root().delegate("."+e,"mouseenter mouseleave",function(e){$(this)[t[e.type]](n)}).one("afterhide",function(){})},select:function(t){var e=this.data("options"),n=e.itemCount,i=e.autowidthitem;return i&&!i.length&&(i=e.items),e.disabled[t]?null:0==n?null:(0>t?t=n+t%n:t>=n&&(t=n-1),this.trigger("changebefore",i[t]),this._update(t),this.trigger("changeafter",i[t]),null)},selectItemByLabel:function(t){var e=this.data("options").itemMapping,n=this,i=null;!$.isArray(t)&&(t=[t]),$.each(t,function(t,o){return i=e[o],void 0!==i?(n.select(i),!1):void 0})},getItems:function(){return this.data("options").items},traverseItems:function(t){var e=this.data("options").value,n=this.data("options").items;return $.each(n,function(n,i){t(i,e[n])}),this},getItemMapping:function(){return this.data("options").itemMapping},disableItemByIndex:function(t){var e=this.data("options");e.disabled[t]=!0,this._repaint()},disableItemByLabel:function(t){var e=this.data("options").itemMapping,n=e[t];return"number"==typeof n?this.disableItemByIndex(n):!1},enableItemByIndex:function(t){var e=this.data("options");delete e.disabled[t],this._repaint()},enableItemByLabel:function(t){var e=this.data("options").itemMapping,n=e[t];return"number"==typeof n?this.enableItemByIndex(n):!1},_transStack:function(t){var e=[],n=-1,i=-1;$.each(t.recordStack,function(o,r){n=t.itemMapping[r],$.isNumeric(n)&&(e.push(n),r==t.selected&&(i=n))}),t.recordStack=e,t.selected=i,e=null},_optionAdaptation:function(t){if(!("itemStyles"in t)){t.itemStyles=[];for(var e=0,n=t.items.length;n>e;e++)t.itemStyles.push("")}return t.autowidthitem=t.autowidthitem||t.items,t.itemCount=t.items.length,t},_createItemMapping:function(t,e){var n={},i={recordStack:[],mapping:{}};return $.each(e,function(t,e){n[e]=t}),i.itemMapping=n,$.each(t,function(t,e){void 0!==n[e]&&(i.recordStack.push(n[e]),i.mapping[e]=n[e])}),i},_update:function(t){var e=this.data("options"),n=[];this.data("options").enabledRecord&&($.each(e.recordStack,function(e,i){i!=t&&n.push(i)}),n.unshift(t),n.length>e.recordCount&&(n.length=e.recordCount),e.recordStack=n),e.selected=t,this._repaint(),n=null},_repaint:function(){var t=$($.parseTmpl(this.tpl,this.data("options")));this.root().html(t.html()),t=null}}}(),"menu")}(),function(){var t="buttoncombobox";KM.ui.define(t,function(){return{defaultOpt:{label:"",title:""},init:function(t){var e=this,n=$.kmuibutton({caret:!0,name:t.comboboxName,title:t.title,text:t.label,click:function(){e.show(this.root())}});e.supper.init.call(e,t),e.on("changebefore",function(t,e){n.kmuibutton("label",e)}),e.data("button",n),e.attachTo(n)},button:function(){return this.data("button")}}}(),"combobox")}(),KM.ui.define("modal",{tpl:'<div class="kmui-modal" tabindex="-1" ><div class="kmui-modal-header"><div class="kmui-close" data-hide="modal"></div><h3 class="kmui-title"><%=title%></h3></div><div class="kmui-modal-body"  style="<%if(width){%>width:<%=width%>px;<%}%><%if(height){%>height:<%=height%>px;<%}%>"> </div><% if(cancellabel || oklabel) {%><div class="kmui-modal-footer"><div class="kmui-modal-tip"></div><%if(oklabel){%><div class="kmui-btn kmui-btn-primary" data-ok="modal"><%=oklabel%></div><%}%><%if(cancellabel){%><div class="kmui-btn" data-hide="modal"><%=cancellabel%></div><%}%></div><%}%></div>',defaultOpt:{title:"",cancellabel:"",oklabel:"",width:"",height:"",backdrop:!0,keyboard:!0},init:function(t){var e=this;e.root($($.parseTmpl(e.tpl,t||{}))),e.data("options",t),t.okFn&&e.on("ok",$.proxy(t.okFn,e)),t.cancelFn&&e.on("beforehide",$.proxy(t.cancelFn,e)),e.root().delegate('[data-hide="modal"]',"click",$.proxy(e.hide,e)).delegate('[data-ok="modal"]',"click",$.proxy(e.ok,e)),$('[data-hide="modal"],[data-ok="modal"]',e.root()).hover(function(){$(this).toggleClass("kmui-hover")}),setTimeout(function(){$(".kmui-modal").draggable({handle:".kmui-modal-header"})},100)},toggle:function(){var t=this;return t[t.data("isShown")?"hide":"show"]()},show:function(){var t=this;t.trigger("beforeshow"),t.data("isShown")||(t.data("isShown",!0),t.escape(),t.backdrop(function(){t.autoCenter(),t.root().show().focus().trigger("aftershow")}),$(".kmui-modal").draggable({handle:".kmui-modal-header"}))},showTip:function(t){$(".kmui-modal-tip",this.root()).html(t).fadeIn()},hideTip:function(){$(".kmui-modal-tip",this.root()).fadeOut(function(){$(this).html("")})},autoCenter:function(){!$.IE6&&this.root().css("margin-left",-(this.root().width()/2))},hide:function(){var t=this;t.trigger("beforehide"),t.data("isShown")&&(t.data("isShown",!1),t.escape(),t.hideModal())},escape:function(){var t=this;t.data("isShown")&&t.data("options").keyboard?t.root().on("keyup",function(e){27==e.which&&t.hide()}):t.data("isShown")||t.root().off("keyup")},hideModal:function(){var t=this;t.root().hide(),t.backdrop(function(){t.removeBackdrop(),t.trigger("afterhide")})},removeBackdrop:function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},backdrop:function(t){var e=this;e.data("isShown")&&e.data("options").backdrop&&(e.$backdrop=$('<div class="kmui-modal-backdrop" />').click("static"==e.data("options").backdrop?$.proxy(e.root()[0].focus,e.root()[0]):$.proxy(e.hide,e))),e.trigger("afterbackdrop"),t&&t()},attachTo:function(t){var e=this;t.data("$mergeObj")||(t.data("$mergeObj",e.root()),t.on("wrapclick",function(){e.toggle(t)}),e.data("$mergeObj",t))},ok:function(){var t=this;t.trigger("beforeok"),t.trigger("ok",t)!==!1&&t.hide()},getBodyContainer:function(){return this.root().find(".kmui-modal-body")}}),KM.ui.define("tooltip",{tpl:'<div class="kmui-tooltip" unselectable="on" onmousedown="return false"><div class="kmui-tooltip-arrow" unselectable="on" onmousedown="return false"></div><div class="kmui-tooltip-inner" unselectable="on" onmousedown="return false"></div></div>',init:function(t){var e=this;e.root($($.parseTmpl(e.tpl,t||{})))},content:function(t){var e=this,n=$(t.currentTarget).attr("data-original-title");e.root().find(".kmui-tooltip-inner").text(n)},position:function(t){var e=this,n=$(t.currentTarget);e.root().css($.extend({display:"block"},n?{top:n.outerHeight(),left:(n.outerWidth()-e.root().outerWidth())/2}:{}))},show:function(t){if(!$(t.currentTarget).hasClass("kmui-disabled")){var e=this;e.content(t),e.root().appendTo($(t.currentTarget)),e.position(t),e.root().css("display","block")}},hide:function(){var t=this;t.root().css("display","none")},attachTo:function(t){function e(t){var e=this;$.contains(document.body,e.root()[0])||e.root().appendTo(t),e.data("tooltip",e.root()),t.each(function(){$(this).attr("data-original-title")&&$(this).on("mouseenter",$.proxy(e.show,e)).on("mouseleave click",$.proxy(e.hide,e))})}var n=this;"undefined"===$.type(t)?$("[data-original-title]").each(function(t,i){e.call(n,$(i))}):t.data("tooltip")||e.call(n,t)}}),KM.ui.define("tab",{init:function(t){var e=this,n=t.selector;$.type(n)&&(e.root($(n,t.context)),e.data("context",t.context),$(n,e.data("context")).on("click",function(t){e.show(t)}))},show:function(t){var e,n,i,t,o=this,r=$(t.target),a=r.closest("ul");e=r.attr("data-context"),e=e&&e.replace(/.*(?=#[^\s]*$)/,"");var s=r.parent("li");s.length&&!s.hasClass("kmui-active")&&(n=a.find(".kmui-active:last a")[0],t=$.Event("beforeshow",{target:r[0],relatedTarget:n}),o.trigger(t),t.isDefaultPrevented()||(i=$(e,o.data("context")),o.activate(r.parent("li"),a),o.activate(i,i.parent(),function(){o.trigger({type:"aftershow",relatedTarget:n})})))},activate:function(t,e,n){if(void 0===t)return $(".kmui-tab-item.kmui-active",this.root()).index();var i=e.find("> .kmui-active");i.removeClass("kmui-active"),t.addClass("kmui-active"),n&&n()}}),KM.ui.define("separator",{tpl:'<div class="kmui-separator" unselectable="on" onmousedown="return false" ></div>',init:function(t){var e=this;return e.root($($.parseTmpl(e.tpl,t))),e}}),$.wordCountAdaptive=function(t,e){var n=$("<span>").html(t).css({display:"inline",position:"absolute",top:-1e7,left:-1e5}).appendTo(document.body),i=n.width();return n.remove(),n=null,50>i?t:(t=t.slice(0,e?-4:-1),t.length?$.wordCountAdaptive(t+"...",!0):"...")},a.extend(r,function(){var t={},e={},n=null,i={},o={};return{registerUI:function(e,n){a.each(e.split(/\s+/),function(e,i){t[i]=n})},registerToolbarUI:function(t,n){a.each(t.split(/\s+/),function(t,i){e[i]=n})},loadUI:function(e){a.each(t,function(t,n){n.call(e)})},_createUI:function(t){var e=$('<div class="kmui-container"></div>'),n=$.kmuitoolbar(),i=$('<div class="kmui-editor-body"></div>'),o=$('<div class="kmui-statusbar"></div>');return e.append(n).append(i).append(o),$(a.isString(t)?"#"+t:t).append(e),{$container:e,$toolbar:n,$body:i,$statusbar:o}},_createToolbar:function(t,n){var i=n.getOptions("toolbars");if(i&&i.length){var o=[];$.each(i,function(i,r){$.each(r.split(/\s+/),function(t,i){if("|"==i)$.kmuiseparator&&o.push($.kmuiseparator());else if(e[i]){var r=e[i].call(n,i);r&&o.push(r)}}),o.length&&t.kmui().appendToBtnmenu(o)}),t.append($('<div class="kmui-dialog-container"></div>'))}else t.hide()},_createStatusbar:function(){},getKityMinder:function(t,e){var n=this._createUI(t),i=this.getMinder(n.$body.get(0),e);return this._createToolbar(n.$toolbar,i),this._createStatusbar(n.$statusbar,i),i.$container=n.$container,this.loadUI(i),i.fire("interactchange")},registerWidget:function(t,e,n){i[t]=$.extend2(e,{$root:"",_preventDefault:!1,root:function(t){return this.$root||(this.$root=t)},preventDefault:function(){this._preventDefault=!0},clear:!1}),n&&(o[t]=n)},getWidgetData:function(t){return i[t]},setWidgetBody:function(t,e,n){n._widgetData||a.extend(n,{_widgetData:{},getWidgetData:function(t){return this._widgetData[t]},getWidgetCallback:function(t){var n=this;return function(){return o[t].apply(n,[n,e].concat(a.argsToArray(arguments,0)))}}});var r=i[t];return r?(r=n._widgetData[t],r||(r=i[t],r=n._widgetData[t]="function"==$.type(r)?r:a.clone(r)),r.root(e.kmui().getBodyContainer()),n.fire("selectionclear"),r.initContent(n,e),e.on("keydown keyup keypress",function(t){t.stopPropagation()}),r._preventDefault||r.initEvent(n,e),void(r.width&&e.width(r.width))):null},setActiveWidget:function(t){n=t}}}()),KM.registerToolbarUI("bold italic redo undo unhyperlink expandnode collapsenode hand zoom-in zoom-out",function(t){var e=this,n=$.kmuibutton({icon:t,click:function(){e.execCommand(t)},title:this.getLang("tooltips")[t]||""});return this.on("interactchange",function(){var e=this.queryCommandState(t);n.kmui().disabled(-1==e).active(1==e)}),n}),KM.registerToolbarUI("fontfamily fontsize",function(t){function e(t){for(var e=null,n=[],i=0,o=t.items.length;o>i;i++)e=t.items[i].val,n.push(e.split(/\s*,\s*/)[0]),t.itemStyles.push("font-family: "+e),t.value.push(e),t.autowidthitem.push($.wordCountAdaptive(n[i]));return t.items=n,t}function n(t){var e=null,n=[];t.itemStyles=[],t.value=[];for(var i=0,o=t.items.length;o>i;i++)e=t.items[i],n.push(e),t.itemStyles.push("font-size: "+e+"px; height:"+(e+2)+"px; line-height: "+(e+2)+"px");return t.value=t.items,t.items=n,t.autoRecord=!1,t}var i=this,o=i.getLang("tooltips."+t),r={label:o,title:o,comboboxName:t,items:i.getOptions(t)||[],itemStyles:[],value:[],autowidthitem:[]},a=null,s=null;if(0==r.items.length)return null;switch(t){case"fontfamily":r=e(r);break;case"fontsize":r=n(r)}return a=$.kmuibuttoncombobox(r).css("zIndex",i.getOptions("zIndex")+1),s=a.kmui(),s.on("comboboxselect",function(e,n){i.execCommand(t,n.value)}).on("beforeshow",function(){0===a.parent().length&&a.appendTo(i.$container.find(".kmui-dialog-container"))}),this.on("interactchange",function(){var e=this.queryCommandState(t),n=this.queryCommandValue(t);s.button().kmui().disabled(-1==e).active(1==e),n&&(n=n.replace(/['"]/g,"").toLowerCase().split(/['|"]?\s*,\s*[\1]?/),s.selectItemByLabel(n))}),s.button().addClass("kmui-combobox")}),KM.registerToolbarUI("forecolor",function(n){function i(){return a.css("background-color")}var o=this,r=null,a=null,s=null;return this.on("interactchange",function(){var t=this.queryCommandState(n);s.kmui().disabled(-1==t).active(1==t)}),s=$.kmuicolorsplitbutton({icon:n,caret:!0,name:n,title:this.getLang("tooltips")[n]||"",click:function(){var e=t.Color.parse(i()).toHEX();"#000000"!=e&&o.execCommand(n,e)}}),a=s.kmui().colorLabel(),r=$.kmuicolorpicker({name:n,lang_clearColor:o.getLang("popupcolor").clearColor||"",lang_themeColor:o.getLang("popupcolor").themeColor||"",lang_standardColor:o.getLang("popupcolor").standardColor||""}).on("pickcolor",function(t,i){e.setTimeout(function(){a.css("backgroundColor",i),o.execCommand(n,i)},0)}).on("show",function(){KM.setActiveWidget(r.kmui().root())}).css("zIndex",o.getOptions("zIndex")+1),s.kmui().on("arrowclick",function(){r.parent().length||o.$container.find(".kmui-dialog-container").append(r),r.kmui().show(s,{caretDir:"down",offsetTop:-5,offsetLeft:8,caretLeft:11,caretTop:-8})}).register("click",s,function(){r.kmui().hide()}),s}),KM.registerToolbarUI("saveto",function(t){function e(t,e){var n=document.createElement("a");n.setAttribute("download",e),n.setAttribute("href",t);var i;try{i=new MouseEvent("click")}catch(o){i=document.createEvent("MouseEvents"),i.initEvent("click",!0,!0)}n.dispatchEvent(i)}var n=this,i=n.getLang("tooltips."+t),o={label:i,title:i,comboboxName:t,items:[],itemStyles:[],value:[],autowidthitem:[],enabledRecord:!1,enabledSelected:!1},s=null,c=null;a.each(r.getAllRegisteredProtocals(),function(t){var e=r.findProtocal(t);if(e.encode){var n=e.fileDescription+"（"+e.fileExtension+"）";o.value.push(t),o.items.push(n),o.autowidthitem.push($.wordCountAdaptive(n),!0)}}),s=$.kmuibuttoncombobox(o).css("zIndex",n.getOptions("zIndex")+1),c=s.kmui();var l=function(){var t=0,e=/MSIE (\d+\.\d+);/.test(navigator.userAgent),n=!!navigator.userAgent.match(/Trident\/7.0/),i=navigator.userAgent.indexOf("rv:11.0");return e&&(t=new Number(RegExp.$1)),-1!=navigator.appVersion.indexOf("MSIE 10")&&(t=10),n&&-1!=i&&(t=11),t},h=function(t,e,n){var i=document.createElement("iframe");i.style.display="none",document.body.appendChild(i),i.contentDocument.open(t,"replace"),i.contentDocument.writeln(e),i.contentDocument.execCommand("saveas","",n)};return c.on("comboboxselect",function(t,i){var o=n.exportData(i.value),a=r.findProtocal(i.value),s=n.getMinderTitle()+a.fileExtension;if("string"==typeof o){var c="data:text/plain; utf-8,"+encodeURIComponent(o);l()>0?".km"===a.fileExtension?h("application/x-javascript",o,n.getMinderTitle()):".svg"===a.fileExtension||h("text/html",o,s):e(c,s)}else o&&o.then&&o.then(function(t){l()>0||e(t,s)})}).on("beforeshow",function(){0===s.parent().length&&s.appendTo(n.$container.find(".kmui-dialog-container"))}).on("aftercomboboxselect",function(){this.setLabelWithDefaultValue()}),c.button().addClass("kmui-combobox")}),KM.registerUI("tooltips",function(){var t=this;$.kmuitooltip&&($("[data-original-title]",t.$container).each(function(e,n){var i=t.getLang("tooltips"),o=$(n).data("original-title");a.each(i,function(e,i){i==o&&t.getShortcutKey(e)&&$(n).attr("data-original-title",o+" ("+t.getShortcutKey(e).toUpperCase()+")")})}),$.kmuitooltip("attachTo",$("[data-original-title]",t.$container)).css("z-index",t.getOptions("zIndex")+1)),t.$container.find("a").click(function(t){t.preventDefault()})}),KM.registerToolbarUI("switchlayout",function(t){var e=this,n=e.getLang("tooltips."+t),i={label:n,title:n,comboboxName:t,items:e.getLayoutStyleItems()||[],itemStyles:[],value:e.getLayoutStyleItems(),autowidthitem:[],enabledRecord:!1},o=null;if(0==i.items.length)return null;a.each(i.items,function(t,n){i.items[t]=e.getLang("layout")[n]}),o=$.kmuibuttoncombobox(i).css("zIndex",e.getOptions("zIndex")+1);var r=o.kmui();r.on("comboboxselect",function(n,i){e.execCommand(t,i.value)}).on("beforeshow",function(){0===o.parent().length&&o.appendTo(e.$container.find(".kmui-dialog-container"))}),e.on("interactchange",function(){var e=this.queryCommandState(t),n=this.queryCommandValue(t);r.button().kmui().disabled(-1==e).active(1==e),n&&(n=n.replace(/['"]/g,"").toLowerCase().split(/['|"]?\s*,\s*[\1]?/),r.selectItemByLabel(n))});var s=[];return a.each(e.getLayoutStyleItems(),function(n,i){s.push({label:e.getLang("tooltips."+t)+" "+i,cmdName:"switchlayout",exec:function(){e.execCommand("switchlayout",i)}})}),s.push({divider:1}),e.addContextmenu(s),r.button().addClass("kmui-combobox")}),KM.registerToolbarUI("node",function(t){function e(t){var e=[];return a.each(t.items,function(i,r){t.value.push(r),e.push((o[i]||i)+"("+n[r].toUpperCase()+")"),t.autowidthitem.push($.wordCountAdaptive(e[e.length-1]))}),t.items=e,t}var n={appendsiblingnode:"enter",appendchildnode:"tab",removenode:"del|backspace",editnode:"F2"},i=this,o=i.getLang("node"),r=i.getLang("tooltips."+t),s={label:r,title:r,comboboxName:t,items:i.getOptions(t)||[],itemStyles:[],value:[],autowidthitem:[],enabledRecord:!1,enabledSelected:!1},l=null;if(0==s.items.length)return null;l=$.kmuibuttoncombobox(e(s)).css("zIndex",i.getOptions("zIndex")+1);var h=l.kmui();return h.on("comboboxselect",function(t,e){i.execCommand(e.value,new c(i.getLang().topic),!0)}).on("beforeshow",function(){0===l.parent().length&&l.appendTo(i.$container.find(".kmui-dialog-container"));var t=l.kmui();t.traverseItems(function(e,n){-1==i.queryCommandState(n)?t.disableItemByLabel(e):t.enableItemByLabel(e)})}),i.on("interactchange",function(){var t=0;a.each(n,function(e){return t=i.queryCommandState(e),-1!=t?!1:void 0}),h.button().kmui().disabled(-1==t).active(1==t)}),h.button().addClass("kmui-combobox")}),KM.registerUI("contextmenu",function(){function t(t){var n;return a.each(e.getContextmenu(),function(e,i){return i.label==t?(n=i,!1):void 0}),n}var e=this,n=$.kmuidropmenu({click:function(n,i,o){var r=t(o);r.exec?r.exec.apply(km):e.execCommand(r.cmdName),this.hide()}});e.$container.append(n),e.on("contextmenu",function(t){var i=t.getTargetNode();i&&(this.removeAllSelectedNodes(),this.select(i));var o=e.getContextmenu(),r=[];if(a.each(o,function(t,n){return n.divider?void(r.length&&r.push(n)):void(-1!=e.queryCommandState(n.cmdName)&&r.push({label:n.label,value:n.cmdName}))
}),r.length){var s=r[r.length-1];s.divider&&r.pop(),n.kmui().setData({data:r}).position(t.getPosition()).show()}t.preventDefault()}),e.on("click",function(){n.kmui().hide()}),e.on("beforemousedown",function(t){t.isRightMB()&&t.stopPropagationImmediately()})}),KM.registerToolbarUI("markers help preference",function(t){var e,n=this,i={title:this.getLang("tooltips")[t]||"",url:n.getOptions("KITYMINDER_HOME_URL")+"dialogs/"+t+"/"+t+".js"},o=$.kmuibutton({icon:t,title:this.getLang("tooltips")[t]||""});return a.loadFile(document,{src:i.url,tag:"script",type:"text/javascript",defer:"defer"},function(){e=$.kmuimodal(i),e.attr("id","kmui-dialog-"+t).addClass("kmui-dialog-"+t).find(".kmui-modal-body").addClass("kmui-dialog-"+t+"-body"),e.kmui().on("beforeshow",function(){var i=this.root();i.parent()[0]||n.$container.find(".kmui-dialog-container").append(i),KM.setWidgetBody(t,e,n)}).attachTo(o)}),n.on("interactchange",function(){var e=this.queryCommandState(t);o.kmui().disabled(-1==e).active(1==e)}),o}),KM.registerToolbarUI("hyperlink",function(t){var e,n=this,i={title:this.getLang("tooltips")[t]||"",url:n.getOptions("KITYMINDER_HOME_URL")+"dialogs/"+t+"/"+t+".js"},o=$.kmuibutton({icon:t,title:this.getLang("tooltips")[t]||""});return a.loadFile(document,{src:i.url,tag:"script",type:"text/javascript",defer:"defer"},function(){e=$.kmuimodal(i),e.attr("id","kmui-dialog-"+t).addClass("kmui-dialog-"+t).find(".kmui-modal-body").addClass("kmui-dialog-"+t+"-body"),e.kmui().on("beforeshow",function(){var i=this.root();i.parent()[0]||n.$container.find(".kmui-dialog-container").append(i),KM.setWidgetBody(t,e,n)}).attachTo(o)}),n.addContextmenu([{label:n.getLang("hyperlink.hyperlink"),exec:function(){e.kmui().show()},cmdName:"hyperlink"},{label:n.getLang("hyperlink.unhyperlink"),exec:function(){this.execCommand("unhyperlink")},cmdName:"unhyperlink"}]),n.on("interactchange",function(){var e=this.queryCommandState(t);o.kmui().disabled(-1==e).active(1==e)}),o}),KM.registerToolbarUI("zoom",function(t){function e(t){var e=[];return a.each(t.items,function(n,i){t.value.push(i),e.push(i+"%"),t.autowidthitem.push($.wordCountAdaptive(e[e.length-1]))}),t.items=e,t}var n=this,i=n.getLang("tooltips."+t),o={label:i,title:i,comboboxName:t,items:n.getOptions(t)||[],itemStyles:[],value:n.getOptions(t),autowidthitem:[],enabledRecord:!1},r=null;if(0==o.items.length)return null;r=$.kmuibuttoncombobox(e(o)).css("zIndex",n.getOptions("zIndex")+1);var s=r.kmui();return s.on("comboboxselect",function(t,e){n.execCommand("zoom",e.value)}).on("beforeshow",function(){0===r.parent().length&&r.appendTo(n.$container.find(".kmui-dialog-container"))}),n.on("interactchange",function(){var e=this.queryCommandState(t),n=this.queryCommandValue(t);s.button().kmui().disabled(-1==e).active(1==e),n&&s.selectItemByLabel(n+"%")}),s.button().addClass("kmui-combobox")}),r.registerProtocal("xmind",function(){function t(e,n){if(n.data={text:e.title},e.marker_refs&&e.marker_refs.marker_ref){var o=e.marker_refs.marker_ref;if(o.length&&o.length>0)for(var r in o){var a=i[o[r].marker_id];a&&(n.data[a[0]]=a[1])}else{var a=i[o.marker_id];a&&(n.data[a[0]]=a[1])}}if(e["xlink:href"]&&(n.data.hyperlink=e["xlink:href"]),e.children&&e.children.topics&&e.children.topics.topic){var s=e.children.topics.topic;if(s.length&&s.length>0){n.children=[];for(var r in s)n.children.push({}),t(s[r],n.children[r])}else n.children=[{}],t(s,n.children[0])}}function e(e){var n=$.xml2json(e),i={},o=n.sheet,r=a.isArray(o)?o[0].topic:o.topic;return t(r,i),i}function n(t,e){zip.createReader(new zip.BlobReader(t),function(t){t.getEntries(e)},onerror)}var i={"priority-1":["PriorityIcon",1],"priority-2":["PriorityIcon",2],"priority-3":["PriorityIcon",3],"priority-4":["PriorityIcon",4],"priority-5":["PriorityIcon",5],"task-start":["ProgressIcon",1],"task-quarter":["ProgressIcon",2],"task-half":["ProgressIcon",3],"task-3quar":["ProgressIcon",4],"task-done":["ProgressIcon",5],"task-oct":null,"task-3oct":null,"task-5oct":null,"task-7oct":null};return{fileDescription:"xmind格式文件",fileExtension:".xmind",decode:function(){return{then:function(t,i){n(t,function(t){t.forEach(function(t){"content.xml"==t.filename&&t.getData(new zip.TextWriter,function(t){var n=e($.parseXML(t));i&&i(n)})})})}}},recognizePriority:-1}}),r.registerProtocal("freemind",function(){function t(e,i){if(i.data={text:e.TEXT},e.icon){var o=e.icon;if(o.length&&o.length>0)for(var r in o){var a=n[o[r].BUILTIN];a&&(i.data[a[0]]=a[1])}else{var a=n[o.BUILTIN];a&&(i.data[a[0]]=a[1])}}if(e.LINK&&(i.data.hyperlink=e.LINK),e.node){var s=e.node;if(s.length&&s.length>0){i.children=[];for(var r in s)i.children.push({}),t(s[r],i.children[r])}else i.children=[{}],t(s,i.children[0])}}function e(e){var n=$.xml2json(e),i={};return t(n.node,i),i}var n={"full-1":["PriorityIcon",1],"full-2":["PriorityIcon",2],"full-3":["PriorityIcon",3],"full-4":["PriorityIcon",4],"full-5":["PriorityIcon",5],"full-6":null,"full-7":null,"full-8":null,"full-9":null,"full-0":null};return{fileDescription:"xmind格式文件",fileExtension:".xmind",decode:function(t){var n=e(t);return n},recognizePriority:-1}}),r.registerProtocal("mindmanager",function(){function t(e,n){if(n.data={text:e.Text&&e.Text.PlainText||""},e.Task){var o;e.Task.TaskPriority&&(o=i[e.Task.TaskPriority],o&&(n.data[o[0]]=o[1])),e.Task.TaskPercentage&&(o=i[e.Task.TaskPercentage],o&&(n.data[o[0]]=o[1]))}if(e.Hyperlink&&(n.data.hyperlink=e.Hyperlink.Url),e.SubTopics&&e.SubTopics.Topic){var r=e.SubTopics.Topic;if(r.length&&r.length>0){n.children=[];for(var a in r)n.children.push({}),t(r[a],n.children[a])}else n.children=[{}],t(r,n.children[0])}}function e(e){var n=$.xml2json(e),i={};return t(n.OneTopic.Topic,i),i}function n(t,e){zip.createReader(new zip.BlobReader(t),function(t){t.getEntries(e)},onerror)}var i={"urn:mindjet:Prio1":["PriorityIcon",1],"urn:mindjet:Prio2":["PriorityIcon",2],"urn:mindjet:Prio3":["PriorityIcon",3],"urn:mindjet:Prio4":["PriorityIcon",4],"urn:mindjet:Prio5":["PriorityIcon",5],0:["ProgressIcon",1],25:["ProgressIcon",2],50:["ProgressIcon",3],75:["ProgressIcon",4],100:["ProgressIcon",5]};return{fileDescription:"mindmanager格式文件",fileExtension:".mmap",decode:function(){return{then:function(t,i){n(t,function(t){t.forEach(function(t){"Document.xml"==t.filename&&t.getData(new zip.TextWriter,function(t){var n=e($.parseXML(t));i&&i(n)})})})}}},recognizePriority:-1}}),r.registerProtocal("plain",function(){function t(t,e){for(var n="";e--;)n+=t;return n}function e(n,i){var o="";return i=i||0,o+=t(h,i),o+=n.data.text+l,n.children&&n.children.forEach(function(t){o+=e(t,i+1)}),o}function n(t){return!/\S/.test(t)}function i(t){for(var e=0;t.charAt(e)===h;)e++;return e}function o(t){return{data:{text:t.replace(new RegExp("^"+h+"*"),"")}}}function r(t){function e(t,e){var n=t.children||(t.children=[]);n.push(e)}for(var r,a,s,c,h={},u=t.split(l),d=0;d<u.length;d++)if(a=u[d],!n(a)){if(s=i(a),c=o(a),0===s){if(r)throw new Error("Invalid local format");r=c}else{if(!h[s-1])throw new Error("Invalid local format");e(h[s-1],c)}h[s]=c}return r}function a(t){if(!Utils.isString(t))return!1;s=t;try{c=r(t)}catch(e){c=null}return!!c}var s,c,l="\n",h="	";return{fileDescription:"大纲文本",fileExtension:".txt",encode:function(t){return e(t,0)},decode:function(t){return s==t&&c?c:r(t)},recognize:a,recognizePriority:-1}}),r.registerProtocal("json",function(){function t(t,e){return"layout"==t||"shicon"==t?void 0:e}return{fileDescription:"KityMinder",fileExtension:".km",encode:function(e){return JSON.stringify(e,t)},decode:function(t){return JSON.parse(t)},recognize:function(t){return Utils.isString(t)&&"{"==t.charAt(0)&&"}"==t.charAt(t.length-1)},recognizePriority:0}}),r.registerProtocal("png",function(){function t(t,e){var n=new Image;n.onload=e,console.log(t),n.src=t}return{fileDescription:"PNG 图片（暂不支持IE）",fileExtension:".png",encode:function(n,i){function o(t,e,n,i){t.save(),t.fillStyle=t.createPattern(e,"repeat"),t.fillRect(0,0,n,i),t.restore()}function r(t,e,n,i){t.drawImage(e,n,i)}function a(t){var e=t.toDataURL("png");return e.replace("image/png","image/octet-stream")}var s,c,l,h,u,d,f=i.getPaper().container,p=getComputedStyle(f).backgroundImage,g=/url\((.+)\)$/.exec(p)[1],m=i.getRenderContainer(),v=m.getRenderBox(),b=(m.getTransform(),v.width),y=v.height,x=20,w=document.createElement("canvas"),C=w.getContext("2d");return g=g.replace(/"/g,""),m.translate(-v.x,-v.y),s=i.getPaper().container.innerHTML,m.translate(v.x,v.y),c=$(s),c.attr({width:v.width,height:v.height,style:'font-family: Arial, "Microsoft Yahei","Heiti SC";'}),s=$("<div></div>").append(c).html(),s=s.replace(/&nbsp;/g,"&#xa0;"),l=new Blob([s],{type:"image/svg+xml;charset=utf-8"}),h=e.URL||e.webkitURL||e,u=h.createObjectURL(l),w.width=b+2*x,w.height=y+2*x,t(u,function(){var e=this;t(g,function(){var t;o(C,this,w.width,w.height),r(C,e,x,x),h.revokeObjectURL(u),t=a(w),d&&d(t)})}),{then:function(t){d=t}}},recognizePriority:-1}}),r.registerProtocal("svg",function(){return{fileDescription:"SVG 矢量图（暂不支持IE）",fileExtension:".svg",encode:function(t,e){return e.getPaper().container.innerHTML.replace(/&nbsp;/g,"&#xa0;")},recognizePriority:-1}})}(kity,window),function(){function t(t,i){return n(t||self.document.URL||self.location.href,i||e())}function e(){var t=document.getElementsByTagName("script");return t[t.length-1].src}function n(t,e){var n=e;return/^(\/|\\\\)/.test(e)?n=/^.+?\w(\/|\\\\)/.exec(t)[0]+e.replace(/^(\/|\\\\)/,""):/^[a-z]+:/i.test(e)||(t=t.split("#")[0].split("?")[0].replace(/[^\\\/]+$/,""),n=t+""+e),i(n)}function i(t){var e=/^[a-z]+:\/\//.exec(t)[0],n=null,i=[];for(t=t.replace(e,"").split("?")[0].split("#")[0],t=t.replace(/\\/g,"/").split(/\//),t[t.length-1]="";t.length;)".."===(n=t.shift())?i.pop():"."!==n&&i.push(n);return e+i.join("/")}window.KITYMINDER_CONFIG={KITYMINDER_HOME_URL:t(),toolbars:["hand | zoom-in zoom zoom-out | collapsenode expandnode | undo redo | bold italic | fontfamily fontsize forecolor | saveto | hyperlink unhyperlink | markers | node | help"]}}(),KityMinder.LANG["zh-cn"]={maintopic:"中心主题",topic:"分支主题",tooltips:{undo:"撤销",redo:"重做",bold:"加粗",italic:"斜体",forecolor:"字体颜色",fontfamily:"字体",fontsize:"字号",layoutstyle:"主题",node:"节点操作",saveto:"另存为",hand:"允许拖拽",zoom:"放大缩小",markers:"添加标签",switchlayout:"切换主题",help:"帮助",preference:"偏好设置",hyperlink:"插入链接",unhyperlink:"删除链接",expandnode:"展开节点",collapsenode:"收起节点"},popupcolor:{clearColor:"清空颜色",standardColor:"标准颜色",themeColor:"主题颜色"},dialogs:{markers:{"static":{lang_input_text:"文本内容：",lang_input_url:"链接地址：",lang_input_title:"标题：",lang_input_target:"是否在新窗口打开："},priority:"优先级",progress:{notdone:"未完成",quarterdone:"完成1/4",halfdone:"完成1/2",threequartersdone:"完成3/4",done:"已完成"}},help:{},hyperlink:{}},node:{appendsiblingnode:"插入同级节点",appendchildnode:"插入子节点",removenode:"删除节点",editnode:"编辑节点"},layout:{"default":"左右展开",bottom:"向下展开"},hyperlink:{hyperlink:"插入超链接",unhyperlink:"取消超链接"}};