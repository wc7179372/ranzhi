+function(t,e,o,i){"use strict";var n="undefined",a=0,s=function(e,o){this.$=t(e),this.options=this.getOptions(o),this.lang=this.getLang(),this.data=this.options.data,this.dirtyData=!0,this.offsetX=0,this.offsetY=0,this.init()};s.DEFAULTS={hotkeyEnable:!0,hotkeys:{selectPrev:"Up",selectNext:"Down",selectLeft:"left",selectRight:"right",deleteNode:"del backspace",addBorther:"return",addChild:"tab insert",centerCanvas:"space"},lang:"zh_cn",langs:{zh_cn:{DefaultName:"灵光闪现",DefaultSubName:"灵光",DefaultNodeName:"闪现",ReadonlyTip:"该节点已被设置为只读，无法进行编辑。",HotkeyDisabled:'快捷键不可用，需要 <a target="_blank" href="https://github.com/jeresig/jquery.hotkeys">jquery.hotkeys</a> 插件支持。'}},data:{text:"New Project",type:"root",expand:!0,theme:"default",caption:"",id:t.uuid()+""},nodeTeamplate:"<div id='node-{id}' class='mindmap-node expand-{expand}' data-type='{type}' data-id='{id}' data-parent='{parent}'><div class='wrapper'><div class='text'>{text}</div><div class='caption'>{caption}</div></div></div>",hSpace:100,vSpace:10,canvasPadding:20,removingNodeTip:null,lineCurvature:60,subLineWidth:4,lineOpacity:1,lineSaturation:90,lineLightness:40,nodeLineWidth:2},s.prototype.getOptions=function(e){return s.DEFAULTS.data.text=s.DEFAULTS.langs.zh_cn.DefaultName,e=t.extend({},s.DEFAULTS,this.$.data(),e)},s.prototype.getLang=function(){if(!this.options.lang){if("undefined"!=typeof e.config&&e.config.clientLang)this.options.lang=config.clientLang;else{var o=t("html").attr("lang");this.options.lang=o?o:"en"}this.options.lang=this.options.lang.replace(/-/,"_").toLowerCase()}return this.options.langs[this.options.lang]||this.options.langs[s.DEFAULTS.lang]},s.prototype.check=function(){var o=this.options,i=typeof t.hotkeys!=n;!i&&o.hotkeyEnable&&e.messager.danger(this.lang.HotkeyDisabled),o.hotkeyEnable=o.hotkeyEnable&&i},s.prototype.init=function(){this.check(),this.initDom(),this.initSize(),this.bindEvents(),this.render()},s.prototype.initDom=function(){var e=this.$;e.attr("id")||e.attr("id","mindmap-"+t.uuid()),this.id=e.attr("id"),this.$container=e.children(".mindmap-container"),this.$container.length||(e.prepend("<div class='mindmap-container'></div>"),this.$container=e.children(".mindmap-container")),this.$canvas=this.$container.children("canvas"),this.$canvas.length||(this.$container.prepend("<canvas class='mindmap-bg'></canvas>".format(this.options.canvasSize)),this.$canvas=this.$container.children("canvas")),this.$desktop=this.$container.children(".mindmap-desktop"),this.$desktop.length||(this.$container.append("<div class='mindmap-desktop'></div>"),this.$desktop=this.$container.children(".mindmap-desktop")),this.$desktop.attr("unselectable","on");var o=e.children(".shadow");o.length||e.append("<div class='mindmap-shadow shadow-top'></div><div class='mindmap-shadow shadow-right'></div><div class='mindmap-shadow shadow-bottom'></div><div class='mindmap-shadow shadow-left'></div>")},s.prototype.initSize=function(){var t=this.$;this.winWidth=t.width(),this.winHeight=t.height(),this.centerX=i.floor(this.winWidth/2),this.centerY=i.floor(this.winHeight/2),this.dirtyData||this.display()},s.prototype.callEvent=function(e,o){if(t.isFunction(this.options[e])){var i=t.proxy(this.options[e],this)(o);return!(void 0!=i&&!i)}return 1},s.prototype.computePosition=function(t,e){var o=e?-1:1;return typeof t.left!=n&&(t.left-=(this.left-this.options.canvasPadding)*o),typeof t.top!=n&&(t.top-=this.top*o),typeof t.x!=n&&(t.x-=(this.left-this.options.canvasPadding)*o),typeof t.y!=n&&(t.y-=this.top*o),t},s.prototype.computeColor=function(t,e){return"hsla({h}, {s}%, {l}%, {a})".format({h:t,s:this.options.lineSaturation,l:this.options.lineLightness,a:e||this.options.lineOpacity})},s.prototype.getNodeData=function(e,o){if("number"==typeof e&&(e=e.toString()),o||(o=this.data),e==o.id)return o;if(t.isArray(o.children)&&o.children.length>0)for(var i in o.children){var n=this.getNodeData(e,o.children[i]);if(n)return n}return null},s.prototype.createDefaultNodeData=function(e){var o={expand:!0,id:t.uuid()+"",parent:e.id};return"root"===e.type?(o.type="sub",o.text=this.lang.DefaultSubName):(o.type="node",o.text=this.lang.DefaultNodeName),o},s.prototype.getNode=function(t){return"string"==typeof t?this.$desktop.children('[data-id="'+t+'"]'):typeof t.id!=n?t.ui.element:void 0},s.prototype.removeNode=function(t){if(this.getNode(t).remove(),t.count>0)for(var e in t.children)this.removeNode(t.children[e])},s.prototype.update=function(e,o,i){var a=!1;if(this.options,t.isPlainObject(e)&&(e=[e]),t.isArray(e))for(var s in e){var r=e[s],d=r.data;if(d||(d=this.getNodeData(r.id)),!d)return;var l=r.action||"update";if("remove"===l||"delete"===l){var p=this.getNodeData(d.parent);p&&(p.children.splice(d.ui.index,1),this.removeNode(d),this.clearNodeStatus(),t.isArray(p.deletions)?p.deletions.push(d):p.deletions=[d],i=!0,o=!0,a=!0,d.action="delete")}else if("add"===l)t.isArray(d.children)?d.children.push(r.newData):d.children=[r.newData],i=!0,o=!0,a=!0,d.action="add";else if("move"===l){if(r.newParent!=d.parent){var h=this.getNodeData(r.newParent),p=this.getNodeData(d.parent);p&&h&&("root"===h.type?("node"===d.type&&(d.colorHue=null),d.type="sub",d.subSide=null):(d.type="node",d.subSide=h.subSide),p.children.splice(d.ui.index,1),p.count-=1,t.isArray(h.children)?h.children.push(d):h.children=[d],h.count+=1,i=!0,o=!0,a=!0,d.action+=" move")}}else if("sort"===l){if(d.count>1){d.children.sort(r.func);for(var s in d.children){var c=d.children[s];c.sort=s,c.action+=" sort"}i=!0,o=!0,a=!0}}else typeof r.text!=n&&r.text!=d.text&&(d.text=r.text,o=!0,a=!0),typeof r.subSide!=n&&r.subSide!=d.subSide&&(d.subSide=r.subSide,i=!0,o=!0,a=!0),a&&(d.action+=" edit")}i&&this.loadNode(),o&&this.showNode(),a&&this.callEvent("onChange",{changes:e,data:this.data})},s.prototype.load=function(t){this.data=t,this.render(t)},s.prototype.render=function(){this.loadNode(),this.showNode()},s.prototype.loadNode=function(e,o){e||(e=this.data);var s=this.options,r=this.$desktop,d="object"==typeof o?o.id?o.id:"":"";typeof e.expand===n&&(e.expand=!0),typeof e.data===n&&(e.data={}),typeof e.type===n&&(e.type="node"),typeof e.id===n&&(e.id=t.uuid()+""),typeof e.readonly===n&&(e.readonly=!1),typeof e.ui===n&&(e.ui={}),e.parent=d;var l=r.children('.mindmap-node[data-id="'+e.id+'"]');if(l.length?(l.toggleClass("expand-false",!e.expand).toggleClass("expand-true",e.expand).attr("data-type",e.type).attr("data-parent",d||"root"),l.children(".text").html(e.text),l.children(".caption").html(e.caption)):(l=t(s.nodeTeamplate.format({type:e.type||"node",expand:e.expand,caption:e.caption||"",id:e.id,parent:d||"root",text:e.text})).appendTo(r),this.bindNodeEvents(l),e.ui.element=l),"root"===e.type)e.ui.subLeftSide=0,e.ui.subRightSide=0,e.ui.vLeftSpan=0,e.ui.vRightSpan=0;else if("sub"===e.type){var p=e.subSide;p||(p=o.ui.subRightSide>o.ui.subLeftSide?"left":"right"),"left"===p?o.ui.subLeftSide++:o.ui.subRightSide++,e.subSide=p,e.colorHue||(e.colorHue=i.floor(55*a++%360))}else e.subSide=o.subSide;l.data("origin-text",e.text),l.toggleClass("readonly",e.readonly);var h=1;if(e.count=0,t.isArray(e.children)&&e.children.length>0){e.ui.topSpanTemp="root"===e.type?{left:0,right:0}:0;var c=0,u=0,f=null;h=0,e.children.sort(function(t,e){return t.sort-e.sort});for(var g in e.children){var v=e.children[g];typeof v.ui===n&&(v.ui={}),"sub"!=v.type&&(v.colorHue=e.colorHue),v.ui.nextBorther=null,f?(v.ui.prevBorther=f.id,f.ui.nextBorther=v.id):v.ui.prevBorther=null,f=v,this.loadNode(v,e,g),v.ui.index=e.count++,"undifined"==typeof v.order&&(v.order=v.ui.index),h+=v.ui.vSpan,"sub"===v.type?"left"===v.subSide?(c+=v.ui.vSpan,v.ui.topSpan=e.ui.topSpanTemp.left,e.ui.topSpanTemp.left+=v.ui.vSpan):(u+=v.ui.vSpan,v.ui.topSpan=e.ui.topSpanTemp.right,e.ui.topSpanTemp.right+=v.ui.vSpan):(v.ui.topSpan=e.ui.topSpanTemp,e.ui.topSpanTemp+=v.ui.vSpan)}"root"===e.type&&(e.ui.vLeftSpan=c,e.ui.vRightSpan=u)}"root"!=e.type&&(e.ui.vSpan=h),this.dirtyData=!1,"root"===e.type&&this.callEvent("afterLoad",{data:e})},s.prototype.showNode=function(e,o){e||(e=this.data);var n=this.options,a=e.ui,s=e.ui.element;if(a.width=s.outerWidth(),a.height=s.outerHeight(),"root"===e.type)a.left=0-i.floor(a.width/2),a.top=0-i.floor(a.height/2),this.left=0-i.floor(i.max(a.width-2*n.canvasPadding,this.winWidth)/4),this.right=0-this.left,this.top=0-i.floor(i.max(a.height-2*n.canvasPadding,this.winHeight)/4),this.bottom=0-this.top;else if(t.isPlainObject(a.dragPos))a.left=a.dragPos.left,a.top=a.dragPos.top;else{if("sub"===e.type){var r=0;"left"===e.subSide?(a.left=o.ui.left-n.hSpace-20-a.width,r=o.ui.vLeftSpan):(a.left=o.ui.left+o.ui.width+n.hSpace+20,r=o.ui.vRightSpan);var d=r*a.height+(r-1)*n.vSpace,l=0-i.floor(d/2),p=a.topSpan*a.height+a.topSpan*n.vSpace,h=a.vSpan*a.height+(a.vSpan-1)*n.vSpace;a.top=l+p+i.floor((h-a.height)/2)}else{a.left="left"===e.subSide?o.ui.left-n.hSpace-a.width:o.ui.left+o.ui.width+n.hSpace;var d=o.ui.vSpan*a.height+(o.ui.vSpan-1)*n.vSpace,l=o.ui.top+i.floor(o.ui.height/2)-i.floor(d/2),p=a.topSpan*a.height+a.topSpan*n.vSpace,h=a.vSpan*a.height+(a.vSpan-1)*n.vSpace;a.top=l+p+i.floor((h-a.height)/2)}"left"===e.subSide?this.left=i.min(this.left,a.left):this.right=i.max(this.right,a.left+a.width),this.top=i.min(this.top,a.top),this.bottom=i.max(this.bottom,a.top+a.height)}if(t.isArray(e.children)&&e.children.length>0)for(var c in e.children)this.showNode(e.children[c],e);if("root"===e.type){var u=this.options.canvasPadding;this.left-=u,this.top-=u,this.right+=2*u,this.bottom+=u,this.width=this.right-this.left,this.height=this.bottom-this.top,this.display(),this.draw(),this.callEvent("afterShow",{data:e})}},s.prototype.display=function(t,e,o){"number"==typeof t&&"number"==typeof e&&(o&&(t+=this.offsetX,e+=this.offsetY),this.offsetX=t,this.offsetY=e),this.x=this.centerX+this.left+this.offsetX,this.y=this.centerY+this.top+this.offsetY,this.$container.css({width:this.width,height:this.height,top:this.y,left:this.x});var i=this.options.canvasPadding;this.$.toggleClass("shadow-left",this.x<0-i).toggleClass("shadow-right",this.x+this.width>this.winWidth+i).toggleClass("shadow-top",this.y<0-i).toggleClass("shadow-bottom",this.y+this.height>this.winHeight+i)},s.prototype.makeNodeVisble=function(t){var e=this.getNodeData(t.data("id"));if(e){var o=e.ui.left-this.left+this.x,i=e.ui.top-this.top+this.y,n=this.options.canvasPadding;if(0>o)this.offsetX+=0-o;else{var a=o+e.ui.width-(this.winWidth+n);a>0&&(this.offsetX+=0-a-80)}if(0>i)this.offsetY+=0-i;else{var a=i+e.ui.height-(this.winWidth+n);a>0&&(this.offsetY+=0-a-80)}this.display()}},s.prototype.clearCanvasArea=function(){this.$canvas[0].getContext("2d").clearRect(0,0,this.width,this.height)},s.prototype.draw=function(e,o){if(e||(e=this.data),"root"===e.type&&(this.$canvas.attr({width:this.width,height:this.height}),this.clearCanvasArea()),o){var n="left"===e.subSide,a=this.options,s=this.$canvas[0].getContext("2d"),r={x:o.ui.left+("root"===o.type?i.floor(o.ui.width/2):n?0:o.ui.width),y:o.ui.top+i.floor(o.ui.height/2)},d={x:e.ui.left+(n?e.ui.width:0),y:e.ui.top+i.floor(e.ui.height/2)},l={x:r.x+(n?-1:1)*a.lineCurvature,y:r.y},p={x:d.x+(n?1:-1)*a.lineCurvature,y:d.y};r=this.computePosition(r),d=this.computePosition(d),l=this.computePosition(l),p=this.computePosition(p),s.beginPath(),s.strokeStyle=this.computeColor(e.colorHue,e.ui.canDrop?".25":"1"),s.lineCap="round",s.lineWidth="sub"===e.type?a.subLineWidth:a.nodeLineWidth,s.moveTo(r.x,r.y),s.bezierCurveTo(l.x,l.y,p.x,p.y,d.x,d.y),s.stroke()}if(e.ui.element.css(this.computePosition({left:e.ui.left,top:e.ui.top})),t.isArray(e.children)&&e.children.length>0)for(var h in e.children)this.draw(e.children[h],e)},s.prototype.bindNodeEvents=function(t){var e,o=this;t.on("click",function(e){o.onNodeClick(e,t)}).mousedown(function(t){t.stopPropagation()}),t.find(".text").on("keyup paste blur",function(e){o.onNodeTextChanged(e,t)}).on("keydown",function(){}),"root"!=t.data("type")&&t.droppable({container:o.$,target:"#"+o.id+' .mindmap-node:not([data-id="'+t.data("id")+'"]',before:function(i){return o.callEvent("beforeDrag",{node:t})?i.element.hasClass("focus")?!1:(e=o.getNodeData(i.element.data("id")),e?void 0:!1):!1},start:function(e){e.element.hasClass("active")||(o.clearNodeStatus(),o.activeNode(t))},drag:function(t){t.pos.left-=o.x,t.pos.top-=o.y,e.ui.dragPos=o.computePosition(t.pos,!0),e.ui.canDrop=t.isIn,o.showNode()},beforeDrop:function(i){if(i.isIn){if(i.target.data("id")==e.parent)return!1}else{if(!o.callEvent("beforeSort",{node:t,event:i}))return;var n=e.subSide;"sub"===e.type&&(e.ui.left<-30?n="left":e.ui.left>30&&(n="right")),o.update([{action:"sort",data:o.getNodeData(e.parent),func:function(t,e){return t.ui.top-e.ui.top}},{data:e,subSide:n}]),o.callEvent("afterSort",{node:t,event:i})}},drop:function(i){o.callEvent("beforeMove",{node:t,event:i})&&(o.update({action:"move",data:e,newParent:i.target.data("id")}),o.callEvent("afterMove",{node:t,event:i}))},finish:function(){e.ui.dragPos=null,e.ui.canDrop=!1,o.showNode()}})},s.prototype.onNodeClick=function(t,e){e.hasClass("active")?this.focusNode(e):(this.clearNodeStatus(),this.activeNode(e)),this.callEvent("onNodeClick",{node:e}),t.stopPropagation()},s.prototype.onNodeTextChanged=function(t,e){var o=e.find(".text").text();o!=e.data("origin-text")&&(e.data("origin-text",o),this.update({id:e.data("id"),text:o}),this.callEvent("onTextChanged",{node:e}))},s.prototype.activeNode=function(t){typeof t===n&&(t=this.$desktop.children('.mindmap-node[data-type="sub"]').first()),t.length||(t=this.$desktop.children(".mindmap-node").first()),this.callEvent("beforeNodeActive",{node:t})&&(t.addClass("active"),this.makeNodeVisble(t),this.activedNode=t,this.isActive=!0,this.callEvent("onNodeActive",{node:t}))},s.prototype.focusNode=function(t,o){if(t.hasClass("readonly"))return e.messager.show(this.lang.ReadonlyTip),void 0;if(t.hasClass("active")&&this.callEvent("beforeNodeFocus",{node:t})){var i=t.addClass("focus").find(".text");i.attr("contenteditable","true"),this.makeNodeVisble(t),i.focus(),o&&i.selectText(),this.isFocus=!0}},s.prototype.clearActiveNode=function(t){typeof t===n&&(t=this.$desktop.children(".mindmap-node.active")),t.removeClass("active"),this.isActive=!1,this.activedNode=null},s.prototype.clearFocusNode=function(t){typeof t===n&&(t=this.$desktop.children(".mindmap-node.focus")),t.removeClass("focus").find(".text").attr("contenteditable","false").blur(),this.isFocus=!1},s.prototype.bindEvents=function(){var e=this.$,o=this;e.resize(t.proxy(this.initSize,this)).click(t.proxy(this.onDesktopClick,this)),this.bindGlobalHotkeys(),this.$container.draggable({finish:function(t){o.display(t.smallOffset.x,t.smallOffset.y,!0)},drag:function(t){o.display(t.smallOffset.x,t.smallOffset.y,!0)}})},s.prototype.bindGlobalHotkeys=function(){var e=this.options;if(e.hotkeyEnable){var i=this,n=e.hotkeys;t(o).on("keydown",null,n.selectPrev,function(){i.selectNode("prev")}).on("keydown",null,n.selectNext,function(){i.selectNode("next")}).on("keydown",null,n.selectLeft,function(){i.selectNode("left")}).on("keydown",null,n.selectRight,function(){i.selectNode("right")}).on("keydown",null,n.deleteNode,function(){i.deleteNode(),8!=event.keyCode||i.isFocus||event.preventDefault()}).on("keydown",null,n.addBorther,function(){i.addBortherNode()}).on("keydown",null,n.addChild,function(t){i.addChildNode(),9==t.keyCode&&t.preventDefault()}).on("keydown",function(){if(event.keyCode>=48&&event.keyCode<=111&&i.isActive&&!i.isFocus){var t=i.activedNode;t&&(t.find(".text").text(""),i.focusNode(t))}}).on("keydown",null,n.centerCanvas,function(){i.display(0,0)})}},s.prototype.addBortherNode=function(){if(this.isActive){var t=this.getNodeData(this.activedNode.data("id"));if(t){var e="root"===t.type?t:this.getNodeData(t.parent),o=this.createDefaultNodeData(e);if(!this.callEvent("beforeAdd",{node:e,newNode:o}))return;this.update({action:"add",data:e,newData:o}),this.clearNodeStatus();var i=this.getNode(o.id);this.activeNode(i),this.focusNode(i,!0),this.callEvent("afterAdd",{node:e,newNode:o})}}},s.prototype.addChildNode=function(){if(this.isActive){var t=this.getNodeData(this.activedNode.data("id"));if(t){var e=this.createDefaultNodeData(t);if(!this.callEvent("beforeAdd",{node:t,newNode:e}))return;this.update({action:"add",data:t,newData:e}),this.clearNodeStatus();var o=this.getNode(e.id);this.activeNode(o),this.focusNode(o,!0),this.callEvent("afterAdd",{node:t,newNode:e})}}},s.prototype.deleteNode=function(){if(!this.isFocus&&this.isActive){var t=this.getNodeData(this.activedNode.data("id"));if(t){if(!this.callEvent("beforeDelte",{node:t}))return;this.update({action:"remove",data:t}),this.callEvent("afterDelete",{node:t})}}},s.prototype.selectNode=function(t){if(!this.isFocus){if(!this.isActive)return this.activeNode(),void 0;var e=null,o=this.getNodeData(this.activedNode.data("id")),i=null;switch("root"===o.type?t="prev"===t||"left"===t?"left":"right":"left"===t?t="left"==o.subSide?"child":"parent":"right"===t&&(t="right"==o.subSide?"child":"parent"),t){case"prev":i=o.ui.prevBorther;break;case"next":i=o.ui.nextBorther;break;case"parent":i=o.parent;break;case"child":o.count>0&&(i=o.children[0].id);break;case"left":if(o.count>0){i=o.children[0].id;for(var n in o.children){var a=o.children[n];if("left"==a.subSide){i=a.id;break}}}break;case"right":if(o.count>0){i=o.children[0].id;for(var n in o.children){var a=o.children[n];if("right"==a.subSide){i=a.id;break}}}}i&&(e=this.getNodeData(i)),e&&(this.clearNodeStatus(),this.activeNode(e.ui.element))}},s.prototype.selectNext=function(){if(!this.isFocus){var t=null;this.isActive||this.activeNode();var e=this.getNodeData(this.activedNode.data("id"));null!=e.ui.nextBorther&&(t=this.getNodeData(e.ui.nextBorther)),t&&(this.clearNodeStatus(),this.activeNode(t.ui.element))}},s.prototype.selectLeft=function(){if(!this.isFocus){var t=null;this.isActive||this.activeNode();var e=this.getNodeData(this.activedNode.data("id"));null!=e.ui.leftBorther&&(t=this.getNodeData(e.ui.leftBorther)),t&&(this.clearNodeStatus(),this.activeNode(t.ui.element))}},s.prototype.onDesktopClick=function(){this.$desktop,this.clearNodeStatus()},s.prototype.clearNodeStatus=function(){this.clearActiveNode(),this.clearFocusNode()},t.fn.mindmap=function(e){return this.each(function(){var o=t(this),i=o.data("zui.mindmap"),n="object"==typeof e&&e;i||o.data("zui.mindmap",i=new s(this,n)),"string"==typeof e&&i[e]()})},t.fn.mindmap.Constructor=s}(jQuery,window,document,Math);
