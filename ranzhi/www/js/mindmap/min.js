+function(t,e,i,o){"use strict";var n="undefined",a=0,s=function(e,i){this.$=t(e),this.options=this.getOptions(i),this.lang=this.getLang(),this.data=this.options.data,this.dirtyData=!0,this.offsetX=0,this.offsetY=0,this.init()};s.DEFAULTS={hotkeyEnable:!0,hotkeys:{selectPrev:"Up",selectNext:"Down",selectLeft:"left",selectRight:"right",deleteNode:"del backspace",addBorther:"return",addChild:"tab insert",centerCanvas:"space"},lang:"zh_cn",langs:{zh_cn:{DefaultName:"灵光闪现",DefaultSubName:"灵光",DefaultNodeName:"闪现",ReadonlyTip:"该节点已被设置为只读，无法进行编辑。",HotkeyDisabled:'快捷键不可用，需要 <a target="_blank" href="https://github.com/jeresig/jquery.hotkeys">jquery.hotkeys</a> 插件支持。'}},data:{text:"New Project",type:"root",expand:!0,theme:"default",caption:"",id:t.uuid()+""},nodeTeamplate:"<div id='node-{id}' class='mindmap-node expand-{expand}' data-type='{type}' data-id='{id}' data-parent='{parent}'><div class='wrapper'><div class='text'>{text}</div><div class='caption'>{caption}</div></div></div>",hSpace:100,vSpace:10,canvasPadding:20,removingNodeTip:null,lineCurvature:60,subLineWidth:4,lineColor:"rainbow",lineOpacity:1,lineSaturation:90,lineLightness:40,nodeLineWidth:2},s.prototype.getOptions=function(i){s.DEFAULTS.data.text=s.DEFAULTS.langs.zh_cn.DefaultName,i=t.extend({},s.DEFAULTS,this.$.data(),i);var o=typeof t.hotkeys!=n;return!o&&i.hotkeyEnable&&e.messager.danger(this.lang.HotkeyDisabled),i.hotkeyEnable=i.hotkeyEnable&&o,i},s.prototype.getLang=function(){if(!this.options.lang){if("undefined"!=typeof e.config&&e.config.clientLang)this.options.lang=config.clientLang;else{var i=t("html").attr("lang");this.options.lang=i?i:"en"}this.options.lang=this.options.lang.replace(/-/,"_").toLowerCase()}return this.options.langs[this.options.lang]||this.options.langs[s.DEFAULTS.lang]},s.prototype.init=function(){this.initDom(),this.initSize(),this.bindEvents(),this.render()},s.prototype.initDom=function(){var e=this.$;e.attr("id")||e.attr("id","mindmap-"+t.uuid()),this.id=e.attr("id"),this.$container=e.children(".mindmap-container"),this.$container.length||(e.prepend("<div class='mindmap-container'></div>"),this.$container=e.children(".mindmap-container")),this.$canvas=this.$container.children("canvas"),this.$canvas.length||(this.$container.prepend("<canvas class='mindmap-bg'></canvas>".format(this.options.canvasSize)),this.$canvas=this.$container.children("canvas")),this.$desktop=this.$container.children(".mindmap-desktop"),this.$desktop.length||(this.$container.append("<div class='mindmap-desktop'></div>"),this.$desktop=this.$container.children(".mindmap-desktop")),this.$desktop.attr("unselectable","on");var i=e.children(".shadow");i.length||e.append("<div class='mindmap-shadow shadow-top'></div><div class='mindmap-shadow shadow-right'></div><div class='mindmap-shadow shadow-bottom'></div><div class='mindmap-shadow shadow-left'></div>")},s.prototype.initSize=function(){var t=this.$;this.winWidth=t.width(),this.winHeight=t.height(),this.centerX=o.floor(this.winWidth/2),this.centerY=o.floor(this.winHeight/2),this.dirtyData||this.display()},s.prototype.callEvent=function(e,i){return t.callEvent(this.options[e],i,this)},s.prototype.computePosition=function(t,e){var i=e?-1:1;return typeof t.left!=n&&(t.left-=(this.left-this.options.canvasPadding)*i),typeof t.top!=n&&(t.top-=this.top*i),typeof t.x!=n&&(t.x-=(this.left-this.options.canvasPadding)*i),typeof t.y!=n&&(t.y-=this.top*i),t},s.prototype.computeColor=function(t,e){return"hsla({h}, {s}%, {l}%, {a})".format({h:t,s:this.options.lineSaturation,l:this.options.lineLightness,a:e||this.options.lineOpacity})},s.prototype.getNodeData=function(e,i){if("number"==typeof e&&(e=e.toString()),i||(i=this.data),e==i.id)return i;if(t.isArray(i.children)&&i.children.length>0)for(var o in i.children){var n=this.getNodeData(e,i.children[o]);if(n)return n}return null},s.prototype.createDefaultNodeData=function(e){var i={expand:!0,id:t.uuid()+"",parent:e.id};return"root"===e.type?(i.type="sub",i.text=this.lang.DefaultSubName):(i.type="node",i.text=this.lang.DefaultNodeName),i},s.prototype.getNode=function(t){return"string"==typeof t?this.$desktop.children('[data-id="'+t+'"]'):typeof t.id!=n?t.ui.element:void 0},s.prototype.removeNode=function(t){if(this.getNode(t).remove(),t.count>0)for(var e in t.children)this.removeNode(t.children[e])},s.prototype.update=function(e,i,o){var a=!1;if(this.options,t.isPlainObject(e)&&(e=[e]),t.isArray(e))for(var s in e){var d=e[s],r=d.data;if(r||(r=this.getNodeData(d.id)),!r)return;var h=d.action||"update";if("remove"===h||"delete"===h){var l=this.getNodeData(r.parent);l&&(l.children.splice(r.index,1),this.removeNode(r),this.clearNodeStatus(),t.isArray(l.deletions)?l.deletions.push(r):l.deletions=[r],o=!0,i=!0,a=!0,r.action="delete")}else if("add"===h)t.isArray(r.children)?r.children.push(d.newData):r.children=[d.newData],o=!0,i=!0,a=!0,r.action="add";else if("move"===h){if(d.newParent!=r.parent){var p=this.getNodeData(d.newParent),l=this.getNodeData(r.parent);l&&p&&("root"===p.type?("node"===r.type&&(r.colorHue=null),r.type="sub",r.subSide=null):(r.type="node",r.subSide=p.subSide),l.children.splice(r.index,1),l.count-=1,t.isArray(p.children)?p.children.push(r):p.children=[r],p.count+=1,o=!0,i=!0,a=!0,r.action+=" move")}}else if("sort"===h){if(r.count>1){r.children.sort(d.func);for(var s in r.children){var c=r.children[s];c.index=s,c.action+=" sort"}o=!0,i=!0,a=!0}}else typeof d.text!=n&&d.text!=r.text&&(r.text=d.text,i=!0,a=!0),typeof d.subSide!=n&&d.subSide!=r.subSide&&(r.subSide=d.subSide,o=!0,i=!0,a=!0),a&&(r.action+=" edit")}o&&this.loadNode(),i&&this.showNode(),a&&this.callEvent("onChange",{changes:e,data:this.data})},s.prototype.export=function(){var e=t.extend({},this.data);return this.fixExport(e),e},s.prototype.exportJSON=function(){return JSON.stringify(this.export())},s.prototype.exportArray=function(e,i){typeof e===n&&(e=this.data),typeof i===n&&(i=[]);var o=t.extend({},e);if(delete o.ui,delete o.children,delete o.subSide,i.push(o),e.children)for(var a in e.children)this.exportArray(e.children[a],i);return i},s.prototype.fixExport=function(t){if(delete t.ui,t.children)for(var e in t.children)this.fixExport(t.children[e])},s.prototype.load=function(t){this.data=t,this.render(t)},s.prototype.render=function(){this.loadNode(),this.showNode()},s.prototype.loadNode=function(e,i){e||(e=this.data);var s=this.options,d=this.$desktop,r="object"==typeof i?i.id?i.id:"":"";typeof e.expand===n&&(e.expand=!0),typeof e.data===n&&(e.data={}),typeof e.type===n&&(e.type="node"),typeof e.id===n&&(e.id=t.uuid()+""),typeof e.readonly===n&&(e.readonly=!1),typeof e.ui===n&&(e.ui={}),e.parent=r;var h=d.children('.mindmap-node[data-id="'+e.id+'"]');if(h.length?(h.toggleClass("expand-false",!e.expand).toggleClass("expand-true",e.expand).attr("data-type",e.type).attr("data-parent",r||"root"),h.children(".text").html(e.text),h.children(".caption").html(e.caption)):(h=t(s.nodeTeamplate.format({type:e.type||"node",expand:e.expand,caption:e.caption||"",id:e.id,parent:r||"root",text:e.text})).appendTo(d),this.bindNodeEvents(h),e.ui.element=h),"root"===e.type)e.ui.subLeftSide=0,e.ui.subRightSide=0,e.ui.vLeftSpan=0,e.ui.vRightSpan=0;else if("sub"===e.type){var l=e.subSide;l||(l=i.ui.subRightSide>i.ui.subLeftSide?"left":"right"),"left"===l?i.ui.subLeftSide++:i.ui.subRightSide++,e.subSide=l,typeof e.colorHue===n&&(e.colorHue=o.floor(55*a++%360))}else e.subSide=i.subSide;h.data("origin-text",e.text),h.toggleClass("readonly",e.readonly);var p=1;if(e.count=0,t.isArray(e.children)&&e.children.length>0){e.ui.topSpanTemp="root"===e.type?{left:0,right:0}:0;var c=0,u=0,f=null;p=0,e.children.sort(function(t,e){return t.index-e.index});for(var v in e.children){var y=e.children[v];typeof y.ui===n&&(y.ui={}),"sub"!=y.type&&(y.colorHue=e.colorHue),y.ui.nextBorther=null,f?(y.ui.prevBorther=f.id,f.ui.nextBorther=y.id):y.ui.prevBorther=null,f=y,this.loadNode(y,e,v),y.index=e.count++,"undifined"==typeof y.order&&(y.order=y.index),p+=y.ui.vSpan,"sub"===y.type?"left"===y.subSide?(c+=y.ui.vSpan,y.ui.topSpan=e.ui.topSpanTemp.left,e.ui.topSpanTemp.left+=y.ui.vSpan):(u+=y.ui.vSpan,y.ui.topSpan=e.ui.topSpanTemp.right,e.ui.topSpanTemp.right+=y.ui.vSpan):(y.ui.topSpan=e.ui.topSpanTemp,e.ui.topSpanTemp+=y.ui.vSpan)}"root"===e.type&&(e.ui.vLeftSpan=c,e.ui.vRightSpan=u)}"root"!=e.type&&(e.ui.vSpan=p),this.dirtyData=!1,"root"===e.type&&this.callEvent("afterLoad",{data:e})},s.prototype.showNode=function(e,i){e||(e=this.data);var n=this.options,a=e.ui,s=e.ui.element;if(a.width=s.outerWidth(),a.height=s.outerHeight(),"root"===e.type)a.left=0-o.floor(a.width/2),a.top=0-o.floor(a.height/2),this.left=0-o.floor(o.max(a.width+n.canvasPadding,this.winWidth)/4),this.right=0-this.left,this.top=0-o.floor(o.max(a.height+n.canvasPadding,this.winHeight)/4),this.bottom=0-this.top;else if(t.isPlainObject(a.dragPos))a.left=a.dragPos.left,a.top=a.dragPos.top;else{if("sub"===e.type){var d=0;"left"===e.subSide?(a.left=i.ui.left-n.hSpace-20-a.width,d=i.ui.vLeftSpan):(a.left=i.ui.left+i.ui.width+n.hSpace+20,d=i.ui.vRightSpan);var r=d*a.height+(d-1)*n.vSpace,h=0-o.floor(r/2),l=a.topSpan*a.height+a.topSpan*n.vSpace,p=a.vSpan*a.height+(a.vSpan-1)*n.vSpace;a.top=h+l+o.floor((p-a.height)/2)}else{a.left="left"===e.subSide?i.ui.left-n.hSpace-a.width:i.ui.left+i.ui.width+n.hSpace;var r=i.ui.vSpan*a.height+(i.ui.vSpan-1)*n.vSpace,h=i.ui.top+o.floor(i.ui.height/2)-o.floor(r/2),l=a.topSpan*a.height+a.topSpan*n.vSpace,p=a.vSpan*a.height+(a.vSpan-1)*n.vSpace;a.top=h+l+o.floor((p-a.height)/2)}"left"===e.subSide?this.left=o.min(this.left,a.left):this.right=o.max(this.right,a.left+a.width),this.top=o.min(this.top,a.top),this.bottom=o.max(this.bottom,a.top+a.height)}if(t.isArray(e.children)&&e.children.length>0)for(var c in e.children)this.showNode(e.children[c],e);if("root"===e.type){var u=this.options.canvasPadding;this.left-=u,this.top-=u,this.right+=2*u,this.bottom+=u,this.width=this.right-this.left,this.height=this.bottom-this.top,this.display(),this.draw(),this.callEvent("afterShow",{data:e})}},s.prototype.display=function(t,e,i){"number"==typeof t&&"number"==typeof e&&(i&&(t+=this.offsetX,e+=this.offsetY),this.offsetX=t,this.offsetY=e),this.x=this.centerX+this.left+this.offsetX,this.y=this.centerY+this.top+this.offsetY,this.$container.css({width:this.width,height:this.height,top:this.y,left:this.x});var o=this.options.canvasPadding;this.$.toggleClass("shadow-left",this.x<0-o).toggleClass("shadow-right",this.x+this.width>this.winWidth+o).toggleClass("shadow-top",this.y<0-o).toggleClass("shadow-bottom",this.y+this.height>this.winHeight+o)},s.prototype.makeNodeVisble=function(t){var e=this.getNodeData(t.data("id"));if(e){var i=e.ui.left-this.left+this.x,o=e.ui.top-this.top+this.y,n=this.options.canvasPadding;if(0>i)this.offsetX+=0-i;else{var a=i+e.ui.width-(this.winWidth+n);a>0&&(this.offsetX+=0-a-80)}if(0>o)this.offsetY+=0-o;else{var a=o+e.ui.height-(this.winWidth+n);a>0&&(this.offsetY+=0-a-80)}this.display()}},s.prototype.clearCanvasArea=function(){this.$canvas[0].getContext("2d").clearRect(0,0,this.width,this.height)},s.prototype.draw=function(e,i){if(e||(e=this.data),"root"===e.type&&(this.$canvas.attr({width:this.width,height:this.height}),this.clearCanvasArea()),i){var n="left"===e.subSide,a=this.options,s=this.$canvas[0].getContext("2d"),d={x:i.ui.left+("root"===i.type?o.floor(i.ui.width/2):n?0:i.ui.width),y:i.ui.top+o.floor(i.ui.height/2)},r={x:e.ui.left+(n?e.ui.width:0),y:e.ui.top+o.floor(e.ui.height/2)},h={x:d.x+(n?-1:1)*a.lineCurvature,y:d.y},l={x:r.x+(n?1:-1)*a.lineCurvature,y:r.y};d=this.computePosition(d),r=this.computePosition(r),h=this.computePosition(h),l=this.computePosition(l),s.beginPath(),s.strokeStyle=this.computeColor(e.colorHue,e.ui.canDrop?".25":"1"),s.lineCap="round",s.lineWidth="sub"===e.type?a.subLineWidth:a.nodeLineWidth,s.moveTo(d.x,d.y),s.bezierCurveTo(h.x,h.y,l.x,l.y,r.x,r.y),s.stroke()}if(e.ui.element.css(this.computePosition({left:e.ui.left,top:e.ui.top})),t.isArray(e.children)&&e.children.length>0)for(var p in e.children)this.draw(e.children[p],e)},s.prototype.bindNodeEvents=function(t){var e,i=this;t.on("click",function(e){i.onNodeClick(e,t)}).mousedown(function(t){t.stopPropagation()}),t.find(".text").on("keyup paste blur",function(e){i.onNodeTextChanged(e,t)}).on("keydown",function(){}),"root"!=t.data("type")&&t.droppable({container:i.$,target:"#"+i.id+' .mindmap-node:not([data-id="'+t.data("id")+'"]',before:function(o){return i.callEvent("beforeDrag",{node:t})?o.element.hasClass("focus")?!1:(e=i.getNodeData(o.element.data("id")),e?void 0:!1):!1},start:function(e){i.callEvent("startDrag",{node:t}),e.element.hasClass("active")||(i.clearNodeStatus(),i.activeNode(t))},drag:function(t){t.pos.left-=i.x,t.pos.top-=i.y,e.ui.dragPos=i.computePosition(t.pos,!0),e.ui.canDrop=t.isIn,i.showNode()},beforeDrop:function(o){if(o.isIn){if(o.target.data("id")==e.parent)return!1}else{if(!i.callEvent("beforeSort",{node:t,event:o}))return;var n=e.subSide;"sub"===e.type&&(e.ui.left<-30?n="left":e.ui.left>30&&(n="right")),i.update([{action:"sort",data:i.getNodeData(e.parent),func:function(t,e){return t.ui.top-e.ui.top}},{data:e,subSide:n}]),i.callEvent("afterSort",{node:t,event:o})}},drop:function(o){i.callEvent("beforeMove",{node:t,event:o})&&(i.update({action:"move",data:e,newParent:o.target.data("id")}),i.callEvent("afterMove",{node:t,event:o}))},finish:function(){e.ui.dragPos=null,e.ui.canDrop=!1,i.showNode()}}),this.callEvent("onBindEvents",{node:t})},s.prototype.onNodeClick=function(t,e){e.hasClass("active")?this.focusNode(e):(this.clearNodeStatus(),this.activeNode(e)),this.callEvent("onNodeClick",{node:e}),t.stopPropagation()},s.prototype.onNodeTextChanged=function(t,e){var i=e.find(".text").text();i!=e.data("origin-text")&&(""==i&&e.find(".text").text(""),e.data("origin-text",i),this.update({id:e.data("id"),text:i}),this.callEvent("onTextChanged",{node:e}))},s.prototype.activeNode=function(t){typeof t===n&&(t=this.$desktop.children('.mindmap-node[data-type="sub"]').first()),t.length||(t=this.$desktop.children(".mindmap-node").first()),this.callEvent("beforeNodeActive",{node:t})&&(t.addClass("active"),this.makeNodeVisble(t),this.activedNode=t,this.isActive=!0,this.callEvent("onNodeActive",{node:t}))},s.prototype.focusNode=function(t,i){if(t.hasClass("readonly"))return e.messager.show(this.lang.ReadonlyTip),void 0;if(t.hasClass("active")&&this.callEvent("beforeNodeFocus",{node:t})){var o=t.addClass("focus").find(".text");o.attr("contenteditable","true"),this.makeNodeVisble(t),o.focus(),(i||typeof i===n)&&o.selectText(),this.isFocus=!0}},s.prototype.clearActiveNode=function(t){typeof t===n&&(t=this.$desktop.children(".mindmap-node.active")),t.removeClass("active"),this.isActive=!1,this.activedNode=null},s.prototype.clearFocusNode=function(t){typeof t===n&&(t=this.$desktop.children(".mindmap-node.focus")),t.removeClass("focus").find(".text").attr("contenteditable","false").blur(),this.isFocus=!1},s.prototype.bindEvents=function(){var e=this.$,i=this;e.resize(t.proxy(this.initSize,this)).click(t.proxy(this.onDesktopClick,this)),this.bindGlobalHotkeys(),this.$container.draggable({before:function(){return i.callEvent("beforeMoveCanvas")?void 0:!1},finish:function(t){i.display(t.smallOffset.x,t.smallOffset.y,!0)},drag:function(t){i.display(t.smallOffset.x,t.smallOffset.y,!0)}})},s.prototype.bindGlobalHotkeys=function(){var e=this.options;if(e.hotkeyEnable){var o=this,n=e.hotkeys;t(i).on("keydown",null,n.selectPrev,function(){o.selectNode("prev")}).on("keydown",null,n.selectNext,function(){o.selectNode("next")}).on("keydown",null,n.selectLeft,function(){o.selectNode("left")}).on("keydown",null,n.selectRight,function(){o.selectNode("right")}).on("keydown",null,n.deleteNode,function(){o.deleteNode(),8!=event.keyCode||o.isFocus||event.preventDefault()}).on("keydown",null,n.addBorther,function(){o.addBortherNode()}).on("keydown",null,n.addChild,function(t){o.addChildNode(),9==t.keyCode&&t.preventDefault()}).on("keydown",function(){if(event.keyCode>=48&&event.keyCode<=111&&o.isActive&&!o.isFocus){var t=o.activedNode;t&&(t.find(".text").text(""),o.focusNode(t))}}).on("keydown",null,n.centerCanvas,function(){o.display(0,0)})}},s.prototype.addBortherNode=function(){if(this.isActive){var t=this.getNodeData(this.activedNode.data("id"));if(t){var e="root"===t.type?t:this.getNodeData(t.parent),i=this.createDefaultNodeData(e);if(!this.callEvent("beforeAdd",{node:e,newNode:i}))return;this.update({action:"add",data:e,newData:i}),this.clearNodeStatus();var o=this.getNode(i.id);this.activeNode(o),this.focusNode(o,!0),this.callEvent("afterAdd",{node:e,newNode:i})}}},s.prototype.addChildNode=function(){if(this.isActive){var t=this.getNodeData(this.activedNode.data("id"));if(t){var e=this.createDefaultNodeData(t);if(!this.callEvent("beforeAdd",{node:t,newNode:e}))return;this.update({action:"add",data:t,newData:e}),this.clearNodeStatus();var i=this.getNode(e.id);this.activeNode(i),this.focusNode(i,!0),this.callEvent("afterAdd",{node:t,newNode:e})}}},s.prototype.deleteNode=function(){if(!this.isFocus&&this.isActive){var t=this.getNodeData(this.activedNode.data("id"));if(t){if(!this.callEvent("beforeDelete",{node:t}))return;this.update({action:"remove",data:t}),this.callEvent("afterDelete",{node:t})}}},s.prototype.selectNode=function(t){if(!this.isFocus){if(!this.isActive)return this.activeNode(),void 0;var e=null,i=this.getNodeData(this.activedNode.data("id")),o=null;switch("root"===i.type?t="prev"===t||"left"===t?"left":"right":"left"===t?t="left"==i.subSide?"child":"parent":"right"===t&&(t="right"==i.subSide?"child":"parent"),t){case"prev":o=i.ui.prevBorther;break;case"next":o=i.ui.nextBorther;break;case"parent":o=i.parent;break;case"child":i.count>0&&(o=i.children[0].id);break;case"left":if(i.count>0){o=i.children[0].id;for(var n in i.children){var a=i.children[n];if("left"==a.subSide){o=a.id;break}}}break;case"right":if(i.count>0){o=i.children[0].id;for(var n in i.children){var a=i.children[n];if("right"==a.subSide){o=a.id;break}}}}o&&(e=this.getNodeData(o)),e&&(this.clearNodeStatus(),this.activeNode(e.ui.element))}},s.prototype.selectNext=function(){if(!this.isFocus){var t=null;this.isActive||this.activeNode();var e=this.getNodeData(this.activedNode.data("id"));null!=e.ui.nextBorther&&(t=this.getNodeData(e.ui.nextBorther)),t&&(this.clearNodeStatus(),this.activeNode(t.ui.element))}},s.prototype.selectLeft=function(){if(!this.isFocus){var t=null;this.isActive||this.activeNode();var e=this.getNodeData(this.activedNode.data("id"));null!=e.ui.leftBorther&&(t=this.getNodeData(e.ui.leftBorther)),t&&(this.clearNodeStatus(),this.activeNode(t.ui.element))}},s.prototype.onDesktopClick=function(){this.$desktop,this.clearNodeStatus()},s.prototype.clearNodeStatus=function(){this.clearActiveNode(),this.clearFocusNode()},t.fn.mindmap=function(e){return this.each(function(){var i=t(this),o=i.data("zui.mindmap"),n="object"==typeof e&&e;o||i.data("zui.mindmap",o=new s(this,n)),"string"==typeof e&&o[e]()})},t.fn.mindmap.Constructor=s}(jQuery,window,document,Math);